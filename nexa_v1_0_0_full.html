<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Structure Evaluator D-3.Final [COMPLIANT]</title>
    <style>
        :root { --b: #000; --w: #fff; --g: #888; }
        body { font-family: "SF Mono", monospace; background: var(--w); color: var(--b); margin: 0; display: flex; flex-direction: column; height: 100vh; font-size: 12px; }
        header { padding: 10px 20px; border-bottom: 1px solid var(--b); display: flex; justify-content: space-between; align-items: baseline; }
        #guide { padding: 20px; border-bottom: 1px solid var(--b); background: #fafafa; line-height: 1.6; }
        #control { margin-top: 10px; padding: 20px; border: 1px dashed var(--b); text-align: center; }
        main { display: flex; flex: 1; overflow: hidden; opacity: 0.1; pointer-events: none; transition: opacity 0.5s; }
        main.active { opacity: 1; pointer-events: auto; }
        .slot { flex: 1; border-right: 1px solid var(--b); padding: 20px; display: flex; flex-direction: column; }
        .slot:last-child { border-right: none; }
        input { width: 100%; border: 1px solid var(--b); padding: 10px; margin-bottom: 10px; font-family: inherit; outline: none; }
        .list { flex: 1; overflow-y: auto; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .item { padding: 8px 0; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .out { border-top: 2px solid var(--b); padding-top: 20px; }
        .m { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1.2rem; align-items: baseline; }
        .v { font-weight: bold; font-variant-numeric: tabular-nums; }
        #st-log { font-size: 10px; color: var(--g); margin-top: 10px; font-family: inherit; }
    </style>
</head>
<body>

<header>
    <div>STRUCTURE_EVALUATOR_D3_FINAL</div>
    <div id="status">CODE: 404_DATA_REQUIRED</div>
</header>

<div id="guide">
    1. Prepare <a href="https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N02-v3_1.html" target="_blank">KSJ-N02-GeoJSON</a> (Station / RailroadSection).<br>
    2. Inject both files (Drag & Drop or Select).
    <div id="control">
        <input type="file" id="fi" accept=".geojson" multiple onchange="P.load(this.files)">
        <div id="st-log">STATUS: NULL</div>
    </div>
</div>

<main id="view">
    <div class="slot">
        <input type="text" placeholder="QUERY_A" oninput="UI.s(this, 'A')">
        <div id="l-A" class="list"></div>
        <div class="out">
            <div class="m"><span>gt</span><span class="v" id="gt-A">0.00000000</span></div>
            <div class="m"><span>E.r</span><span class="v" id="er-A">0.00000000</span></div>
            <div class="m"><span>E.e</span><span class="v" id="ee-A">0.00000000</span></div>
        </div>
    </div>
    <div class="slot">
        <input type="text" placeholder="QUERY_B" oninput="UI.s(this, 'B')">
        <div id="l-B" class="list"></div>
        <div class="out">
            <div class="m"><span>gt</span><span class="v" id="gt-B">0.00000000</span></div>
            <div class="m"><span>E.r</span><span class="v" id="er-B">0.00000000</span></div>
            <div class="m"><span>E.e</span><span class="v" id="ee-B">0.00000000</span></div>
        </div>
    </div>
</main>

<script>
/**
 * P: Data Processor [D-3.Final Compliant]
 * 幾何学的距離のみに基づきトポロジーを抽出
 */
const P = {
    st: [],
    EPSILON: 0.001, // 幾何学的近傍定数

    async load(fs) {
        const log = document.getElementById('st-log');
        let rawSt = [], rawSe = [];

        for (const f of fs) {
            const j = JSON.parse(await f.text());
            if (f.name.includes("Station")) rawSt = j.features;
            if (f.name.includes("RailroadSection")) rawSe = j.features;
        }

        // 1. ノード属性の初期化（幾何情報保存）
        this.st = rawSt.map(feat => {
            const p = feat.properties;
            const c = feat.geometry.coordinates[0];
            return {
                n: p.N02_005, l: p.N02_003, o: p.N02_004,
                c: p.N02_002 ? parseInt(p.N02_002) : 1,
                x: c[0], y: c[1],
                deg: 0
            };
        });

        // 2. 幾何的一致（接合事実）のバインド
        rawSe.forEach(feat => {
            const coords = feat.geometry.coordinates;
            const start = coords[0];
            const end = coords[coords.length - 1];

            this.st.forEach(node => {
                const dStart = Math.hypot(node.x - start[0], node.y - start[1]);
                const dEnd = Math.hypot(node.x - end[0], node.y - end[1]);
                if (dStart < this.EPSILON || dEnd < this.EPSILON) {
                    node.deg += 1;
                }
            });
        });

        if (this.st.length > 0) {
            window.DB = this.st;
            document.getElementById('view').classList.add('active');
            document.getElementById('status').innerText = "CODE: 200_OPERATIONAL";
            log.innerText = `STATION_NODES: ${this.st.length}`;
        }
    }
};

/**
 * UI: User Interface
 * 境界固定および沈黙の保持
 */
const UI = {
    s(el, sid) {
        const l = document.getElementById(`l-${sid}`);
        l.innerHTML = '';
        const q = el.value.trim();
        if (!window.DB || q.length < 1) return;

        window.DB.filter(s => s.n.includes(q)).slice(0, 30).forEach(s => {
            const d = document.createElement('div');
            d.className = 'item';
            d.innerText = `${s.n} [${s.l}]`;
            d.onclick = () => {
                // 指摘3.4に基づく数値境界拘束
                const gt = Math.min(10.0, s.deg * 0.5);
                const er = Math.min(2.0, (s.c * 2) / (s.deg + 1));
                const ee = Math.log(s.deg + 1);

                document.getElementById(`gt-${sid}`).innerText = gt.toFixed(8);
                document.getElementById(`er-${sid}`).innerText = er.toFixed(8);
                document.getElementById(`ee-${sid}`).innerText = ee.toFixed(8);
            };
            l.appendChild(d);
        });
    }
};
</script>
</body>
</html>