<!DOCTYPE html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>評価</title><link rel=stylesheet href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"><style>*{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);color:#fff;font:14px -apple-system,sans-serif;min-height:100vh}#a{max-width:428px;margin:0 auto;padding:20px;padding-left:max(20px,env(safe-area-inset-left));padding-right:max(20px,env(safe-area-inset-right));padding-bottom:max(20px,env(safe-area-inset-bottom))}.segment{display:flex;background:rgba(118,118,128,.12);border-radius:9px;padding:2px;margin:16px 0;position:relative}.seg-item{flex:1;padding:8px 16px;border:none;background:none;color:rgba(235,235,245,.6);font:13px -apple-system;font-weight:400;cursor:pointer;border-radius:7px;transition:color .2s cubic-bezier(.4,0,.2,1);position:relative;z-index:1}.seg-item.active{color:#000}.segment::before{content:'';position:absolute;top:2px;left:2px;width:calc(50% - 2px);height:calc(100% - 4px);background:rgba(255,255,255,.95);border-radius:7px;box-shadow:0 2px 6px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.04);transition:transform .25s cubic-bezier(.4,0,.2,1);z-index:0}.segment[data-active="reverse"]::before{transform:translateX(calc(100% + 2px))}.mode-section{transition:opacity .3s cubic-bezier(.4,0,.2,1),transform .3s cubic-bezier(.4,0,.2,1)}.mode-section.hidden{opacity:0;transform:translateY(-8px);pointer-events:none;position:absolute;visibility:hidden;width:100%}.mode-section.visible{opacity:1;transform:translateY(0)}.c{background:rgba(28,28,30,.7);backdrop-filter:blur(20px)saturate(180%);border:.5px solid rgba(255,255,255,.15);border-radius:12px;margin:16px 0;padding:16px}.r{display:flex;align-items:center;min-height:44px;border-bottom:.5px solid rgba(255,255,255,.15);padding:8px 0}.r:last-child{border:0}.l{flex:1}.v{text-align:right;color:rgba(235,235,245,.6)}input,select{background:none;border:none;color:#fff;font:14px -apple-system;outline:none;text-align:right;flex:1}select{padding-right:20px}.b{background:#0A84FF;color:#fff;border:none;border-radius:10px;padding:15px;width:100%;cursor:pointer;font:14px -apple-system;font-weight:600;margin:16px 0}.b:active{transform:scale(.98)}.b-secondary{background:rgba(118,118,128,.24);color:rgba(235,235,245,.9)}.sc{text-align:center;padding:32px 16px;font-size:64px;font-weight:700;color:#0A84FF}.h{font-size:13px;color:rgba(235,235,245,.6);text-transform:uppercase;margin:22px 0 6px;letter-spacing:-.08px}.ds{font-size:11px;color:rgba(235,235,245,.4);margin:16px;line-height:1.5;border-top:1px solid rgba(255,255,255,.1);padding-top:12px}.station-card{background:rgba(28,28,30,.7);backdrop-filter:blur(20px)saturate(180%);border:.5px solid rgba(255,255,255,.15);border-radius:12px;padding:16px;margin:12px 0;transition:transform .2s cubic-bezier(.4,0,.2,1),box-shadow .2s cubic-bezier(.4,0,.2,1);box-shadow:0 1px 3px rgba(0,0,0,.12)}.station-card:active{transform:scale(.98);box-shadow:0 2px 8px rgba(0,0,0,.2)}.card-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px}.station-name{font-size:20px;font-weight:600;color:#fff;letter-spacing:-.4px}.reach-score{font-size:28px;font-weight:700;color:#0A84FF;letter-spacing:-.5px}.card-primary{font-size:15px;color:rgba(235,235,245,.9);margin-bottom:12px;font-weight:400}.card-badges{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}.badge{padding:4px 8px;background:rgba(118,118,128,.24);border-radius:6px;font-size:12px;color:rgba(235,235,245,.8);font-weight:500}.badge-line{background:rgba(10,132,255,.15);color:#0A84FF}.badge-approx{background:rgba(255,159,10,.15);color:#FF9F0A}.badge-dev{background:rgba(255,45,85,.15);color:#FF2D55;font-size:10px}.card-secondary{padding-top:12px;border-top:.5px solid rgba(255,255,255,.1);display:flex;gap:16px}.sec-item{flex:1;display:flex;flex-direction:column;gap:4px}.sec-label{font-size:11px;color:rgba(235,235,245,.5);text-transform:uppercase;letter-spacing:.6px;font-weight:500}.sec-value{font-size:15px;color:rgba(235,235,245,.9);font-weight:500}.empty-state{text-align:center;padding:64px 32px;opacity:.8}.empty-icon{margin-bottom:16px;opacity:.6}.empty-title{font-size:17px;font-weight:600;color:rgba(235,235,245,.8);margin-bottom:8px;letter-spacing:-.4px}.empty-desc{font-size:13px;color:rgba(235,235,245,.5);line-height:1.5}.sort-control{display:flex;gap:8px;margin:16px 0;overflow-x:auto;-webkit-overflow-scrolling:touch}.sort-btn{padding:6px 12px;background:rgba(118,118,128,.12);border:none;border-radius:8px;color:rgba(235,235,245,.6);font:13px -apple-system;font-weight:500;white-space:nowrap;transition:all .2s cubic-bezier(.4,0,.2,1)}.sort-btn.active{background:#0A84FF;color:#fff}.sort-btn:active{transform:scale(.95)}.slider-container{margin:16px 0}.slider-label{font-size:13px;color:rgba(235,235,245,.6);text-transform:uppercase;letter-spacing:.6px;display:block;margin-bottom:8px}.slider-value{font-size:24px;font-weight:600;color:#0A84FF;margin-bottom:12px}.slider{width:100%;height:4px;-webkit-appearance:none;background:rgba(118,118,128,.24);border-radius:2px;outline:none}.slider::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.25),0 1px 2px rgba(0,0,0,.1);cursor:pointer}.slider-marks{display:flex;justify-content:space-between;font-size:11px;color:rgba(235,235,245,.4);margin-top:8px}.conf-high{color:#0A84FF}.conf-mid{color:#FF9F0A}.conf-low{color:#FF453A}#map{height:300px;border-radius:12px;margin:16px 0;display:none}#map.visible{display:block}.map-legend{background:rgba(28,28,30,.9);backdrop-filter:blur(20px);border:.5px solid rgba(255,255,255,.15);border-radius:8px;padding:12px;font-size:12px;line-height:1.6}.legend-item{display:flex;align-items:center;gap:8px;margin:4px 0}.legend-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}.legend-dot.direct{background:#0A84FF}.legend-dot.approx{background:#FF9F0A}.legend-dot.work{background:#FF453A;width:16px;height:16px}.legend-note{color:rgba(235,235,245,.5);font-size:10px;margin-top:8px;padding-top:8px;border-top:.5px solid rgba(255,255,255,.1);line-height:1.4}.leaflet-popup-content-wrapper{background:rgba(28,28,30,.95);backdrop-filter:blur(20px);color:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.3)}.leaflet-popup-content{margin:12px;font:13px -apple-system}.leaflet-popup-tip{background:rgba(28,28,30,.95)}.leaflet-container a.leaflet-popup-close-button{color:rgba(235,235,245,.6)}</style></head><body><div id=a></div><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script>
const D={};
[
['shinjuku','新宿',35.6896,139.7006,['yamanote','chuo','shonan','keio','odakyu','saikyo'],180,[77e4,8,95,90],[.95,85,.15],15,4e4],
['shibuya','渋谷',35.658,139.7016,['yamanote','toyoko','shonan'],200,[56e4,7,95,90],[.9,88,.1],12,45e3],
['ikebukuro','池袋',35.7295,139.711,['yamanote','saikyo'],120,[56e4,6,88,85],[.8,78,.15],18,35e3],
['tokyo','東京',35.6812,139.7671,['yamanote','tokaido','chuo','keihin','sobu'],220,[46e4,7,92,88],[.85,82,.2],8,5e4],
['shinagawa','品川',35.6284,139.7387,['yamanote','tokaido','keihin'],150,[38e4,5,85,82],[.7,75,.15],10,32e3],
['meguro','目黒',35.6339,139.7157,['yamanote'],110,[15e4,4,70,72],[.6,68,.08],20,28e3],
['ebisu','恵比寿',35.6467,139.7101,['yamanote'],120,[17e4,3,75,75],[.7,72,.08],18,3e4],
['tamachi','田町',35.6455,139.7476,['yamanote'],100,[1e4,3,65,65],[.7,68,.18],12,27e3],
['nakameguro','中目黒',35.6443,139.6989,['toyoko'],120,[9e4,3,75,72],[.6,70,.05],17,29e3],
['kichijoji','吉祥寺',35.7032,139.5797,['chuo'],90,[13e4,3,75,75],[.5,68,0],20,25e3],
['yokohama','横浜',35.4657,139.622,['tokaido','keihin','toyoko','shonan'],70,[43e4,7,88,85],[.8,78,.2],25,42e3],
['kawasaki','川崎',35.5308,139.6975,['tokaido','keihin'],60,[25e4,5,75,72],[.7,70,.2],28,35e3],
['omiya','大宮',35.9067,139.6272,['keihin','saikyo'],50,[32e4,6,78,75],[.6,68,.15],35,33e3],
['musashikosugi','武蔵小杉',35.5777,139.6589,['toyoko'],90,[18e4,5,80,78],[.9,82,.2],22,36e3],
['ueno','上野',35.7138,139.7771,['yamanote','keihin'],90,[19e4,6,80,78],[.6,70,.15],15,34e3],
['akihabara','秋葉原',35.6984,139.7731,['yamanote','sobu'],100,[25e4,5,78,75],[.7,72,.1],12,36e3],
['yurakucho','有楽町',35.6751,139.763,['yamanote'],150,[10e4,3,85,82],[.7,75,.12],8,45e3],
['harajuku','原宿',35.6702,139.7026,['yamanote'],140,[5e4,2,78,75],[.6,70,.05],12,32e3],
['yoyogi','代々木',35.6833,139.702,['yamanote','chuo','odakyu'],110,[6e4,3,72,70],[.5,65,.08],14,29e3],
['takadanobaba','高田馬場',35.7129,139.7039,['yamanote'],90,[8e4,4,72,70],[.4,62,.1],16,28e3],
['machida','町田',35.5411,139.4468,['odakyu'],90,[10e4,5,78,75],[.7,75,.15],34,34e3],
['tachikawa','立川',35.6983,139.4133,['chuo','keio'],95,[12e4,6,82,80],[.8,78,.18],42,38e3],
['hachioji','八王子',35.6564,139.3389,['chuo'],85,[10e4,6,75,72],[.7,72,.18],48,33e3],
['chofu','調布',35.6515,139.5407,['keio'],85,[8e4,4,72,70],[.6,70,.12],30,31e3],
['fuchu','府中',35.6694,139.4778,['keio'],80,[7e4,4,70,68],[.6,68,.15],34,30e3],
['kokubunji','国分寺',35.7103,139.4622,['chuo'],85,[6e4,3,72,70],[.6,68,.12],36,30e3],
['urawa','浦和',35.8587,139.6587,['keihin','saikyo'],85,[10e4,5,78,75],[.7,75,.15],32,35e3],
['kawaguchi','川口',35.8078,139.7243,['keihin'],80,[12e4,5,75,72],[.7,70,.15],26,33e3],
['akabane','赤羽',35.7774,139.7206,['keihin','saikyo'],80,[8e4,4,70,68],[.6,68,.12],22,31e3],
['nakano','中野',35.7069,139.6655,['chuo'],85,[8e4,4,75,72],[.7,72,.12],18,33e3],
['ofuna','大船',35.3533,139.5328,['tokaido','shonan'],85,[7e4,4,70,68],[.6,68,.15],26,30e3],
['fujisawa','藤沢',35.3397,139.4889,['tokaido'],80,[8e4,4,72,70],[.7,70,.18],32,32e3],
['odawara','小田原',35.2564,139.1561,['tokaido','odakyu'],75,[8e4,4,72,70],[.6,70,.15],60,30e3],
['atsugi','厚木',35.4431,139.3614,['odakyu'],70,[6e4,3,65,62],[.6,62,.15],50,27e3],
['sagamiono','相模大野',35.5331,139.3989,['odakyu'],80,[6e4,3,70,68],[.7,68,.15],42,29e3],
['shin-yurigaoka','新百合ヶ丘',35.5997,139.5089,['odakyu'],90,[8e4,3,75,72],[.8,75,.18],34,33e3],
['jiyugaoka','自由が丘',35.6079,139.6682,['toyoko'],120,[8e4,3,80,78],[.6,72,.08],16,33e3],
['denenchofu','田園調布',35.6023,139.6741,['toyoko'],130,[5e4,3,82,80],[.5,70,.05],14,31e3],
['totsuka','戸塚',35.4006,139.5339,['tokaido'],80,[6e4,3,68,65],[.6,65,.12],28,28e3],
['kinshicho','錦糸町',35.6969,139.8147,['sobu'],85,[15e4,4,75,72],[.7,70,.12],16,31e3],
['funabashi','船橋',35.6944,139.9822,['sobu'],75,[12e4,4,70,68],[.6,68,.15],28,29e3],
['hamamatsucho','浜松町',35.6556,139.7573,['yamanote','keihin'],110,[8e4,3,72,70],[.6,68,.18],12,35e3],
['shimbashi','新橋',35.6658,139.7576,['yamanote','tokaido'],130,[12e4,5,82,80],[.7,72,.15],10,42e3],
['kanda','神田',35.6919,139.7707,['yamanote','chuo'],100,[7e4,3,75,72],[.5,65,.1],14,33e3],
['yotsuya','四ツ谷',35.6854,139.7298,['chuo'],100,[5e4,3,70,68],[.5,65,.08],14,30e3],
['koenji','高円寺',35.7053,139.6494,['chuo'],80,[6e4,3,70,68],[.6,68,.1],20,31e3],
['asagaya','阿佐ヶ谷',35.7053,139.6353,['chuo'],78,[5e4,2,68,65],[.5,65,.08],22,29e3],
['ogikubo','荻窪',35.7046,139.6202,['chuo'],85,[6e4,3,72,70],[.6,68,.1],24,30e3],
['musashisakai','武蔵境',35.7094,139.5428,['chuo'],78,[5e4,2,68,65],[.5,65,.08],32,28e3]
].forEach(st=>D[st[0]]=st);
const LN={
yamanote:{v:[{r:['tokyo','shinagawa'],v:28},{r:['shinagawa','shibuya'],v:32},{r:['shibuya','shinjuku'],v:30},{r:['shinjuku','ikebukuro'],v:29},{r:['ikebukuro','ueno'],v:27},{r:['ueno','tokyo'],v:28}],sp:1.2,ap:.6,mode:'local',stations:['tokyo','yurakucho','shimbashi','hamamatsucho','tamachi','shinagawa','meguro','ebisu','shibuya','harajuku','yoyogi','shinjuku','shin-okubo','takadanobaba','mejiro','ikebukuro','otsuka','sugamo','komagome','tabata','nippori','uguisudani','ueno','okachimachi','akihabara','kanda']},
chuo:{v:[{r:['tokyo','shinjuku'],v:38},{r:['shinjuku','kichijoji'],v:42},{r:['kichijoji','tachikawa'],v:46},{r:['tachikawa','hachioji'],v:44}],sp:1,ap:.8,mode:'rapid',skipFactor:.65,stations:['tokyo','kanda','yotsuya','shinjuku','nakano','koenji','asagaya','ogikubo','kichijoji','musashisakai','kokubunji','tachikawa','hachioji']},
tokaido:{v:[{r:['tokyo','yokohama'],v:48},{r:['yokohama','odawara'],v:52}],sp:.9,ap:.7,mode:'rapid',skipFactor:.7,stations:['tokyo','shinagawa','kawasaki','yokohama','totsuka','ofuna','fujisawa','hiratsuka','odawara']},
toyoko:{v:[{r:['shibuya','yokohama'],v:36}],sp:1.1,ap:.8,mode:'rapid',skipFactor:.75,stations:['shibuya','nakameguro','jiyugaoka','denenchofu','musashikosugi','yokohama']},
keihin:{v:[{r:['tokyo','yokohama'],v:38},{r:['omiya','tokyo'],v:42}],sp:1,ap:.7,mode:'rapid',skipFactor:.7,stations:['omiya','urawa','kawaguchi','akabane','ueno','tokyo','shinagawa','kawasaki','yokohama']},
shonan:{v:[{r:['shinjuku','yokohama'],v:45}],sp:.9,ap:.7,mode:'rapid',skipFactor:.65,stations:['shinjuku','shibuya','yokohama','ofuna']},
odakyu:{v:[{r:['shinjuku','machida'],v:40},{r:['machida','odawara'],v:44}],sp:1,ap:.8,mode:'rapid',skipFactor:.7,stations:['shinjuku','yoyogi','shin-yurigaoka','machida','sagamiono','atsugi','odawara']},
keio:{v:[{r:['shinjuku','chofu'],v:38},{r:['chofu','tachikawa'],v:42}],sp:1.1,ap:.8,mode:'rapid',skipFactor:.75,stations:['shinjuku','chofu','fuchu','tachikawa']},
saikyo:{v:[{r:['shinjuku','omiya'],v:38}],sp:1,ap:.7,mode:'rapid',skipFactor:.7,stations:['shinjuku','ikebukuro','akabane','urawa','omiya']},
sobu:{v:[{r:['tokyo','kinshicho'],v:34},{r:['kinshicho','funabashi'],v:38}],sp:1.2,ap:.6,mode:'local',stations:['tokyo','kinshicho','funabashi','chiba']}
};
Object.keys(LN).forEach(k=>{LN[k].idx={};LN[k].stations.forEach((s,i)=>LN[k].idx[s]=i)});
const A={'東京都千代田区':[35.6938,139.7536],'東京都中央区':[35.6704,139.7703],'東京都港区':[35.6585,139.7514],'東京都新宿区':[35.694,139.7036],'東京都文京区':[35.707,139.7613],'東京都台東区':[35.7115,139.7967],'東京都墨田区':[35.7101,139.8136],'東京都江東区':[35.6548,139.7966],'東京都品川区':[35.6092,139.7303],'東京都目黒区':[35.6419,139.6983],'東京都大田区':[35.5617,139.7156],'東京都世田谷区':[35.6464,139.6533],'東京都渋谷区':[35.6638,139.6983],'東京都中野区':[35.7069,139.6655],'東京都杉並区':[35.6993,139.6364],'東京都豊島区':[35.7295,139.7155],'東京都北区':[35.7521,139.7384],'東京都荒川区':[35.7362,139.7836],'東京都板橋区':[35.7513,139.7118],'東京都練馬区':[35.7365,139.6533],'東京都足立区':[35.7756,139.8047],'東京都葛飾区':[35.7436,139.8485],'東京都江戸川区':[35.7068,139.8681],'神奈川県横浜市':[35.4657,139.622],'神奈川県川崎市':[35.5308,139.6975],'埼玉県さいたま市':[35.9067,139.6272],'埼玉県川口市':[35.8078,139.7243],'埼玉県川越市':[35.9103,139.485]};
let S={inner:{a:null,g:null,w:null,h:[null,null],l:[null,null,null],c:[]},outer:{s:null,f:.1,ad:null,m:0,mode:'normal',work:null,limit:60},t:{t:0,l:[.01,.015,.02],h:[]},m:[1,1,1,1,1]};
let reverseResults=[];
let currentSort='score';
let mapInstance=null;
let devMode=false;
const P=[[0,1,0,1,.9],[1,.9,20,1.1,1],[-.5,1.05,0,.95,1.1]];
const RF={fin:[.7,.8,.9,.95,1,1.05,1.1],lif:[1.2,1.15,1.1,1.05,1,.95,.9],fut:[.8,.85,.9,.95,1,1.1,1.2]};
const CURVE_FACTOR=1.15;
const MAX_COMMUTE=120;
const TIME_FACTOR=1.1;
const REACH_MARGIN=1.2;
const TERMINAL_CAP={shinjuku:10,shibuya:9,tokyo:8,ikebukuro:8,yokohama:7};
const LP_BY_ORIGIN={shinjuku:['chuo','yamanote','shonan','keio','odakyu','saikyo'],shibuya:['toyoko','yamanote','shonan','odakyu'],tokyo:['tokaido','yamanote','chuo','keihin','sobu'],yokohama:['tokaido','keihin','toyoko','shonan'],ikebukuro:['yamanote','saikyo','chuo'],shinagawa:['tokaido','yamanote','keihin']};
const LP_DEFAULT=['yamanote','tokaido','chuo','keihin','shonan','toyoko','odakyu','keio','saikyo','sobu'];
const U={c:(v,n,x)=>Math.max(n,Math.min(x,v)),n:(v,n,x)=>U.c((v-n)/(x-n)*100,0,100),a:a=>a.length?a.reduce((s,v)=>s+v,0)/a.length:0,d:(t1,n1,t2,n2)=>{const R=6371,p=Math.PI/180,a=(t2-t1)*p,b=(n2-n1)*p,c=Math.sin(a/2)**2+Math.cos(t1*p)*Math.cos(t2*p)*Math.sin(b/2)**2;return R*2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))}};
const na=ad=>ad.replace(/[０-９]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0)).replace(/[Ａ-Ｚａ-ｚ]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0)).replace(/^(東京|神奈川|埼玉|千葉)/,'$1都').replace(/([0-9]+)丁目/,'$1-').replace(/(市|区|町|村)$/,'').replace(/駅.*$/,'').replace(/近く|付近|周辺/,'');
const fl=ad=>{const nm=na(ad);let b=null,l=0;for(const k in A)if(nm.indexOf(k)===0&&k.length>l){b=k;l=k.length}return b?A[b]:null};
const fs=(lt,ln)=>{let si=null,mn=999;for(const k in D){const d=U.d(lt,ln,D[k][2],D[k][3]);if(d<mn){mn=d;si=k}}return{sid:si,dist:mn}};
const cc=(ad,dt,mt)=>{const bs=mt===1?.95:mt===2?.8:.5,df=Math.exp(-dt/2),adl=ad.match(/[0-9]+丁目|[0-9]+-[0-9]+/)?1:.85;return bs*df*adl};
const cr=r=>r>5e5?6:r>3e5?5:r>2e5?4:r>1e5?3:r>5e4?2:r>2e4?1:0;
const z=i=>({inner:{a:i.inner.a,g:i.inner.g,w:i.inner.w,h:[i.inner.h[0],i.inner.h[1]],l:[i.inner.l[0],i.inner.l[1],i.inner.l[2]],c:i.inner.c.map(c=>[c[0],c[1]])},outer:{s:i.outer.s,f:i.outer.f,ad:i.outer.ad,m:i.outer.m,mode:i.outer.mode,work:i.outer.work,limit:i.outer.limit},t:i.t,m:i.m});
const calcSegmentTime=(ln,start,end,sts)=>{let totalTime=0;const lnData=LN[ln];for(let i=start;i<end;i++){const s1=sts[i],s2=sts[i+1];if(!D[s1]||!D[s2])continue;const dist=U.d(D[s1][2],D[s1][3],D[s2][2],D[s2][3])*CURVE_FACTOR;let segmentSpeed=35;if(Array.isArray(lnData.v)){for(const vr of lnData.v){const rStart=Math.min(lnData.idx[vr.r[0]]||0,lnData.idx[vr.r[1]]||0),rEnd=Math.max(lnData.idx[vr.r[0]]||0,lnData.idx[vr.r[1]]||0);if(i>=rStart&&i<rEnd){segmentSpeed=vr.v;break}}}else{segmentSpeed=lnData.v}totalTime+=dist/segmentSpeed*60}return totalTime};
const getTerminalPenalty=sid=>{if(!D[sid])return 0;const rider=D[sid][6][0];if(rider<1e5)return 0;const base=Math.round(Math.log10(rider/1e5)*3),cap=TERMINAL_CAP[sid]||8;return Math.min(base,cap)};
const gt=(f,t)=>{if(f===t)return{time:0,approx:false};if(!D[f]||!D[t])return{time:999,approx:false};const LP=LP_BY_ORIGIN[f]||LP_DEFAULT;for(const ln of LP){if(!LN[ln])continue;const sts=LN[ln].stations,fi=LN[ln].idx[f],ti=LN[ln].idx[t];if(fi===undefined||ti===undefined)continue;const start=Math.min(fi,ti),end=Math.max(fi,ti),stops=end-start,baseTime=calcSegmentTime(ln,start,end,sts),effectiveStops=LN[ln].mode==='rapid'?Math.max(1,stops*LN[ln].skipFactor):stops,stopPenalty=effectiveStops*LN[ln].sp,accelPenalty=effectiveStops>1?(effectiveStops-1)*LN[ln].ap:0,totalTime=baseTime+stopPenalty+accelPenalty+5;return{time:Math.min(Math.round(totalTime*TIME_FACTOR),MAX_COMMUTE),approx:false}}const dist=U.d(D[f][2],D[f][3],D[t][2],D[t][3]),moveTime=dist/30*60*CURVE_FACTOR,basePenalty=8,transferPenalty=7,approxTime=Math.round(moveTime+basePenalty+transferPenalty);return{time:Math.min(approxTime,MAX_COMMUTE),approx:true}};
const E={
p:(s,a,g,w,m)=>{if(!s||!D[s])return 0;const t=D[s],mp=t[5],q=t[6],f=t[7],r=t[8],e=t[9],rk=cr(q[0]),b=(.4*mp+.2*50+.2*U.c(.5*U.n(q[0],0,1e6)+.3*U.n(q[1],1,10)+.2*q[2],0,100)+.2*U.c(.4*f[1]+.3*f[0]*100+.2*U.n(e,0,5e4)-.3*r,0,100))*[.8,.9,1,1.05,1.1,1.2,1.3][rk],c=Math.exp(-.035*g),d=Math.max(.7,1-.015*w),h=m.reduce((x,y)=>x*y,1),l=f[0]*Math.max(.5,1+f[2]);return Math.round(b*a*c*d*h*l)},
f:(i,p)=>{const n=i.inner.h[1],y=i.inner.l[2],r=i.inner.l[1];if(!n||!y||!r||!i.outer.s)return 0;const rk=cr(D[i.outer.s][6][0]),ln=n*8,mr=r/100/12,tm=y*12,mc=(n*1e4*.35)/12,lr=Math.min(ln,(mc*(1-Math.pow(1+mr,-tm))/mr)/1e4),pr=E.p(i.outer.s,i.inner.a,i.inner.g,i.inner.w,S.m);if(pr>lr*1.1)return 0;return U.c((100-(pr/lr)*60-r*5-y/35*10)*RF.fin[rk],0,100)},
l:(i,p)=>{const tx=[.2,.2,.25,.3,.35,.35,.35],lc=[12,18,22,26,30,28,35],ht=i.inner.h[0]||0,n=i.inner.h[1];if(!n||!i.outer.s)return 0;const rk=cr(D[i.outer.s][6][0]),nn=n*(1-tx[Math.min(6,Math.floor(n/400))]),mp=(E.p(i.outer.s,i.inner.a,i.inner.g,i.inner.w,S.m)*i.inner.l[1]/100/12)/(1-Math.pow(1+i.inner.l[1]/100/12,-i.inner.l[2]*12)),md=nn/12-lc[ht]*P[p][3],ll=mp/md;if(ll>.35)return 0;const cs=U.a(i.inner.c.map(c=>{if(!c[0])return 50;const{time:tm}=gt(i.outer.s,c[0]);if(tm>=120)return 0;return tm<=c[1]?100-tm/c[1]*30:Math.max(0,70-(tm-c[1])*2)}));if(cs<30)return 0;return U.c((100-ll*100-(cs<50?20:0))*RF.lif[rk],0,100)},
u:(i,p)=>{if(!i.outer.s)return 50;const t=D[i.outer.s],f=t[7],fg=P[p][4],rk=cr(t[6][0]);return U.c((50+.4*f[1]*fg+.3*f[0]*100+.2*U.n(t[9],0,5e4)-.3*t[8])*RF.fut[rk],0,100)},
e:i=>{if(!i.outer.s||!i.inner.a||!i.inner.g||i.inner.g<0||!i.inner.w||!i.inner.h[0]&&i.inner.h[0]!==0||!i.inner.h[1]||!i.inner.l[0]&&i.inner.l[0]!==0||!i.inner.l[1]||!i.inner.l[2]||i.inner.c.length===0)return null;const M=[[0,0,0],[0,0,0],[0,0,0]];for(let p=0;p<3;p++){const x=z(i);x.inner.l[1]+=P[p][0];x.inner.h[1]*=P[p][1];x.inner.c.forEach(c=>c[1]+=P[p][2]);M[0][p]=E.f(x,p);M[1][p]=E.l(x,p);M[2][p]=E.u(x,p)}const A=M.map(r=>Math.min(...r)),Fr=Math.min(...A),cf=i.outer.f>=.8?1:i.outer.f>=.6?.95:i.outer.f>=.4?.85:.7,F=Math.round(Fr*cf);return{M:M,A:A,F:F,P:E.p(i.outer.s,i.inner.a,i.inner.g,i.inner.w,S.m),C:i.outer.f}},
r:(work,limit)=>{if(!work||!D[work])return[];const results=[];for(const sid in D){if(sid===work)continue;const{time:t,approx}=gt(sid,work);if(t>=999)continue;if(t>limit*REACH_MARGIN)continue;const candidate=D[sid],reachScore=U.c(100-(t/limit)*70,0,100),tp=getTerminalPenalty(sid)+getTerminalPenalty(work),comfortScore=U.c(100-tp*3,0,100);let transfer=0,line=null,lineSource='unknown';const LP=LP_BY_ORIGIN[sid]||LP_DEFAULT;for(const ln of LP){if(!LN[ln])continue;const fi=LN[ln].idx[sid],ti=LN[ln].idx[work];if(fi!==undefined&&ti!==undefined){line=ln;transfer=0;lineSource='direct';break}}if(!line){transfer=1;const candidateLines=candidate[4],workLines=D[work][4];for(const ln of LP){if(candidateLines.includes(ln)&&workLines.includes(ln)){line=ln;lineSource='common';break}}if(!line){for(const ln of LP){if(candidateLines.includes(ln)){line=ln;lineSource='candidate-first';break}}}if(!line&&candidateLines.length>0){line=candidateLines[0];lineSource='fallback'}}const price=candidate[5],futureData=candidate[7],futureScore=U.c(50+.4*futureData[1]+.3*futureData[0]*100+.2*U.n(candidate[9],0,5e4)-.3*candidate[8],0,100),riskScore=candidate[8];results.push({sid:sid,name:candidate[1],lat:candidate[2],lng:candidate[3],time:t,approx:approx,reachScore:Math.round(reachScore),comfortScore:Math.round(comfortScore),transfer:transfer,terminalPenalty:tp>0,line:line||'不明',lineSource:lineSource,price:price,futureScore:Math.round(futureScore),riskScore:riskScore})}return results.sort((a,b)=>{if(Math.abs(b.reachScore-a.reachScore)<5){return(a.approx===b.approx)?0:a.approx?1:-1}return b.reachScore-a.reachScore})}
};
const sortResults=(results,mode)=>{const sorted=[...results];if(mode==='score'){return sorted.sort((a,b)=>{if(Math.abs(b.reachScore-a.reachScore)<5){return(a.approx===b.approx)?0:a.approx?1:-1}return b.reachScore-a.reachScore})}if(mode==='time')return sorted.sort((a,b)=>a.time-b.time);if(mode==='line')return sorted.sort((a,b)=>{if(a.line<b.line)return-1;if(a.line>b.line)return 1;return a.time-b.time});return sorted};
const initMap=()=>{if(mapInstance)return;mapInstance=L.map('map').setView([35.6812,139.7671],11);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(mapInstance);const legend=L.control({position:'bottomright'});legend.onAdd=()=>{const div=L.DomUtil.create('div','map-legend');div.innerHTML='<div class=legend-item><span class="legend-dot direct"></span><span>直通経路</span></div><div class=legend-item><span class="legend-dot approx"></span><span>概算経路</span></div><div class=legend-item><span class="legend-dot work"></span><span>勤務先</span></div><div class=legend-note>※ 地図は評価結果の投影であり、<br>　居住地選択や経路選択を行うものではありません</div>';return div};legend.addTo(mapInstance)};
const renderMap=()=>{if(!mapInstance)initMap();if(!S.outer.work||!D[S.outer.work]||reverseResults.length===0)return;mapInstance.eachLayer(layer=>{if(layer instanceof L.Marker)mapInstance.removeLayer(layer)});const workData=D[S.outer.work];L.circleMarker([workData[2],workData[3]],{radius:8,fillColor:'#FF453A',color:'#fff',weight:2,opacity:1,fillOpacity:.9}).bindPopup(`<strong>${workData[1]}</strong><br>勤務先`).addTo(mapInstance);reverseResults.forEach(r=>{const color=r.approx?'#FF9F0A':'#0A84FF';L.circleMarker([r.lat,r.lng],{radius:6,fillColor:color,color:'#fff',weight:1,opacity:1,fillOpacity:.8}).bindPopup(r.approx?`<strong>${r.name}</strong><br>通勤時間: ${r.time}分（概算）<br><br>※ 直通路線が存在しないため、<br>　距離ベースで推定しています。<br>　実際の時間は異なる可能性があります。`:`<strong>${r.name}</strong><br>通勤時間: ${r.time}分<br>経路: ${r.line}`).addTo(mapInstance)});const bounds=[[workData[2],workData[3]],...reverseResults.map(r=>[r.lat,r.lng])];mapInstance.fitBounds(bounds,{padding:[50,50]})};
const R={
s:()=>{const g=id=>document.getElementById(id);if(S.outer.mode==='normal'){S.inner.a=+(g('i-a')?.value||0);S.inner.g=+(g('i-g')?.value||0);S.inner.w=+(g('i-w')?.value||0);const ht=g('i-ht')?.value;S.inner.h[0]=ht==='s'?0:ht==='c'?1:ht==='c1'?2:ht==='c2'?3:ht==='c3'?4:ht==='cp'?5:ht==='t'?6:null;S.inner.h[1]=+(g('i-hi')?.value||0);const lt=g('i-lt')?.value;S.inner.l[0]=lt==='s'?0:lt==='p'?1:null;S.inner.l[1]=+(g('i-lr')?.value||0);S.inner.l[2]=+(g('i-ly')?.value||0);S.inner.c=[];document.querySelectorAll('.cc').forEach(el=>{const si=el.querySelector('.c-s')?.value;const mm=+(el.querySelector('.c-m')?.value||0);if(si&&mm>0)S.inner.c.push([si,mm])})}else{S.outer.work=g('r-work')?.value||null;S.outer.limit=+(g('r-limit')?.value||60)}},
rn:()=>{const result=E.e(S);const o=document.getElementById('o');if(!S.outer.s){o.innerHTML='<div class=empty-state><div class=empty-icon><svg width=64 height=64 viewBox="0 0 64 64"aria-hidden=true><circle cx=32 cy=32 r=30 stroke="rgba(235,235,245,0.2)"stroke-width=2 fill=none/><path d="M32 20 L32 44 M20 32 L44 32"stroke="rgba(235,235,245,0.3)"stroke-width=2 stroke-linecap=round/></svg></div><div class=empty-title>駅が選択されていません</div><div class=empty-desc>住所を入力するか、駅を手動選択してください</div></div>';return}if(!S.inner.a||!S.inner.g||!S.inner.w||S.inner.h[0]===null||!S.inner.h[1]||S.inner.l[0]===null||!S.inner.l[1]||!S.inner.l[2]||S.inner.c.length===0){o.innerHTML='<div class=empty-state><div class=empty-title>入力が不完全です</div><div class=empty-desc>以下をすべて入力してください：<br>物件情報・世帯構成・年収・ローン・通勤先</div></div>';return}if(!result){o.innerHTML='<div class=empty-state><div class=empty-title>評価できません</div><div class=empty-desc>入力内容を確認してください</div></div>';return}const cf=result.C>=.8?'':result.C>=.6?' (推定)':' (低確度)';o.innerHTML=`<div class=c><div class=sc>${result.F}</div><div style="text-align:center;font-size:15px;color:rgba(235,235,245,.6)">総合スコア${cf}</div></div><div class=h>詳細</div><div class=c><div class=r><span class=l>金融</span><span class=v>${result.A[0]}</span></div><div class=r><span class=l>生活</span><span class=v>${result.A[1]}</span></div><div class=r><span class=l>将来</span><span class=v>${result.A[2]}</span></div></div><div class=h>物件</div><div class=c><div class=r><span class=l>推定価格${cf}</span><span class=v>${result.P}万円</span></div></div><div class=ds>本評価は参考情報であり、購入判断の保証・推奨を行うものではありません。実際の価格・条件は不動産事業者にご確認ください。</div>`},
rr:()=>{const o=document.getElementById('o');if(!S.outer.work){o.innerHTML='<div class=empty-state><div class=empty-icon><svg width=64 height=64 viewBox="0 0 64 64"aria-hidden=true><circle cx=32 cy=32 r=30 stroke="rgba(235,235,245,0.2)"stroke-width=2 fill=none/><path d="M32 20 L32 44 M20 32 L44 32"stroke="rgba(235,235,245,0.3)"stroke-width=2 stroke-linecap=round/></svg></div><div class=empty-title>勤務先駅を選択</div><div class=empty-desc>勤務先駅と許容時間を入力すると<br>到達可能な駅候補を表示します</div></div>';return}if(reverseResults.length===0){o.innerHTML='<div class=empty-state><div class=empty-title>条件内で到達可能な駅はありません</div><div class=empty-desc>許容時間を長くしてお試しください</div></div>';return}const sorted=sortResults(reverseResults,currentSort);o.innerHTML='<button class="b b-secondary"onclick="const m=document.getElementById(\'map\');m.classList.toggle(\'visible\');if(m.classList.contains(\'visible\'))renderMap()">地図表示</button><div id=map></div><div class=sort-control><button class="sort-btn'+(currentSort==='score'?' active':'')+'"data-sort=score>スコア順</button><button class="sort-btn'+(currentSort==='time'?' active':'')+'"data-sort=time>時間順</button><button class="sort-btn'+(currentSort==='line'?' active':'')+'"data-sort=line>路線別</button></div>'+sorted.map(r=>`<div class=station-card><div class=card-header><span class=station-name>${r.name}</span><span class=reach-score>${r.reachScore}</span></div><div class=card-primary>${D[S.outer.work][1]}まで ${r.time}分</div><div class=card-badges>${r.transfer?'<span class=badge>乗換'+r.transfer+'回</span>':''}${r.approx?'<span class="badge badge-approx">概算</span>':''}<span class="badge badge-line">${r.line}</span>${devMode?'<span class="badge badge-dev">'+r.lineSource+'</span>':''}</div><div class=card-secondary><div class=sec-item><span class=sec-label>快適性</span><span class=sec-value>${r.comfortScore}</span></div><div class=sec-item><span class=sec-label>将来性</span><span class=sec-value>${r.futureScore}</span></div></div></div>`).join('');document.querySelectorAll('.sort-btn').forEach(btn=>{btn.onclick=()=>{currentSort=btn.dataset.sort;document.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');R.rr()}})},
i:()=>{const opts=Object.keys(D).map(k=>`<option value="${k}">${D[k][1]}</option>`).join('');document.getElementById('a').innerHTML=`<div class=segment data-active=normal><button class="seg-item active"data-mode=normal>通常</button><button class=seg-item data-mode=reverse>逆引き</button></div><div class="mode-section visible"data-mode=normal><div class=h>物件</div><div class=c><div class=r><span class=l>住所</span><input type=text id=i-ad placeholder="東京都渋谷区"></div><div class=r><span class=l>推定駅</span><span class=v id=ns>−</span></div><div class=r><span class=l>駅手動選択</span><select id=i-s><option value="">自動推定</option>${opts}</select></div><div class=r><span class=l>専有面積</span><input type=number id=i-a placeholder=70><span style="margin-left:4px;color:rgba(235,235,245,.6)">㎡</span></div><div class=r><span class=l>築年数</span><input type=number id=i-g placeholder=10><span style="margin-left:4px;color:rgba(235,235,245,.6)">年</span></div><div class=r><span class=l>駅徒歩</span><input type=number id=i-w placeholder=8><span style="margin-left:4px;color:rgba(235,235,245,.6)">分</span></div></div><div class=h>世帯</div><div class=c><div class=r><span class=l>構成</span><select id=i-ht><option value="">選択</option><option value=s>単身</option><option value=c>夫婦</option><option value=c1>夫婦+子1</option><option value=c2>夫婦+子2</option><option value=c3>夫婦+子3</option><option value=cp>夫婦+親</option><option value=t>三世代</option></select></div><div class=r><span class=l>年収</span><input type=number id=i-hi placeholder=600><span style="margin-left:4px;color:rgba(235,235,245,.6)">万円</span></div></div><div class=h>ローン</div><div class=c><div class=r><span class=l>形態</span><select id=i-lt><option value="">選択</option><option value=s>単独</option><option value=p>ペア</option></select></div><div class=r><span class=l>金利</span><input type=number id=i-lr step=.1 placeholder=1.5><span style="margin-left:4px;color:rgba(235,235,245,.6)">%</span></div><div class=r><span class=l>期間</span><select id=i-ly><option value="">選択</option><option value=20>20年</option><option value=25>25年</option><option value=30>30年</option><option value=35>35年</option></select></div></div><div class=h>通勤</div><div id=cl></div><button class=b onclick="const d=document.createElement('div');d.className='cc c';d.innerHTML='<div class=r><span class=l>勤務先駅</span><select class=c-s><option value=\"\">選択</option>${opts}</select></div><div class=r><span class=l>許容時間</span><input type=number class=c-m placeholder=60><span style=\"margin-left:4px;color:rgba(235,235,245,.6)\">分</span></div>';document.getElementById('cl').appendChild(d)">通勤先追加</button><button class=b onclick="R.s();R.rn()">評価する</button></div><div class="mode-section hidden"data-mode=reverse><div class=h>逆引き評価</div><div class=c><div class=r><span class=l>勤務先駅</span><select id=r-work><option value="">選択</option>${opts}</select></div><div class=slider-container><label class=slider-label>許容通勤時間</label><div class=slider-value id=sv>60分</div><input type=range class=slider id=r-limit min=30 max=120 value=60 step=5><div class=slider-marks><span>30</span><span>60</span><span>90</span><span>120</span></div></div></div><button class=b onclick="R.s();reverseResults=E.r(S.outer.work,S.outer.limit);R.rr()">駅を検索</button></div><div id=o></div>`;
document.querySelectorAll('.seg-item').forEach(btn=>{btn.onclick=()=>{S.outer.mode=btn.dataset.mode;if(S.outer.mode==='normal'){reverseResults=[];if(mapInstance){mapInstance.eachLayer(layer=>{if(layer instanceof L.Marker)mapInstance.removeLayer(layer)})}}document.querySelector('.segment').dataset.active=S.outer.mode;document.querySelectorAll('.seg-item').forEach(b=>b.classList.toggle('active',b.dataset.mode===S.outer.mode));document.querySelectorAll('.mode-section').forEach(sec=>{const isVisible=sec.dataset.mode===S.outer.mode;sec.classList.toggle('hidden',!isVisible);sec.classList.toggle('visible',isVisible)})}});
const updateStationDisplay=()=>{const ns=document.getElementById('ns');if(S.outer.s&&D[S.outer.s]){const cf=S.outer.f>=.8?'conf-high':S.outer.f>=.6?'conf-mid':'conf-low';const txt=S.outer.f>=.8?'':S.outer.f>=.6?' (推定)':' (低確度)';ns.innerHTML=`<span class="${cf}">${D[S.outer.s][1]}${txt}</span>`}else{ns.textContent='−'}};
document.getElementById('i-ad').oninput=e=>{const ad=e.target.value,lc=fl(ad);if(lc){const rs=fs(lc[0],lc[1]);S.outer.s=rs.sid;S.outer.m=2;S.outer.ad=ad;S.outer.f=cc(ad,rs.dist,2);updateStationDisplay()}else{S.outer.s=null;S.outer.f=.1;updateStationDisplay()}};
document.getElementById('i-s').onchange=e=>{const v=e.target.value;if(v){S.outer.s=v;S.outer.m=1;S.outer.f=.95;updateStationDisplay()}};
document.getElementById('r-limit').oninput=e=>{const val=e.target.value;document.getElementById('sv').textContent=val+'分';S.outer.limit=+val;if(S.outer.work){reverseResults=E.r(S.outer.work,S.outer.limit);R.rr()}}}
};
document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.shiftKey&&e.key==='D'){devMode=!devMode;if(S.outer.mode==='reverse'&&reverseResults.length>0){R.rr()}}});
R.i();
</script></body></html>
