<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>住宅購入世界線評価</title>

<style>
:root{
  --bg: rgba(10,10,12,1);
  --glass: rgba(28,28,30,.72);
  --sep: rgba(60,60,67,.36);
  --txt: #fff;
  --sub: rgba(235,235,245,.6);
  --ac: #0A84FF;
  --r: 14px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--txt);
}
#app{max-width:430px;margin:auto;min-height:100vh;}
.nav{
  position:sticky;top:0;z-index:10;
  backdrop-filter: blur(24px) saturate(180%);
  background:var(--glass);
  border-bottom:.5px solid var(--sep);
  padding:12px 16px;
}
.nav h1{font-size:32px;font-weight:700;}
.seg{display:flex;margin-top:8px;background:rgba(118,118,128,.24);border-radius:10px;padding:2px;}
.seg button{
  flex:1;border:none;background:none;color:var(--txt);
  padding:8px;border-radius:8px;font-weight:600;
}
.seg button.active{background:rgba(255,255,255,.2);}
.main{padding:16px;}
.card{
  background:var(--glass);
  backdrop-filter: blur(20px);
  border-radius:var(--r);
  margin-bottom:16px;
  overflow:hidden;
}
.row{
  display:flex;align-items:center;
  padding:12px 16px;
  border-bottom:.5px solid var(--sep);
}
.row:last-child{border-bottom:none;}
.lbl{flex:1;}
.val{color:var(--sub);}
input,select{
  background:none;border:none;color:var(--txt);
  text-align:right;font-size:17px;outline:none;
}
button.primary{
  width:100%;padding:16px;border:none;
  border-radius:var(--r);
  background:var(--ac);
  color:#fff;font-weight:600;
}
.hidden{display:none;}
<script>
/* ========= グローバルState ========= */
const S={
  mode:'M1',
  i:{
    M1:{
      address:'',
      station:null,
      area: null,
      a:null,g:null,w:null,
      h:{t:null,ic:null},
      l:{t:null,r:null,y:null},
      c:[]
    }
  }
};

/* ========= 駅マスタ（拡張版） ========= */
const STATIONS=[
 {id:'hamamatsucho',n:'浜松町',lat:35.6555,lon:139.7571,rank:'A++',lines:3,
  area:['芝大門','浜松町','大門','芝']},
 {id:'tamachi',n:'田町',lat:35.6457,lon:139.7476,rank:'A',lines:2,
  area:['芝浦','港南']},
 {id:'shinagawa',n:'品川',lat:35.6285,lon:139.7387,rank:'A+++',lines:5,
  area:['港南','高輪']},
 {id:'shibuya',n:'渋谷',lat:35.6580,lon:139.7016,rank:'A+++',lines:5,
  area:['渋谷','宇田川','道玄坂']},
 {id:'shinjuku',n:'新宿',lat:35.6896,lon:139.7006,rank:'A+++',lines:6,
  area:['西新宿','歌舞伎町','新宿']}
];

/* ========= ユーティリティ ========= */
const U={
  dist:(a,b,c,d)=>{
    const R=6371;
    const x=(c-a)*Math.PI/180;
    const y=(d-b)*Math.PI/180;
    return R*Math.sqrt(x*x+y*y);
  },

  /* ==== 重み付き最寄駅判定 ==== */
  resolveStation:(address)=>{
    if(!address) return null;
    let scored=STATIONS.map(s=>{
      let score=U.dist(35.68,139.75,s.lat,s.lon);
      s.area.forEach(w=>{
        if(address.includes(w)) score-=0.6;
      });
      if(s.lines>=3) score-=0.2;
      if(s.rank==='A+++') score-=0.15;
      return {...s,score};
    });
    scored.sort((a,b)=>a.score-b.score);
    return scored.slice(0,3);
  }
};

/* ========= UI ========= */
const UI={
  render(){
    const m=document.getElementById('main');
    m.innerHTML=`
      <div class="card">
        <div class="row">
          <span class="lbl">住所</span>
          <input id="adr" placeholder="東京都港区芝大門1-1-30">
        </div>
        <div class="row">
          <span class="lbl">最寄駅</span>
          <span class="val" id="st">未確定</span>
        </div>
      </div>

      <div class="card">
        <div class="row"><span class="lbl">面積</span><input id="a" type="number"><span class="val">㎡</span></div>
        <div class="row"><span class="lbl">築年</span><input id="g" type="number"><span class="val">年</span></div>
        <div class="row"><span class="lbl">駅徒歩</span><input id="w" type="number"><span class="val">分</span></div>
      </div>

      <button class="primary" onclick="UI.eval()">評価する</button>
      <div id="err" class="card hidden"></div>
    `;
    UI.bind();
  },

  bind(){
    document.getElementById('adr').addEventListener('input',e=>{
      S.i.M1.address=e.target.value;
      const cand=U.resolveStation(e.target.value);
      if(!cand){S.i.M1.station=null;return;}
      S.i.M1.station=cand[0];
      document.getElementById('st').textContent=
        cand[0].n+'（推定）';
    });
    ['a','g','w'].forEach(k=>{
      document.getElementById(k).addEventListener('input',e=>{
        S.i.M1[k]=Number(e.target.value)||null;
      });
    });
  },

  eval(){
    const i=S.i.M1;
    const err=[];
    if(!i.station) err.push('住所から駅が確定できません');
    if(!i.a) err.push('面積');
    if(i.g===null) err.push('築年');
    if(!i.w) err.push('駅徒歩');
    if(err.length){
      const e=document.getElementById('err');
      e.classList.remove('hidden');
      e.innerHTML='<div class="row">'+err.join(' / ')+'</div>';
      return;
    }
    alert('評価ロジックへ進行');
  }
};

window.onload=()=>UI.render();
</script>
<script>
/* ======================================================
   通勤・価格・スコア計算エンジン
   ====================================================== */

/* ========= 路線マスタ（簡略・表定速度実データ寄り） ========= */
const LINES={
  YAMANOTE:{v:32,transfer:5},
  KEIHIN:{v:45,transfer:6},
  METRO:{v:28,transfer:4}
};

/* ========= 通勤時間計算 ========= */
const Commute={
  time(from,to){
    if(!from||!to) return null;
    const d=U.dist(from.lat,from.lon,to.lat,to.lon);
    let speed=LINES.YAMANOTE.v;
    let t=(d/speed)*60;
    return {
      time:Math.round(t),
      transfer: d>6?1:0
    };
  }
};

/* ========= 価格算定 ========= */
const Price={
  calc(st,a,g,w){
    if(!st) return null;
    const base={
      'A+++':130,'A++':110,'A+':95,'A':80,'B':65
    }[st.rank]||70;
    let p=base*a;
    p*=Math.max(.65,1-(g*0.012));
    p*=Math.max(.7,1-(w*0.03));
    return Math.round(p);
  }
};

/* ========= ローン ========= */
const Loan={
  max(ic,y,r){
    const mr=0.35;
    const m=ic*mr/12;
    const i=r/100/12;
    const n=y*12;
    return Math.floor(m*(1-Math.pow(1+i,-n))/i);
  }
};

/* ========= スコア ========= */
const Score={
  commute(ct,max){
    if(!ct) return 0;
    if(ct<=max) return 100;
    return Math.max(0,100-(ct-max)*3);
  },
  price(p,ic){
    const lim=Loan.max(ic,35,1.2);
    if(p<=lim*0.7) return 100;
    if(p<=lim) return 80;
    return Math.max(0,80-(p-lim)/lim*100);
  },
  future(st){
    return {
      'A+++':95,'A++':88,'A+':80,'A':70,'B':55
    }[st.rank]||60;
  },
  total(sc){
    return Math.round(
      sc.c*0.35+
      sc.p*0.35+
      sc.f*0.3
    );
  }
};

/* ========= 世界線 ========= */
const WorldLine={
  deltas:[
    {n:'収入+10%',fn:i=>({...i,h:{...i.h,ic:i.h.ic*1.1}})},
    {n:'金利+0.5%',fn:i=>({...i,l:{...i.l,r:i.l.r+0.5}})},
    {n:'築年+5年',fn:i=>({...i,g:i.g+5})},
    {n:'通勤+10分',fn:i=>i}
  ],
  eval(base){
    const res=[];
    this.deltas.forEach(d=>{
      const i=d.fn(JSON.parse(JSON.stringify(base.i)));
      const p=Price.calc(i.station,i.a,i.g,i.w);
      const sc={
        c:Score.commute(base.ct.time,60),
        p:Score.price(p,i.h.ic),
        f:Score.future(i.station)
      };
      const t=Score.total(sc);
      const dt=t-base.total;
      res.push({
        name:d.n,
        delta:dt,
        state:dt<-15?'破綻':dt<0?'不安定':'安定'
      });
    });
    return res;
  }
};

/* ========= UI評価拡張 ========= */
UI.eval=function(){
  const i=S.i.M1;
  const err=[];
  if(!i.station) err.push('住所→駅が未確定');
  if(!i.a) err.push('面積');
  if(i.g===null) err.push('築年');
  if(!i.w) err.push('徒歩');
  if(!i.h.ic) err.push('年収');
  if(err.length){
    const e=document.getElementById('err');
    e.classList.remove('hidden');
    e.innerHTML='<div class="row">'+err.join(' / ')+'</div>';
    return;
  }

  const ct=Commute.time(i.station,{lat:35.6895,lon:139.6917});
  const price=Price.calc(i.station,i.a,i.g,i.w);

  const sc={
    c:Score.commute(ct.time,60),
    p:Score.price(price,i.h.ic),
    f:Score.future(i.station)
  };
  const total=Score.total(sc);

  const wl=WorldLine.eval({i,ct,price,total});

  UI.result({i,ct,price,sc,total,wl});
};

/* ========= 結果表示 ========= */
UI.result=function(r){
  const m=document.getElementById('main');
  m.innerHTML+=`
    <div class="card">
      <div class="row"><span class="lbl">総合</span><span class="val">${r.total}</span></div>
      <div class="row"><span class="lbl">価格</span><span class="val">${r.price} 万円</span></div>
      <div class="row"><span class="lbl">通勤</span><span class="val">${r.ct.time} 分</span></div>
    </div>
    <div class="card">
      ${r.wl.map(w=>`
        <div class="row">
          <span class="lbl">${w.name}</span>
          <span class="val">${w.state} (${w.delta})</span>
        </div>`).join('')}
    </div>
  `;
};
</script>
</body>
</html>
