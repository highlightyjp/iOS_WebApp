<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>NEXA â€” ä½å±…ç”¨ä¸å‹•ç”£ åˆ¤å®šãƒ„ãƒ¼ãƒ«</title>
<style>
:root{
  --bg:#050A14; --fg:#E6F1FF; --sub:#8FA3BF; --accent:#00F0FF;
  --glass:rgba(18,28,54,.56); --border:rgba(255,255,255,.06);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;font-size:15px}
body{ -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100%; }
header#site-header{
  position:fixed;inset:0 0 auto 0;top:0;left:0;right:0;
  padding:calc(env(safe-area-inset-top)+10px) 14px 10px;
  background:var(--glass);backdrop-filter:blur(26px) saturate(140%);
  border-bottom:1px solid var(--border);z-index:99999;
  display:flex;align-items:center;justify-content:space-between;
  -webkit-tap-highlight-color:transparent;
}
.header-left{display:flex;align-items:center;gap:12px}
#app-logo{font-weight:800;letter-spacing:.06em;font-size:18px}
.header-right{display:flex;align-items:center;gap:8px}
.icon-button{
  width:48px;height:44px;border-radius:10px;border:none;
  background:transparent;color:var(--fg);font-size:18px;
  display:inline-flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:rgba(255,255,255,0.06);
}
main{
  position:relative;
  padding: calc(env(safe-area-inset-top)+84px) 16px calc(env(safe-area-inset-bottom)+110px);
  min-height:100dvh; overflow-y:auto; -webkit-overflow-scrolling:touch;
  z-index:1;
}

/* card */
.card{
  background:var(--glass);border:1px solid var(--border);
  border-radius:var(--radius);padding:14px;margin-bottom:16px;
}
.card h3{margin:0 0 10px;font-size:17px}

/* label + input */
.field-label{display:block;color:var(--sub);font-size:12px;margin-top:10px}
.input,select,textarea{
  width:100%;padding:12px;border-radius:12px;border:none;margin-top:6px;
  background:rgba(255,255,255,.03);color:var(--fg);font-size:15px;
  outline:none;
}
.input[type=number]{-moz-appearance:textfield}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}

/* primary button */
.btn-primary{
  width:100%;padding:14px;border-radius:28px;border:none;background:var(--accent);
  color:#000;font-weight:800;font-size:17px;margin-top:18px;cursor:pointer;
  box-shadow:0 6px 18px rgba(0,240,255,.08);
}
.btn-ghost{background:transparent;border:1px solid var(--border);padding:10px;border-radius:12px}

/* footer */
footer#site-footer{
  position:fixed;left:0;right:0;bottom:0;padding:10px 12px calc(env(safe-area-inset-bottom)+10px);
  text-align:center;font-size:12px;color:var(--sub);background:linear-gradient(rgba(0,0,0,0),rgba(0,0,0,.02));
  z-index:2;
}

/* result sections */
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.small{font-size:13px;color:var(--sub)}

/* settings */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center}
.warning{color:#FFD36A;font-size:12px;margin-top:6px}

/* responsive */
@media (min-width:760px){
  main{max-width:760px;margin:0 auto;padding-left:24px;padding-right:24px}
}
</style>
</head>
<body>
<header id="site-header" role="banner">
  <div class="header-left">
    <div id="app-logo">NEXA</div>
    <div class="small" style="opacity:.9">ä½å±…ç”¨ä¸å‹•ç”£ãƒ»åˆ¤å®šãƒ­ã‚°ç”Ÿæˆ</div>
  </div>
  <div class="header-right">
    <button id="btn-history" class="icon-button" title="å±¥æ­´">ğŸ•˜</button>
    <button id="btn-settings" class="icon-button" title="è¨­å®š" aria-label="è¨­å®š">â‹¯</button>
  </div>
</header>

<main id="main">
  <!-- INPUT -->
  <section class="card" id="card-input">
    <h3>å…¥åŠ›</h3>

    <label class="field-label">ç‰©ä»¶ä¾¡æ ¼ï¼ˆä¸‡å††ï¼‰</label>
    <input id="f_price" class="input" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š3480">

    <label class="field-label">å°‚æœ‰é¢ç©ï¼ˆã¡ï¼‰</label>
    <input id="f_area" class="input" type="number" placeholder="ä¾‹ï¼š58">

    <label class="field-label">ç¯‰å¹´ï¼ˆè¥¿æš¦ï¼‰</label>
    <input id="f_built" class="input" type="number" placeholder="ä¾‹ï¼š1998">

    <label class="field-label">æœˆé¡å›ºå®šè²»ï¼ˆç®¡ç†è²»ãƒ»ä¿®ç¹•ç­‰ã®åˆè¨ˆãƒ»å††ï¼‰</label>
    <input id="f_fees" class="input" type="number" placeholder="ä¾‹ï¼š30000">

    <label class="field-label">ãã®ä»–æœˆé¡è²»ç”¨ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆãƒ»å…±è´ç­‰ãƒ»å††ï¼‰</label>
    <input id="f_other" class="input" type="number" placeholder="0">
  </section>

  <section class="card" id="card-household">
    <h3>ä¸–å¸¯ãƒ»ãƒ­ãƒ¼ãƒ³</h3>

    <label class="field-label">ä¸–å¸¯å¹´åï¼ˆä¸‡å††ï¼‰</label>
    <input id="f_income" class="input" type="number" placeholder="ä¾‹ï¼š850">

    <label class="field-label">è³¼å…¥æ™‚å¹´é½¢ï¼ˆä»£è¡¨è€…ï¼‰ ã¾ãŸã¯ ç”Ÿå¹´æœˆæ—¥ï¼ˆYYYY-MM-DDï¼‰</label>
    <input id="f_age" class="input" type="text" placeholder="ä¾‹ï¼š35 ã¾ãŸã¯ 1992-04-20">

    <label class="field-label">ãƒ­ãƒ¼ãƒ³å½¢æ…‹</label>
    <select id="f_loanType" class="input">
      <option value="solo">å˜ç‹¬ãƒ­ãƒ¼ãƒ³</option>
      <option value="pair">ãƒšã‚¢ãƒ­ãƒ¼ãƒ³</option>
      <option value="combined">åå…¥åˆç®—</option>
    </select>

    <div style="display:flex;gap:10px;margin-top:8px">
      <select id="f_loanYears" class="input" style="flex:1">
        <option>25</option><option>30</option><option>35</option><option>40</option>
      </select>
      <input id="f_down" class="input" type="number" placeholder="é ­é‡‘ï¼ˆä¸‡å††ï¼‰" style="width:130px">
    </div>
  </section>

  <section class="card" id="card-location">
    <h3>ç«‹åœ°ãƒ»é€šå‹¤ï¼ˆä»»æ„ï¼‰</h3>
    <label class="field-label">ç‰©ä»¶ä½æ‰€ï¼ˆéƒµä¾¿ç•ªå· or ä½æ‰€ï¼‰</label>
    <input id="f_address" class="input" type="text" placeholder="ä¾‹ï¼š123-4567 / æ±äº¬éƒ½...">

    <label class="field-label">æœ€å¯„ã‚Šé§…ï¼ˆè¤‡æ•°å¯ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
    <input id="f_stations" class="input" type="text" placeholder="ä¾‹ï¼šâ—‹â—‹é§…, â–³â–³é§…">

    <label class="field-label">é€šå‹¤å…ˆï¼ˆè¤‡æ•°å¯ï¼‰</label>
    <input id="f_commutes" class="input" type="text" placeholder="ä¾‹ï¼šè·å ´1, è·å ´2">
  </section>

  <button id="btn-evaluate" class="btn-primary">è©•ä¾¡ã™ã‚‹</button>

  <!-- RESULT -->
  <section class="card" id="card-result" style="display:none">
    <h3>è©•ä¾¡çµæœ</h3>
    <div id="result-summary" style="font-weight:700;margin-bottom:8px"></div>
    <div class="result-grid" style="margin-bottom:12px">
      <div>
        <div class="small">æ¨å®šãƒ©ãƒ³ã‚¯</div>
        <div id="result-rank" style="font-size:22px;font-weight:800">â€”</div>
      </div>
      <div>
        <div class="small">å†…éƒ¨è©¦è¡Œæ•°</div>
        <div id="result-trials" style="font-size:16px">â€”</div>
      </div>
    </div>

    <div class="small">æƒ³å®šã•ã‚Œã‚‹ä¸–ç•Œç·š</div>
    <ul id="result-worldlines" style="margin:8px 0 12px;color:var(--fg)"></ul>

    <div class="small">æ„Ÿåº¦ï¼ˆå½±éŸ¿ãŒå¤§ãã„è¦å› ï¼‰</div>
    <ul id="result-factors" style="margin:8px 0 6px;color:var(--fg)"></ul>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-pdf" class="btn-ghost">PDFå‡ºåŠ›</button>
      <button id="btn-saveSnapshot" class="btn-ghost">ã“ã®è©•ä¾¡ã‚’ä¿å­˜</button>
      <button id="btn-compare" class="btn-ghost">éå»ã¨æ¯”è¼ƒ</button>
    </div>
  </section>

  <!-- HISTORY PANEL (è»½é‡) -->
  <section class="card" id="card-history" style="display:none">
    <h3>è©•ä¾¡å±¥æ­´</h3>
    <div id="history-list" class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btn-exportHistory" class="btn-ghost">å±¥æ­´ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (JSON)</button>
      <button id="btn-clearHistory" class="btn-ghost">å±¥æ­´ã‚’å…¨æ¶ˆå»</button>
    </div>
  </section>
</main>

<!-- SETTINGS PANEL -->
<div id="dialog-settings" style="display:none;position:fixed;inset:80px 16px 110px;background:transparent;z-index:99990">
  <div style="height:100%;display:flex;align-items:flex-start;justify-content:center">
    <div style="width:100%;max-width:720px">
      <div class="card">
        <h3>è¨­å®š / ãƒã‚¹ã‚¿ç·¨é›†</h3>

        <div class="settings-grid">
          <label class="small">åˆ¤æ–­çµŒç·¯ã‚’è¡¨ç¤º</label>
          <input type="checkbox" id="s_showProcess">

          <label class="small">è©¦è¡Œæ•°ã‚’æ˜ç¤º</label>
          <input type="checkbox" id="s_showTrials">
        </div>

        <hr style="border:none;height:12px">

        <label class="field-label">ç®¡ç†è²»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆå††/ã¡ï¼‰</label>
        <div style="display:flex;gap:8px">
          <input id="m_mg_min" class="input" type="number" placeholder="ä¸‹é™">
          <input id="m_mg_max" class="input" type="number" placeholder="ä¸Šé™">
        </div>
        <div id="m_mg_warn" class="warning"></div>

        <label class="field-label">ä¿®ç¹•ç©ç«‹é‡‘ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ï¼ˆå††/ã¡ï¼‰</label>
        <div style="display:flex;gap:8px">
          <input id="m_rp_min" class="input" type="number" placeholder="ä¸‹é™">
          <input id="m_rp_max" class="input" type="number" placeholder="ä¸Šé™">
        </div>
        <div id="m_rp_warn" class="warning"></div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btn-masterExport" class="btn-ghost">ãƒã‚¹ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <input id="masterImportFile" type="file" accept="application/json" style="display:none">
          <button id="btn-masterImport" class="btn-ghost">ãƒã‚¹ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btn-closeSettings" class="btn-primary">é–‰ã˜ã‚‹</button>
        </div>

      </div>
    </div>
  </div>
</div>

<footer id="site-footer">Â© Yoshinobu Takamitsu ï½œ æœ¬ã‚¢ãƒ—ãƒªã¯åˆ¤æ–­ææ–™ã®æ•´ç†ã‚’ç›®çš„ã¨ã—ã€çµæœã‚’ä¿è¨¼ã—ã¾ã›ã‚“</footer>

<script>
/* ========================
   Utilities
   ======================== */
const $ = id => document.getElementById(id);
const store = {};

/* safe parse */
function jparse(s, d=null){try{return JSON.parse(s)}catch(e){return d}}

/* ----- LocalStorage keys ----- */
const LS_FORM = 'nexa_form_v1';
const LS_SETTINGS = 'nexa_settings_v1';
const LS_MASTER = 'nexa_master_v1';

/* ========================
   Restore form from localStorage
   ======================== */
function saveFormAutosave(){
  const f = {
    price: $('f_price').value,
    area: $('f_area').value,
    built: $('f_built').value,
    fees: $('f_fees').value,
    other: $('f_other').value,
    income: $('f_income').value,
    age: $('f_age').value,
    loanType: $('f_loanType').value,
    loanYears: $('f_loanYears').value,
    down: $('f_down').value,
    address: $('f_address').value,
    stations: $('f_stations').value,
    commutes: $('f_commutes').value
  };
  localStorage.setItem(LS_FORM, JSON.stringify(f));
}

function restoreForm(){
  const f = jparse(localStorage.getItem(LS_FORM), {});
  if(!f) return;
  $('f_price').value = f.price || '';
  $('f_area').value = f.area || '';
  $('f_built').value = f.built || '';
  $('f_fees').value = f.fees || '';
  $('f_other').value = f.other || '';
  $('f_income').value = f.income || '';
  $('f_age').value = f.age || '';
  $('f_loanType').value = f.loanType || 'solo';
  $('f_loanYears').value = f.loanYears || '25';
  $('f_down').value = f.down || '';
  $('f_address').value = f.address || '';
  $('f_stations').value = f.stations || '';
  $('f_commutes').value = f.commutes || '';
}

/* attach autosave on inputs */
function attachAutosave(){
  const els = document.querySelectorAll('#card-input input,#card-input select,#card-location input,#card-household input,#card-household select');
  els.forEach(el=>{
    el.addEventListener('input', saveFormAutosave, {passive:true});
  });
}

/* ========================
   Settings / Master
   ======================== */
const DEFAULT_SETTINGS = { showProcess:true, showTrials:true };
const DEFAULT_MASTER = { mg:{min:150,max:300}, rp:{min:200,max:400}, warnings:{excessiveFeeRatio:0.4} };

function loadSettings(){
  return jparse(localStorage.getItem(LS_SETTINGS), DEFAULT_SETTINGS);
}
function saveSettings(s){
  localStorage.setItem(LS_SETTINGS, JSON.stringify(s));
}
function loadMaster(){ return jparse(localStorage.getItem(LS_MASTER), DEFAULT_MASTER); }
function saveMaster(m){ localStorage.setItem(LS_MASTER, JSON.stringify(m)); }

/* populate settings UI */
function initSettingsUI(){
  const s = loadSettings();
  $('s_showProcess').checked = !!s.showProcess;
  $('s_showTrials').checked = !!s.showTrials;

  const m = loadMaster();
  $('m_mg_min').value = m.mg.min; $('m_mg_max').value = m.mg.max;
  $('m_rp_min').value = m.rp.min; $('m_rp_max').value = m.rp.max;
  validateMasterUI();
}

/* validate master and warn */
function validateMasterUI(){
  const mgMin = Number($('m_mg_min').value || 0);
  const mgMax = Number($('m_mg_max').value || 0);
  $('m_mg_warn').textContent = mgMin>mgMax ? 'ç®¡ç†è²»ã®ä¸‹é™ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™' : '';

  const rpMin = Number($('m_rp_min').value || 0);
  const rpMax = Number($('m_rp_max').value || 0);
  $('m_rp_warn').textContent = rpMax>2000 ? 'ä¿®ç¹•ç©ç«‹é‡‘ä¸Šé™ãŒå¤§ãã™ãã¾ã™' : '';
}

/* settings listeners */
function attachSettingsHandlers(){
  $('btn-settings').addEventListener('click', openSettings, {passive:true});
  $('btn-closeSettings').addEventListener('click', closeSettings);
  $('s_showProcess').addEventListener('change', ()=>{
    const s = loadSettings(); s.showProcess = $('s_showProcess').checked; saveSettings(s);
  }, {passive:true});
  $('s_showTrials').addEventListener('change', ()=>{
    const s = loadSettings(); s.showTrials = $('s_showTrials').checked; saveSettings(s);
  }, {passive:true});

  ['m_mg_min','m_mg_max','m_rp_min','m_rp_max'].forEach(id=>{
    $(id).addEventListener('input', ()=>{
      validateMasterUI();
      const m = loadMaster();
      m.mg.min = Number($('m_mg_min').value||0);
      m.mg.max = Number($('m_mg_max').value||0);
      m.rp.min = Number($('m_rp_min').value||0);
      m.rp.max = Number($('m_rp_max').value||0);
      saveMaster(m);
    }, {passive:true});
  });

  $('btn-masterExport').addEventListener('click', ()=>{
    const m = loadMaster();
    const blob = new Blob([JSON.stringify(m, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'nexa_master.json'; a.click();
    URL.revokeObjectURL(url);
  }, {passive:true});

  $('btn-masterImport').addEventListener('click', ()=>$('masterImportFile').click());
  $('masterImportFile').addEventListener('change', (ev)=>{
    const f = ev.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{ try{
      const parsed = JSON.parse(r.result);
      saveMaster(parsed); initSettingsUI();
      alert('ãƒã‚¹ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
    }catch(e){ alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message) } };
    r.readAsText(f);
  }, {passive:true});
}

/* open / close */
function openSettings(){
  $('dialog-settings').style.display='block';
}
function closeSettings(){
  $('dialog-settings').style.display='none';
}

/* ========================
   IndexedDB for history
   ======================== */
const DB_NAME = 'nexa_db_v1';
const STORE = 'results';
let _db = null;

function openDB(){ return new Promise((res,rej)=>{
  if(_db) return res(_db);
  const rq = indexedDB.open(DB_NAME,1);
  rq.onupgradeneeded = e => {
    const db = e.target.result;
    if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE, { keyPath: 'id' });
  };
  rq.onsuccess = e => { _db = e.target.result; res(_db); };
  rq.onerror = e => rej(e);
}); }

async function saveResultToDB(obj){
  await openDB();
  return new Promise((res,rej)=>{
    const tx = _db.transaction(STORE,'readwrite');
    const os = tx.objectStore(STORE);
    os.put(obj);
    tx.oncomplete = ()=>res();
    tx.onerror = e=>rej(e);
  });
}
async function loadAllResults(){ await openDB();
  return new Promise(res=>{
    const tx = _db.transaction(STORE,'readonly'); const req = tx.objectStore(STORE).getAll();
    req.onsuccess = e => res(e.target.result || []);
  });
}
async function clearAllResults(){ await openDB();
  return new Promise(res=>{
    const tx = _db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).clear();
    tx.oncomplete = ()=>res();
  });
}

/* history UI */
async function renderHistory(){
  const list = await loadAllResults();
  const box = $('history-list');
  if(!list.length){ box.textContent='éå»ã®è©•ä¾¡ã¯ã‚ã‚Šã¾ã›ã‚“'; return; }
  list.sort((a,b)=>new Date(b.time) - new Date(a.time));
  box.innerHTML = list.slice(0,12).map(r=>{
    return `<div style="padding:8px;border-radius:10px;background:rgba(255,255,255,.02);margin-bottom:8px">
      <div style="font-weight:700">${r.rank}ï½œ${r.summary}</div>
      <div class="small">${new Date(r.time).toLocaleString()}</div>
    </div>`;
  }).join('');
}

/* export history */
$('btn-exportHistory')?.addEventListener('click', async ()=>{
  const all = await loadAllResults();
  const blob = new Blob([JSON.stringify(all,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'nexa_history.json'; a.click();
  URL.revokeObjectURL(url);
}, {passive:true});

$('btn-clearHistory')?.addEventListener('click', async ()=>{
  if(!confirm('å±¥æ­´ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await clearAllResults(); renderHistory(); alert('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}, {passive:true});

/* ========================
   Evaluation core
   ======================== */
function parseAgeInput(v){
  v = (v||'').trim();
  if(/\d{4}-\d{2}-\d{2}/.test(v)){
    const d = new Date(v); if(!isNaN(d)) return Math.max(0, new Date().getFullYear() - d.getFullYear());
  }
  const n = Number(v); if(!isNaN(n) && n>0 && n<120) return n;
  return null;
}

/* rough monthly loan calc: use annuity approx monthly payment factor for simplicity */
function calcMonthlyPayment(principalYen, years, annualRate){
  const n = years * 12;
  const r = annualRate / 12;
  if(r === 0) return principalYen / n;
  const factor = r / (1 - Math.pow(1+r, -n));
  return principalYen * factor;
}

function monteCarloSimulation(base, trials){
  let stable=0, stress=0;
  for(let i=0;i<trials;i++){
    const interestShock = 1 + (Math.random()-0.5)*0.4; // Â±20%
    const feeShock = 1 + Math.random()*0.25;
    const monthly = base.monthlyLoan * interestShock + base.monthlyFees * feeShock;
    if(monthly < base.safeThreshold) stable++;
    if(monthly > base.dangerThreshold) stress++;
  }
  return { stableRatio: stable/trials, stressRatio: stress/trials };
}

function sensitivityFactors(input){
  const arr = [
    {name:'ç‰©ä»¶ä¾¡æ ¼', weight: input.price},
    {name:'å›ºå®šè²»ï¼ˆç®¡ç†ãƒ»ä¿®ç¹•ç­‰ï¼‰', weight: input.monthlyFees},
    {name:'ä¸–å¸¯å¹´å', weight: input.income}
  ];
  return arr.sort((a,b)=>b.weight-a.weight).slice(0,3).map(x=>x.name);
}

/* generate worldlines texts */
function generateWorldlines(mc){
  return [
    {name:'å‰æç¶™ç¶š', text: mc.stableRatio>0.7 ? 'ç¾åœ¨ã®å‰æãŒç¶šã‘ã°ã€ç”Ÿæ´»ã¯æ¯”è¼ƒçš„å®‰å®šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚' : 'å‰æãŒç¶šã„ã¦ã‚‚è² æ‹…å¢—ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚'},
    {name:'æ¡ä»¶æ‚ªåŒ–', text: mc.stressRatio>0.3 ? 'é‡‘åˆ©ã‚„è²»ç”¨ä¸Šæ˜‡æ™‚ã«å¤§ããªåœ§è¿«ã‚’å—ã‘ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚' : 'ä¸€å®šã®æ‚ªåŒ–ã§ã‚‚å³ç ´ç¶»ã¯ã—ã«ãã„å‚¾å‘ã§ã™ã€‚'},
    {name:'æ¡ä»¶æ”¹å–„', text: 'åå…¥å¢—ã‚„é ­é‡‘ã®ç©ã¿å¢—ã—ã«ã‚ˆã‚Šã€é¸æŠè‚¢ã¯åºƒãŒã‚Šã¾ã™ã€‚'}
  ];
}

/* main evaluate wrapper */
async function runEvaluation(){
  // collect
  const priceWan = Number($('f_price').value || 0);
  const priceYen = priceWan * 10000;
  const area = Number($('f_area').value || 0);
  const fees = Number($('f_fees').value || 0);
  const other = Number($('f_other').value || 0);
  const monthlyFees = fees + other;
  const incomeWan = Number($('f_income').value || 0);
  const incomeYen = incomeWan * 10000;

  const loanYears = Number($('f_loanYears').value || 25);
  const downWan = Number($('f_down').value || 0);
  const downYen = downWan * 10000;
  const principal = Math.max(0, priceYen - downYen);

  // interest default assumptions (can be extended)
  const annualRate = 0.005; // 0.5% base
  const monthlyLoan = calcMonthlyPayment(principal, loanYears, annualRate);

  const safeThreshold = incomeYen / 12 * 0.25; // 25% rule
  const dangerThreshold = incomeYen / 12 * 0.4;

  // trials limit: choose reasonable count based on platform
  let trials = 8000;
  try{
    // if on heavy device, reduce
    if(navigator.userAgent.match(/iPhone|Android/)) trials = 3000;
    if(navigator.deviceMemory && navigator.deviceMemory < 2) trials = 1500;
  }catch(e){}

  const mc = monteCarloSimulation({
    monthlyLoan, monthlyFees, safeThreshold, dangerThreshold
  }, trials);

  let rank='B', summary='æ…é‡ãªæ¤œè¨ãŒå¿…è¦ã§ã™ã€‚';
  if(mc.stableRatio > 0.75) { rank='A'; summary='å‰æå¤‰åŒ–ã«å¯¾ã—ã¦æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ã¾ã™ã€‚'; }
  if(mc.stressRatio > 0.4) { rank='C'; summary='æ¡ä»¶æ‚ªåŒ–æ™‚ã®å½±éŸ¿ãŒå¤§ãã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'; }

  const factors = sensitivityFactors({ price: priceWan, monthlyFees, income: incomeWan });
  const worldlines = generateWorldlines(mc);

  const result = {
    id: crypto.randomUUID(),
    time: new Date().toISOString(),
    input: {
      priceWan, area, built: $('f_built').value, monthlyFees, incomeWan, loanYears, downWan,
      address: $('f_address').value, stations: $('f_stations').value, commutes: $('f_commutes').value
    },
    rank, summary, trials, mc, factors, worldlines
  };

  // show
  $('card-result').style.display='block';
  $('result-rank').textContent = rank;
  $('result-summary').textContent = summary;
  $('result-trials').textContent = (loadSettings().showTrials ? ('ç´„' + trials.toLocaleString() + 'é€šã‚Š') : '');
  $('result-worldlines').innerHTML = worldlines.map(w=>`<li><strong>${w.name}</strong>ï¼š ${w.text}</li>`).join('');
  $('result-factors').innerHTML = factors.map(f=>`<li>${f}</li>`).join('');

  // save automatically to DB
  await saveResultToDB(result);

  return result;
}

/* ========================
   Print / PDF: open printable HTML and call print()
   Use browser-native print to avoid japanese font problems
   ======================== */
function openPrintableReport(result){
  const html = buildReportHTML(result);
  const w = window.open('', '_blank');
  if(!w) { alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
  // allow render then print
  w.focus();
  setTimeout(()=>{ try{ w.print(); }catch(e){ console.warn(e); } }, 500);
}

function buildReportHTML(result){
  const input = result.input;
  const lines = result.worldlines.map(w=>`<li><strong>${w.name}</strong>ï¼š${w.text}</li>`).join('');
  const factors = result.factors.map(f=>`<li>${f}</li>`).join('');
  const header = `
    <div style="font-family: -apple-system, 'Hiragino Sans', 'Noto Sans JP', sans-serif; padding:18px;">
      <h1 style="margin:0 0 8px">NEXA è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ</h1>
      <div style="color:#666">${new Date(result.time).toLocaleString('ja-JP')}</div>
      <hr style="margin:14px 0">
    </div>
  `;
  const body = `
    <div style="padding:0 18px 36px;font-family: -apple-system, 'Hiragino Sans', 'Noto Sans JP', sans-serif;color:#111">
      <h2>æ¦‚è¦</h2>
      <p><strong>ãƒ©ãƒ³ã‚¯ï¼š</strong>${result.rank}ã€€/ã€€<strong>è¦ç´„ï¼š</strong>${result.summary}</p>

      <h3>å…¥åŠ›ã‚µãƒãƒª</h3>
      <ul>
        <li>ç‰©ä»¶ä¾¡æ ¼ï¼š ${input.priceWan} ä¸‡å††</li>
        <li>å°‚æœ‰é¢ç©ï¼š ${input.area || '-'} ã¡</li>
        <li>æœˆé¡å›ºå®šè²»ï¼š ${input.monthlyFees} å††</li>
        <li>ä¸–å¸¯å¹´åï¼š ${input.incomeWan} ä¸‡å††</li>
        <li>ãƒ­ãƒ¼ãƒ³æœŸé–“ï¼š ${input.loanYears} å¹´</li>
        <li>é ­é‡‘ï¼š ${input.downWan} ä¸‡å††</li>
        <li>ä½æ‰€ï¼š ${input.address || '-'}</li>
        <li>æœ€å¯„ã‚Šé§…ï¼š ${input.stations || '-'}</li>
      </ul>

      <h3>æƒ³å®šã•ã‚Œã‚‹ä¸–ç•Œç·š</h3>
      <ul>${lines}</ul>

      <h3>æ„Ÿåº¦ï¼ˆå½±éŸ¿ãŒå¤§ãã„è¦å› ï¼‰</h3>
      <ul>${factors}</ul>

      <h3>è©¦è¡Œã«ã¤ã„ã¦</h3>
      <p>å†…éƒ¨è©¦è¡Œæ•°ï¼šç´„ ${result.trials.toLocaleString()} é€šã‚Šã®è¿‘ä¼¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«åŸºã¥ãåˆ¤æ–­ææ–™ã§ã™ã€‚æ•°å€¤ã¯ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹è¿‘ä¼¼ã§ã‚ã‚Šã€çµæœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>

      <hr>
      <div style="font-size:12px;color:#666">NEXA v1.0 ï½œ Â© Yoshinobu Takamitsu</div>
      <div style="font-size:11px;color:#666;margin-top:6px">å…è²¬ï¼šæœ¬è³‡æ–™ã¯åˆ¤æ–­ææ–™ã®æ•´ç†ã‚’ç›®çš„ã¨ã—ã€æœ€çµ‚åˆ¤æ–­ãŠã‚ˆã³å¥‘ç´„ã¯åˆ©ç”¨è€…ã®è²¬ä»»ã§è¡Œã£ã¦ãã ã•ã„ã€‚</div>
    </div>
  `;
  // small, printable CSS
  const css = `<style>
    @media print{ body{ -webkit-print-color-adjust:exact } }
    body{margin:0;color:#222}
    h1,h2,h3{color:#111}
    ul{line-height:1.6}
  </style>`;
  return `<!doctype html><html><head><meta charset="utf-8">${css}</head><body>${header}${body}</body></html>`;
}

/* ========================
   UI wiring
   ======================== */
function attachUI(){
  attachAutosave();
  attachSettingsHandlers();

  // restore on load
  restoreForm();
  initSettingsUI();

  $('btn-evaluate').addEventListener('click', async ()=>{
    $('btn-evaluate').disabled = true;
    try{
      const res = await runEvaluation();
      // scroll to result
      $('card-result').scrollIntoView({behavior:'smooth', block:'center'});
    }catch(e){ console.error(e); alert('è©•ä¾¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
    $('btn-evaluate').disabled = false;
  });

  // history button
  $('btn-history').addEventListener('click', async ()=>{
    // toggle
    const el = $('card-history');
    if(el.style.display === 'block'){ el.style.display='none'; } else {
      await renderHistory(); el.style.display='block'; window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
    }
  }, {passive:true});

  // settings open/close (already attached)
  $('btn-settings').addEventListener('click', openSettings, {passive:true});
  $('btn-closeSettings').addEventListener('click', closeSettings, {passive:true});

  // save snapshot explicit
  $('btn-saveSnapshot').addEventListener('click', async ()=>{
    try{
      const last = await runEvaluation(); // evaluate and save
      alert('è©•ä¾¡ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆå±¥æ­´ã«è¿½åŠ ï¼‰');
    }catch(e){ console.error(e); alert('ä¿å­˜ã«å¤±æ•—'); }
  });

  $('btn-pdf').addEventListener('click', async ()=>{
    const list = await loadAllResults();
    const last = list.sort((a,b)=> new Date(b.time) - new Date(a.time))[0];
    if(!last){ alert('ã¾ãšè©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰PDFã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
    openPrintableReport(last);
  });

  $('btn-compare').addEventListener('click', async ()=>{
    const list = await loadAllResults();
    if(list.length < 2){ alert('æ¯”è¼ƒå¯èƒ½ãªéå»è©•ä¾¡ãŒè¶³ã‚Šã¾ã›ã‚“'); return; }
    // compare latest two
    const sorted = list.sort((a,b)=> new Date(b.time) - new Date(a.time));
    const a = sorted[0], b = sorted[1];
    const diffs = [];
    if(a.rank !== b.rank) diffs.push(`ãƒ©ãƒ³ã‚¯ãŒå¤‰ã‚ã‚Šã¾ã—ãŸ: ${b.rank} â†’ ${a.rank}`);
    if(Math.abs(a.mc.stableRatio - b.mc.stableRatio) > 0.05) diffs.push('å®‰å®šæ€§ã®å‰æãŒ5%ä»¥ä¸Šå¤‰åŒ–');
    if(diffs.length===0) diffs.push('å¤§ããªå‰æå·®åˆ†ã¯è¦‹ã‚‰ã‚Œã¾ã›ã‚“');
    alert('æ¯”è¼ƒçµæœ:\n' + diffs.join('\n'));
  });

  // master import/export already wired
  // attach open printable for direct use
}

/* ========================
   Init on DOMContentLoaded
   ======================== */
document.addEventListener('DOMContentLoaded', ()=>{
  attachUI();
  // protect header click: ensure header is frontmost
  const header = $('site-header'); header.style.zIndex = 99999; header.style.pointerEvents='auto';
});

/* ========================
   Defensive: elementFromPoint debug helper (for inspection)
   ======================== */
window.nexaDebugElementAt = function(x,y){
  try{ const el = document.elementFromPoint(x,y); return el ? el.outerHTML.slice(0,400) : null; }catch(e){ return String(e); }
};

</script>
</body>
</html>