<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>NEXA â€” åˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆæœ€çµ‚ç‰ˆï¼‰</title>
<style>
:root{
  --bg:#050A14; --fg:#E6F1FF; --sub:#8FA3BF; --accent:#00F0FF;
  --glass:rgba(18,28,54,.56); --border:rgba(255,255,255,.06);
  --radius:16px; --btn-height:64px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;font-size:15px}
body{ -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100%; }

/* Header */
header#site-header{
  position:fixed;top:0;left:0;right:0;
  padding:calc(env(safe-area-inset-top)+10px) 14px 10px;
  background:var(--glass);backdrop-filter:blur(28px) saturate(140%);
  border-bottom:1px solid var(--border);z-index:1200;
  display:flex;align-items:center;justify-content:space-between;
}
.header-left{display:flex;align-items:center;gap:10px}
#app-logo{font-weight:800;letter-spacing:.06em;font-size:18px}
.header-right{display:flex;align-items:center;gap:8px}
.icon-button{
  width:44px;height:40px;border-radius:10px;border:none;
  background:transparent;color:var(--fg);font-size:18px;
  display:inline-flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;cursor:pointer;
}

/* Main content: give big bottom padding to avoid footer / fixed button overlap */
main{
  position:relative;
  padding: calc(env(safe-area-inset-top)+88px) 16px calc(env(safe-area-inset-bottom) + var(--btn-height) + 40px);
  min-height:100dvh; overflow-y:auto; -webkit-overflow-scrolling:touch;
  z-index:1;
  -webkit-user-select:none;
}

/* card */
.card{
  background:var(--glass);border:1px solid var(--border);
  border-radius:var(--radius);padding:14px;margin-bottom:16px;
}
.card h3{margin:0 0 10px;font-size:17px}

/* labels and inputs */
.field-label{display:block;color:var(--sub);font-size:12px;margin-top:10px}
.input,select,textarea{
  width:100%;padding:12px;border-radius:12px;border:none;margin-top:6px;
  background:rgba(255,255,255,.03);color:var(--fg);font-size:15px;
  outline:none;-webkit-appearance:none;appearance:none;
}
.select-wrap{position:relative}
.select-wrap::after{
  content:'â–¾';position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--sub);
  pointer-events:none;font-size:14px;
}

/* fixed primary button above footer */
.fixed-action{
  position:fixed;left:12px;right:12px;bottom:calc(env(safe-area-inset-bottom)+12px);
  z-index:1300;display:flex;justify-content:center;
}
.btn-primary{
  width:100%;max-width:920px;height:var(--btn-height);border-radius:28px;border:none;
  background:var(--accent);color:#000;font-weight:800;font-size:17px;cursor:pointer;
  box-shadow:0 8px 26px rgba(0,240,255,.08);
}

/* footer: visible but non-intercepting by default */
footer#site-footer{
  position:fixed;left:0;right:0;bottom:0;padding:10px 12px calc(env(safe-area-inset-bottom)+10px);
  text-align:center;font-size:12px;color:var(--sub);
  background:linear-gradient(rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  border-top:1px solid rgba(255,255,255,0.02);
  z-index:1100;
  pointer-events:none; /* prevent capturing taps */
}
footer#site-footer > * { pointer-events:auto; } /* allow interactive inside if needed */

/* result / hidden */
#card-result, #card-history, #card-settings { display:none; }

.small{font-size:13px;color:var(--sub)}
.warning{color:#FFD36A;font-size:12px;margin-top:6px}

/* modal settings (hidden until toggled) */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1400;display:flex;align-items:center;justify-content:center;
}
.modal{
  width:calc(100% - 48px);max-width:720px;background:var(--bg);border-radius:14px;padding:16px;border:1px solid var(--border);
}

/* accessibility focus */
.icon-button:focus, .btn-primary:focus, .input:focus { outline:2px solid rgba(0,240,255,.12); outline-offset:2px; }

/* small screens tweak */
@media (min-width:760px){
  main{max-width:760px;margin:0 auto;padding-left:24px;padding-right:24px}
  .fixed-action{left:calc(50% - 380px);right:auto; width:760px; transform:translateX(-50%);}
}
</style>
</head>
<body>
<header id="site-header" role="banner">
  <div class="header-left">
    <div id="app-logo">NEXA</div>
    <div class="small" style="opacity:.95">ä½å±…ç”¨ä¸å‹•ç”£ãƒ»åˆ¤å®šãƒ­ã‚°ç”Ÿæˆ</div>
  </div>
  <div class="header-right">
    <button id="btn-history" class="icon-button" title="å±¥æ­´" aria-label="å±¥æ­´">ğŸ•˜</button>
    <button id="btn-settings" class="icon-button" title="è¨­å®š" aria-label="è¨­å®š">â‹¯</button>
  </div>
</header>

<main id="main">
  <!-- Input -->
  <section class="card" id="card-input">
    <h3>å…¥åŠ›</h3>

    <label class="field-label" for="price">ç‰©ä»¶ä¾¡æ ¼ï¼ˆä¸‡å††ï¼‰</label>
    <input id="price" class="input" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š3080">

    <label class="field-label" for="area">å°‚æœ‰é¢ç©ï¼ˆã¡ï¼‰</label>
    <input id="area" class="input" type="number" placeholder="ä¾‹ï¼š58">

    <label class="field-label" for="built">ç¯‰å¹´ï¼ˆè¥¿æš¦ï¼‰</label>
    <input id="built" class="input" type="number" placeholder="ä¾‹ï¼š1998">

    <label class="field-label" for="fees">ç®¡ç†è²»ï¼ˆæœˆé¡ãƒ»å††ï¼‰</label>
    <input id="fees" class="input" type="number" placeholder="ä¾‹ï¼š15000">

    <label class="field-label" for="repair">ä¿®ç¹•ç©ç«‹é‡‘ï¼ˆæœˆé¡ãƒ»å††ï¼‰</label>
    <input id="repair" class="input" type="number" placeholder="ä¾‹ï¼š15000">

    <label class="field-label" for="other">ãã®ä»–æœˆé¡è²»ç”¨ï¼ˆãƒãƒƒãƒˆãƒ»å…±è´ç­‰ãƒ»å††ï¼‰</label>
    <input id="other" class="input" type="number" placeholder="ä¾‹ï¼š0">
  </section>

  <!-- Household / Loan -->
  <section class="card" id="card-household">
    <h3>ä¸–å¸¯ãƒ»ãƒ­ãƒ¼ãƒ³</h3>

    <label class="field-label" for="income">ä¸–å¸¯å¹´åï¼ˆä¸‡å††ï¼‰</label>
    <input id="income" class="input" type="number" placeholder="ä¾‹ï¼š850">

    <label class="field-label" for="ageOrDob">è³¼å…¥æ™‚å¹´é½¢ï¼ˆä»£è¡¨è€…ï¼‰ ã¾ãŸã¯ ç”Ÿå¹´æœˆæ—¥ï¼ˆYYYY-MM-DDï¼‰</label>
    <input id="ageOrDob" class="input" type="text" placeholder="ä¾‹ï¼š35 ã¾ãŸã¯ 1990-04-12">

    <label class="field-label" for="loanType">ãƒ­ãƒ¼ãƒ³å½¢æ…‹</label>
    <select id="loanType" class="input">
      <option value="solo">å˜ç‹¬ãƒ­ãƒ¼ãƒ³</option>
      <option value="pair">ãƒšã‚¢ãƒ­ãƒ¼ãƒ³</option>
      <option value="combined">åå…¥åˆç®—</option>
    </select>

    <label class="field-label" for="loanYears">ãƒ­ãƒ¼ãƒ³æœŸé–“ï¼ˆå¹´ï¼‰ â€” é¸æŠã—ã¦ãã ã•ã„</label>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="select-wrap" style="flex:1">
        <select id="loanYears" class="input">
          <option value="5">5</option><option value="10">10</option><option value="15">15</option>
          <option value="20">20</option><option value="25" selected>25</option><option value="30">30</option>
          <option value="35">35</option><option value="40">40</option><option value="45">45</option>
        </select>
      </div>
      <div class="small">å¹´</div>
      <div style="width:120px">
        <label class="field-label" for="down">é ­é‡‘ï¼ˆä¸‡å††ï¼‰</label>
        <input id="down" class="input" type="number" placeholder="ä¾‹ï¼š400">
      </div>
    </div>
  </section>

  <!-- Location optional -->
  <section class="card" id="card-location">
    <h3>ç«‹åœ°ãƒ»é€šå‹¤ï¼ˆä»»æ„ï¼‰</h3>
    <label class="field-label" for="address">ç‰©ä»¶ä½æ‰€ï¼ˆéƒµä¾¿ç•ªå· or ä½æ‰€ï¼‰</label>
    <input id="address" class="input" type="text" placeholder="ä¾‹ï¼šæ±äº¬éƒ½æ¸¯åŒºèŠå¤§é–€1-1-30">

    <label class="field-label" for="stations">æœ€å¯„ã‚Šé§…ï¼ˆè¤‡æ•°å¯ãƒ»ã‚«ãƒ³ãƒã§åŒºåˆ‡ã‚‹ï¼‰</label>
    <input id="stations" class="input" type="text" placeholder="ä¾‹ï¼šå¤§é–€, æµœæ¾ç”º">

    <label class="field-label" for="commutes">é€šå‹¤å…ˆï¼ˆè¤‡æ•°å¯ï¼‰</label>
    <input id="commutes" class="input" type="text" placeholder="ä¾‹ï¼šè·å ´A, è·å ´B">
  </section>

  <!-- Result card (hidden until evaluated) -->
  <section class="card" id="card-result" aria-live="polite" style="display:none">
    <h3>è©•ä¾¡çµæœ</h3>
    <div id="result-summary" style="font-weight:700;margin-bottom:8px"></div>

    <div style="display:flex;gap:14px;margin-bottom:12px">
      <div style="flex:1">
        <div class="small">æ¨å®šãƒ©ãƒ³ã‚¯</div>
        <div id="result-rank" style="font-size:22px;font-weight:800">â€”</div>
      </div>
      <div style="width:150px">
        <div class="small">å†…éƒ¨è©¦è¡Œæ•°</div>
        <div id="result-trials" style="font-size:16px">â€”</div>
      </div>
    </div>

    <div class="small">æƒ³å®šã•ã‚Œã‚‹ä¸–ç•Œç·š</div>
    <ul id="result-worldlines" style="margin:8px 0 12px;color:var(--fg)"></ul>

    <div class="small">å½±éŸ¿ãŒå¤§ãã„è¦å› </div>
    <ul id="result-factors" style="margin:8px 0 6px;color:var(--fg)"></ul>
  </section>

  <!-- History -->
  <section class="card" id="card-history" style="display:none">
    <h3>è©•ä¾¡å±¥æ­´</h3>
    <div id="history-list" class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="exportHistory" class="icon-button" style="pointer-events:auto">â¤“</button>
      <button id="clearHistory" class="icon-button" style="pointer-events:auto">ğŸ—‘</button>
    </div>
  </section>
</main>

<!-- fixed primary action (above footer) -->
<div class="fixed-action">
  <button id="btn-evaluate" class="btn-primary">è©•ä¾¡ã™ã‚‹</button>
</div>

<footer id="site-footer">
  <span>Â© Yoshinobu Takamitsu ï½œ æœ¬ã‚¢ãƒ—ãƒªã¯åˆ¤æ–­ææ–™ã®æ•´ç†ã‚’ç›®çš„ã¨ã—ã€çµæœã‚’ä¿è¨¼ã—ã¾ã›ã‚“</span>
</footer>

<!-- modal placeholder -->
<div id="modal-root" aria-hidden="true"></div>

<script>
/* ========= Utilities ========= */
const $ = id => document.getElementById(id);
const q = sel => document.querySelector(sel);
const jparse = (s,d=null)=>{ try{return JSON.parse(s)}catch(e){return d} };

/* ===== storage keys ===== */
const FORM_KEY = 'nexa_form_final_v1';
const DB_NAME = 'nexa_db_final_v1';
const STORE = 'results';

/* ===== IndexedDB helpers ===== */
let _db = null;
function openDB(){ return new Promise((res,rej)=>{
  if(_db) return res(_db);
  const req = indexedDB.open(DB_NAME,1);
  req.onupgradeneeded = e => {
    const db = e.target.result;
    if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE, { keyPath:'id' });
  };
  req.onsuccess = e => { _db = e.target.result; res(_db); };
  req.onerror = e => rej(e);
});}
async function saveResult(obj){ await openDB(); return new Promise((res,rej)=>{
  const tx = _db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(obj);
  tx.oncomplete = ()=>res(); tx.onerror = e => rej(e);
})}
async function loadAll(){ await openDB(); return new Promise(res=>{
  const tx = _db.transaction(STORE,'readonly'); const req = tx.objectStore(STORE).getAll();
  req.onsuccess = e => res(e.target.result || []);
});}
async function clearAll(){ await openDB(); return new Promise(res=>{
  const tx = _db.transaction(STORE,'readwrite'); tx.objectStore(STORE).clear();
  tx.oncomplete = ()=>res();
});}

/* ===== autosave/restore form ===== */
function saveForm(){
  const state = {
    price: $('price').value, area:$('area').value, built:$('built').value,
    fees:$('fees').value, repair:$('repair').value, other:$('other').value,
    income:$('income').value, ageOrDob:$('ageOrDob').value, loanType:$('loanType').value,
    loanYears:$('loanYears').value, down:$('down').value,
    address:$('address').value, stations:$('stations').value, commutes:$('commutes').value
  };
  localStorage.setItem(FORM_KEY, JSON.stringify(state));
}
function restoreForm(){
  const s = jparse(localStorage.getItem(FORM_KEY), {});
  if(!s) return;
  Object.keys(s).forEach(k=>{ const el = $(k); if(el) el.value = s[k]||''; });
}

/* attach autosave */
function attachAutosave(){
  document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', saveForm, {passive:true}));
}

/* ===== core calc / montecarlo ===== */
function uid(){ return crypto.randomUUID(); }
function calcMonthlyPayment(principalYen, years, annualRate){
  const n = years * 12;
  const r = annualRate / 12;
  if(r === 0) return principalYen / n;
  return principalYen * (r / (1 - Math.pow(1+r, -n)));
}
function monteCarlo(base, trials){
  let stable=0, stress=0;
  for(let i=0;i<trials;i++){
    const ishock = 1 + (Math.random()-0.5)*0.4; // Â±20%
    const fshock = 1 + Math.random()*0.25; // +0~25%
    const monthly = base.monthlyLoan * ishock + base.monthlyFees * fshock;
    if(monthly < base.safeThreshold) stable++;
    if(monthly > base.dangerThreshold) stress++;
  }
  return { stableRatio: stable/trials, stressRatio: stress/trials };
}
function sensitivity(input){
  const arr = [{name:'ç‰©ä»¶ä¾¡æ ¼',w:input.priceWan},{name:'å›ºå®šè²»',w:input.monthlyFees},{name:'ä¸–å¸¯å¹´å',w:input.incomeWan}];
  return arr.sort((a,b)=>b.w-a.w).slice(0,3).map(x=>x.name);
}

/* ===== run evaluation ===== */
async function runEvaluation(){
  // gather
  const priceWan = Number($('price').value || 0);
  const priceYen = priceWan * 10000;
  const area = Number($('area').value || 0);
  const fees = Number($('fees').value || 0);
  const repair = Number($('repair').value || 0);
  const other = Number($('other').value || 0);
  const monthlyFees = fees + repair + other;
  const incomeWan = Number($('income').value || 0);
  const incomeYen = incomeWan * 10000;
  const loanYears = Number($('loanYears').value || 25);
  const downWan = Number($('down').value || 0);
  const downYen = downWan * 10000;
  const principal = Math.max(0, priceYen - downYen);
  const annualRate = 0.005; // 0.5% baseline
  const monthlyLoan = calcMonthlyPayment(principal, loanYears, annualRate);
  const safeThreshold = incomeYen / 12 * 0.25;
  const dangerThreshold = incomeYen / 12 * 0.4;

  // trials adapt to device
  let trials = 3000;
  try{ if(navigator.deviceMemory && navigator.deviceMemory < 2) trials = 1000; }catch(e){}

  const mc = monteCarlo({ monthlyLoan, monthlyFees, safeThreshold, dangerThreshold }, trials);

  let rank='B', summary='æ…é‡ãªæ¤œè¨ãŒå¿…è¦ã§ã™ã€‚';
  if(mc.stableRatio > 0.75){ rank='A'; summary='å‰æå¤‰åŒ–ã«å¯¾ã—ã¦æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ã¾ã™ã€‚'; }
  if(mc.stressRatio > 0.4){ rank='C'; summary='æ¡ä»¶æ‚ªåŒ–æ™‚ã®å½±éŸ¿ãŒå¤§ãã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'; }

  const factors = sensitivity({ priceWan, monthlyFees, incomeWan });
  const worldlines = [
    {name:'å‰æç¶™ç¶š', text: mc.stableRatio>0.7 ? 'æ¡ä»¶ãŒç¶šã‘ã°æ¯”è¼ƒçš„å®‰å®š' : 'å‰æãŒç¶šã„ã¦ã‚‚æ³¨æ„ãŒå¿…è¦'},
    {name:'æ¡ä»¶æ‚ªåŒ–', text: mc.stressRatio>0.3 ? 'æ‚ªåŒ–æ™‚ã«è² æ‹…å¢—' : 'å¤šå°‘ã®æ‚ªåŒ–ã§å³ç ´ç¶»ã—ã«ãã„'},
    {name:'æ¡ä»¶æ”¹å–„', text: 'åå…¥å¢—ã‚„é ­é‡‘ã§é¸æŠè‚¢ãŒåºƒãŒã‚‹'}
  ];

  const result = { id: uid(), time: new Date().toISOString(),
    input:{priceWan,area,monthlyFees,incomeWan,loanYears,downWan}, rank, summary, trials, mc, factors, worldlines };

  // render into UI
  $('card-result').style.display = 'block';
  $('result-rank').textContent = result.rank;
  $('result-summary').textContent = result.summary;
  $('result-trials').textContent = 'ç´„ ' + result.trials.toLocaleString() + ' é€šã‚Š';
  $('result-worldlines').innerHTML = result.worldlines.map(w=>`<li><strong>${w.name}</strong>ï¼š ${w.text}</li>`).join('');
  $('result-factors').innerHTML = result.factors.map(f=>`<li>${f}</li>`).join('');

  // save
  try{ await saveResult(result); }catch(e){ console.warn('save fail', e); }

  // scroll result into view (center)
  $('card-result').scrollIntoView({behavior:'smooth', block:'center'});

  return result;
}

/* ===== UI wiring (DOMContentLoaded safe) ===== */
document.addEventListener('DOMContentLoaded', ()=>{

  // restore previous form, attach autosave
  restoreForm();
  attachAutosave();

  // evaluate button
  const evalBtn = $('btn-evaluate');
  evalBtn.addEventListener('click', async (ev)=>{
    if(evalBtn.disabled) return;
    try{
      evalBtn.disabled = true;
      evalBtn.textContent = 'è©•ä¾¡ä¸­â€¦';
      await runEvaluation();
    }catch(e){ console.error(e); alert('è©•ä¾¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
    evalBtn.disabled = false;
    evalBtn.textContent = 'è©•ä¾¡ã™ã‚‹';
  }, {passive:false});

  // history button toggles card-history
  $('btn-history').addEventListener('click', async ()=>{
    const ch = $('card-history');
    if(ch.style.display === 'block'){ ch.style.display = 'none'; return; }
    ch.style.display = 'block';
    const hs = await loadAll();
    const box = $('history-list');
    if(!hs.length) box.textContent = 'å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“';
    else box.innerHTML = hs.slice(-12).reverse().map(h=>`
      <div style="padding:8px;margin-bottom:8px;background:rgba(255,255,255,.02);border-radius:8px">
        <div style="font-weight:700">${h.rank} ï¼ ${h.summary}</div>
        <div class="small">${new Date(h.time).toLocaleString()}</div>
      </div>
    `).join('');
  }, {passive:true});

  // export/clear history
  $('exportHistory').addEventListener('click', async ()=>{
    const all = await loadAll();
    const blob = new Blob([JSON.stringify(all,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'nexa_history.json'; a.click(); URL.revokeObjectURL(url);
  }, {passive:true});
  $('clearHistory').addEventListener('click', async ()=>{
    if(confirm('å±¥æ­´ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')){ await clearAll(); $('history-list').textContent='å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“'; alert('å‰Šé™¤ã—ã¾ã—ãŸ'); }
  }, {passive:true});

  // settings opens lightweight modal
  $('btn-settings').addEventListener('click', ()=>{
    openSettingsModal();
  }, {passive:true});
});

/* ===== settings modal implementation ===== */
function openSettingsModal(){
  const root = $('modal-root');
  root.innerHTML = `
    <div class="modal-backdrop" id="settings-backdrop" role="dialog" aria-modal="true">
      <div class="modal">
        <h3 style="margin-top:0">è¨­å®š</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
          <label><input type="checkbox" id="opt-showTrials" checked> å†…éƒ¨è©¦è¡Œæ•°ã‚’è¡¨ç¤º</label>
          <label><input type="checkbox" id="opt-showWorldlines" checked> æƒ³å®šä¸–ç•Œç·šã‚’è¡¨ç¤º</label>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="settings-close" class="icon-button" style="pointer-events:auto">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>`;
  // attach close
  $('settings-backdrop').addEventListener('click', (e)=>{ if(e.target.id === 'settings-backdrop') closeSettingsModal(); });
  $('settings-close').addEventListener('click', closeSettingsModal);
}
function closeSettingsModal(){ const root = $('modal-root'); root.innerHTML = ''; }

/* ===== end of script ===== */
</script>
</body>
</html>