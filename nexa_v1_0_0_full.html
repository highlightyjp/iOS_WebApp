<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>NEXA â€” ä¿®æ­£ç‰ˆï¼ˆiOS safe-area å¯¾å¿œï¼‰</title>
<style>
:root{
  --bg:#050A14; --fg:#E6F1FF; --sub:#8FA3BF; --accent:#00F0FF;
  --glass:rgba(18,28,54,.56); --border:rgba(255,255,255,.06);
  --radius:14px; --btn-height:64px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif}
body{ -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100%; }

/* Header */
header#site-header{
  position:fixed;top:0;left:0;right:0;
  padding:calc(env(safe-area-inset-top) + 10px) 14px 10px;
  background:var(--glass);backdrop-filter:blur(28px) saturate(140%);
  border-bottom:1px solid var(--border);z-index:1200;
  display:flex;align-items:center;justify-content:space-between;
}
#app-logo{font-weight:800;letter-spacing:.06em;font-size:18px}
.header-right{display:flex;align-items:center;gap:8px}
.icon-button{
  width:44px;height:40px;border-radius:10px;border:none;
  background:transparent;color:var(--fg);font-size:18px;
  display:inline-flex;align-items:center;justify-content:center;
  -webkit-tap-highlight-color:transparent;cursor:pointer;
}

/* Main â€” padding will be set dynamically by JS */
main{
  position:relative;
  min-height:100dvh; overflow-y:auto; -webkit-overflow-scrolling:touch;
  z-index:1; padding-left:16px;padding-right:16px;
}

/* Card */
.card{
  background:var(--glass);border:1px solid var(--border);
  border-radius:var(--radius);padding:14px;margin-bottom:16px;
}
.card h3{margin:0 0 10px;font-size:17px}

/* labels and inputs */
.field-label{display:block;color:var(--sub);font-size:12px;margin-top:10px}
.input,select,textarea{
  width:100%;padding:12px;border-radius:12px;border:none;margin-top:6px;
  background:rgba(255,255,255,.03);color:var(--fg);font-size:15px;
  outline:none;-webkit-appearance:none;appearance:none;
}
.select-wrap{position:relative}
.select-wrap::after{
  content:'â–¾';position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--sub);
  pointer-events:none;font-size:14px;
}

/* fixed primary button above footer */
.fixed-action{
  position:fixed;left:12px;right:12px;bottom:calc(env(safe-area-inset-bottom) + 12px);
  z-index:1400;display:flex;justify-content:center;pointer-events:auto;
}
.btn-primary{
  width:100%;max-width:920px;height:var(--btn-height);border-radius:28px;border:none;
  background:var(--accent);color:#000;font-weight:800;font-size:17px;cursor:pointer;
  box-shadow:0 8px 26px rgba(0,240,255,.08);
}

/* footer: we still show it but it must not intercept taps where fixed button sits */
footer#site-footer{
  position:fixed;left:0;right:0;bottom:0;padding:10px 12px calc(env(safe-area-inset-bottom)+10px);
  text-align:center;font-size:12px;color:var(--sub);
  background:linear-gradient(rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  border-top:1px solid rgba(255,255,255,0.02);
  z-index:1200;
  pointer-events:none; /* avoid intercepting fixed button */
}

/* small styling */
.small{font-size:13px;color:var(--sub)}
.warning{color:#FFD36A;font-size:12px;margin-top:6px}

/* modal */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:1500;display:flex;align-items:center;justify-content:center;
}
.modal{
  width:calc(100% - 48px);max-width:720px;background:var(--bg);border-radius:14px;padding:16px;border:1px solid var(--border);
}

/* accessibility focus */
.icon-button:focus, .btn-primary:focus, .input:focus { outline:2px solid rgba(0,240,255,.12); outline-offset:2px; }

/* desktop tweak */
@media (min-width:760px){
  main{max-width:760px;margin:0 auto;padding-left:24px;padding-right:24px}
  .fixed-action{left:calc(50% - 380px);right:auto; width:760px; transform:translateX(-50%);}
}
</style>
</head>
<body>
<header id="site-header" role="banner">
  <div style="display:flex;align-items:center;gap:10px">
    <div id="app-logo">NEXA</div>
    <div class="small" style="opacity:.95">ä½å±…ç”¨ä¸å‹•ç”£ãƒ»åˆ¤å®šãƒ­ã‚°</div>
  </div>
  <div class="header-right">
    <button id="btn-history" class="icon-button" title="å±¥æ­´" aria-label="å±¥æ­´">ğŸ•˜</button>
    <button id="btn-settings" class="icon-button" title="è¨­å®š" aria-label="è¨­å®š">â‹¯</button>
  </div>
</header>

<main id="main">
  <section class="card" id="card-input">
    <h3>å…¥åŠ›</h3>

    <label class="field-label" for="price">ç‰©ä»¶ä¾¡æ ¼ï¼ˆä¸‡å††ï¼‰</label>
    <input id="price" class="input" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š3080">

    <label class="field-label" for="area">å°‚æœ‰é¢ç©ï¼ˆã¡ï¼‰</label>
    <input id="area" class="input" type="number" placeholder="ä¾‹ï¼š58">

    <label class="field-label" for="built">ç¯‰å¹´ï¼ˆè¥¿æš¦ï¼‰</label>
    <input id="built" class="input" type="number" placeholder="ä¾‹ï¼š1998">

    <label class="field-label" for="fees">ç®¡ç†è²»ï¼ˆæœˆé¡ãƒ»å††ï¼‰</label>
    <input id="fees" class="input" type="number" placeholder="ä¾‹ï¼š15000">

    <label class="field-label" for="repair">ä¿®ç¹•ç©ç«‹é‡‘ï¼ˆæœˆé¡ãƒ»å††ï¼‰</label>
    <input id="repair" class="input" type="number" placeholder="ä¾‹ï¼š15000">

    <label class="field-label" for="other">ãã®ä»–æœˆé¡è²»ç”¨ï¼ˆãƒãƒƒãƒˆãƒ»å…±è´ç­‰ãƒ»å††ï¼‰</label>
    <input id="other" class="input" type="number" placeholder="ä¾‹ï¼š0">
  </section>

  <section class="card" id="card-household">
    <h3>ä¸–å¸¯ãƒ»ãƒ­ãƒ¼ãƒ³</h3>

    <label class="field-label" for="income">ä¸–å¸¯å¹´åï¼ˆä¸‡å††ï¼‰</label>
    <input id="income" class="input" type="number" placeholder="ä¾‹ï¼š850">

    <label class="field-label" for="ageOrDob">è³¼å…¥æ™‚å¹´é½¢ï¼ˆä»£è¡¨è€…ï¼‰ ã¾ãŸã¯ ç”Ÿå¹´æœˆæ—¥ï¼ˆYYYY-MM-DDï¼‰</label>
    <input id="ageOrDob" class="input" type="text" placeholder="ä¾‹ï¼š35 ã¾ãŸã¯ 1990-04-12">

    <label class="field-label" for="loanType">ãƒ­ãƒ¼ãƒ³å½¢æ…‹</label>
    <select id="loanType" class="input">
      <option value="solo">å˜ç‹¬ãƒ­ãƒ¼ãƒ³</option>
      <option value="pair">ãƒšã‚¢ãƒ­ãƒ¼ãƒ³</option>
      <option value="combined">åå…¥åˆç®—</option>
    </select>

    <label class="field-label" for="loanYears">ãƒ­ãƒ¼ãƒ³æœŸé–“ï¼ˆå¹´ï¼‰ â€” é¸æŠã—ã¦ãã ã•ã„</label>
    <div style="display:flex;gap:10px;align-items:center">
      <div style="flex:1;position:relative">
        <select id="loanYears" class="input" aria-label="ãƒ­ãƒ¼ãƒ³æœŸé–“">
          <option value="5">5</option><option value="10">10</option><option value="15">15</option>
          <option value="20">20</option><option value="25" selected>25</option><option value="30">30</option>
          <option value="35">35</option><option value="40">40</option><option value="45">45</option>
        </select>
        <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--sub);pointer-events:none">å¹´ â–¾</div>
      </div>
      <div style="width:120px">
        <label class="field-label" for="down">é ­é‡‘ï¼ˆä¸‡å††ï¼‰</label>
        <input id="down" class="input" type="number" placeholder="ä¾‹ï¼š400">
      </div>
    </div>
  </section>

  <section class="card" id="card-location">
    <h3>ç«‹åœ°ãƒ»é€šå‹¤ï¼ˆä»»æ„ï¼‰</h3>
    <label class="field-label" for="address">ç‰©ä»¶ä½æ‰€ï¼ˆéƒµä¾¿ç•ªå· or ä½æ‰€ï¼‰</label>
    <input id="address" class="input" type="text" placeholder="ä¾‹ï¼šæ±äº¬éƒ½æ¸¯åŒºèŠå¤§é–€1-1-30">

    <label class="field-label" for="stations">æœ€å¯„ã‚Šé§…ï¼ˆè¤‡æ•°å¯ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
    <input id="stations" class="input" type="text" placeholder="ä¾‹ï¼šå¤§é–€, æµœæ¾ç”º">

    <label class="field-label" for="commutes">é€šå‹¤å…ˆï¼ˆè¤‡æ•°å¯ï¼‰</label>
    <input id="commutes" class="input" type="text" placeholder="ä¾‹ï¼šè·å ´A, è·å ´B">
  </section>

  <section class="card" id="card-result" style="display:none">
    <h3>è©•ä¾¡çµæœ</h3>
    <div id="result-summary" style="font-weight:700;margin-bottom:8px"></div>
    <div style="display:flex;gap:14px;margin-bottom:12px">
      <div style="flex:1">
        <div class="small">æ¨å®šãƒ©ãƒ³ã‚¯</div>
        <div id="result-rank" style="font-size:22px;font-weight:800">â€”</div>
      </div>
      <div style="width:150px">
        <div class="small">å†…éƒ¨è©¦è¡Œæ•°</div>
        <div id="result-trials" style="font-size:16px">â€”</div>
      </div>
    </div>
    <div class="small">æƒ³å®šã•ã‚Œã‚‹ä¸–ç•Œç·š</div>
    <ul id="result-worldlines" style="margin:8px 0 12px;color:var(--fg)"></ul>
    <div class="small">å½±éŸ¿ãŒå¤§ãã„è¦å› </div>
    <ul id="result-factors" style="margin:8px 0 6px;color:var(--fg)"></ul>
  </section>

  <section class="card" id="card-history" style="display:none">
    <h3>è©•ä¾¡å±¥æ­´</h3>
    <div id="history-list" class="small">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
  </section>
</main>

<div class="fixed-action" id="fixed-action">
  <button id="btn-evaluate" class="btn-primary" aria-label="è©•ä¾¡ã™ã‚‹">è©•ä¾¡ã™ã‚‹</button>
</div>

<footer id="site-footer">
  <span>Â© Yoshinobu Takamitsu ï½œ æœ¬ã‚¢ãƒ—ãƒªã¯åˆ¤æ–­ææ–™ã®æ•´ç†ã‚’ç›®çš„ã¨ã—ã€çµæœã‚’ä¿è¨¼ã—ã¾ã›ã‚“</span>
</footer>

<!-- modal root -->
<div id="modal-root" aria-hidden="true"></div>

<script>
/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const parseJSON = s=>{ try{return JSON.parse(s)}catch(e){return null} };

/* ---------- Storage / DB ---------- */
const FORM_KEY = 'nexa_form_v2';
const DB_NAME = 'nexa_db_v2';
const STORE = 'results';
let _db = null;
function openDB(){ return new Promise((res,rej)=>{
  if(_db) return res(_db);
  const r = indexedDB.open(DB_NAME,1);
  r.onupgradeneeded = e=>{ const db = e.target.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE,{keyPath:'id'}); };
  r.onsuccess = e=>{ _db = e.target.result; res(_db); };
  r.onerror = e=>rej(e);
}); }
async function saveResult(obj){ await openDB(); return new Promise((res,rej)=>{ const tx = _db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(obj); tx.oncomplete = ()=>res(); tx.onerror = e=>rej(e); }); }
async function loadAll(){ await openDB(); return new Promise(res=>{ const tx = _db.transaction(STORE,'readonly'); const req = tx.objectStore(STORE).getAll(); req.onsuccess = e=>res(e.target.result||[]); }); }

/* ---------- autosave / restore ---------- */
function saveForm(){
  const s = {
    price: $('price').value, area:$('area').value, built:$('built').value,
    fees:$('fees').value, repair:$('repair').value, other:$('other').value,
    income:$('income').value, ageOrDob:$('ageOrDob').value, loanType:$('loanType').value,
    loanYears:$('loanYears').value, down:$('down').value,
    address:$('address').value, stations:$('stations').value, commutes:$('commutes').value
  };
  localStorage.setItem(FORM_KEY, JSON.stringify(s));
}
function restoreForm(){
  const s = parseJSON(localStorage.getItem(FORM_KEY))||{};
  Object.keys(s).forEach(k=>{ const el = $(k); if(el) el.value = s[k]||''; });
}
function bindAutosave(){ document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', saveForm, {passive:true})); }

/* ---------- layout adjust ---------- */
function adjustLayout(){
  const headerH = $('site-header').offsetHeight || 88;
  const fixedH = $('fixed-action').offsetHeight || 80;
  // set main padding
  const main = document.querySelector('main');
  main.style.paddingTop = (headerH + 12) + 'px';
  main.style.paddingBottom = (fixedH + 24) + 'px';
  // ensure fixed-action bottom respects safe area (handled by CSS calc with env)
}
window.addEventListener('resize', adjustLayout);
window.addEventListener('orientationchange', ()=>setTimeout(adjustLayout,300));

/* ---------- core calc ---------- */
function uid(){ return crypto.randomUUID(); }
function calcMonthly(principalYen, years, annualRate){
  const n = years * 12;
  const r = annualRate / 12;
  if(r === 0) return principalYen / n;
  return principalYen * (r / (1 - Math.pow(1+r, -n)));
}
function monteCarlo(base,trials){
  let stable=0, stress=0;
  for(let i=0;i<trials;i++){
    const ishock = 1 + (Math.random()-0.5)*0.4;
    const fshock = 1 + Math.random()*0.25;
    const monthly = base.monthlyLoan * ishock + base.monthlyFees * fshock;
    if(monthly < base.safe) stable++;
    if(monthly > base.danger) stress++;
  }
  return { stableRatio: stable/trials, stressRatio: stress/trials };
}
function sensitivity(input){
  const arr = [{name:'ç‰©ä»¶ä¾¡æ ¼', w: input.priceWan},{name:'å›ºå®šè²»', w: input.monthlyFees},{name:'ä¸–å¸¯å¹´å', w: input.incomeWan}];
  return arr.sort((a,b)=>b.w-a.w).slice(0,3).map(x=>x.name);
}

/* ---------- run evaluation and UI render ---------- */
async function runEvaluation(){
  const priceWan = Number($('price').value || 0);
  const priceYen = priceWan * 10000;
  const area = Number($('area').value || 0);
  const fees = Number($('fees').value || 0);
  const repair = Number($('repair').value || 0);
  const other = Number($('other').value || 0);
  const monthlyFees = fees + repair + other;
  const incomeWan = Number($('income').value || 0);
  const incomeYen = incomeWan * 10000;
  const loanYears = Number($('loanYears').value || 25);
  const downWan = Number($('down').value || 0);
  const downYen = downWan * 10000;
  const principal = Math.max(0, priceYen - downYen);
  const annualRate = 0.005; // baseline 0.5%
  const monthlyLoan = calcMonthly(principal, loanYears, annualRate);
  const safe = incomeYen / 12 * 0.25;
  const danger = incomeYen / 12 * 0.4;

  // trials adapt
  let trials = 3000;
  try{ if(navigator.deviceMemory && navigator.deviceMemory < 2) trials = 1500; }catch(e){}

  const mc = monteCarlo({ monthlyLoan, monthlyFees, safe, danger }, trials);
  let rank='B', summary='æ…é‡ãªæ¤œè¨ãŒå¿…è¦ã§ã™ã€‚';
  if(mc.stableRatio > 0.75){ rank='A'; summary='å‰æå¤‰åŒ–ã«å¯¾ã—ã¦æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ã¾ã™ã€‚'; }
  if(mc.stressRatio > 0.4){ rank='C'; summary='æ¡ä»¶æ‚ªåŒ–æ™‚ã®å½±éŸ¿ãŒå¤§ãã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'; }

  const factors = sensitivity({ priceWan, monthlyFees, incomeWan });
  const worldlines = [
    {name:'å‰æç¶™ç¶š', text: mc.stableRatio>0.7 ? 'æ¡ä»¶ãŒç¶šã‘ã°æ¯”è¼ƒçš„å®‰å®š' : 'å‰æãŒç¶šã„ã¦ã‚‚æ³¨æ„ãŒå¿…è¦'},
    {name:'æ¡ä»¶æ‚ªåŒ–', text: mc.stressRatio>0.3 ? 'æ‚ªåŒ–æ™‚ã«è² æ‹…å¢—' : 'å¤šå°‘ã®æ‚ªåŒ–ã§å³ç ´ç¶»ã—ã«ãã„'},
    {name:'æ¡ä»¶æ”¹å–„', text: 'åå…¥å¢—ã‚„é ­é‡‘ã§é¸æŠè‚¢ãŒåºƒãŒã‚‹'}
  ];

  const result = { id: uid(), time: new Date().toISOString(), input:{priceWan,area,monthlyFees,incomeWan,loanYears,downWan}, rank, summary, trials, mc, factors, worldlines };

  // render
  $('card-result').style.display = 'block';
  $('result-summary').textContent = result.summary;
  $('result-rank').textContent = result.rank;
  $('result-trials').textContent = 'ç´„ ' + result.trials.toLocaleString() + ' é€šã‚Š';
  $('result-worldlines').innerHTML = result.worldlines.map(w=>`<li><strong>${w.name}</strong>ï¼š ${w.text}</li>`).join('');
  $('result-factors').innerHTML = result.factors.map(f=>`<li>${f}</li>`).join('');

  // save
  try{ await saveResult(result); }catch(e){ console.warn(e); }

  // scroll result into view
  document.querySelector('#card-result').scrollIntoView({ behavior:'smooth', block:'center' });

  return result;
}

/* ---------- UI wiring ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // layout adjust
  adjustLayout();
  setTimeout(adjustLayout, 120); // small delay for safe-area to settle

  // restore and autosave
  restoreForm();
  bindAutosave();

  // eval button
  const btn = $('btn-evaluate');
  btn.addEventListener('click', async ()=>{
    if(btn.disabled) return;
    try{
      btn.disabled = true; btn.textContent = 'è©•ä¾¡ä¸­â€¦';
      await runEvaluation();
    }catch(e){ console.error(e); alert('è©•ä¾¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
    btn.disabled = false; btn.textContent = 'è©•ä¾¡ã™ã‚‹';
  }, {passive:false});

  // history button
  $('btn-history').addEventListener('click', async ()=>{
    const h = $('card-history');
    if(h.style.display === 'block'){ h.style.display = 'none'; return; }
    const list = await loadAll();
    const box = $('history-list');
    if(!list.length) box.textContent = 'å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“';
    else box.innerHTML = list.slice(-12).reverse().map(r=>`<div style="padding:8px;background:rgba(255,255,255,.02);border-radius:8px;margin-bottom:8px"><div style="font-weight:700">${r.rank} ï¼ ${r.summary}</div><div class="small">${new Date(r.time).toLocaleString()}</div></div>`).join('');
    h.style.display = 'block';
    h.scrollIntoView({behavior:'smooth', block:'center'});
  }, {passive:true});

  // settings
  $('btn-settings').addEventListener('click', ()=>{ openSettings(); }, {passive:true});
});

/* ---------- settings modal (light) ---------- */
function openSettings(){
  const root = $('modal-root');
  root.innerHTML = `<div class="modal-backdrop"><div class="modal"><h3 style="margin-top:0">è¨­å®š</h3>
    <label><input id="opt-trials" type="checkbox" checked> å†…éƒ¨è©¦è¡Œæ•°ã‚’è¡¨ç¤º</label>
    <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="close-set" class="icon-button">é–‰ã˜ã‚‹</button></div></div></div>`;
  $('close-set').addEventListener('click', ()=>{ root.innerHTML=''; }, {passive:true});
}
</script>
</body>
</html>