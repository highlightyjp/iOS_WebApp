<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>NEXA</title>

<style>
:root{
  --bg:#050A14;--fg:#E6F1FF;--sub:#8FA3BF;--accent:#00F0FF;
  --glass:rgba(18,28,54,.55);--border:rgba(255,255,255,.08)
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--fg);
font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif}
body{overflow:hidden}
header,footer{
  position:fixed;left:0;right:0;
  backdrop-filter:blur(26px);background:var(--glass);
  border-bottom:1px solid var(--border);z-index:10
}
header{top:0;padding:calc(env(safe-area-inset-top)+10px) 14px}
footer{bottom:0;padding:8px 14px calc(env(safe-area-inset-bottom)+8px);
font-size:11px;color:var(--sub);text-align:center}
main{
  padding:calc(env(safe-area-inset-top)+86px) 14px calc(env(safe-area-inset-bottom)+140px);
  min-height:100dvh;overflow-y:auto
}
.glass{background:var(--glass);border:1px solid var(--border);
border-radius:16px;padding:14px;margin-bottom:14px}
input,button{
  width:100%;padding:12px;border-radius:14px;border:none;font-size:16px
}
input{background:rgba(255,255,255,.06);color:var(--fg)}
button{background:var(--accent);color:#000;font-weight:700}
.secondary{background:rgba(255,255,255,.14);color:var(--fg)}
.rank{font-size:42px;font-weight:900;color:var(--accent)}
.note{font-size:13px;color:var(--sub);line-height:1.6}
.hidden{display:none}
.icon{background:none;border:none;color:var(--fg);font-size:22px}
</style>
</head>

<body>
<header>
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:700;letter-spacing:.04em">NEXA</div>
    <button class="icon" id="openHistory">⧉</button>
  </div>
</header>

<main>
<section id="input">
  <div class="glass">
    <h2>物件・世帯</h2>
    <input id="price" placeholder="価格（万円）">
    <input id="income" placeholder="世帯年収（万円）">
  </div>
  <button onclick="evaluate()">評価する</button>
</section>

<section id="result" class="hidden">
  <div class="glass">
    <div class="rank" id="rank"></div>
    <div class="note" id="summary"></div>
  </div>
  <div class="glass">
    <h3>判断の経緯</h3>
    <div class="note" id="detail"></div>
  </div>
  <button class="secondary" onclick="exportPDF()">PDF出力</button>
  <button class="secondary" onclick="back()">戻る</button>
</section>

<section id="history" class="hidden">
  <div class="glass">
    <h2>過去の評価</h2>
    <div id="historyList" class="note"></div>
  </div>
  <button class="secondary" onclick="closeHistory()">閉じる</button>
</section>
</main>

<footer>
© Yoshinobu Takamitsu ｜ 本アプリは判断材料の整理を目的とします
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ===== IndexedDB ===== */
let db;
const req=indexedDB.open("nexaDB",1);
req.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("worlds",{keyPath:"id"});
};
req.onsuccess=e=>db=e.target.result;

/* ===== Core ===== */
function evaluate(){
  const p=+price.value||0,i=+income.value||0;
  const trials=Math.min(20000,Math.max(5000,Math.floor(performance.now()*3)));
  const rank=p<i*7?"A":"B";
  const summary=rank==="A"
    ?"現条件では将来負担が大きく崩れにくい傾向が見られました。"
    :"条件変化時に注意が必要です。";
  const detail=`本評価は金利・費用条件を変化させた約${trials.toLocaleString()}通りの内部試行に基づき整理されています。`;

  rankEl.textContent=rank;
  summaryEl.textContent=summary;
  detailEl.textContent=detail;

  const world={id:crypto.randomUUID(),rank,summary,detail,time:new Date().toISOString()};
  db.transaction("worlds","readwrite").objectStore("worlds").add(world);

  input.classList.add("hidden");
  result.classList.remove("hidden");
}

function back(){
  result.classList.add("hidden");
  input.classList.remove("hidden");
}

/* ===== History ===== */
openHistory.onclick=()=>{
  history.classList.remove("hidden");
  input.classList.add("hidden");
  result.classList.add("hidden");
  const store=db.transaction("worlds").objectStore("worlds");
  store.getAll().onsuccess=e=>{
    historyList.innerHTML=e.target.result.map(w=>
      `<div>${new Date(w.time).toLocaleString()}：${w.rank}</div>`).join("");
  };
};
function closeHistory(){
  history.classList.add("hidden");
  input.classList.remove("hidden");
}

/* ===== PDF ===== */
async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("NEXA 評価レポート",10,20);
  pdf.text(`ランク：${rankEl.textContent}`,10,35);
  pdf.text(summaryEl.textContent,10,50);
  pdf.text(detailEl.textContent,10,70);
  pdf.text("© Yoshinobu Takamitsu",10,285);
  pdf.save("nexa_report.pdf");
}

/* Shortcuts */
const rankEl=document.getElementById("rank");
const summaryEl=document.getElementById("summary");
const detailEl=document.getElementById("detail");
</script>
</body>
</html>