<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ESTATE OS | Ver 100.0</title>
<style>
  :root {
    --bg: #0a0a0a; --panel: #141414; --border: #333; --text: #ccc;
    --acc-main: #00ff9d; --acc-warn: #ff3333; --acc-gold: #d4af37;
    --font-mono: "SF Mono", "Hiragino Sans", "Yu Gothic", monospace;
  }
  * { box-sizing: border-box; touch-action: manipulation; }
  body { background: var(--bg); color: var(--text); font-family: var(--font-mono); margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
  
  /* Layout */
  #app-shell { display: flex; flex: 1; overflow: hidden; }
  #sidebar { width: 320px; background: var(--panel); border-right: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; z-index: 10; }
  #main-view { flex: 1; position: relative; display: flex; flex-direction: column; background: #000; }
  
  /* Components */
  .header { padding: 12px; border-bottom: 1px solid var(--border); font-size: 12px; letter-spacing: 2px; color: var(--acc-main); display: flex; justify-content: space-between; align-items: center; }
  .section { padding: 16px; border-bottom: 1px solid var(--border); }
  .label { font-size: 10px; color: #666; margin-bottom: 4px; display: block; }
  .value-disp { font-size: 14px; color: #fff; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }
  
  /* Inputs */
  input[type="range"] { width: 100%; background: transparent; -webkit-appearance: none; cursor: pointer; }
  input[type="range"]::-webkit-slider-runnable-track { background: #333; height: 2px; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; background: var(--acc-main); width: 12px; height: 12px; margin-top: -5px; border-radius: 0; }
  input[type="text"], select { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; font-family: inherit; font-size: 12px; }
  input:focus { border-color: var(--acc-main); outline: none; }
  
  /* Buttons & Tabs */
  .btn-group { display: flex; gap: 4px; margin-bottom: 10px; }
  .btn { flex: 1; background: #222; border: 1px solid var(--border); color: #888; padding: 8px; font-size: 10px; cursor: pointer; text-align: center; transition: 0.2s; }
  .btn.active { background: var(--acc-main); color: #000; font-weight: bold; border-color: var(--acc-main); }
  .btn.warn { border-color: var(--acc-warn); color: var(--acc-warn); }
  .btn:active { transform: translateY(1px); }

  /* Map & Result */
  #map-canvas { width: 100%; height: 100%; display: block; }
  #overlay-ui { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); border: 1px solid var(--acc-main); padding: 10px; width: 200px; font-size: 10px; display: none; }
  
  /* Indicators */
  .score-box { text-align: center; padding: 20px 0; border-bottom: 1px solid var(--border); }
  .score-val { font-size: 42px; font-weight: bold; color: var(--acc-main); text-shadow: 0 0 10px rgba(0,255,157,0.3); }
  .score-label { font-size: 10px; letter-spacing: 1px; }
  
  /* Utilities */
  .hidden { display: none !important; }
  .tag { display: inline-block; padding: 2px 4px; font-size: 9px; border: 1px solid #444; margin-right: 4px; }
  .tag.blue { border-color: cyan; color: cyan; }
  .tag.gold { border-color: var(--acc-gold); color: var(--acc-gold); }

  /* Mobile */
  @media (max-width: 768px) { #app-shell { flex-direction: column; } #sidebar { width: 100%; height: 50vh; } }
</style>
</head>
<body>

<script>
/** * ESTATE OS CORE (Ver 100.0)
 * Logic: Physics, Calculus, Stat, Law
 * Arch: Procedural Generation & Vector Analysis
 */

// --- 1. COMPRESSED MASTER DATA (PROCEDURAL) ---
const M = {
  // Hubs: [Name, Lat, Lon, Rank(0:S,1:A,2:B), Lines(Bitmask)]
  hubs: [
    ["東京", 35.6812, 139.7671, 0, 255], ["新宿", 35.6896, 139.7005, 0, 255],
    ["横浜", 35.4657, 139.6223, 0, 127], ["武蔵小杉", 35.5768, 139.6596, 0, 63],
    ["大宮", 35.9063, 139.6240, 0, 63], ["川崎", 35.5313, 139.6974, 1, 31],
    ["二子玉川", 35.6117, 139.6266, 1, 16], ["豊洲", 35.6550, 139.7960, 1, 8],
    ["立川", 35.6980, 139.4137, 1, 15], ["海浜幕張", 35.6484, 140.0419, 2, 4],
    ["大門", 35.6568, 139.7548, 1, 12], ["五反田", 35.6264, 139.7236, 1, 14]
  ],
  // Physics Constants: [BasePrice, DecayRate(RC/Wood), Inflation]
  phys: { base: 1000, rc: -0.015, wood: -0.035, inf: 0.005 },
  // Line Physics: [Speed(km/h), Accel, Comfort]
  lines: { subway: [35, 0.6, 0.8], jr: [55, 0.8, 0.9], exp: [80, 0.9, 1.0] }
};

// --- 2. VECTOR & PHYSICS ENGINE ---
const Vec = {
  dist: (x1, y1, x2, y2) => Math.sqrt((x1-x2)**2 + (y1-y2)**2) * 111, // km approx
  time: (dist, type) => {
    const [v, a, c] = M.lines[type] || M.lines.jr;
    return (dist / v * 60) + (dist * 0.5); // Minutes (Kinematic approx)
  },
  psi: (p, s, t, stress) => {
    // Ψ Equation: Integral(Financial Mass * Life Density)
    let sum = 0;
    const years = 35;
    const monthlyStress = 1 / (1 + 0.1 * (stress**2)); // Weber-Fechner Law
    for(let y=0; y<years; y++) {
      const val = p * Math.exp((M.phys.inf + M.phys.rc) * y); // Asset Curve
      const loan = Math.max(0, p * (1 - y/years)); // Linear Payoff
      const mass = val - loan;
      sum += (mass * (s**0.6) * monthlyStress); // Integration
    }
    return Math.floor(sum / 1000); // Normalized Score
  }
};

// --- 3. STATE MANAGEMENT ---
const State = {
  slot: 0,
  data: [{}, {}, {}], // 3 Slots
  mode: 'AUDIT', // AUDIT, MAP, TARGET
  ui: {},
  
  init() {
    this.data = this.data.map(() => ({
      price: 6000, size: 70, dist: 5, station: "横浜",
      work: "大門", income: 1000, cash: 500
    }));
    this.render();
    this.loop();
  },

  // Main Simulation Loop (60fps Logic)
  loop() {
    if(this.mode === 'AUDIT' || this.mode === 'TARGET') {
      const d = this.data[this.slot];
      
      // 1. Locate (Procedural Matching)
      const stObj = M.hubs.find(h => h[0] === d.station) || M.hubs[0];
      const wkObj = M.hubs.find(h => h[0] === d.work) || M.hubs[10];
      
      // 2. Physics (Distance & Time)
      const dist = Vec.dist(stObj[1], stObj[2], wkObj[1], wkObj[2]);
      const time = Vec.time(dist, dist > 15 ? 'exp' : 'subway') + (d.dist * 1.5);
      
      // 3. Stress Vector
      const stress = (time / 60) + (dist > 30 ? 0.5 : 0);
      
      // 4. Calculate Ψ
      const psi = Vec.psi(d.price, d.size, 35, stress);
      
      // 5. Update UI
      UI.update(psi, time|0, dist|0, d);
      
      // 6. Reverse Targeting (If Active)
      if(this.mode === 'TARGET') Target.calc(d, psi);
    }
    requestAnimationFrame(() => this.loop());
  }
};

// --- 4. UI CONTROLLER ---
const UI = {
  els: {},
  setup() {
    ['price','size','dist','income','cash'].forEach(k => {
      const sl = document.getElementById('in-'+k);
      const dp = document.getElementById('disp-'+k);
      sl.addEventListener('input', e => {
        State.data[State.slot][k] = parseFloat(e.target.value);
        dp.innerText = State.data[State.slot][k].toLocaleString();
      });
      this.els[k] = {sl, dp};
    });
    
    // Slot Switch
    document.querySelectorAll('.slot-btn').forEach((b, i) => {
      b.addEventListener('click', () => {
        State.slot = i;
        State.render(); // Load Slot Data
        document.querySelectorAll('.slot-btn').forEach(bb=>bb.classList.remove('active'));
        b.classList.add('active');
      });
    });

    // Tab Switch
    document.querySelectorAll('.tab-btn').forEach(b => {
      b.addEventListener('click', () => {
        State.mode = b.dataset.mode;
        document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
        document.getElementById('view-'+State.mode.toLowerCase()).classList.remove('hidden');
        if(State.mode === 'MAP') MapEng.draw();
      });
    });
  },
  
  update(score, time, km, d) {
    const grade = score > 1000 ? 'S' : score > 700 ? 'A' : score > 400 ? 'B' : 'E';
    const color = grade === 'S' ? 'var(--acc-gold)' : grade === 'E' ? 'var(--acc-warn)' : 'var(--acc-main)';
    
    document.getElementById('score-val').innerText = grade;
    document.getElementById('score-val').style.color = color;
    document.getElementById('score-pts').innerText = `Ψ-Index: ${score}`;
    
    // Logic/Feedback
    let msg = `[物理演算完了] 職場まで${km}km / 所要${time}分`;
    if(time > 60) msg += ` ⚠️通勤負荷高`;
    if(d.price > d.income * 7 + d.cash) msg = `⚠️ 財務警告: 危険水域 (倍率 ${(d.price/d.income).toFixed(1)}x)`;
    
    document.getElementById('console-out').innerText = msg;
    
    // Bar Charts
    const assetH = Math.min(100, score/12);
    document.getElementById('bar-asset').style.height = assetH + '%';
    document.getElementById('bar-asset').style.background = color;
  }
};

// --- 5. MAP ENGINE (CANVAS) ---
const MapEng = {
  ctx: null,
  init() {
    const cvs = document.getElementById('map-canvas');
    cvs.width = cvs.clientWidth; cvs.height = cvs.clientHeight;
    this.ctx = cvs.getContext('2d');
    
    // Interaction
    cvs.addEventListener('click', e => {
      // Hit Test (Simple)
      const rect = cvs.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      this.checkHit(x, y);
    });
  },
  
  draw() {
    if(!this.ctx) this.init();
    const c = this.ctx;
    const w = c.canvas.width, h = c.canvas.height;
    
    // BG
    c.fillStyle = '#050505'; c.fillRect(0,0,w,h);
    
    // Grid
    c.strokeStyle = '#222'; c.lineWidth = 1;
    for(let i=0; i<w; i+=50) { c.beginPath(); c.moveTo(i,0); c.lineTo(i,h); c.stroke(); }
    for(let i=0; i<h; i+=50) { c.beginPath(); c.moveTo(0,i); c.lineTo(w,i); c.stroke(); }
    
    // Draw Hubs
    M.hubs.forEach(hub => {
      // Map LatLon to XY (Simplified projection for Tokyo)
      const cx = (hub[2] - 139.3) * 600; 
      const cy = h - ((hub[1] - 35.3) * 600);
      
      // Draw Node
      const rank = hub[3];
      c.fillStyle = rank === 0 ? '#d4af37' : rank === 1 ? 'cyan' : '#444';
      c.beginPath(); c.arc(cx, cy, rank===0?6:4, 0, Math.PI*2); c.fill();
      
      // Label
      c.fillStyle = '#888'; c.font = '10px monospace';
      c.fillText(hub[0], cx+8, cy+3);
      
      // Hazard Ring (Simulation)
      if(hub[1] < 35.6 && hub[2] > 139.7) { // Bay Area
        c.strokeStyle = 'rgba(255,0,0,0.3)';
        c.beginPath(); c.arc(cx, cy, 20, 0, Math.PI*2); c.stroke();
      }
    });
  },
  
  checkHit(mx, my) {
    // Logic to select station on click
    document.getElementById('overlay-ui').style.display = 'block';
    document.getElementById('overlay-ui').innerHTML = `戦略座標取得<br>X:${mx|0} Y:${my|0}`;
  }
};

// --- 6. REVERSE TARGETING ENGINE ---
const Target = {
  calc(d, currentPsi) {
    const el = document.getElementById('target-res');
    if(currentPsi > 800) {
      el.innerHTML = `<span style="color:var(--acc-main)">GOAL REACHED</span><br>現年収でSランク到達可能`;
      return;
    }
    // Binary Search for Required Income
    let low = d.income, high = 5000, req = high;
    for(let i=0; i<20; i++) { // Max 20 iterations
      let mid = (low+high)/2;
      let ratio = d.price / (mid + d.cash/10); // Simplified logic
      if (ratio < 5) high = mid; else low = mid; // 5x rule
    }
    req = Math.floor(high);
    el.innerHTML = `必要世帯年収: <span style="color:#fff">${req}万円</span><br>不足: ${(req - d.income)}万円`;
  }
};

// --- 7. API HANDLER (ONLINE) ---
const API = {
  async getGeo(addr) {
    try {
      // Pseudo-code for GSI API (Functional structure)
      // const res = await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${addr}`);
      // On success: Update State.data.lat/lon
      console.log("API: Geo fetch triggered for " + addr);
    } catch(e) { console.error("Offline Mode"); }
  }
};

window.onload = () => { UI.setup(); State.init(); };

</script>

<div id="app-shell">
  <div id="sidebar">
    <div class="header">
      <span>ESTATE OS</span>
      <span style="font-size:9px; border:1px solid #333; padding:2px;">v100.0</span>
    </div>
    
    <div class="section">
      <span class="label">COMPARISON SLOTS</span>
      <div class="btn-group">
        <div class="btn slot-btn active">CASE 01</div>
        <div class="btn slot-btn">CASE 02</div>
        <div class="btn slot-btn">CASE 03</div>
      </div>
    </div>

    <div class="section">
      <span class="label">PROPERTY VALUE (万円)</span>
      <div class="value-disp" id="disp-price">6,000</div>
      <input type="range" id="in-price" min="2000" max="20000" step="100" value="6000">
      
      <span class="label" style="margin-top:12px;">SIZE (㎡)</span>
      <div class="value-disp" id="disp-size">70</div>
      <input type="range" id="in-size" min="30" max="150" step="1" value="70">

      <span class="label" style="margin-top:12px;">DISTANCE (min)</span>
      <div class="value-disp" id="disp-dist">5</div>
      <input type="range" id="in-dist" min="1" max="30" step="1" value="5">
      
      <span class="label" style="margin-top:12px;">STATION & WORK (AUTO)</span>
      <div style="display:flex; gap:5px;">
        <input type="text" value="横浜" onchange="State.data[State.slot].station=this.value">
        <span style="padding-top:8px;">to</span>
        <input type="text" value="大門" onchange="State.data[State.slot].work=this.value">
      </div>
    </div>

    <div class="section">
      <span class="label">HOUSEHOLD INCOME (万円)</span>
      <div class="value-disp" id="disp-income">1,000</div>
      <input type="range" id="in-income" min="400" max="3000" step="50" value="1000">

      <span class="label" style="margin-top:12px;">CASH / EQUITY (万円)</span>
      <div class="value-disp" id="disp-cash">500</div>
      <input type="range" id="in-cash" min="0" max="5000" step="50" value="500">
    </div>

    <div class="section">
      <div class="btn-group">
        <div class="btn" onclick="prompt('JSON Export:', JSON.stringify(State.data))">BACKUP</div>
        <div class="btn warn" onclick="if(confirm('Reset?')) location.reload()">RESET</div>
      </div>
    </div>
  </div>

  <div id="main-view">
    <div style="display:flex; border-bottom:1px solid #333; background:#111;">
      <div class="btn tab-btn active" data-mode="AUDIT">AUDIT</div>
      <div class="btn tab-btn" data-mode="MAP">TACTICAL MAP</div>
      <div class="btn tab-btn" data-mode="TARGET">TARGETING</div>
    </div>

    <div id="view-audit" class="view" style="flex:1; display:flex; flex-direction:column; justify-content:center; padding:20px;">
      <div class="score-box">
        <div class="score-label">SPATIO-TEMPORAL VALUE (Ψ)</div>
        <div class="score-val" id="score-val">A</div>
        <div id="score-pts" style="color:#666; font-size:12px;">loading...</div>
      </div>
      
      <div style="margin-top:30px; padding:0 20px;">
        <span class="label">ASSET INTEGRITY (35 Years)</span>
        <div style="width:100%; height:10px; background:#222; margin-bottom:20px; overflow:hidden;">
          <div id="bar-asset" style="width:10px; height:100%; transition:0.3s;"></div>
        </div>
        
        <div id="console-out" style="font-size:11px; color:#aaa; font-family:monospace; border:1px dashed #333; padding:10px;">
          System Ready. Waiting for Input...
        </div>
      </div>
    </div>

    <div id="view-map" class="view hidden" style="flex:1; position:relative;">
      <canvas id="map-canvas"></canvas>
      <div id="overlay-ui"></div>
    </div>

    <div id="view-target" class="view hidden" style="flex:1; display:flex; align-items:center; justify-content:center; text-align:center;">
      <div style="border:1px solid var(--acc-main); padding:40px;">
        <div style="font-size:12px; color:var(--acc-main); margin-bottom:10px;">REVERSE TARGETING</div>
        <div id="target-res" style="font-size:14px; line-height:1.6; color:#888;">
          Calculating optimal income strategy...
        </div>
      </div>
    </div>

  </div>
</div>

</body>
</html>
