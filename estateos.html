<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ESTATE OS | TRIAD SYSTEM</title>
    <style>
        /* =========================================
           CORE SYSTEM: NOIR THEME & RESET
           ========================================= */
        :root {
            --bg-color: #000000;
            --text-main: #E0E0E0;
            --text-dim: #555555;
            --accent-main: #FF8C00; /* Amber Orange (MAGI Lines) */
            --accent-blue: #00FFFF; /* LOGOS */
            --accent-yellow: #FFD700; /* AEGIS */
            --accent-red: #FF0055; /* HEDON */
            --font-mincho: "Hiragino Mincho ProN", "Yu Mincho", serif;
            --font-mono: "Courier New", Consolas, monospace;
            --border-width: 2px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            font-size: 14px;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        /* Utility */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-blue { color: var(--accent-blue); }
        .text-yellow { color: var(--accent-yellow); }
        .text-red { color: var(--accent-red); }

        /* =========================================
           UI COMPONENT: NEO-MAGI INTERFACE
           ========================================= */
        .triad-console {
            position: relative;
            width: 100%;
            padding: 20px 10px;
            background: #000;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
            overflow: hidden;
        }

        /* Headers */
        .magi-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 4px double var(--accent-main);
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .magi-title {
            font-family: var(--font-mincho);
            font-weight: 900;
            font-size: 2rem;
            color: var(--accent-main);
            transform: scale(1, 0.85); /* å¹³ä½“ */
            letter-spacing: -2px;
            line-height: 1;
        }
        .magi-meta {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--accent-main);
            line-height: 1.2;
            text-align: left;
        }

        /* The Triangle Layout */
        .triad-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 10px;
            position: relative;
        }

        /* Hexagon Modules */
        .magi-module {
            position: relative;
            height: 100px;
            background: #000;
            border: var(--border-width) solid var(--accent-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .module-top {
            grid-column: 1 /span 2;
            width: 60%;
            margin: 0 auto;
            clip-path: polygon(0 0, 100% 0, 100% 70%, 80% 100%, 20% 100%, 0 70%);
            border-bottom: none; 
        }
        .module-left { clip-path: polygon(0 0, 80% 0, 100% 20%, 100% 100%, 0 100%); }
        .module-right { clip-path: polygon(20% 0, 100% 0, 100% 100%, 0 100%, 0 20%); }

        .module-label {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-dim);
            z-index: 2;
        }

        /* Status Stamps */
        .stamp {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(2);
            font-family: var(--font-mincho);
            font-weight: 900;
            font-size: 2.5rem;
            border: 3px solid currentColor;
            padding: 5px 10px;
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            pointer-events: none;
            white-space: nowrap;
        }
        .stamp.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* Verdict Center */
        .verdict-display {
            position: absolute;
            top: 55%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 5;
            pointer-events: none;
            width: 100%;
        }
        .verdict-rank {
            font-family: var(--font-mono);
            font-size: 4rem;
            font-weight: 900;
            color: var(--text-main);
            text-shadow: 0 0 10px var(--accent-main);
        }
        .verdict-msg {
            font-size: 0.7rem;
            color: var(--accent-main);
            background: #000;
            padding: 2px 5px;
            margin-top: -10px;
        }

        .blink { animation: blinker 0.1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* Active States */
        .status-logos.active { background: rgba(0, 255, 255, 0.2); border-color: var(--accent-blue); }
        .status-aegis.active { background: rgba(255, 215, 0, 0.2); border-color: var(--accent-yellow); }
        .status-hedon.active { background: rgba(255, 0, 85, 0.2); border-color: var(--accent-red); }

        /* Input Forms */
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .section-title {
            border-left: 4px solid var(--accent-main);
            padding-left: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            margin: 30px 0 15px 0;
            color: var(--text-main);
        }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        
        input[type="text"], input[type="number"], input[type="tel"], select {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            font-size: 1rem;
            border-radius: 4px;
            font-family: var(--font-mono);
            appearance: none;
        }
        .search-icon {
            position: absolute; right: 10px; top: 32px; font-size: 1.2rem; cursor: pointer;
        }

        /* Detail Modal */
        .detail-panel {
            background: #111; border: 1px solid #333; padding: 15px; margin-top: 5px;
            display: none; font-family: var(--font-mono); font-size: 0.8rem; color: #aaa;
        }
        .detail-panel.open { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .btn-action {
            background: #222; color: var(--accent-main); border: 1px solid var(--accent-main);
            padding: 8px 15px; width: 100%; margin-top: 10px; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="app">
    <div class="triad-console">
        <div class="magi-header">
            <div>
                <div class="magi-meta">CODE: ESTATE_63<br>PRIORITY: AAA</div>
                <div class="magi-title">ç‰©ä»¶å¯©æŸ»</div>
            </div>
            <div style="text-align:right;">
                <div class="magi-meta">MODE: TRIAD_COUNCIL<br>TARGET: LOCKED</div>
                <div class="magi-title">åˆ¤æ±º</div>
            </div>
        </div>

        <div class="triad-grid" id="triad_ui">
            <div class="magi-module module-top status-aegis" onclick="app.toggleDetail('aegis')">
                <div class="module-label">AEGISãƒ»2</div>
                <div class="stamp text-yellow" id="stamp_aegis">æ‰¿èª</div>
            </div>
            <div class="magi-module module-left status-hedon" onclick="app.toggleDetail('hedon')">
                <div class="module-label">HEDONãƒ»3</div>
                <div class="stamp text-red" id="stamp_hedon">æ‰¿èª</div>
            </div>
            <div class="magi-module module-right status-logos" onclick="app.toggleDetail('logos')">
                <div class="module-label">LOGOSãƒ»1</div>
                <div class="stamp text-blue" id="stamp_logos">æ‰¿èª</div>
            </div>

            <div class="verdict-display">
                <div class="verdict-rank" id="final_rank">--</div>
                <div class="verdict-msg blink" id="system_status">STANDBY</div>
            </div>
        </div>

        <div id="detail_aegis" class="detail-panel">
            <div class="text-yellow mb-4">[AEGIS SYSTEM LOG]</div>
            <div id="log_aegis">NO DATA</div>
            <button class="btn-action" onclick="app.openHazardMap()">ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ç¢ºèª</button>
        </div>
        <div id="detail_hedon" class="detail-panel">
            <div class="text-red mb-4">[HEDON SYSTEM LOG]</div>
            <div id="log_hedon">NO DATA</div>
            <button class="btn-action" onclick="app.openRouteSearch()">é€šå‹¤ãƒ«ãƒ¼ãƒˆæ¤œç´¢</button>
        </div>
        <div id="detail_logos" class="detail-panel">
            <div class="text-blue mb-4">[LOGOS SYSTEM LOG]</div>
            <div id="log_logos">NO DATA</div>
        </div>
    </div>

    <div class="container">
        <div class="section-title">I. ç‰©ä»¶ãƒ»ç«‹åœ° (GEO-SPATIAL)</div>
        <div class="input-group">
            <label class="input-label">éƒµä¾¿ç•ªå· (è‡ªå‹•è£œå®Œ)</label>
            <input type="tel" id="inp_zip" placeholder="123-4567" onblur="app.fetchAddress()">
        </div>
        <div class="input-group">
            <label class="input-label">ä½æ‰€ (è‡ªå‹•å…¥åŠ›)</label>
            <input type="text" id="inp_address" placeholder="æ±äº¬éƒ½...">
            <span class="search-icon" onclick="app.fetchCoords()">ğŸ“</span>
        </div>
        <div class="flex" style="gap:10px;">
            <div class="input-group w-full">
                <label class="input-label">ç‰©ä»¶ä¾¡æ ¼ (ä¸‡å††)</label>
                <input type="tel" id="inp_price" class="sanitizer" placeholder="5000">
            </div>
            <div class="input-group w-full">
                <label class="input-label">ç®¡ç†ãƒ»ä¿®ç¹• (å††/æœˆ)</label>
                <input type="tel" id="inp_cost" class="sanitizer" placeholder="25000">
            </div>
        </div>

        <div class="section-title">II. ä¸–å¸¯ãƒ»è·æ¥­ (FINANCIAL)</div>
        <div class="input-group">
            <label class="input-label">å¹´é½¢ (å¤« / å¦»)</label>
            <div class="flex" style="gap:10px;">
                <input type="number" id="inp_age_h" placeholder="35">
                <input type="number" id="inp_age_w" placeholder="32">
            </div>
        </div>
        <div class="input-group">
            <label class="input-label">ä¸–å¸¯å¹´å (ä¸‡å††)</label>
            <input type="tel" id="inp_income" class="sanitizer" placeholder="800">
        </div>
        <div class="input-group">
            <label class="input-label">è·æ¥­ã‚¿ã‚¤ãƒ—</label>
            <select id="inp_career">
                <option value="standard">ä¸€èˆ¬ä¼æ¥­ (æ¨™æº–)</option>
                <option value="public">å…¬å‹™å“¡ (å®‰å®š)</option>
                <option value="maker">å¤§æ‰‹ãƒ¡ãƒ¼ã‚«ãƒ¼ (å¹´åŠŸåºåˆ—)</option>
                <option value="it">ITãƒ»ãƒ¡ã‚¬ãƒ™ãƒ³ãƒãƒ£ãƒ¼ (çŸ­æœŸé›†ä¸­)</option>
                <option value="finance">é‡‘èãƒ»å•†ç¤¾ (é«˜ãƒªã‚¹ã‚¯é«˜ãƒªã‚¿ãƒ¼ãƒ³)</option>
                <option value="free">ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ (ä¸å®‰å®š)</option>
            </select>
        </div>
        <div class="input-group">
            <label class="input-label">æ•™è‚²ãƒ—ãƒ©ãƒ³</label>
            <select id="inp_edu">
                <option value="public">Allå…¬ç«‹</option>
                <option value="mix">å¤§å­¦ã®ã¿ç§ç«‹</option>
                <option value="elite">ç§ç«‹ä¸€è²« (Elite)</option>
            </select>
        </div>

        <div class="section-title">III. ãƒªã‚¹ã‚¯è£œæ­£ (FACTOR)</div>
        <div class="input-group">
            <label class="input-label">é§…ãƒ©ãƒ³ã‚¯ (è‡ªå·±ç”³å‘Š)</label>
            <select id="inp_station_rank">
                <option value="1">â˜…1 (æ”¯ç·šãƒ»ãƒã‚¹ä¾¿)</option>
                <option value="3" selected>â˜…3 (æ€¥è¡Œåœè»Š/Hub)</option>
                <option value="5">â˜…5 (Core/è¤‡æ•°è·¯ç·š)</option>
            </select>
        </div>
        <div class="input-group">
            <label class="input-label">é€šå‹¤ã‚¹ãƒˆãƒ¬ã‚¹</label>
            <select id="inp_commute_stress">
                <option value="low">ä½ (å¿«é©)</option>
                <option value="mid" selected>ä¸­ (æ¨™æº–)</option>
                <option value="high">é«˜ (ç–²å¼Š)</option>
                <option value="hell">åœ°ç„ (é™ç•Œ)</option>
            </select>
        </div>
        <div style="height: 50px;"></div>
    </div>
</div>

<script>
/* =================================================================
   ESTATE OS COMPLETE LOGIC BUNDLE
   Includes: Master Data, Utilities, Sonar(API), Engine, Triad, App
   =================================================================
*/

// --- 1. COMPRESSED MASTER DATA ---
const TAX_MAP = [[195,5,0], [330,10,9.75], [695,20,42.75], [900,23,63.6], [1800,33,153.6], [4000,40,279.6], [Infinity,45,479.6]];
const CAREER_CURVES = {
    standard: [[22,100], [30,130], [45,160], [55,170], [60,100]],
    public:   [[22,100], [35,140], [50,180], [60,180], [65,120]],
    maker:    [[22,100], [30,120], [40,160], [55,200], [60,120]],
    it:       [[22,110], [30,180], [40,200], [50,180], [60,80]],
    finance:  [[22,120], [30,180], [45,250], [55,250], [60,50]],
    free:     [[22,100], [30,150], [40,150], [50,120], [60,80]]
};
const EDU_COSTS = {
    public: { 6:30, 12:50, 15:50, 18:250 },
    mix:    { 6:30, 12:50, 15:100, 18:500 },
    elite:  { 6:100, 12:400, 15:300, 18:600 }
};

// --- 2. UTILITIES ---
const Utils = {
    sanitizeNum: (val) => {
        if (!val) return 0;
        let s = val.toString().replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
        s = s.replace(/[^0-9.-]/g, '');
        return parseFloat(s) || 0;
    },
    sanitizeZip: (val) => {
        if (!val) return "";
        let s = val.toString().replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
        return s.replace(/[^0-9]/g, '').substring(0, 7);
    },
    formatCurrency: (num) => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(num),
    calcDist: (lat1, lon1, lat2, lon2) => {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
};

// --- 3. SONAR (API) ---
class Sonar {
    constructor() { this.cache = {}; }
    
    async searchAddress(query) {
        if (!query) return null;
        try {
            const res = await fetch(`https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            return (data && data.length > 0) ? { lat: data[0].geometry.coordinates[1], lon: data[0].geometry.coordinates[0], title: data[0].properties.title } : null;
        } catch (e) { return null; }
    }

    async searchZip(zip) {
        const z = Utils.sanitizeZip(zip);
        if (z.length !== 7) return null;
        try {
            const res = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${z}`);
            const data = await res.json();
            return (data && data.results) ? `${data.results[0].address1}${data.results[0].address2}${data.results[0].address3}` : null;
        } catch (e) { return null; }
    }

    async scanArea(lat, lon) {
        // Overpass API Query (Hospital, Supermarket)
        const q = `[out:json][timeout:3];(node["amenity"="hospital"](around:1500,${lat},${lon});node["shop"="supermarket"](around:800,${lat},${lon}););out body;`;
        const fetchWithTimeout = (ms, promise) => {
            return new Promise((resolve) => {
                const timer = setTimeout(() => resolve(null), ms);
                promise.then(value => { clearTimeout(timer); resolve(value); }).catch(() => { clearTimeout(timer); resolve(null); });
            });
        };
        try {
            const res = await fetchWithTimeout(3000, fetch("https://overpass-api.de/api/interpreter", { method: 'POST', body: q }));
            if (!res) return { status: 'TIMEOUT' };
            const data = await res.json();
            return this.analyze(data.elements, lat, lon);
        } catch (e) { return { status: 'ERROR' }; }
    }

    analyze(nodes, clat, clon) {
        if (!nodes) return { status: 'NO_DATA' };
        let res = { hospital: 9999, supermarket: 9999 };
        nodes.forEach(n => {
            const d = Math.round(Utils.calcDist(clat, clon, n.lat, n.lon) * 1000);
            if (n.tags.amenity === 'hospital' && d < res.hospital) res.hospital = d;
            if (n.tags.shop === 'supermarket' && d < res.supermarket) res.supermarket = d;
        });
        return { status: 'OK', data: res };
    }
}

// --- 4. ENGINE (Simulation) ---
class EstateEngine {
    simulate(inputs) {
        let assets = 0, isBankrupt = false, bankruptAge = null;
        const loanAmt = inputs.price * 10000;
        const mRate = 0.018 / 12;
        const mPay = (loanAmt * mRate) / (1 - Math.pow(1 + mRate, -420));
        let loanBal = loanAmt;
        
        const curve = CAREER_CURVES[inputs.career] || CAREER_CURVES.standard;
        const getMult = (age) => {
            for(let i=0; i<curve.length-1; i++) {
                if(age >= curve[i][0] && age <= curve[i+1][0]) {
                    const t = (age - curve[i][0]) / (curve[i+1][0] - curve[i][0]);
                    return curve[i][1] + t * (curve[i+1][1] - curve[i][1]);
                }
            }
            return age > 60 ? 50 : 100;
        };

        for (let i = 0; i <= (100 - inputs.ageH); i++) {
            const cAge = inputs.ageH + i;
            // Income
            let inc = inputs.income * 10000 * (getMult(cAge)/100);
            if (cAge >= 60) inc *= 0.6; 
            if (cAge >= 65) inc = 2500000; // Pension
            const tax = (inc <= 3300000) ? 0.2 : 0.3; // Simple Tax
            const takeHome = inc * (1 - tax);

            // Expense
            let cost = (inputs.cost * 12) + (150000 * 12 * Math.pow(1.01, i)); // Living + inflation
            if (i < 35) { cost += (mPay * 12); loanBal -= (mPay*12)*0.6; }
            
            // Edu
            const childAge = cAge - 35;
            if (childAge >= 0 && childAge <= 22) {
                const plan = EDU_COSTS[inputs.eduType];
                if(plan[childAge]) cost += plan[childAge]*10000;
                cost += 600000; // Child living
            }

            assets += (takeHome - cost);
            if (assets < 0 && !isBankrupt) { isBankrupt = true; bankruptAge = cAge; }
        }
        return { finalAssets: assets, isBankrupt, bankruptAge };
    }
}

// --- 5. TRIAD SYSTEM (The Brains) ---
class TriadSystem {
    execute(sim, sonar, inputs) {
        // LOGOS (Finance)
        let v1 = true, log1 = `è³‡ç”£æ®‹é«˜: ${Utils.formatCurrency(sim.finalAssets)}`;
        if (sim.isBankrupt) { v1 = false; log1 = `ç ´ç¶»è­¦å‘Š: ${sim.bankruptAge}æ­³ã§è³‡é‡‘æ¯æ¸‡ã€‚`; }
        else if (inputs.stationRank < 3) { log1 += " ã ãŒãƒªã‚»ãƒ¼ãƒ«å¼±ã€‚"; }

        // AEGIS (Safety)
        let v2 = true, log2 = "";
        if (sonar.status === 'OK') {
            if (sonar.data.hospital > 1500) { v2 = false; log2 = `åŒ»ç™‚éç–: ç—…é™¢${sonar.data.hospital}mã€‚`; }
            else log2 = `åŒ»ç™‚ã‚¢ã‚¯ã‚»ã‚¹è‰¯(${sonar.data.hospital}m)ã€‚`;
        } else { log2 = "å‘¨è¾ºãƒ‡ãƒ¼ã‚¿å–å¾—ä¸å¯ã€‚ç¾åœ°è¦ç¢ºèªã€‚"; }
        if (inputs.stationRank === 1) { v2 = false; log2 += " å­¤ç«‹ãƒªã‚¹ã‚¯ã‚ã‚Šã€‚"; }

        // HEDON (Life)
        let v3 = true, log3 = "";
        if (sonar.status === 'OK') {
            if (sonar.data.supermarket > 800) { v3 = false; log3 = `ä¸ä¾¿: ã‚¹ãƒ¼ãƒ‘ãƒ¼é æ–¹(${sonar.data.supermarket}m)ã€‚`; }
            else log3 = `è²·ç‰©è‡³ä¾¿(${sonar.data.supermarket}m)ã€‚`;
        }
        if (inputs.stress === 'hell') { v3 = false; log3 += " é€šå‹¤åœ°ç„ã«ã‚ˆã‚Šæ‹’å¦ã€‚"; }

        // Synthesis
        let rank = "C", msg = "è¦å¯©è­°";
        if (v1 && v2 && v3) { rank = "S"; msg = "å®Œå…¨èª¿å’Œ: ç†æƒ³éƒ·ã§ã™ã€‚"; }
        else if (v1 && v2 && !v3) { rank = "B"; msg = "ç¦æ¬²çš„é¸æŠ: è³‡ç”£ã¨å®‰å…¨ã¯ç›¤çŸ³ã€‚"; }
        else if (!v1 && v2 && v3) { rank = "C"; msg = "ç”˜ã„ç½ : å°†æ¥ç ´ç¶»ã—ã¾ã™ã€‚"; }
        else if (v1 && !v2 && v3) { rank = "D"; msg = "ç ‚ä¸Šã®æ¥¼é–£: ç½å®³ãƒªã‚¹ã‚¯å¤§ã€‚"; }
        else { rank = "D"; msg = "å´ä¸‹: å•é¡ŒãŒå¤šã™ãã¾ã™ã€‚"; }

        return { rank, msg, details: { logos: {vote:v1, log:log1}, aegis: {vote:v2, log:log2}, hedon: {vote:v3, log:log3} } };
    }
}

// --- 6. APP CONTROLLER ---
class App {
    constructor() {
        this.engine = new EstateEngine();
        this.sonar = new Sonar();
        this.triad = new TriadSystem();
        this.sonarData = { status: 'NO_DATA' };
        this.coords = null;
    }

    init() {
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('input', () => this.schedule());
        });
        document.querySelectorAll('.sanitizer').forEach(el => {
            el.addEventListener('blur', (e) => { e.target.value = Utils.sanitizeNum(e.target.value) || ""; });
        });
    }

    schedule() {
        clearTimeout(this.timer);
        document.getElementById('system_status').innerText = "CALCULATING...";
        document.getElementById('system_status').classList.add('blink');
        this.timer = setTimeout(() => this.run(), 1000);
    }

    async run() {
        const inputs = {
            zip: document.getElementById('inp_zip').value,
            price: Utils.sanitizeNum(document.getElementById('inp_price').value),
            cost: Utils.sanitizeNum(document.getElementById('inp_cost').value),
            ageH: Utils.sanitizeNum(document.getElementById('inp_age_h').value) || 35,
            income: Utils.sanitizeNum(document.getElementById('inp_income').value),
            career: document.getElementById('inp_career').value,
            eduType: document.getElementById('inp_edu').value,
            stationRank: parseInt(document.getElementById('inp_station_rank').value),
            stress: document.getElementById('inp_commute_stress').value
        };

        if (!inputs.income || !inputs.price) {
            document.getElementById('system_status').innerText = "STANDBY";
            return;
        }

        const sim = this.engine.simulate(inputs);
        
        // Scan only if we have coords
        if (this.coords) {
             this.sonarData = await this.sonar.scanArea(this.coords.lat, this.coords.lon);
        }

        const verdict = this.triad.execute(sim, this.sonarData, inputs);
        this.render(verdict);
    }

    render(v) {
        // Reset
        ['logos','aegis','hedon'].forEach(m => {
            document.querySelector(`.status-${m}`).classList.remove('active');
            document.getElementById(`stamp_${m}`).className = 'stamp'; 
        });

        // Logs
        document.getElementById('log_logos').innerText = v.details.logos.log;
        document.getElementById('log_aegis').innerText = v.details.aegis.log;
        document.getElementById('log_hedon').innerText = v.details.hedon.log;

        // Reveal Sequence
        const reveal = (id, vote, color) => {
            const el = document.querySelector(`.status-${id}`);
            const stamp = document.getElementById(`stamp_${id}`);
            if(vote) {
                el.classList.add('active');
                stamp.innerText = "æ‰¿èª";
                stamp.classList.add(color);
            } else {
                stamp.innerText = "å¦å®š";
                stamp.classList.add('text-red');
                stamp.style.borderColor = 'red';
            }
            stamp.classList.add('show');
        };

        setTimeout(() => reveal('logos', v.details.logos.vote, 'text-blue'), 100);
        setTimeout(() => reveal('aegis', v.details.aegis.vote, 'text-yellow'), 300);
        setTimeout(() => reveal('hedon', v.details.hedon.vote, 'text-red'), 500);

        setTimeout(() => {
            const r = document.getElementById('final_rank');
            r.innerText = v.rank + " RANK";
            r.style.color = (v.rank==='S')?'var(--accent-blue)':(v.rank==='B')?'var(--accent-main)':'var(--accent-red)';
            const s = document.getElementById('system_status');
            s.innerText = v.msg;
            s.classList.remove('blink');
        }, 700);
    }

    async fetchAddress() {
        const zip = document.getElementById('inp_zip').value;
        const addr = await this.sonar.searchZip(zip);
        if (addr) {
            document.getElementById('inp_address').value = addr;
            this.fetchCoords();
        }
    }

    async fetchCoords() {
        const addr = document.getElementById('inp_address').value;
        const res = await this.sonar.searchAddress(addr);
        if (res) {
            this.coords = { lat: res.lat, lon: res.lon };
            document.getElementById('system_status').innerText = `LOCATED: ${res.title}`;
            this.schedule();
        }
    }

    toggleDetail(id) { document.getElementById(`detail_${id}`).classList.toggle('open'); }
    openHazardMap() {
        if(this.coords) window.open(`https://disaportal.gsi.go.jp/maps/?ll=${this.coords.lat},${this.coords.lon}&z=16`, '_blank');
    }
    openRouteSearch() {
        window.open(`https://transit.yahoo.co.jp/search/result?to=${encodeURIComponent(document.getElementById('inp_address').value)}`, '_blank');
    }
}

// START
const app = new App();
window.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>
