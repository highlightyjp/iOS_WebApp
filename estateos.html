<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ESTATE OS v45.0</title>
<style>
    :root {
        --bg: #0f172a; --card: rgba(30,41,59,0.9); --menu: #0f172a;
        --gold: #fbbf24; --cyan: #06b6d4; --red: #f43f5e; --green: #10b981;
        --text: #f8fafc; --sub: #94a3b8;
        --safe-top: env(safe-area-inset-top); --safe-btm: env(safe-area-inset-bottom);
        --font: "Hiragino Sans", "Meiryo", sans-serif;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { 
        margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); 
        height: 100dvh; overflow: hidden; display: flex; flex-direction: column; line-height: 1.5;
    }

    /* Typography */
    .num { font-family: "Courier New", Courier, monospace; }
    .text-gold { color: var(--gold); } .text-cyan { color: var(--cyan); }
    .text-red { color: var(--red); } .text-green { color: var(--green); }
    .text-small { font-size: 11px; color: var(--sub); }

    /* Layout */
    header {
        height: calc(50px + var(--safe-top)); padding-top: var(--safe-top);
        background: rgba(15,23,42,0.98); border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex; align-items: center; padding-left: 15px; z-index: 1000;
    }
    .brand { font-weight: 900; letter-spacing: 1px; font-size: 18px; }
    
    main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: calc(80px + var(--safe-btm)); }
    
    .hud-fixed {
        position: sticky; top: 0; background: var(--bg); z-index: 500;
        padding-bottom: 10px; border-bottom: 2px solid var(--gold); margin-bottom: 20px;
    }

    .glass {
        background: var(--card); border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
        padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    /* Components */
    .acc-btn { 
        width: 100%; text-align: left; background: none; border: none; color: var(--cyan);
        font-weight: bold; padding: 10px 0; border-bottom: 1px solid rgba(6,182,212,0.2);
        display: flex; justify-content: space-between; cursor: pointer;
    }
    .acc-content { padding-top: 15px; }
    
    label { display: block; font-size: 12px; color: var(--sub); margin-bottom: 4px; margin-top: 10px; }
    input, select {
        width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #334155;
        border-radius: 6px; color: #fff; padding: 10px; font-size: 15px;
    }
    input:focus { border-color: var(--cyan); box-shadow: 0 0 8px rgba(6,182,212,0.3); }

    /* Switch Component */
    .toggle-group { display: flex; background: #0f172a; border-radius: 8px; padding: 3px; border: 1px solid #334155; }
    .toggle-btn { 
        flex: 1; text-align: center; padding: 8px; font-size: 12px; border-radius: 6px; 
        cursor: pointer; color: var(--sub); transition: 0.2s;
    }
    .toggle-btn.active { background: var(--cyan); color: #000; font-weight: bold; }

    .btn {
        width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold;
        font-size: 16px; cursor: pointer; transition: 0.1s;
    }
    .btn-p { background: linear-gradient(135deg, var(--cyan), #0891b2); color: #000; }
    .btn-s { background: #1e293b; color: #fff; border: 1px solid #334155; }
    .btn:active { transform: scale(0.98); opacity: 0.9; }

    /* Report Table */
    .report-card { border: 1px solid var(--gold); padding: 20px; background: #1e293b; border-radius: 12px; }
    .row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #334155; font-size: 13px; }
    .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    .bg-green { background: rgba(16,185,129,0.2); color: var(--green); border: 1px solid var(--green); }
    .bg-red { background: rgba(244,63,94,0.2); color: var(--red); border: 1px solid var(--red); }
    .bg-gold { background: rgba(251,191,36,0.2); color: var(--gold); border: 1px solid var(--gold); }

    /* Oracle Section */
    .oracle { border-left: 3px solid var(--gold); padding-left: 15px; margin-top: 20px; font-style: italic; }
    
    /* Toast */
    #toast {
        position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 30px;
        font-size: 12px; z-index: 2000; opacity: 0; transition: 0.3s; pointer-events: none;
    }
    #toast.show { opacity: 1; }

    /* Lock Screen */
    #lock-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg);
        z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    @media print {
        header, .hud-fixed, .btn, .no-print { display: none !important; }
        body { background: #fff; color: #000; overflow: visible; }
        .glass, .report-card { border: 1px solid #000; background: none; color: #000; page-break-inside: avoid; }
        .text-cyan, .text-gold, .text-red { color: #000 !important; }
    }
</style>
</head>
<body>

<div id="lock-screen">
    <div class="brand text-gold" style="font-size: 32px; margin-bottom: 40px;">ESTATE OS</div>
    <div class="text-small" style="margin-bottom: 20px;">ãƒ‘ã‚¿ãƒ¼ãƒ³å…¥åŠ›ã§è§£é™¤</div>
    <canvas id="lock-cvs" width="300" height="300"></canvas>
</div>

<header>
    <div class="brand">ESTATE <span class="text-cyan">OS</span> <span class="text-small">v45.0 Oracle</span></div>
</header>

<main>
    <div class="hud-fixed">
        <div class="text-small">æœˆé¡å®Ÿè³ªè² æ‹…ï¼ˆãƒ­ãƒ¼ãƒ³ï¼‹ç¶­æŒè²»ï¼æ§é™¤ï¼‰</div>
        <div class="text-gold num" style="font-size: 28px; font-weight: 900;"><span id="hud-total">0</span> <span style="font-size: 14px;">å††</span></div>
        <div class="text-small flex" style="display:flex; justify-content: space-between;">
            <span>åˆ¤å®šãƒ©ãƒ³ã‚¯: <span id="hud-rank" class="num">--</span></span>
            <span>å°†æ¥å¢—é¡ãƒªã‚¹ã‚¯: <span id="hud-risk" class="text-red">--</span></span>
        </div>
    </div>

    <div class="glass">
        <button class="acc-btn" onclick="toggleAcc('acc-fin')">ã€ 1 ã€‘ è³‡é‡‘ãƒ»ãƒ­ãƒ¼ãƒ³æˆ¦ç•¥ <span id="icon-fin">â–¼</span></button>
        <div id="acc-fin" class="acc-content">
            <label>å€Ÿå…¥å½¢å¼</label>
            <div class="toggle-group">
                <div class="toggle-btn active" id="btn-single" onclick="setLoan('single')">å¤«å˜ç‹¬</div>
                <div class="toggle-btn" id="btn-pair" onclick="setLoan('pair')">ãƒšã‚¢ãƒ­ãƒ¼ãƒ³</div>
            </div>
            <div style="display: flex; gap: 10px;">
                <div style="flex:1;"><label>ç‰©ä»¶ä¾¡æ ¼ (ä¸‡å††)</label><input type="number" id="in-price" value="6000" oninput="calc()"></div>
                <div style="flex:1;"><label>é ­é‡‘ (ä¸‡å††)</label><input type="number" id="in-down" value="500" oninput="calc()"></div>
            </div>
            <label>é‡‘åˆ©ãƒ†ã‚¹ãƒˆ (%)</label>
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="range" min="0.3" max="4.0" step="0.01" value="0.47" id="sl-rate" style="flex:1;" oninput="syncRate(this.value)">
                <span class="num text-gold" id="dsp-rate" style="width:50px;">0.47</span>
            </div>
            <label>å¤« å¹´å(ä¸‡) / å¦» å¹´å(ä¸‡)</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="in-inc-h" value="800" oninput="calc()">
                <input type="number" id="in-inc-w" value="500" oninput="calc()">
            </div>
        </div>
    </div>

    <div class="glass">
        <button class="acc-btn" onclick="toggleAcc('acc-prop')">ã€ 2 ã€‘ ç‰©ä»¶ãƒ»å¿«é©æ€§æƒ…å ± <span id="icon-prop">â–¼</span></button>
        <div id="acc-prop" class="acc-content">
            <label>ç‰©ä»¶åï¼ˆè‡ªå‹•æ¤œç´¢å¯¾è±¡ï¼‰</label>
            <input type="text" id="in-name" placeholder="ç‰©ä»¶åã‚’å…¥åŠ›" oninput="checkMaster(this.value)">
            <div id="gov-status" class="text-small mt-5"></div>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1;"><label>å°‚æœ‰é¢ç© (ã¡)</label><input type="number" id="in-area" value="65" oninput="calc()"></div>
                <div style="flex:1;"><label>ç¯‰å¹´ (è¥¿æš¦)</label><input type="number" id="in-year" value="2015" oninput="calc()"></div>
            </div>

            <label>ã‚¨ã‚¢ã‚³ãƒ³è¨­ç½®çŠ¶æ³</label>
            <div class="toggle-group">
                <div class="toggle-btn active" onclick="setAC('ok', this)">å…¨å®¤å¯</div>
                <div class="toggle-btn" onclick="setAC('risk', this)">éš è”½é…ç®¡</div>
                <div class="toggle-btn" onclick="setAC('ng', this)">ä¸å¯éƒ¨å±‹æœ‰</div>
            </div>

            <label>2024å¹´çœã‚¨ãƒåŸºæº–</label>
            <div class="toggle-group">
                <div class="toggle-btn" onclick="setEnergy('low', this)">é©åˆãªã—</div>
                <div class="toggle-btn active" onclick="setEnergy('high', this)">ZEH/çœã‚¨ãƒ</div>
            </div>
        </div>
    </div>

    <div class="glass">
        <button class="acc-btn" onclick="toggleAcc('acc-gov')">ã€ 3 ã€‘ ç®¡ç†ãƒ»å»ºã¦æ›¿ãˆãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ« <span id="icon-gov">â–¼</span></button>
        <div id="acc-gov" class="acc-content">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>ç®¡ç†è²» (å††/æœˆ)</label><input type="number" id="in-fee-m" value="15000" oninput="calc()"></div>
                <div style="flex:1;"><label>ç©ç«‹é‡‘ (å††/æœˆ)</label><input type="number" id="in-fee-r" value="12000" oninput="calc()"></div>
            </div>
            <label>ç©ç«‹æ–¹å¼</label>
            <div class="toggle-group">
                <div class="toggle-btn active" onclick="setFund('step', this)">æ®µéšå¢—é¡</div>
                <div class="toggle-btn" onclick="setFund('flat', this)">å‡ç­‰ç©ç«‹</div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1;"><label>ç·æˆ¸æ•°</label><input type="number" id="in-units" value="50" oninput="calc()"></div>
                <div style="flex:1;"><label>æ•·åœ°é¢ç© (ã¡)</label><input type="number" id="in-land" value="2000" oninput="calc()"></div>
            </div>
            <label>å®¹ç©ç‡ï¼ˆéƒ½å¸‚è¨ˆç”» %ï¼‰</label>
            <input type="number" id="in-yoseki" value="200" oninput="calc()">
        </div>
    </div>

    <div class="glass">
        <button class="acc-btn" onclick="toggleAcc('acc-loc')">ã€ 4 ã€‘ ç«‹åœ°ãƒ»ãƒã‚¶ãƒ¼ãƒ‰ <span id="icon-loc">â–¼</span></button>
        <div id="acc-loc" class="acc-content">
            <label>æœ€å¯„é§…</label>
            <input type="text" id="in-st" value="ã‚»ãƒ³ã‚¿ãƒ¼å—" oninput="calc()">
            <label>å¾’æ­©åˆ†æ•°ï¼ˆåºƒå‘Šè¡¨è¨˜ï¼‰</label>
            <input type="number" id="in-walk" value="8" oninput="calc()">
            <label>åœ°å½¢ãƒ»é“è·¯è£œæ­£</label>
            <div class="toggle-group">
                <div class="toggle-btn active" onclick="setLoc('flat', this)">å¹³å¦</div>
                <div class="toggle-btn" onclick="setLoc('slope', this)">å‚é“/ä¿¡å·å¤š</div>
            </div>
            <label>ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—åˆ¤å®š</label>
            <div class="toggle-group">
                <div class="toggle-btn active" onclick="setHaz('safe', this)">å®‰å…¨</div>
                <div class="toggle-btn" onclick="setHaz('warn', this)">æµ¸æ°´æ³¨æ„</div>
                <div class="toggle-btn" onclick="setHaz('danger', this)">ãƒ¬ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³</div>
            </div>
        </div>
    </div>

    <button class="btn btn-p" onclick="showReport()">âš¡ ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ</button>
    <div style="height:20px;"></div>
    <button class="btn btn-s no-print" onclick="openMaster()">ğŸ›  ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</button>

    <div id="report-area" style="display:none; margin-top:30px;">
        <div class="report-card">
            <div style="text-align:center; border-bottom:2px solid var(--gold); padding-bottom:10px; margin-bottom:20px;">
                <div class="text-small">ä¸å‹•ç”£æˆ¦ç•¥ ç›£æŸ»å ±å‘Šæ›¸</div>
                <div id="rep-name" style="font-size:20px; font-weight:bold;">ç‰©ä»¶å</div>
            </div>

            <div style="display:flex; justify-content:space-around; align-items:center; margin-bottom:20px;">
                <div style="text-align:center;">
                    <div class="text-small">ç·åˆæ ¼ä»˜</div>
                    <div id="res-rank" style="font-size:48px; font-weight:900; line-height:1;">A</div>
                </div>
                <div style="text-align:center;">
                    <div class="text-small">ç·åˆã‚¹ã‚³ã‚¢</div>
                    <div id="res-score" style="font-size:32px; font-weight:bold;">--</div>
                    <div class="text-small">/ 100ç‚¹</div>
                </div>
            </div>

            <div class="row"><span>å€Ÿå…¥å¯èƒ½é¡åˆ¤å®š</span><span id="res-loan-limit">--</span></div>
            <div class="row"><span>ä¸–å¸¯ç‰‡ç¿¼è€æ€§</span><span id="res-one-wing">--</span></div>
            <div class="row"><span>å¤«å©¦å±…ä½é©æ­£</span><span id="res-dinks">--</span></div>
            <div class="row"><span>ã‚¨ã‚¢ã‚³ãƒ³å…¨å®¤</span><span id="res-ac">--</span></div>
            <div class="row"><span>å»ºã¦æ›¿ãˆä½™åŠ›</span><span id="res-reb">--</span></div>
            <div class="row"><span>åœŸåœ°ä¸‹å€¤ä¿è¨¼</span><span id="res-land-val">--</span></div>

            <div class="oracle">
                <div class="text-gold" style="font-size:12px; font-weight:bold;">ğŸ”® æœªæ¥äºˆçŸ¥ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</div>
                <div id="res-oracle" class="text-small" style="line-height:1.6; margin-top:8px;"></div>
            </div>
        </div>
        
        <div style="margin-top:20px; display:flex; gap:10px;" class="no-print">
            <button class="btn btn-p" style="flex:2;" onclick="copyLine()">ğŸ“‹ LINEå…±æœ‰ç”¨ã‚³ãƒ”ãƒ¼</button>
            <button class="btn btn-s" style="flex:1;" onclick="window.print()">ğŸ–¨ å°åˆ·</button>
        </div>
    </div>
</main>

<div id="toast"></div>

<div id="modal-master" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:2000; padding:20px; overflow-y:auto;">
    <div class="brand text-gold mb-10">ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <div class="text-small">ç·¨é›†ã—ãŸå†…å®¹ã¯å³åº§ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
    <textarea id="mst-edit" style="width:100%; height:300px; font-family:monospace; font-size:10px; margin-top:10px;"></textarea>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn btn-p" onclick="saveMaster()">ä¿å­˜ã—ã¦åæ˜ </button>
        <button class="btn btn-s" onclick="closeMaster()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
// --- åˆæœŸãƒ‡ãƒ¼ã‚¿ (Ver 45.0 Oracle) ---
const CSV_GV = `ID,BukkenMei,Hoshi,Tensu,Nintei,Kigen
1,ãƒ‘ãƒ¼ã‚¯ã‚·ãƒ†ã‚£æ­¦è”µå°æ‰ãƒŸãƒƒãƒ‰ã‚¹ã‚«ã‚¤ã‚¿ãƒ¯ãƒ¼,5,96,true,2027/12
2,ã‚¶ãƒ»ãƒ¨ã‚³ãƒãƒã‚¿ãƒ¯ãƒ¼ã‚º,5,98,true,2027/01
3,æ¸¯åŒ—ã‚»ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ¬ã‚¤ã‚¹,5,92,true,2026/09
4,ãƒ™ãƒ«ã‚¸ã‚§ãƒ³ãƒ‰ã‚»ãƒ³ã‚¿ãƒ¼å—,5,91,true,2026/07
5,ã‚¤ãƒ‹ã‚·ã‚¢æ¸¯åŒ—ãƒ‹ãƒ¥ãƒ¼ã‚¿ã‚¦ãƒ³,5,98,true,2027/02
6,åºƒå°¾ã‚¬ãƒ¼ãƒ‡ãƒ³ãƒ’ãƒ«ã‚º,5,95,true,2026/04`;

// --- çŠ¶æ…‹ç®¡ç† ---
let loanMode = 'single';
let acStatus = 'ok';
let energyStatus = 'high';
let fundMode = 'step';
let locMode = 'flat';
let hazStatus = 'safe';
let masterData = [];

// --- ã‚¢ãƒ—ãƒªåˆæœŸåŒ– ---
window.onload = () => { initLock(); loadMaster(); calc(); };

function initLock() {
    const c = document.getElementById('lock-cvs'), ctx = c.getContext('2d');
    let pts = [], dots = [];
    for(let i=0; i<3; i++) for(let j=0; j<3; j++) dots.push({x:75*(j+1), y:75*(i+1), i: i*3+j});
    
    const redraw = (cur) => {
        ctx.clearRect(0,0,300,300);
        if(pts.length) {
            ctx.beginPath(); ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 6; ctx.lineCap='round';
            ctx.moveTo(dots[pts[0]].x, dots[pts[0]].y);
            pts.slice(1).forEach(k => ctx.lineTo(dots[k].x, dots[k].y));
            if(cur) ctx.lineTo(cur.x, cur.y);
            ctx.stroke();
        }
        dots.forEach(d => {
            ctx.beginPath(); ctx.arc(d.x, d.y, 8, 0, 7);
            ctx.fillStyle = pts.includes(d.i) ? '#fbbf24' : '#334155';
            ctx.fill();
        });
    };

    let drawing = false;
    const getPos = e => {
        const r = c.getBoundingClientRect(), t = e.touches ? e.touches[0] : e;
        return {x: t.clientX - r.left, y: t.clientY - r.top};
    };

    c.addEventListener('touchstart', e => { e.preventDefault(); drawing = true; pts = []; redraw(getPos(e)); });
    c.addEventListener('touchmove', e => {
        if(!drawing) return;
        const p = getPos(e); redraw(p);
        dots.forEach(d => {
            if(Math.hypot(d.x - p.x, d.y - p.y) < 25 && !pts.includes(d.i)) pts.push(d.i);
        });
    });
    c.addEventListener('touchend', () => {
        drawing = false; 
        if(pts.length >= 4) {
            const key = localStorage.getItem('eo_lock');
            const now = JSON.stringify(pts);
            if(!key) { localStorage.setItem('eo_lock', now); unlock(); }
            else if(key === now) unlock();
            else { pts = []; redraw(); showToast('ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒé•ã„ã¾ã™'); }
        }
    });
    redraw();
}

function unlock() { document.getElementById('lock-screen').style.display = 'none'; }

function loadMaster() {
    const raw = localStorage.getItem('eo_mst_gv') || CSV_GV;
    document.getElementById('mst-edit').value = raw;
    const rows = raw.trim().split('\n');
    masterData = rows.slice(1).map(r => {
        const c = r.split(',');
        return { name: c[1], star: parseInt(c[2]), score: parseInt(c[3]), cert: c[4]==='true' };
    });
}

function saveMaster() {
    localStorage.setItem('eo_mst_gv', document.getElementById('mst-edit').value);
    loadMaster();
    closeMaster();
    showToast('ãƒã‚¹ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}

function openMaster() { document.getElementById('modal-master').style.display = 'block'; }
function closeMaster() { document.getElementById('modal-master').style.display = 'none'; }

function toggleAcc(id) {
    const el = document.getElementById(id);
    const icon = document.getElementById('icon-' + id.split('-')[1]);
    const isHidden = el.style.display === 'none';
    el.style.display = isHidden ? 'block' : 'none';
    icon.innerText = isHidden ? 'â–²' : 'â–¼';
}

// --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
function setLoan(m) { loanMode = m; updateToggle('btn-single', m==='single'); updateToggle('btn-pair', m==='pair'); calc(); }
function setAC(v, el) { acStatus = v; updateToggleGroup(el); calc(); }
function setEnergy(v, el) { energyStatus = v; updateToggleGroup(el); calc(); }
function setFund(v, el) { fundMode = v; updateToggleGroup(el); calc(); }
function setLoc(v, el) { locMode = v; updateToggleGroup(el); calc(); }
function setHaz(v, el) { hazStatus = v; updateToggleGroup(el); calc(); }

function updateToggle(id, active) { document.getElementById(id).classList.toggle('active', active); }
function updateToggleGroup(el) {
    Array.from(el.parentElement.children).forEach(c => c.classList.remove('active'));
    el.classList.add('active');
}

function syncRate(v) { document.getElementById('dsp-rate').innerText = v; calc(); }

function checkMaster(name) {
    const hit = masterData.find(m => name.includes(m.name));
    const status = document.getElementById('gov-status');
    if(hit) {
        status.innerHTML = `<span class="text-green">âœ… å…¬çš„è©•ä¾¡ç™»éŒ²æ¸ˆ: â˜…${hit.star} (${hit.score}ç‚¹)</span>`;
        return hit;
    } else {
        status.innerHTML = `<span class="text-small">æœªç™»éŒ²ç‰©ä»¶ã§ã™ï¼ˆGoogleæ¤œç´¢æ¨å¥¨ï¼‰</span>`;
        return null;
    }
}

function calc() {
    const price = parseFloat(document.getElementById('in-price').value) || 0;
    const down = parseFloat(document.getElementById('in-down').value) || 0;
    const loan = Math.max(0, price - down);
    const rate = parseFloat(document.getElementById('sl-rate').value) / 100 / 12;
    const months = 35 * 12;
    
    // ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆ
    const pmt = loan > 0 ? Math.floor(loan * 10000 * (rate * Math.pow(1+rate, months)) / (Math.pow(1+rate, months) - 1)) : 0;
    
    // ç¶­æŒè²»
    const feeM = parseFloat(document.getElementById('in-fee-m').value) || 0;
    const feeR = parseFloat(document.getElementById('in-fee-r').value) || 0;
    
    // ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ (2024å¹´ä»¥é™ç°¡ç•¥åŒ–ãƒ¢ãƒ‡ãƒ«)
    const year = parseInt(document.getElementById('in-year').value);
    let deduction = 0;
    if (energyStatus === 'high') {
        deduction = Math.min(loan * 10000 * 0.007 / 12, 400000 / 12);
    } else if (year >= 1982) {
        deduction = Math.min(loan * 10000 * 0.007 / 12, 200000 / 12);
    }

    const total = pmt + feeM + feeR - deduction;
    document.getElementById('hud-total').innerText = Math.floor(total).toLocaleString();
    
    // å°†æ¥ãƒªã‚¹ã‚¯
    const risk = fundMode === 'step' ? 'å°†æ¥2.5å€å¢—é¡' : 'ãªã—';
    document.getElementById('hud-risk').innerText = risk;

    return { total, pmt, feeM, feeR, loan, price, deduction };
}

function showReport() {
    const d = calc();
    const name = document.getElementById('in-name').value || "æœªè¨­å®šã®ç‰©ä»¶";
    const master = checkMaster(name);
    
    let score = 60;
    let reasons = [];

    // 1. è³‡é‡‘é¢
    const incH = parseFloat(document.getElementById('in-inc-h').value) || 0;
    const incW = parseFloat(document.getElementById('in-inc-w').value) || 0;
    const hhInc = loanMode === 'pair' ? (incH + incW) : incH;
    const ratio = (d.pmt * 12) / (hhInc * 10000) * 100;
    
    if (ratio < 20) score += 15;
    else if (ratio < 28) score += 5;
    else score -= 20;

    // ç‰‡ç¿¼è€æ€§
    const oneWingRatio = (d.pmt * 12) / (incH * 10000) * 100;
    document.getElementById('res-one-wing').innerText = oneWingRatio < 35 ? "ç¶­æŒå¯èƒ½" : "å±é™º(è¦ä¿é™º)";

    // 2. é¢ç©ãƒ»å¤«å©¦é©æ­£
    const area = parseFloat(document.getElementById('in-area').value);
    if (area >= 55 && area <= 70) { score += 10; document.getElementById('res-dinks').innerText = "é»„é‡‘æ¯”(S)"; }
    else if (area < 40) { score -= 30; document.getElementById('res-dinks').innerText = "ç‹­å°(DANGER)"; }
    else { document.getElementById('res-dinks').innerText = "è¨±å®¹ç¯„å›²"; }

    // 3. ç©ºèª¿
    if (acStatus === 'ok') score += 5;
    else if (acStatus === 'ng') score -= 15;
    document.getElementById('res-ac').innerText = acStatus === 'ok' ? "å…¨å®¤å®Œå‚™" : "ä¸€éƒ¨ä¸å¯/åˆ¶ç´„æœ‰";

    // 4. ç®¡ç†ãƒ»å»ºã¦æ›¿ãˆ
    const units = parseInt(document.getElementById('in-units').value);
    const land = parseFloat(document.getElementById('in-land').value);
    const mochimochi = land / units;
    document.getElementById('res-reb').innerText = mochimochi > 30 ? "é«˜(åœŸåœ°æŒåˆ†å¤š)" : "ä¸­(ä¸€èˆ¬)";
    if (mochimochi > 30) score += 10;
    
    if (master) score += 10;

    // ãƒã‚¶ãƒ¼ãƒ‰ Kill Switch
    if (hazStatus === 'danger') score = 0;

    // æœ€çµ‚è¡¨ç¤º
    const scoreFinal = Math.min(100, Math.max(0, score));
    const rank = scoreFinal >= 90 ? 'S' : (scoreFinal >= 75 ? 'A' : (scoreFinal >= 60 ? 'B' : 'C'));
    if (hazStatus === 'danger') { document.getElementById('res-rank').innerText = 'E'; document.getElementById('res-rank').className = 'text-red'; }
    else { document.getElementById('res-rank').innerText = rank; document.getElementById('res-rank').className = 'text-gold'; }
    
    document.getElementById('res-score').innerText = scoreFinal;
    document.getElementById('rep-name').innerText = name;
    document.getElementById('res-loan-limit').innerText = ratio.toFixed(1) + "%";
    document.getElementById('res-land-val').innerText = (mochimochi * 50).toFixed(0) + "ä¸‡å††(æ¨å®š)";

    // ã‚ªãƒ©ã‚¯ãƒ«
    const oracle = `ã€2035å¹´ã€‘è‡ªå‹•é‹è»¢æ™®åŠã«ã‚ˆã‚Šå‘¨è¾ºã®é™å¯‚æ€§ãŒä¾¡å€¤ã«ã€‚å…‰ç†±è²»ä¸Šæ˜‡ã«ä¼´ã„çœã‚¨ãƒæ€§èƒ½ãŒå·®åˆ¥åŒ–ã®éµã€‚
ã€2045å¹´ã€‘2026å¹´æ”¹æ­£æ³•ã«åŸºã¥ãå†ç”Ÿæ±ºè­°ãŒç¾å®ŸåŒ–ã€‚åœŸåœ°æŒåˆ†${mochimochi.toFixed(1)}ã¡ãŒè³‡ç”£ã®ç›¾ã¨ãªã‚Šã¾ã™ã€‚
ã€2055å¹´ã€‘æ°—å€™å¤‰å‹•ãŒé€²ã‚€ä¸­ã€${hazStatus==='safe'?'æœ¬é«˜å°ç«‹åœ°ã¯å¸Œå°‘ãªå®‰å…¨åœ':'æ°´é˜²å¯¾ç­–ã®å¾¹åº•'}ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹æ™‚ä»£ã¸ã€‚`;
    document.getElementById('res-oracle').innerText = oracle;

    document.getElementById('report-area').style.display = 'block';
    document.getElementById('report-area').scrollIntoView({behavior: 'smooth'});
}

function showToast(m) {
    const t = document.getElementById('toast');
    t.innerText = m; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

function copyLine() {
    const name = document.getElementById('in-name').value;
    const rank = document.getElementById('res-rank').innerText;
    const total = document.getElementById('hud-total').innerText;
    const txt = `ã€æ¤œè¨ç‰©ä»¶ã€‘${name}\n---\nåˆ¤å®š: ${rank}ãƒ©ãƒ³ã‚¯\næœˆé¡å®Ÿè³ª: ${total}å††\nå°†æ¥åœŸåœ°å€¤: ${document.getElementById('res-land-val').innerText}\n---\n#ESTATE_OS`;
    navigator.clipboard.writeText(txt).then(() => showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}
</script>
</body>
</html>
