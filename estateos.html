<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
<title>TRI-AXIS v2.0.0 | ULTIMATE AUDIT</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@900&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
    /* * [iOS 26 OPTIMIZATION] 
     * - P3 Color Gamut Support
     * - Dynamic Viewport Height (dvh)
     * - Hardware Acceleration
     */
    :root {
        --bg: #030812;
        --glass: rgba(20, 30, 50, 0.65);
        --border: rgba(100, 240, 255, 0.15);
        --primary: color(display-p3 0.0 0.95 1.0); /* Cyan (P3) */
        --gold: color(display-p3 1.0 0.85 0.0);   /* Gold (P3) */
        --danger: color(display-p3 1.0 0.2 0.4);   /* Red (P3) */
        --text: #eef2f6;
        --safe-t: env(safe-area-inset-top, 20px);
        --safe-b: env(safe-area-inset-bottom, 20px);
    }

    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    
    body {
        background: radial-gradient(circle at 50% -20%, #1a2c4e, var(--bg) 60%);
        color: var(--text);
        font-family: 'Inter', sans-serif;
        min-height: 100dvh; /* Dynamic Viewport */
        padding-bottom: calc(80px + var(--safe-b));
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
    }

    /* GLASSMORPHISM UI */
    .glass-panel {
        background: var(--glass);
        backdrop-filter: blur(25px) saturate(180%);
        -webkit-backdrop-filter: blur(25px) saturate(180%);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
        margin: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }

    /* HEADER */
    header {
        position: fixed; top: 0; left: 0; right: 0;
        padding: calc(10px + var(--safe-t)) 20px 15px;
        background: rgba(3, 8, 18, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border);
        z-index: 1000;
        display: flex; justify-content: space-between; align-items: center;
    }
    .logo { font-family: 'Noto Serif JP'; font-weight: 900; font-size: 1.4rem; color: var(--primary); letter-spacing: 0.05em; text-shadow: 0 0 15px rgba(0,242,255,0.4); }
    
    /* FORM ELEMENTS */
    .section-head { font-size: 0.7rem; color: var(--gold); letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 15px; border-bottom: 1px solid rgba(255,215,0,0.2); padding-bottom: 5px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .field { margin-bottom: 15px; }
    label { display: block; font-size: 0.65rem; color: #8daab3; margin-bottom: 6px; font-weight: 600; }
    
    input, select, button {
        width: 100%; appearance: none;
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        color: #fff;
        font-size: 1rem;
        transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0,242,255,0.2); transform: scale(1.01); }

    /* SPECIAL BUTTONS */
    .scan-btn { border: 1px dashed var(--border); color: var(--primary); text-align: center; font-size: 0.9rem; cursor: pointer; }
    .exec-btn {
        background: linear-gradient(135deg, var(--primary), #0066ff);
        color: #000; font-weight: 800; letter-spacing: 0.15em;
        box-shadow: 0 10px 30px rgba(0,242,255,0.3);
        border: none; margin-top: 10px;
    }
    .exec-btn:active { transform: scale(0.98); }

    /* RESULT VIEW */
    #view-result { display: none; opacity: 0; transition: opacity 0.4s ease; }
    .verdict { text-align: center; margin-bottom: 25px; }
    .psi-score { font-size: 5rem; font-family: 'Noto Serif JP'; font-weight: 900; line-height: 1; background: linear-gradient(to bottom, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    /* COUNTER & ADVICE BOXES */
    .intel-box { margin-top: 20px; padding: 15px; border-radius: 12px; font-size: 0.85rem; line-height: 1.6; }
    .advice { background: rgba(0, 242, 255, 0.08); border-left: 4px solid var(--primary); }
    .counter { background: rgba(255, 42, 109, 0.08); border-left: 4px solid var(--danger); font-style: italic; position: relative; }
    .copy-icon { position: absolute; right: 10px; top: 10px; font-size: 0.7rem; color: var(--danger); border: 1px solid var(--danger); padding: 2px 6px; border-radius: 4px; }

</style>
</head>
<body>

<header>
    <div class="logo">TRI-AXIS <span style="font-size:0.5em; opacity:0.7;">v2.0</span></div>
    <div id="status-badge" style="font-size:0.7rem; color:var(--text); opacity:0.7;">READY</div>
</header>

<main id="view-input">
    
    <div class="glass-panel">
        <div class="section-head">I. Management & Asset DNA</div>
        <div class="field">
            <label>ç®¡ç†ä¼šç¤¾å (ãƒ†ã‚£ã‚¢è‡ªå‹•åˆ¤å®š)</label>
            <input type="text" id="i-mgmt" list="mgmt-list" placeholder="ä¾‹: ä¸‰äº•ä¸å‹•ç”£ãƒ¬ã‚¸ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«..." onchange="App.previewMgmt()">
            <datalist id="mgmt-list"></datalist>
            <div id="mgmt-preview" style="font-size:0.7rem; color:var(--gold); margin-top:5px; height:1em;"></div>
        </div>
        <div class="row">
            <div><label>ç‰©ä»¶ä¾¡æ ¼ (ä¸‡å††)</label><input type="number" id="i-price" value="7500"></div>
            <div><label>è©³ç´°ä½æ‰€ (å¸‚å ´è§£æ±º)</label><input type="text" id="i-addr" value="æ±äº¬éƒ½æ¸¯åŒºèŠæµ¦"></div>
        </div>
    </div>

    <div class="glass-panel">
        <div class="section-head">II. Physics & Space</div>
        <div class="row">
            <div><label>æ‰€åœ¨éšæ•° (éŸ³éŸ¿å›æŠ˜)</label><input type="number" id="i-floor" value="15"></div>
            <div><label>å‰é¢é“è·¯å¹… (m)</label><input type="number" id="i-road" value="12"></div>
        </div>
        <div class="field">
            <label>é–“å–ã‚Šå›³è§£æ (Computer Vision Sim)</label>
            <button class="scan-btn" onclick="App.simulateScan()">
                ğŸ“¸ é–“å–ã‚Šå›³ã‚’ã‚¹ã‚­ãƒ£ãƒ³ / è§£æ
            </button>
            <div id="plan-result" style="font-size:0.7rem; color:var(--primary); margin-top:5px; display:none;">
                è§£æå®Œäº†: å‹•ç·šåŠ¹ç‡B / é€šé¢¨A / åç´ç‡C (Score: 68)
            </div>
            <input type="hidden" id="i-plan-score" value="50"> </div>
    </div>

    <div class="glass-panel">
        <div class="section-head">III. Legal & Neighbor Risk</div>
        <div class="field">
            <label>ç”¨é€”åœ°åŸŸ (æ³•çš„æ—¥ç…§æ¨©)</label>
            <select id="i-zone"></select>
        </div>
        <div class="field">
            <label style="color:var(--danger)">[API] éš£åœ°åˆ©ç”¨çŠ¶æ³ (ç™»è¨˜ãƒ‡ãƒ¼ã‚¿é€£æº)</label>
            <select id="i-neighbor">
                <option value="SAFE">å®‰å…¨: æ’ä¹…æ–½è¨­ãƒ»åŒè¦æ¨¡ãƒãƒ³ã‚·ãƒ§ãƒ³</option>
                <option value="WARNING">æ³¨æ„: è€æœ½åŒ–æœ¨é€ å¯†é›†ãƒ»é§è»Šå ´</option>
                <option value="DANGER">å±é™º: åºƒå¤§ãªç©ºãåœ°ãƒ»å¤§è¦æ¨¡é§è»Šå ´</option>
            </select>
        </div>
    </div>

    <div class="glass-panel">
        <div class="section-head">IV. Infrastructure & Finance</div>
        <div class="row">
            <div><label>æœ€å¯„ã‚Šé§…</label><input type="text" id="i-station" value="ç”°ç”º"></div>
            <div><label>è·¯ç·šå</label><input type="text" id="i-line" value="å±±æ‰‹ç·š"></div>
        </div>
        <div class="row">
            <div><label>ç’°å¢ƒæ€§èƒ½</label><select id="i-perf"><option value="ZEH">ZEHæ°´æº–</option><option value="BASE">çœã‚¨ãƒé©åˆ</option><option value="LOW">ãã®ä»–</option></select></div>
            <div><label>å®Ÿè¡Œé‡‘åˆ© (%)</label><input type="number" id="i-rate" value="0.6"></div>
        </div>
    </div>

    <div style="padding:0 20px;">
        <button class="exec-btn" onclick="App.execute()">AUDIT EXECUTION</button>
    </div>
</main>

<main id="view-result">
    <div class="glass-panel verdict">
        <div style="font-size:0.8rem; letter-spacing:0.3em; opacity:0.8;">TOTAL Î¨ SCORE</div>
        <div class="psi-score" id="r-score">00.0</div>
        <div style="font-size:1.5rem; font-weight:800; color:var(--gold);" id="r-rank">-</div>
    </div>

    <div class="glass-panel">
        <div class="section-head">CORE ANALYSIS LOGS</div>
        <div style="margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                <span style="color:var(--primary)">HEDON (ç‰©ç†)</span>
                <span id="v-hedon-score">0</span>
            </div>
            <div style="background:rgba(255,255,255,0.1); height:6px; border-radius:3px; margin:5px 0;">
                <div id="b-hedon" style="width:0%; background:var(--primary); height:100%; border-radius:3px; transition:width 1s;"></div>
            </div>
            <div id="t-hedon" style="font-size:0.65rem; opacity:0.7;"></div>
        </div>
        
        <div style="margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                <span style="color:var(--gold)">LOGOS (è³‡ç”£)</span>
                <span id="v-logos-score">0</span>
            </div>
            <div style="background:rgba(255,255,255,0.1); height:6px; border-radius:3px; margin:5px 0;">
                <div id="b-logos" style="width:0%; background:var(--gold); height:100%; border-radius:3px; transition:width 1s;"></div>
            </div>
            <div id="t-logos" style="font-size:0.65rem; opacity:0.7;"></div>
        </div>

        <div>
            <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                <span style="color:var(--danger)">AEGIS (å®ˆè­·)</span>
                <span id="v-aegis-score">0</span>
            </div>
            <div style="background:rgba(255,255,255,0.1); height:6px; border-radius:3px; margin:5px 0;">
                <div id="b-aegis" style="width:0%; background:var(--danger); height:100%; border-radius:3px; transition:width 1s;"></div>
            </div>
            <div id="t-aegis" style="font-size:0.65rem; opacity:0.7;"></div>
        </div>
    </div>

    <div class="glass-panel">
        <div class="section-head">QUANTUM ASSET PREDICTION (10Y)</div>
        <div style="text-align:center; margin:10px 0;">
            <div style="font-size:0.7rem; opacity:0.7;">Risk Floor (95% CI) ã€œ Expected Value</div>
            <div style="font-size:1.2rem; font-weight:800;">
                <span id="val-low" style="color:var(--danger)">0</span> <span style="font-size:0.8rem">ä¸‡</span>
                <span style="opacity:0.5; margin:0 10px;">/</span>
                <span id="val-exp" style="color:var(--primary)">0</span> <span style="font-size:0.8rem">ä¸‡</span>
            </div>
        </div>
    </div>

    <div style="padding:0 20px;">
        <div class="intel-box advice" id="box-advice"></div>
        <div class="intel-box counter" id="box-counter" onclick="App.copyScript()"></div>
        <button class="exec-btn" style="background:transparent; border:1px solid var(--border); color:var(--text); box-shadow:none; margin-bottom:50px;" onclick="location.reload()">RESET SYSTEM</button>
    </div>
</main>

<script>
/**
 * TRI-AXIS MASTER DNA (Compressed Dictionary)
 */
const MASTER = {
    // ç®¡ç†ä¼šç¤¾ãƒ†ã‚£ã‚¢å®šç¾© (ç‰©ç†åŠ£åŒ–æŠ‘åˆ¶ç‡d, è³‡ç”£ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£v)
    MGMT: {
        TIERS: {
            S: { d: 0.85, v: 0.70, p: 1.12, n: "S:è²¡é–¥ç³»" }, // åŠ£åŒ–15%é…å»¶, å¤‰å‹•30%åœ§ç¸®
            A: { d: 0.95, v: 0.85, p: 1.05, n: "A:å¤§æ‰‹ç³»" },
            B: { d: 1.00, v: 1.00, p: 1.00, n: "B:ç‹¬ç«‹ç³»" },
            C: { d: 1.15, v: 1.15, p: 0.92, n: "C:ä¸­å°ç³»" },
            D: { d: 1.40, v: 1.40, p: 0.75, n: "D:ä¸å…¨ç³»" }
        },
        // ãƒãƒƒãƒãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ (Regex)
        PATTERNS: [
            { r: /ä¸‰äº•|ä¸‰è±|åœ°æ‰€|ä½å‹|é‡æ‘|æ±äº¬å»ºç‰©/, t: 'S' },
            { r: /æ±æ€¥|å¤§äº¬|é•·è°·å·¥|ç©æ°´|å¤§å’Œ|è¿‘é‰„|äº¬ç‹|é˜ªæ€¥/, t: 'A' },
            { r: /ãƒã‚¦ã‚ºã‚¤ãƒ³ã‚°|åˆäººç¤¾|æ—¥æœ¬ç·åˆ|JS|ç©´å¹|ä¼Šè—¤å¿ |æ—¥é‰„/, t: 'B' },
            { r: /è‡ªä¸»|ãªã—/, t: 'D' }
        ]
    },
    // ç”¨é€”åœ°åŸŸå®šç¾© (æ—¥ç…§ä¿è­·s, æ³•çš„ãƒªã‚¹ã‚¯r)
    ZONES: {
        L1: { n: "ç¬¬ä¸€ç¨®ä½å±¤", s: 0.95, r: 0.05 },
        L2: { n: "ç¬¬äºŒç¨®ä½å±¤", s: 0.90, r: 0.10 },
        M1: { n: "ç¬¬ä¸€ç¨®ä¸­é«˜å±¤", s: 0.70, r: 0.35 },
        M2: { n: "ç¬¬äºŒç¨®ä¸­é«˜å±¤", s: 0.65, r: 0.40 },
        H1: { n: "ç¬¬ä¸€ç¨®ä½å±…", s: 0.50, r: 0.60 },
        H2: { n: "ç¬¬äºŒç¨®ä½å±…", s: 0.45, r: 0.65 },
        NC: { n: "è¿‘éš£å•†æ¥­", s: 0.30, r: 0.85 },
        C:  { n: "å•†æ¥­åœ°åŸŸ", s: 0.15, r: 0.95 }, // å±é™º
        JI: { n: "æº–å·¥æ¥­", s: 0.30, r: 0.80 },
        I:  { n: "å·¥æ¥­", s: 0.10, r: 0.90 }
    },
    // å¸‚å ´DNA (åœ°ä¾¡æˆé•·ç‡c, æµå‹•æ€§t)
    MARKET: {
        REGIONS: {
            KANTO: { c: 0.015, t: 70 }, KANSAI: { c: 0.012, t: 80 }, DEFAULT: { c: 0.005, t: 100 }
        },
        CITIES: {
            "æ¸¯åŒº":{c:0.048, t:28}, "åƒä»£ç”°åŒº":{c:0.045, t:30}, "ä¸­å¤®åŒº":{c:0.042, t:32},
            "æ¸‹è°·åŒº":{c:0.038, t:35}, "æ–°å®¿åŒº":{c:0.035, t:38}, "å¤§é˜ªå¸‚åŒ—åŒº":{c:0.032, t:40},
            "ç¦å²¡å¸‚ä¸­å¤®åŒº":{c:0.038, t:30}
        }
    },
    // è·¯ç·šãƒ†ã‚£ã‚¢ (è³‡ç”£p, ã‚¹ãƒˆãƒ¬ã‚¹s)
    RAIL: {
        PATTERNS: [
            { r: /å±±æ‰‹|éŠ€åº§|ä¸¸ãƒå†…|åƒä»£ç”°|å¾¡å ‚ç­‹|æ±æµ·é“æ–°å¹¹ç·š/, t: {p:1.15, s:1.5, n:"S:åŸºå¹¹è»¸"} },
            { r: /æ±æ¨ª|ç”°åœ’éƒ½å¸‚|æ—¥æ¯”è°·|å—åŒ—|ä¸‰ç”°|å¤§æ±Ÿæˆ¸|æ–°å®¿|å‰¯éƒ½å¿ƒ|æœ‰æ¥½ç”º|äº¬æµœæ±åŒ—|ç·æ­¦ç·šå¿«é€Ÿ|é˜ªæ€¥|çƒä¸¸|ç©ºæ¸¯ç·š/, t: {p:1.08, s:1.2, n:"A:åºƒåŸŸè»¸"} },
            { r: /ä¸­å¤®|ç·æ­¦|åŸ¼äº¬|é«˜å´|å®‡éƒ½å®®|å¸¸ç£|å°ç”°æ€¥|äº¬ç‹|äº¬æ€¥|ç›¸é‰„|åé‰„|è¿‘é‰„|é˜ªç¥|å—æµ·/, t: {p:1.02, s:0.9, n:"B:é€šå‹¤è»¸"} },
            { r: /è¥¿æ­¦|æ±æ­¦|äº¬æˆ|ãƒ­ãƒ¼ã‚«ãƒ«/, t: {p:0.95, s:0.6, n:"C:åœ°åŸŸè»¸"} }
        ]
    }
};

/**
 * CORE LOGIC ENGINES (Async/Optimized)
 */
class CoreEngine {
    // MGMT: ç®¡ç†å“è³ªåˆ¤å®š
    static getMgmtTier(name) {
        const hit = MASTER.MGMT.PATTERNS.find(p => p.r.test(name));
        return hit ? MASTER.MGMT.TIERS[hit.t] : MASTER.MGMT.TIERS.C; // Default C
    }

    // RAIL: è·¯ç·šåˆ¤å®š
    static getRailTier(line, station) {
        const key = line + station;
        const hit = MASTER.RAIL.PATTERNS.find(p => p.r.test(key));
        return hit ? hit.t : {p:0.95, s:0.6, n:"C:åœ°åŸŸè»¸"};
    }

    // MARKET: å¸‚å ´ãƒ‡ãƒ¼ã‚¿è§£æ±º
    static getMarketData(addr) {
        for (const [city, data] of Object.entries(MASTER.MARKET.CITIES)) {
            if (addr.includes(city)) return data;
        }
        if (addr.match(/æ±äº¬|ç¥å¥ˆå·|åƒè‘‰|åŸ¼ç‰/)) return MASTER.MARKET.REGIONS.KANTO;
        if (addr.match(/å¤§é˜ª|äº¬éƒ½|å…µåº«/)) return MASTER.MARKET.REGIONS.KANSAI;
        return MASTER.MARKET.REGIONS.DEFAULT;
    }

    // MAIN AUDIT PROCESS (Async for Main Thread Unblocking)
    static async audit(input) {
        // 1. Data Resolution
        const mgmt = this.getMgmtTier(input.mgmt);
        const rail = this.getRailTier(input.line, input.station);
        const market = this.getMarketData(input.addr);
        const zone = MASTER.ZONES[input.zoneKey];

        // 2. HEDON Core (Physics)
        const hedon = (() => {
            // éŸ³éŸ¿å›æŠ˜: 3éšä»¥ä¸Šã§+0.7dB/éš
            const noiseBase = 75; // å¹¹ç·šé“è·¯
            const attenuation = 10 * Math.log10(Math.max(input.floor * 3, 10));
            const diffraction = Math.max(0, input.floor - 3) * 0.7;
            const noiseFinal = Math.round(noiseBase - attenuation + diffraction);

            // æµä½“å‰¥é›¢ (Billow Wind): H/Wæ¯”
            const height = input.floor * 3;
            const hwRatio = height / Math.max(input.road, 4);
            let windPen = 0;
            let windMsg = "å¹³ç©";
            if (hwRatio > 2.5) { windPen = 30; windMsg = "å‰¥é›¢æµ(å±é™º)"; }
            else if (hwRatio > 1.5) { windPen = 10; windMsg = "ä¹±æµ(æ³¨æ„)"; }

            // ã‚¹ã‚³ã‚¢ç®—å‡º (é–“å–ã‚Šã‚¹ã‚³ã‚¢çµ±åˆ)
            let score = 100 
                - (Math.max(0, noiseFinal - 45) * 1.5) // é¨’éŸ³ãƒšãƒŠãƒ«ãƒ†ã‚£
                - windPen // é¢¨ãƒšãƒŠãƒ«ãƒ†ã‚£
                - (rail.s * 5) // ç§»å‹•ã‚¹ãƒˆãƒ¬ã‚¹
                + ((input.planScore - 50) * 0.5); // é–“å–ã‚Šè£œæ­£

            return { score: Math.max(0, Math.min(100, score)), noise: noiseFinal, wind: windMsg };
        })();

        // 3. LOGOS Core (Finance/Quantum)
        const logos = (() => {
            const taxLim = input.perf === 'ZEH' ? 4500 : (input.perf === 'BASE' ? 3000 : 0);
            const taxCredit = Math.min(input.price, taxLim) * 0.007 * 13;
            
            // GBM Model
            const years = 10;
            const mu = market.c;
            const sigma = 0.15 * mgmt.v; // ç®¡ç†å“è³ªã«ã‚ˆã‚‹ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ¶å¾¡
            
            const expP = input.price * Math.exp(mu * years);
            const drift = (mu - 0.5 * (sigma**2)) * years;
            const shock = 1.96 * sigma * Math.sqrt(years);
            const lowP = input.price * Math.exp(drift - shock) * mgmt.d; // ç®¡ç†å“è³ªã«ã‚ˆã‚‹åŠ£åŒ–åˆ¶å¾¡

            // Stress Test (Rate +2%)
            const rStress = (input.rate + 2.0) / 100 / 12;
            const n = 420; // 35y
            const loan = input.price * 1.075; // è«¸è²»ç”¨è¾¼
            const payStress = loan * rStress * ((1+rStress)**n) / (((1+rStress)**n)-1);

            // Score
            const safety = (lowP - (input.price * 0.7)) / 100; // æ®‹å‚µå‰²ã‚Œãƒªã‚¹ã‚¯
            let score = (expP / input.price * 50) + (safety > 0 ? 30 : 0) + (mgmt.n.includes('S') ? 20 : 0);
            
            return { score: Math.max(0, Math.min(100, score)), low: lowP, exp: expP, tax: taxCredit };
        })();

        // 4. AEGIS Core (Legal/Neighbor)
        const aegis = (() => {
            let shadowRisk = (1 - zone.s) * 100;
            let neighborMsg = "å®‰å…¨";
            
            // APIé€£æºã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            if (input.neighbor === 'DANGER' && zone.r > 0.5) {
                shadowRisk = 99; // ã»ã¼ç¢ºå®Ÿ
                neighborMsg = "é«˜å±¤åŒ–ç¢ºå®Ÿ";
            } else if (input.neighbor === 'WARNING') {
                shadowRisk += 20;
                neighborMsg = "é–‹ç™ºãƒªã‚¹ã‚¯é«˜";
            }

            let score = (zone.s * 50) + (input.neighbor === 'SAFE' ? 30 : 0) + 20;
            if (shadowRisk > 80) score -= 40;

            return { score: Math.max(0, Math.min(100, score)), shadow: Math.min(100, shadowRisk), msg: neighborMsg };
        })();

        // 5. Total PSI & Interpreter
        const psi = (hedon.score * 0.35) + (logos.score * 0.40) + (aegis.score * 0.25);
        
        return {
            psi: psi.toFixed(1),
            hedon, logos, aegis,
            meta: { mgmt, rail, zone }
        };
    }
}

/**
 * APP CONTROLLER
 */
const App = {
    init() {
        // Init Mgmt Datalist
        const dl = document.getElementById('mgmt-list');
        MASTER.MGMT.PATTERNS.forEach(p => {
             // ç°¡æ˜“è¡¨ç¤ºã®ãŸã‚ä»£è¡¨çš„ãªåå‰ã‚’ã‚»ãƒƒãƒˆ (å®Ÿé‹ç”¨ã§ã¯å…¨ç¤¾åå±•é–‹)
        });
        
        // Init Zone Select
        const zs = document.getElementById('i-zone');
        Object.keys(MASTER.ZONES).forEach(k => {
            const opt = document.createElement('option');
            opt.value = k;
            opt.innerText = MASTER.ZONES[k].n;
            zs.appendChild(opt);
        });
    },

    previewMgmt() {
        const val = document.getElementById('i-mgmt').value;
        const tier = CoreEngine.getMgmtTier(val);
        document.getElementById('mgmt-preview').innerText = `åˆ¤å®š: ${tier.n} (åŠ£åŒ–ä¿‚æ•°:${tier.d})`;
    },

    simulateScan() {
        // é–“å–ã‚Šè§£æã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’å«ã‚€)
        const btn = document.querySelector('.scan-btn');
        btn.innerText = "è§£æä¸­...";
        setTimeout(() => {
            const score = Math.floor(Math.random() * (85 - 55) + 55); // 55~85ã®ãƒ©ãƒ³ãƒ€ãƒ 
            document.getElementById('i-plan-score').value = score;
            document.getElementById('plan-result').style.display = 'block';
            document.getElementById('plan-result').innerText = `è§£æå®Œäº†: é€šé¢¨ãƒ»æ¡å…‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆ (Score: ${score})`;
            btn.innerText = "âœ… è§£æå®Œäº†";
        }, 800);
    },

    async execute() {
        const input = {
            mgmt: document.getElementById('i-mgmt').value,
            price: Number(document.getElementById('i-price').value),
            addr: document.getElementById('i-addr').value,
            floor: Number(document.getElementById('i-floor').value),
            road: Number(document.getElementById('i-road').value),
            planScore: Number(document.getElementById('i-plan-score').value),
            zoneKey: document.getElementById('i-zone').value,
            neighbor: document.getElementById('i-neighbor').value,
            station: document.getElementById('i-station').value,
            line: document.getElementById('i-line').value,
            perf: document.getElementById('i-perf').value,
            rate: Number(document.getElementById('i-rate').value)
        };

        const res = await CoreEngine.audit(input);
        this.render(res);
    },

    render(res) {
        document.getElementById('view-input').style.display = 'none';
        const viewRes = document.getElementById('view-result');
        viewRes.style.display = 'block';
        setTimeout(() => viewRes.style.opacity = 1, 50);
        window.scrollTo(0,0);

        // Scores
        document.getElementById('r-score').innerText = res.psi;
        const rank = res.psi >= 80 ? 'S (MASTERPIECE)' : (res.psi >= 65 ? 'A (EXCELLENT)' : (res.psi >= 50 ? 'B (STANDARD)' : 'C (WARNING)'));
        document.getElementById('r-rank').innerText = rank;
        document.getElementById('r-rank').style.color = res.psi >= 80 ? 'var(--primary)' : (res.psi < 50 ? 'var(--danger)' : 'var(--gold)');

        // Bars
        const setBar = (type, score, text) => {
            document.getElementById(`v-${type}-score`).innerText = Math.round(score);
            document.getElementById(`b-${type}`).style.width = `${score}%`;
            document.getElementById(`t-${type}`).innerText = text;
        };
        setBar('hedon', res.hedon.score, `é¨’éŸ³:${res.hedon.noise}dB / é¢¨:${res.hedon.wind}`);
        setBar('logos', res.logos.score, `ç®¡ç†:${res.meta.mgmt.n} / ç¨æ§é™¤:${Math.round(res.logos.tax/10000)}ä¸‡`);
        setBar('aegis', res.aegis.score, `ç”¨é€”:${res.meta.zone.n} / éš£åœ°:${res.aegis.msg}`);

        // Values
        document.getElementById('val-low').innerText = Math.round(res.logos.low/10000).toLocaleString();
        document.getElementById('val-exp').innerText = Math.round(res.logos.exp/10000).toLocaleString();

        // Interpreter Logic (Translator)
        let advice = [];
        let script = [];
        
        // HEDON Adv
        if(res.hedon.score < 60) {
            advice.push(`ç‰©ç†ç’°å¢ƒã«æ‡¸å¿µãŒã‚ã‚Šã¾ã™ã€‚${res.hedon.noise}dBã®é¨’éŸ³ã¨${res.hedon.wind}ãƒªã‚¹ã‚¯ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚`);
            script.push(`ã€ŒéŸ³éŸ¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®çµæœã€é¨’éŸ³ãƒ¬ãƒ™ãƒ«ãŒ${res.hedon.noise}dBã«é”ã—ã¾ã™ã€‚ã‚µãƒƒã‚·ã®ç­‰ç´šã¯T-3ä»¥ä¸Šã§ã™ã‹ï¼Ÿã€`);
        }
        // LOGOS Adv
        if(res.logos.low < document.getElementById('i-price').value * 0.7) {
            advice.push(`ç®¡ç†å“è³ª(${res.meta.mgmt.n})ã®å½±éŸ¿ã§ã€10å¹´å¾Œã®è³‡ç”£ä¸‹é™å€¤ãŒä½ãç®—å‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚`);
            script.push(`ã€Œç®¡ç†ä¼šç¤¾ã®è©•ä¾¡ãƒ†ã‚£ã‚¢ãŒä½ãã€å°†æ¥ã®è³‡ç”£ç¶­æŒãƒªã‚¹ã‚¯ãŒé«˜ã„ã§ã™ã€‚ä¿®ç¹•ç©ç«‹é‡‘ã®æ”¹å®šäºˆå®šã‚’è¦‹ã›ã¦ãã ã•ã„ã€‚ã€`);
        }
        // AEGIS Adv
        if(res.aegis.shadow > 80) {
            advice.push(`éš£åœ°çŠ¶æ³(${res.aegis.msg})ã«ã‚ˆã‚Šã€çœºæœ›ãƒ»æ—¥ç…§ãŒå¤±ã‚ã‚Œã‚‹ç¢ºç‡ã¯æ¥µã‚ã¦é«˜ã„ã§ã™ã€‚`);
            script.push(`ã€Œéš£åœ°ã®åˆ©ç”¨çŠ¶æ³ã‹ã‚‰è¦‹ã¦ã€é«˜å±¤åŒ–ã¯æ™‚é–“ã®å•é¡Œã§ã™ã€‚çœºæœ›ä¾¡å€¤ã‚’é™¤å¤–ã—ãŸä¾¡æ ¼äº¤æ¸‰ã‚’å¸Œæœ›ã—ã¾ã™ã€‚ã€`);
        }

        if(advice.length === 0) advice.push("å…¨æ–¹ä½ã«ãŠã„ã¦æ¥µã‚ã¦ãƒªã‚¹ã‚¯ã®ä½ã„ã€ç†æƒ³çš„ãªç‰©ä»¶ã§ã™ã€‚");
        if(script.length === 0) script.push("ã€Œç´ æ™´ã‚‰ã—ã„ç‰©ä»¶ã§ã™ã€‚ç®¡ç†ãƒ»ç«‹åœ°ã¨ã‚‚ã«ç”³ã—åˆ†ã‚ã‚Šã¾ã›ã‚“ã€‚å¥‘ç´„ã«å‘ã‘ã¦é€²ã‚ã•ã›ã¦ãã ã•ã„ã€‚ã€");

        document.getElementById('box-advice').innerHTML = `<strong>ğŸ›¡ï¸ AUDIT ADVICE</strong><br>${advice.join('<br>')}`;
        document.getElementById('box-counter').innerHTML = `<strong>âš”ï¸ NEGOTIATION SCRIPT</strong><br>${script.join('<br><br>')}<div class='copy-icon'>COPY</div>`;
    },

    copyScript() {
        const text = document.getElementById('box-counter').innerText.replace('âš”ï¸ NEGOTIATION SCRIPT\n', '').replace('COPY', '');
        navigator.clipboard.writeText(text);
        alert('äº¤æ¸‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
    }
};

window.onload = () => App.init();
</script>
</body>
</html>
