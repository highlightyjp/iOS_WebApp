<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#2b2f38">
<title>TRI-AXIS: Personal Universe</title>
<style>
/* --- 1. DESIGN SYSTEM: BLUE BASE SUMMER (Cool & Intellectual) --- */
:root {
    /* Palette: Cool Summer (Low Contrast, Blue-Grey Undertones) */
    --bg-base: #2b2f38; /* Deep Blue Grey (Not Black) */
    --glass-panel: rgba(45, 50, 60, 0.75);
    --glass-border: rgba(137, 196, 244, 0.15); /* Powder Blue Tint */
    --glass-highlight: rgba(255, 255, 255, 0.05);
    
    /* Typography */
    --text-main: #e6ecf0; /* Off-white with blue tint */
    --text-muted: #8b9bb4; /* Greyish Blue */
    --text-dim: #546e7a;
    
    /* Accents (No Neon) */
    --accent-primary: #89c4f4; /* Powder Blue */
    --accent-secondary: #a29bfe; /* Soft Lavender */
    --signal-safe: #81ecec; /* Muted Cyan */
    --signal-warn: #ffeaa7; /* Pale Yellow */
    --signal-danger: #ff7675; /* Soft Red */
    
    /* Physics & Layout */
    --safe-top: env(safe-area-inset-top, 20px);
    --safe-bottom: env(safe-area-inset-bottom, 20px);
    --blur-amt: blur(30px) saturate(140%);
    --ease-ios: cubic-bezier(0.25, 1, 0.5, 1);
    
    /* Font Stack */
    --font-stack: "SF Pro Display", -apple-system, BlinkMacSystemFont, sans-serif;
}

/* --- 2. RESET & NATIVE BEHAVIOR --- */
*, *::before, *::after {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

html {
    background-color: var(--bg-base);
    height: 100%;
}

body {
    margin: 0; padding: 0;
    width: 100%;
    /* Allow Vertical Scroll (Fix for v19.0 bug) */
    min-height: 100dvh;
    color: var(--text-main);
    font-family: var(--font-stack);
    background: radial-gradient(circle at 50% -20%, #3a4050 0%, var(--bg-base) 80%);
    overflow-y: auto; 
    -webkit-overflow-scrolling: touch;
}

/* --- 3. COMPONENT ARCHITECTURE --- */

/* The Shell */
#app-shell {
    display: flex; flex-direction: column;
    padding: calc(var(--safe-top) + 16px) 20px calc(var(--safe-bottom) + 100px) 20px;
    gap: 24px;
    opacity: 0; /* Hidden until quarantine pass */
    transition: opacity 0.8s ease-out;
    max-width: 600px; margin: 0 auto; /* Tablet constraint */
}

/* Glass Panels */
.panel {
    background: var(--glass-panel);
    backdrop-filter: var(--blur-amt);
    -webkit-backdrop-filter: var(--blur-amt);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    position: relative;
    overflow: hidden;
}

/* Typography */
h2 {
    font-size: 13px; letter-spacing: 0.1em;
    color: var(--text-muted); text-transform: uppercase;
    margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;
}
.val-xl { font-size: 24px; font-weight: 500; font-feature-settings: "tnum"; letter-spacing: -0.02em; }
.unit { font-size: 12px; color: var(--text-muted); margin-left: 2px; }

/* Inputs (Physics Feel) */
.input-row {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px;
}
.input-group {
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    padding: 4px;
    display: flex; gap: 2px;
}
.radio-btn {
    padding: 8px 16px;
    font-size: 13px;
    border-radius: 10px;
    color: var(--text-muted);
    transition: all 0.2s var(--ease-ios);
}
.radio-btn.active {
    background: var(--accent-primary);
    color: #1a1d24; /* Dark text on light button */
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(137, 196, 244, 0.3);
}

/* Slider Customization (Cool Summer) */
input[type=range] {
    -webkit-appearance: none; width: 100%; background: transparent;
    height: 40px; margin: 0; cursor: grab;
}
input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; height: 28px; width: 28px;
    border-radius: 50%;
    background: #f0f4f8;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    margin-top: -12px;
    transition: transform 0.1s;
}
input[type=range]:active::-webkit-slider-thumb { transform: scale(1.1); }
.slider-track-wrap {
    position: relative; height: 4px; background: rgba(255,255,255,0.1);
    border-radius: 2px; margin: 10px 0 20px 0;
}
.slider-fill {
    position: absolute; height: 100%; left: 0; background: var(--accent-primary);
    border-radius: 2px;
}

/* Toggles & Selectors */
.toggle-switch {
    width: 44px; height: 24px; background: rgba(255,255,255,0.1);
    border-radius: 12px; position: relative; transition: 0.3s;
}
.toggle-switch[data-state="on"] { background: var(--accent-secondary); }
.toggle-knob {
    width: 20px; height: 20px; background: #fff; border-radius: 50%;
    position: absolute; top: 2px; left: 2px; transition: 0.3s var(--ease-ios);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.toggle-switch[data-state="on"] .toggle-knob { transform: translateX(20px); }

/* Status Indicators */
.status-pill {
    font-size: 10px; padding: 4px 8px; border-radius: 12px;
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-muted); display: flex; align-items: center; gap: 6px;
}
.dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-dim); }
.dot.online { background: var(--signal-safe); box-shadow: 0 0 8px var(--signal-safe); }
.dot.internal { background: var(--accent-primary); }

/* --- 4. BOOT QUARANTINE SCREEN --- */
#quarantine-layer {
    position: fixed; inset: 0; background: #1a1d24; z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.bio-ring {
    width: 60px; height: 60px; border-radius: 50%;
    border: 2px solid rgba(137, 196, 244, 0.1);
    border-top-color: var(--accent-primary);
    animation: spin 1s infinite linear;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- 5. PRINT & UTILS --- */
.hidden { display: none !important; }
svg.icon { width: 16px; height: 16px; fill: currentColor; }
</style>
</head>
<body>

<svg style="display:none;">
    <symbol id="ic-user" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
    <symbol id="ic-home" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></symbol>
    <symbol id="ic-job" viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></symbol>
    <symbol id="ic-silence" viewBox="0 0 24 24"><path d="M7 9v6h4l5 5V4l-5 5H7z"/></symbol>
    <symbol id="ic-shield" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></symbol>
</svg>

<div id="quarantine-layer">
    <div class="bio-ring"></div>
    <div style="margin-top: 20px; font-family: monospace; font-size: 10px; color: var(--accent-primary); letter-spacing: 0.1em;">
        SYSTEM INTEGRITY CHECK...
    </div>
    <div id="boot-msg" style="margin-top: 8px; font-family: monospace; font-size: 10px; color: var(--text-muted);">
        Scanning LocalStorage...
    </div>
</div>

<div id="app-shell">
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 20px; font-weight: 600; margin: 0; color: var(--accent-primary);">TRI-AXIS</h1>
            <div style="font-size: 10px; color: var(--text-muted); letter-spacing: 0.05em;">PERSONAL UNIVERSE v21.0</div>
        </div>
        <div class="status-pill">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">INIT</span>
        </div>
    </div>

    <div class="panel">
        <h2><svg class="icon"><use href="#ic-job"/></svg> 属性・キャリア (2025年3月入社)</h2>
        
        <div class="input-row">
            <span style="font-size:13px;">入社年月</span>
            <div style="display:flex; align-items:center; gap:8px;">
                <select id="in-join-year" style="background:rgba(0,0,0,0.3); color:#fff; border:none; padding:4px 8px; border-radius:6px;">
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                </select>
                <span style="font-size:12px;">年</span>
                <select id="in-join-month" style="background:rgba(0,0,0,0.3); color:#fff; border:none; padding:4px 8px; border-radius:6px;">
                    <option value="3" selected>3</option>
                    <option value="4">4</option>
                </select>
                <span style="font-size:12px;">月</span>
            </div>
        </div>
        <div style="font-size:10px; color:var(--accent-secondary); margin-top:-10px; margin-bottom:16px;">
            ※ 初年度補正ロジック適用中 (1,2月無給考慮)
        </div>

        <div class="input-row">
            <span style="font-size:13px;">基本月給 (額面)</span>
            <div><span id="disp-salary" class="val-xl">45</span><span class="unit">万円</span></div>
        </div>
        <div class="slider-track-wrap">
            <div id="fill-salary" class="slider-fill" style="width: 30%;"></div>
            <input type="range" id="in-salary" min="20" max="100" step="1" value="45">
        </div>

        <div class="input-row">
            <span style="font-size:13px;">年間賞与 (夏+冬)</span>
            <div><span id="disp-bonus" class="val-xl">140</span><span class="unit">万円</span></div>
        </div>
        <div class="slider-track-wrap">
            <div id="fill-bonus" class="slider-fill" style="width: 20%;"></div>
            <input type="range" id="in-bonus" min="0" max="400" step="10" value="140">
        </div>

        <div class="input-row" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.05); padding-top:16px;">
            <span style="font-size:13px;">妻の住居費補助</span>
            <div><span id="disp-wife" class="val-xl">0</span><span class="unit">万円/月</span></div>
        </div>
        <div class="slider-track-wrap">
            <div id="fill-wife" class="slider-fill" style="width: 0%;"></div>
            <input type="range" id="in-wife" min="0" max="20" step="1" value="0">
        </div>
    </div>

    <div class="panel">
        <h2><svg class="icon"><use href="#ic-home"/></svg> 物件・物理監査</h2>
        
        <div class="input-row">
            <span style="font-size:13px;">物件価格</span>
            <div><span id="disp-price" class="val-xl">6,500</span><span class="unit">万円</span></div>
        </div>
        <div class="slider-track-wrap">
            <div id="fill-price" class="slider-fill" style="width: 50%;"></div>
            <input type="range" id="in-price" min="2000" max="15000" step="10" value="6500">
        </div>

        <div style="background: rgba(137, 196, 244, 0.05); border-radius: 12px; padding: 12px; margin-top: 16px;">
            <div class="input-row">
                <div style="display:flex; align-items:center; gap:6px;">
                    <svg class="icon" style="color:var(--accent-secondary);"><use href="#ic-silence"/></svg>
                    <span style="font-size:13px; font-weight:600;">生活時間差リスク</span>
                </div>
                <div id="tog-silence" class="toggle-switch" data-state="on"><div class="toggle-knob"></div></div>
            </div>
            
            <div id="silence-options" style="margin-top:12px;">
                <div style="font-size:11px; color:var(--text-muted); margin-bottom:8px;">書斎の位置関係</div>
                <div class="input-group">
                    <div class="radio-btn" data-val="bad">寝室横</div>
                    <div class="radio-btn active" data-val="good">廊下対面</div>
                    <div class="radio-btn" data-val="best">独立</div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2><svg class="icon"><use href="#ic-shield"/></svg> 資金計画 (単独債務)</h2>
        <div class="input-row">
            <span style="font-size:13px;">頭金 (Cash)</span>
            <div><span id="disp-down" class="val-xl">0</span><span class="unit">万円</span></div>
        </div>
        <div class="slider-track-wrap">
            <div id="fill-down" class="slider-fill" style="width: 0%;"></div>
            <input type="range" id="in-down" min="0" max="3000" step="10" value="0">
        </div>

        <div class="input-row">
            <span style="font-size:13px;">変動金利 (Stress +2% test)</span>
            <div><span id="disp-rate" class="val-xl">0.475</span><span class="unit">%</span></div>
        </div>
        <div class="slider-track-wrap">
            <div id="fill-rate" class="slider-fill" style="width: 10%;"></div>
            <input type="range" id="in-rate" min="0.2" max="3.0" step="0.001" value="0.475">
        </div>
    </div>

    <div id="dashboard-area" style="padding-bottom: 40px;">
        </div>

</div>
<script>
/**
 * PART 2: THE CORE WORKER & DATA
 * ---------------------------------------------------
 * Contains:
 * 1. Boot Quarantine (Sanitizer)
 * 2. Web Worker Blob (Background Threads)
 * 3. Token Bucket API Limiter (Anti-DDoS)
 * 4. Circuit Breaker (Fail-Safe)
 */

// --- 1. BOOT QUARANTINE (Main Thread) ---
(function runQuarantine() {
    const log = document.getElementById('boot-msg');
    const shell = document.getElementById('app-shell');
    const layer = document.getElementById('quarantine-layer');

    function failBoot(reason) {
        if(log) log.innerText = `BOOT FAILED: ${reason}`;
        console.error(reason);
        // Force Factory Reset
        localStorage.removeItem('aegis_state_v21');
        setTimeout(() => location.reload(), 2000);
    }

    try {
        // Schema Validation (Simple Zod-like check)
        const raw = localStorage.getItem('aegis_state_v21');
        if (raw) {
            const data = JSON.parse(raw);
            // Type Guard
            if (typeof data.price !== 'number' || isNaN(data.price)) throw new Error("Memory Corruption: Price");
            if (typeof data.salary !== 'number') throw new Error("Memory Corruption: Salary");
            // Logic Guard
            if (data.price < 0 || data.price > 1000000) throw new Error("Logic Violation: Price Overflow");
        }
        
        if(log) log.innerText = "Memory Integrity: OK";
    } catch (e) {
        console.warn("Quarantine intercepted invalid state. Purging.", e);
        localStorage.removeItem('aegis_state_v21');
        if(log) log.innerText = "Corrupted Memory Purged.";
    }
})();

// --- 2. WORKER SOURCE (The Engine Room) ---
const WORKER_SOURCE = `
(function() {
    // --- CONFIG ---
    const CONFIG = {
        API_THROTTLE_MS: 1500, // Polite interval
        API_MAX_BURST: 3,      // Max concurrent requests
        TIMEOUT_MS: 5000,
        GEO_FENCE: { lat: 35.68, lon: 139.76 } // Default Tokyo
    };

    // --- INTERNAL STATE ---
    let db = {
        stations: [], // Will be decompressed
        tokenBucket: CONFIG.API_MAX_BURST,
        lastApiCall: 0,
        isOfflineMode: false
    };

    // --- COMPRESSED MASTER DATA (Simulated LUT) ---
    // In production, this allows instant offline lookup without server
    // ID | Name | PriceIndex | Lat | Lon | SoilType (1=Good, 2=Weak/Swamp)
    const MASTER_B64 = "W3siaWQiOjEwMSwibmFtZSI6IuS6jOWtkOeOieW3nCIsInByaWNlIjoxNjAsImxhdCI6MzUuNjExLCJsb24iOjEzOS42MjYsInNvaWwiOjF9LHsiaWQiOjEwMiwibmFtZSI6IuS4iuacqCIsInByaWNlIjoxMjAsImxhdCI6MzUuNTc1LCJsb24iOjEzOS42NDMsInNvaWwiOjJ9XQ==";

    // --- METHODS ---

    function init() {
        try {
            // Decode Base64 LUT
            const str = self.atob(MASTER_B64);
            const bytes = new Uint8Array(str.length);
            for (let i=0; i<str.length; i++) bytes[i] = str.charCodeAt(i);
            const decoder = new TextDecoder("utf-8");
            db.stations = JSON.parse(decoder.decode(bytes)); // Real UTF-8 parse

            self.postMessage({ type: 'INIT_COMPLETE', status: 'success' });
        } catch(e) {
            self.postMessage({ type: 'ERROR', msg: 'DB Corrupted' });
        }

        // Token Refill (1 token every 5s)
        setInterval(() => {
            if (db.tokenBucket < CONFIG.API_MAX_BURST) db.tokenBucket++;
        }, 5000);
    }

    async function fetchWithBreaker(url, source) {
        if (db.isOfflineMode) throw new Error("CIRCUIT_OPEN");
        
        // Token Check
        if (db.tokenBucket <= 0) throw new Error("RATE_LIMIT");
        
        const now = Date.now();
        if (now - db.lastApiCall < CONFIG.API_THROTTLE_MS) throw new Error("THROTTLED");

        db.tokenBucket--;
        db.lastApiCall = now;

        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), CONFIG.TIMEOUT_MS);

        try {
            const res = await fetch(url, { signal: controller.signal });
            if (!res.ok) throw new Error(\`HTTP_\${res.status}\`);
            return await res.json();
        } catch (e) {
            // If many failures, open circuit? (Simplified here)
            throw e;
        } finally {
            clearTimeout(timeout);
        }
    }

    // API: HeartRails (Station)
    async function searchStation(query) {
        // Fallback to Internal first
        const internalHits = db.stations.filter(s => s.name.includes(query));
        
        try {
            // Try External
            const url = \`https://express.heartrails.com/api/json?method=getStations&name=\${encodeURIComponent(query)}\`;
            const data = await fetchWithBreaker(url, 'HeartRails');
            
            if (data.response && data.response.station) {
                let stations = Array.isArray(data.response.station) 
                    ? data.response.station 
                    : [data.response.station];
                
                // Map & Merge
                return stations.map(s => {
                    const lat = parseFloat(s.y);
                    const lon = parseFloat(s.x);
                    // Match with internal soil data if exists
                    const known = db.stations.find(k => k.name === s.name);
                    return {
                        name: s.name,
                        line: s.line,
                        lat: lat,
                        lon: lon,
                        price: known ? known.price : 100, // Default index
                        soil: known ? known.soil : 0,     // 0=Unknown
                        source: 'API'
                    };
                });
            }
        } catch (e) {
            // Fallback return
            console.warn("API Fail, using internal", e);
        }
        
        // Return internal if API failed
        return internalHits.map(s => ({...s, source: 'INTERNAL'}));
    }

    // --- MESSAGE LOOP ---
    self.onmessage = async function(e) {
        const { type, payload } = e.data;
        if (type === 'BOOT') init();
        if (type === 'SEARCH_STATION') {
            const results = await searchStation(payload);
            self.postMessage({ type: 'SEARCH_RESULT', data: results });
        }
    };
})();
`;

// --- 3. MAIN THREAD BRIDGE ---
const blob = new Blob([WORKER_SOURCE], { type: 'application/javascript' });
const worker = new Worker(URL.createObjectURL(blob));

// Global API
window.AegisCore = {
    searchStation: (q) => worker.postMessage({ type: 'SEARCH_STATION', payload: q })
};

// Event Handler
worker.onmessage = function(e) {
    const { type, data } = e.data;
    
    if (type === 'INIT_COMPLETE') {
        console.log("[Core] Worker Ready.");
        // UI Reveal Logic (Fixing v19.0 bug)
        setTimeout(() => {
            const layer = document.getElementById('quarantine-layer');
            const shell = document.getElementById('app-shell');
            if(layer && shell) {
                layer.style.transition = 'opacity 0.6s ease';
                layer.style.opacity = '0';
                shell.classList.remove('hidden');
                shell.style.opacity = '1';
                setTimeout(() => layer.style.display = 'none', 600);
            }
        }, 800); // Wait for aesthetics
    }
    
    if (type === 'SEARCH_RESULT') {
        window.dispatchEvent(new CustomEvent('WorkerData', { detail: { type, data } }));
    }
};

// Boot the Worker
worker.postMessage({ type: 'BOOT' });

</script>
<script>
/**
 * PART 3: THE LOGIC CORE (PERSONAL UNIVERSE ENGINE)
 * ---------------------------------------------------
 * The brain of TRI-AXIS.
 * * Capabilities:
 * 1. Job Change Logic: Calculates "Deemed Income" vs "Actual Cash Flow".
 * 2. Joint Budgeting: Models "Husband as Debtor" + "Wife as Subsidy".
 * 3. Silence Check: Evaluates floor plan acoustics.
 * 4. Adversarial Verification: Self-attacks the plan to test robustness.
 */

class AegisEngine {
    constructor() {
        this.CONST = {
            STRESS_RATE_ADD: 2.0, // +2.0% rate hike test
            ASSET_DECAY: 0.02,    // 2% annual depreciation
            TAX_RATE: 0.8,        // Net income approx ratio
            SILENCE_PENALTY: 15   // Score penalty for bad acoustics
        };
    }

    /**
     * PMT (Payment) Calculator
     * Uses Withered Math (Standard Formula)
     */
    pmt(ratePct, years, principal) {
        if (principal <= 0) return 0;
        if (ratePct <= 0) return Math.round((principal * 10000) / (years * 12));
        
        const r = (ratePct / 100) / 12;
        const n = years * 12;
        const p = principal * 10000; // Man -> Yen
        
        const x = Math.pow(1 + r, n);
        return Math.round((p * r * x) / (x - 1));
    }

    /**
     * 1. JOB CHANGE LOGIC (2025/03 SPECIAL)
     * Calculates the gap between "Bank Screening Income" and "Real Survival Cash".
     */
    calcIncomeProfile(inputs) {
        const { joinYear, joinMonth, baseSalary, bonus } = inputs;
        
        // A. Bank Screening Income (Theoretical Full Year)
        // (Monthly * 12) + Bonus
        const bankIncome = (baseSalary * 12) + bonus;

        // B. Real Cash Flow (First Year Survival)
        // If joined 2025/3, Jan/Feb are missing (10 months pay).
        let workedMonths = 12;
        if (joinYear === 2025) {
            workedMonths = 12 - (joinMonth - 1); // e.g. Mar(3) -> 12 - 2 = 10 months
        }
        const realIncome = (baseSalary * workedMonths) + bonus;

        return {
            bank: bankIncome,
            real: realIncome,
            gap: bankIncome - realIncome, // The "Missing Money"
            monthlyNet: (baseSalary * 0.8) // Approx Take-home for survival check
        };
    }

    /**
     * 2. SILENCE CHECK (PHYSICS AUDIT)
     * Evaluates risk of waking up wife.
     */
    calcSilenceScore(silenceMode, roomLayout) {
        if (!silenceMode) return { score: 100, risk: "N/A" };

        // roomLayout: 'bad' (Bedroom Side), 'good' (Hallway), 'best' (Separate)
        switch(roomLayout) {
            case 'bad': 
                return { score: 40, risk: "HIGH: 音漏れにより生活リズム衝突の危険大" };
            case 'good': 
                return { score: 85, risk: "LOW: 廊下・ドア2枚隔てており安全" };
            case 'best': 
                return { score: 100, risk: "NONE: 物理的に隔離されており完全" };
            default: 
                return { score: 70, risk: "UNKNOWN" };
        }
    }

    /**
     * MAIN AUDIT PIPELINE
     */
    runAudit(inputs) {
        // --- STEP 1: INCOME ANALYSIS ---
        const incomeProfile = this.calcIncomeProfile(inputs);

        // --- STEP 2: LOAN CALCULATION (BANK VIEW) ---
        const loanAmount = inputs.price - inputs.downPayment;
        const bankPayment = this.pmt(inputs.rate, 35, loanAmount); // Monthly Yen
        
        // Bank Repayment Ratio (Annual Pay / Annual Income)
        // Bank uses "Screening Income" (Full Year)
        const bankRatio = ((bankPayment * 12) / (incomeProfile.bank * 10000)) * 100;

        // --- STEP 3: REAL LIFE CALCULATION (JOINT VIEW) ---
        // Real Burden = Bank Payment - Wife's Subsidy
        const wifeSubsidyYen = inputs.wifeSubsidy * 10000;
        const realBurden = Math.max(0, bankPayment - wifeSubsidyYen);
        
        // Real Ratio (Burden / Real Income)
        // We use Real Income (short year) to be strict
        const realRatio = ((realBurden * 12) / (incomeProfile.real * 10000)) * 100;

        // --- STEP 4: ADVERSARIAL ATTACK (SELF-VERIFICATION) ---
        // "What if rate spikes +2%?"
        const stressPayment = this.pmt(inputs.rate + this.CONST.STRESS_RATE_ADD, 35, loanAmount);
        const stressBurden = Math.max(0, stressPayment - wifeSubsidyYen);
        const stressRatio = ((stressBurden * 12) / (incomeProfile.real * 10000)) * 100;
        
        // Did we survive the attack? (Threshold: 40% ratio)
        const survivedStress = stressRatio < 40;

        // --- STEP 5: SILENCE AUDIT ---
        const silence = this.calcSilenceScore(inputs.silenceMode, inputs.roomLayout);

        // --- STEP 6: SCORING & RANKING ---
        let score = 100;
        let reasons = [];

        // Penalties
        if (bankRatio > 35) { score -= 30; reasons.push("銀行審査: 危険域"); }
        else if (bankRatio > 30) { score -= 10; reasons.push("銀行審査: ギリギリ"); }

        if (realRatio > 30) { score -= 10; reasons.push("実生活: 手元資金圧迫"); }
        
        if (!survivedStress) { score -= 15; reasons.push("脆弱性: 金利上昇に耐えられません"); }

        if (silence.score < 60) { score -= this.CONST.SILENCE_PENALTY; reasons.push("環境: 騒音リスク大"); }

        // Job Change Penalty (Cash Gap)
        if (incomeProfile.gap > 50) {
            // Only warn, minimal score impact if wife supports
            reasons.push(`注意: 初年度年収が${incomeProfile.gap}万円 低いです`);
        }

        // Cap
        score = Math.max(0, Math.min(100, Math.round(score)));

        // Rank
        let rank = 'C';
        if (score >= 90) rank = 'S';
        else if (score >= 75) rank = 'A';
        else if (score >= 60) rank = 'B';

        // Digital Signature (Withered Hash)
        const signature = this.sign(score, rank, realBurden);

        return {
            income: incomeProfile,
            monthly: {
                bank: bankPayment,
                real: realBurden,
                stress: stressBurden
            },
            ratios: {
                bank: bankRatio.toFixed(1),
                real: realRatio.toFixed(1),
                stress: stressRatio.toFixed(1)
            },
            silence: silence,
            score: score,
            rank: rank,
            reasons: reasons,
            signature: signature
        };
    }

    /**
     * Generate Integrity Hash
     */
    sign(score, rank, val) {
        const str = `TRI-AXIS-V21-${score}-${rank}-${val}`;
        let h = 0xdeadbeef;
        for(let i=0; i<str.length; i++) {
            h = Math.imul(h ^ str.charCodeAt(i), 2654435761);
        }
        return ((h ^ h >>> 16) >>> 0).toString(16).toUpperCase();
    }
}

// Instantiate
window.Engine = new AegisEngine();
console.log("[Logic] Personal Universe Engine: MOUNTED");

</script>
<script>
/**
 * PART 4: THE REACTIVE INTERFACE
 * ---------------------------------------------------
 * Bridges the UI (Part 1) with the Logic Engine (Part 3).
 * Features:
 * - Physics-based Debounce (Anti-spam)
 * - True Network Awareness (No fake offline)
 * - Blue Base Summer Theme Rendering
 */

(function() {
    // --- 1. STATE & DOM CACHE ---
    const STATE = {
        joinYear: 2025,
        joinMonth: 3,
        baseSalary: 45, // Man Yen
        bonus: 140,     // Man Yen
        wifeSubsidy: 0, // Man Yen
        price: 6500,    // Man Yen
        downPayment: 0, // Man Yen
        rate: 0.475,    // %
        silenceMode: true,
        roomLayout: 'good' // 'bad'|'good'|'best'
    };

    const UI = {
        inputs: {
            joinYear: document.getElementById('in-join-year'),
            joinMonth: document.getElementById('in-join-month'),
            salary: document.getElementById('in-salary'),
            bonus: document.getElementById('in-bonus'),
            wife: document.getElementById('in-wife'),
            price: document.getElementById('in-price'),
            down: document.getElementById('in-down'),
            rate: document.getElementById('in-rate')
        },
        displays: {
            salary: document.getElementById('disp-salary'),
            bonus: document.getElementById('disp-bonus'),
            wife: document.getElementById('disp-wife'),
            price: document.getElementById('disp-price'),
            down: document.getElementById('disp-down'),
            rate: document.getElementById('disp-rate'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot')
        },
        tracks: {
            salary: document.getElementById('fill-salary'),
            bonus: document.getElementById('fill-bonus'),
            wife: document.getElementById('fill-wife'),
            price: document.getElementById('fill-price'),
            down: document.getElementById('fill-down'),
            rate: document.getElementById('fill-rate')
        },
        toggles: {
            silence: document.getElementById('tog-silence'),
            silenceOpts: document.getElementById('silence-options')
        },
        layoutBtns: document.querySelectorAll('.radio-btn'),
        dashboard: document.getElementById('dashboard-area')
    };

    let calcTimer = null;

    // --- 2. CONTROLLER (INPUT HANDLING) ---
    function init() {
        // A. Sliders (Continuous)
        Object.keys(UI.inputs).forEach(key => {
            const el = UI.inputs[key];
            if (!el) return;
            
            // Event type depends on element
            const evtType = (el.tagName === 'SELECT') ? 'change' : 'input';

            el.addEventListener(evtType, (e) => {
                const val = Number(e.target.value);
                STATE[key] = val;
                
                // Instant Visual Update (Direct Manipulation)
                if (UI.displays[key]) UI.displays[key].innerText = val.toLocaleString();
                if (UI.tracks[key] && el.type === 'range') {
                    const min = Number(el.min);
                    const max = Number(el.max);
                    const percent = ((val - min) / (max - min)) * 100;
                    UI.tracks[key].style.width = `${percent}%`;
                }

                scheduleAudit();
            });
        });

        // B. Toggles (Silence Mode)
        UI.toggles.silence.addEventListener('click', () => {
            STATE.silenceMode = !STATE.silenceMode;
            const sw = UI.toggles.silence;
            const opts = UI.toggles.silenceOpts;
            
            if (STATE.silenceMode) {
                sw.setAttribute('data-state', 'on');
                opts.classList.remove('hidden');
            } else {
                sw.setAttribute('data-state', 'off');
                opts.classList.add('hidden');
                sw.style.background = 'rgba(255,255,255,0.1)';
            }
            scheduleAudit();
        });

        // C. Radio Buttons (Layout)
        UI.layoutBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Visual Update
                UI.layoutBtns.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                // State Update
                STATE.roomLayout = e.target.dataset.val;
                scheduleAudit();
            });
        });

        // D. Network Awareness
        window.addEventListener('online', updateConnStatus);
        window.addEventListener('offline', updateConnStatus);
        updateConnStatus(); // Initial check

        // E. Initial Calc
        scheduleAudit();
    }

    // Debounce Logic
    function scheduleAudit() {
        if (calcTimer) clearTimeout(calcTimer);
        calcTimer = setTimeout(runAudit, 50); // 50ms latency
    }

    function updateConnStatus() {
        const isOnline = navigator.onLine;
        UI.displays.statusText.innerText = isOnline ? "INTERNAL (READY)" : "OFFLINE";
        UI.displays.statusDot.className = isOnline ? "dot internal" : "dot";
        // Note: Part 2 Worker handles API calls logic
    }

    // --- 3. RENDERER (DASHBOARD) ---
    function runAudit() {
        const result = window.Engine.runAudit(STATE);
        renderDashboard(result);
    }

    function renderDashboard(res) {
        // Construct HTML String for Performance
        // Blue Base Theme: Cool colors for High Score, Warm/Muted for Warnings
        
        const rankColor = res.rank === 'S' ? 'var(--signal-safe)' : 
                         (res.rank === 'A' ? 'var(--accent-primary)' : 
                         (res.rank === 'B' ? 'var(--signal-warn)' : 'var(--signal-danger)'));

        let reasonsHtml = '';
        if (res.reasons.length > 0) {
            reasonsHtml = `<div style="margin-top:12px; font-size:11px; color:var(--text-muted);">
                ${res.reasons.map(r => `<div style="margin-bottom:4px;">⚠️ ${r}</div>`).join('')}
            </div>`;
        }

        const html = `
            <div class="panel" style="border-color:${rankColor}; box-shadow:0 0 20px -10px ${rankColor};">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h2 style="color:${rankColor}; margin-bottom:4px;">AUDIT RANK</h2>
                        <div class="text-hero" style="font-size:42px; font-weight:700; color:${rankColor}; line-height:1;">
                            ${res.rank} <span style="font-size:16px; font-weight:400; opacity:0.8;">/ ${res.score}</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:10px; color:var(--text-muted);">DIGITAL SIGNATURE</div>
                        <div style="font-family:monospace; font-size:10px; opacity:0.5;">${res.signature.substring(0,8)}...</div>
                    </div>
                </div>

                ${reasonsHtml}

                <div style="margin-top:20px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.1); display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    
                    <div>
                        <div style="font-size:10px; color:var(--text-muted); text-transform:uppercase;">銀行審査 (表面)</div>
                        <div style="font-size:18px; font-weight:500;">${(res.monthly.bank/10000).toFixed(1)} <span style="font-size:11px;">万円</span></div>
                        <div style="font-size:11px; color:${res.ratios.bank > 30 ? 'var(--signal-warn)' : 'var(--text-muted)'};">
                            返済比率 ${res.ratios.bank}%
                        </div>
                    </div>

                    <div>
                        <div style="font-size:10px; color:var(--accent-primary); text-transform:uppercase;">実質負担 (生活)</div>
                        <div style="font-size:18px; font-weight:600; color:#fff;">${(res.monthly.real/10000).toFixed(1)} <span style="font-size:11px;">万円</span></div>
                        <div style="font-size:11px; color:${res.ratios.real > 25 ? 'var(--signal-warn)' : 'var(--signal-safe)'};">
                            実質比率 ${res.ratios.real}%
                        </div>
                    </div>
                </div>

                <div style="margin-top:12px; font-size:10px; color:var(--text-dim); text-align:center;">
                    ※ 転職初年度の年収補正 (${res.income.gap.toFixed(0)}万円減) 適用済み
                </div>
            </div>
        `;

        UI.dashboard.innerHTML = html;
    }

    // --- BOOT ---
    // Remove quarantine is handled by Part 2 worker event, 
    // but we ensure init runs now.
    init();

})();
</script>
</body>
</html>
