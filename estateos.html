<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ESTATE OS | TRIAD</title>
    <style>
        /* =========================================
           CORE SYSTEM: NOIR THEME & RESET
           ========================================= */
        :root {
            --bg-color: #000000;
            --text-main: #E0E0E0;
            --text-dim: #555555;
            --accent-main: #FF8C00; /* Amber Orange (MAGI Lines) */
            --accent-blue: #00FFFF; /* LOGOS */
            --accent-yellow: #FFD700; /* AEGIS */
            --accent-red: #FF0055; /* HEDON */
            --font-mincho: "Hiragino Mincho ProN", "Yu Mincho", serif;
            --font-mono: "Courier New", Consolas, monospace;
            --glass: rgba(20, 20, 20, 0.9);
            --border-width: 2px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            font-size: 14px;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        /* Utility */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-accent { color: var(--accent-main); }
        .text-blue { color: var(--accent-blue); }
        .text-yellow { color: var(--accent-yellow); }
        .text-red { color: var(--accent-red); }

        /* =========================================
           UI COMPONENT: NEO-MAGI INTERFACE
           ========================================= */
        /* The Container */
        .triad-console {
            position: relative;
            width: 100%;
            padding: 20px 10px;
            background: #000;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
            overflow: hidden;
        }

        /* Headers (æè¨´ / æ±ºè­°) */
        .magi-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 4px double var(--accent-main);
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .magi-title {
            font-family: var(--font-mincho);
            font-weight: 900;
            font-size: 2rem;
            color: var(--accent-main);
            transform: scale(1, 0.85); /* å¹³ä½“ */
            letter-spacing: -2px;
            line-height: 1;
        }
        .magi-meta {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--accent-main);
            line-height: 1.2;
            text-align: left;
        }

        /* The Triangle Layout */
        .triad-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 10px;
            position: relative;
        }

        /* Hexagon Modules (LOGOS, AEGIS, HEDON) */
        .magi-module {
            position: relative;
            height: 100px;
            background: #000;
            border: var(--border-width) solid var(--accent-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer; /* Tap for details */
        }
        /* Top Center (AEGIS) */
        .module-top {
            grid-column: 1 /span 2;
            width: 60%;
            margin: 0 auto;
            clip-path: polygon(0 0, 100% 0, 100% 70%, 80% 100%, 20% 100%, 0 70%);
            border-bottom: none; /* clip-path limitation fix by logic */
        }
        /* Bottom Left (HEDON) */
        .module-left {
            clip-path: polygon(0 0, 80% 0, 100% 20%, 100% 100%, 0 100%);
        }
        /* Bottom Right (LOGOS) */
        .module-right {
            clip-path: polygon(20% 0, 100% 0, 100% 100%, 0 100%, 0 20%);
        }

        .module-label {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-dim);
            z-index: 2;
        }

        /* Status Stamps (æ‰¿èª/å¦å®š) */
        .stamp {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(2);
            font-family: var(--font-mincho);
            font-weight: 900;
            font-size: 2.5rem;
            border: 3px solid currentColor;
            padding: 5px 10px;
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            pointer-events: none;
            white-space: nowrap;
        }
        .stamp.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        /* Verdict Center */
        .verdict-display {
            position: absolute;
            top: 55%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 5;
            pointer-events: none;
        }
        .verdict-rank {
            font-family: var(--font-mono);
            font-size: 4rem;
            font-weight: 900;
            color: var(--text-main);
            text-shadow: 0 0 10px var(--accent-main);
        }
        .verdict-msg {
            font-size: 0.7rem;
            color: var(--accent-main);
            background: #000;
            padding: 2px 5px;
        }

        /* "Thinking" Animation */
        .blink { animation: blinker 0.1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* Status Colors */
        .status-logos.active { background: rgba(0, 255, 255, 0.2); box-shadow: inset 0 0 20px var(--accent-blue); border-color: var(--accent-blue); }
        .status-aegis.active { background: rgba(255, 215, 0, 0.2); box-shadow: inset 0 0 20px var(--accent-yellow); border-color: var(--accent-yellow); }
        .status-hedon.active { background: rgba(255, 0, 85, 0.2); box-shadow: inset 0 0 20px var(--accent-red); border-color: var(--accent-red); }

        /* =========================================
           INPUT FORMS & LAYOUT
           ========================================= */
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .section-title {
            border-left: 4px solid var(--accent-main);
            padding-left: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            margin: 30px 0 15px 0;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-group { margin-bottom: 15px; position: relative; }
        .input-label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        
        input[type="text"], input[type="number"], select {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            font-size: 1rem;
            border-radius: 4px;
            font-family: var(--font-mono);
            appearance: none;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-main);
            box-shadow: 0 0 8px rgba(255, 140, 0, 0.3);
        }

        .btn-action {
            background: #222;
            color: var(--accent-main);
            border: 1px solid var(--accent-main);
            padding: 8px 15px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 5px;
        }
        .btn-action:active { background: var(--accent-main); color: #000; }

        /* Address Search Button inside input */
        .search-icon {
            position: absolute;
            right: 10px; top: 32px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Detail Modal (Slide Down) */
        .detail-panel {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            margin-top: 5px;
            display: none;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: #aaa;
        }
        .detail-panel.open { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .score-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 5px 0; }
        .score-val { color: #fff; font-weight: bold; }

    </style>
</head>
<body>

<div id="app">
    <div class="triad-console">
        <div class="magi-header">
            <div>
                <div class="magi-meta">CODE: ESTATE_63<br>PRIORITY: AAA</div>
                <div class="magi-title">ç‰©ä»¶å¯©æŸ»</div>
            </div>
            <div style="text-align:right;">
                <div class="magi-meta">MODE: SELF_GOVERNANCE<br>TARGET: LOCKED</div>
                <div class="magi-title">åˆ¤æ±º</div>
            </div>
        </div>

        <div class="triad-grid" id="triad_ui">
            <div class="magi-module module-top status-aegis" onclick="app.toggleDetail('aegis')">
                <div class="module-label">AEGISãƒ»2</div>
                <div class="stamp text-yellow" id="stamp_aegis">æ‰¿èª</div>
            </div>
            <div class="magi-module module-left status-hedon" onclick="app.toggleDetail('hedon')">
                <div class="module-label">HEDONãƒ»3</div>
                <div class="stamp text-red" id="stamp_hedon">æ‰¿èª</div>
            </div>
            <div class="magi-module module-right status-logos" onclick="app.toggleDetail('logos')">
                <div class="module-label">LOGOSãƒ»1</div>
                <div class="stamp text-blue" id="stamp_logos">æ‰¿èª</div>
            </div>

            <div class="verdict-display">
                <div class="verdict-rank" id="final_rank">--</div>
                <div class="verdict-msg blink" id="system_status">STANDBY</div>
            </div>
        </div>

        <div id="detail_aegis" class="detail-panel">
            <div class="text-yellow mb-4">[AEGIS SYSTEM LOG]</div>
            <div id="log_aegis">NO DATA</div>
            <button class="btn-action w-full mt-2" onclick="window.open('https://disaportal.gsi.go.jp/maps/', '_blank')">ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—èµ·å‹•</button>
        </div>
        <div id="detail_hedon" class="detail-panel">
            <div class="text-red mb-4">[HEDON SYSTEM LOG]</div>
            <div id="log_hedon">NO DATA</div>
        </div>
        <div id="detail_logos" class="detail-panel">
            <div class="text-blue mb-4">[LOGOS SYSTEM LOG]</div>
            <div id="log_logos">NO DATA</div>
        </div>
    </div>

    <div class="container">
        <div class="section-title">
            <span>I. ç‰©ä»¶ãƒ»ç«‹åœ°</span>
            <span class="text-dim" style="font-size:0.7rem">GEO-SPATIAL</span>
        </div>
        
        <div class="input-group">
            <label class="input-label">éƒµä¾¿ç•ªå· (7æ¡ãƒ»è‡ªå‹•è£œå®Œ)</label>
            <input type="tel" id="inp_zip" placeholder="123-4567" onblur="app.fetchAddress()">
        </div>
        
        <div class="input-group">
            <label class="input-label">ä½æ‰€ (è‡ªå‹•å…¥åŠ›)</label>
            <input type="text" id="inp_address" placeholder="æ±äº¬éƒ½åƒä»£ç”°åŒº...">
            <span class="search-icon" onclick="app.fetchCoords()">ğŸ“</span>
        </div>

        <div class="flex" style="gap:10px;">
            <div class="input-group w-full">
                <label class="input-label">ç‰©ä»¶ä¾¡æ ¼ (ä¸‡å††)</label>
                <input type="tel" id="inp_price" class="sanitizer" placeholder="5000">
            </div>
            <div class="input-group w-full">
                <label class="input-label">ç®¡ç†è²»+ä¿®ç¹• (å††/æœˆ)</label>
                <input type="tel" id="inp_cost" class="sanitizer" placeholder="25000">
            </div>
        </div>

        <div class="section-title">
            <span>II. ä¸–å¸¯ãƒ»è·æ¥­</span>
            <span class="text-dim" style="font-size:0.7rem">FINANCIAL-CORE</span>
        </div>

        <div class="input-group">
            <label class="input-label">ç¾åœ¨ã®å¹´é½¢ (å¤«/å¦»)</label>
            <div class="flex" style="gap:10px;">
                <input type="number" id="inp_age_h" placeholder="35">
                <input type="number" id="inp_age_w" placeholder="32">
            </div>
        </div>

        <div class="input-group">
            <label class="input-label">ä¸–å¸¯å¹´å (ä¸‡å††)</label>
            <input type="tel" id="inp_income" class="sanitizer" placeholder="800">
        </div>

        <div class="input-group">
            <label class="input-label">è·æ¥­ã‚¿ã‚¤ãƒ— (æ˜‡çµ¦ã‚«ãƒ¼ãƒ–é©ç”¨)</label>
            <select id="inp_career">
                <option value="standard">ä¸€èˆ¬ä¼æ¥­ (æ¨™æº–)</option>
                <option value="public">å…¬å‹™å“¡ (å®‰å®š/é€€è·é‡‘)</option>
                <option value="maker">å¤§æ‰‹ãƒ¡ãƒ¼ã‚«ãƒ¼ (å¹´åŠŸåºåˆ—)</option>
                <option value="it">ITãƒ»ãƒ¡ã‚¬ãƒ™ãƒ³ãƒãƒ£ãƒ¼ (çŸ­æœŸé›†ä¸­)</option>
                <option value="finance">é‡‘èãƒ»å•†ç¤¾ (é«˜åå…¥/æ¿€å‹™)</option>
                <option value="free">ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹/è‡ªå–¶æ¥­ (ä¿éšœãªã—)</option>
            </select>
        </div>

        <div class="input-group">
            <label class="input-label">æ•™è‚²ãƒ—ãƒ©ãƒ³</label>
            <select id="inp_edu">
                <option value="public">Allå…¬ç«‹ (æ¨™æº–)</option>
                <option value="mix">å¤§å­¦ã®ã¿ç§ç«‹</option>
                <option value="elite">ä¸­é«˜å¤§ç§ç«‹ (ã‚¨ãƒªãƒ¼ãƒˆ)</option>
            </select>
        </div>

        <div class="section-title">
            <span>III. ãƒªã‚¹ã‚¯è£œæ­£</span>
            <span class="text-dim" style="font-size:0.7rem">RISK-FACTOR</span>
        </div>
        
        <div class="input-group">
            <label class="input-label">æœ€å¯„é§…ãƒ©ãƒ³ã‚¯ (è‡ªå·±ç”³å‘Š)</label>
            <select id="inp_station_rank">
                <option value="1">â˜…1 (æ”¯ç·šãƒ»ãƒã‚¹ä¾¿)</option>
                <option value="3" selected>â˜…3 (æ€¥è¡Œåœè»Š/Hub)</option>
                <option value="5">â˜…5 (Core/è¤‡æ•°è·¯ç·š)</option>
            </select>
        </div>

        <div class="input-group">
            <label class="input-label">é€šå‹¤ã‚¹ãƒˆãƒ¬ã‚¹ (å¤«å©¦åˆè¨ˆ)</label>
            <select id="inp_commute_stress">
                <option value="low">ä½ (å¿«é©/ãƒªãƒ¢ãƒ¼ãƒˆ)</option>
                <option value="mid" selected>ä¸­ (æ¨™æº–çš„)</option>
                <option value="high">é«˜ (æº€å“¡ãƒ»ä¹—æ›å¤š)</option>
                <option value="hell">åœ°ç„ (é™ç•Œ)</option>
            </select>
        </div>
        
        <div style="height: 100px;"></div> </div>
</div>

/* =========================================
   COMPRESSED MASTER DATA (The Knowledge)
   ========================================= */

// 1. ç¨å‹™ãƒã‚¹ã‚¿ (2026 Basis) - Income Tax Brackets [UpperLimit(Man), Rate(%), Deduction(Man)]
const TAX_MAP = [
    [195, 5, 0], [330, 10, 9.75], [695, 20, 42.75], [900, 23, 63.6],
    [1800, 33, 153.6], [4000, 40, 279.6], [Infinity, 45, 479.6]
];
const SOCIAL_RATES = { health: 0.05, pension: 0.0915, emp: 0.006, care: 0.009 }; // Half split assumed

// 2. ã‚­ãƒ£ãƒªã‚¢ã‚«ãƒ¼ãƒ– (Age vs Salary Multiplier %)
// 22=100 as base. Interpolated at runtime.
const CAREER_CURVES = {
    standard: [[22,100], [30,130], [45,160], [55,170], [60,100]],
    public:   [[22,100], [35,140], [50,180], [60,180], [65,120]], // Stable
    maker:    [[22,100], [30,120], [40,160], [55,200], [60,120]], // Seniority
    it:       [[22,110], [30,180], [40,200], [50,180], [60,80]],  // Early peak
    finance:  [[22,120], [30,180], [45,250], [55,250], [60,50]],  // High risk
    free:     [[22,100], [30,150], [40,150], [50,120], [60,80]]   // Unstable
};

// 3. æ•™è‚²è²»ã‚¤ãƒ™ãƒ³ãƒˆ (Age of Child: Cost in Man-Yen)
const EDU_COSTS = {
    public: { 6:30, 12:50, 15:50, 18:250 }, // å…¥å­¦æ™‚ãªã©è¦æ‰€ã®ã¿
    mix:    { 6:30, 12:50, 15:100, 18:500 },
    elite:  { 6:100, 12:400, 15:300, 18:600 }
};

// 4. åœ°ç†ãƒãƒ– (For Distance Calculation)
// [Name, Lat, Lon, EcoScore]
const GEO_HUBS = [
    ["Tokyo", 35.681, 139.767, 100], ["Shinjuku", 35.690, 139.700, 95],
    ["Yokohama", 35.466, 139.622, 90], ["Omiya", 35.906, 139.624, 85],
    ["Chiba", 35.613, 140.113, 80], ["Osaka", 34.702, 135.495, 95],
    ["Nagoya", 35.170, 136.881, 90], ["Hakata", 33.590, 130.420, 90]
];

// 5. åœ§ç¸®é§…ãƒã‚¹ã‚¿ (Major Stations only for brevity in this output, normally 2000+)
// Format: Name|Rank|Lat|Lon (Shortened lat/lon)
const STATION_DB_RAW = 
"æ±äº¬|5|35.68|139.76;æ–°å®¿|5|35.69|139.70;æ¨ªæµœ|5|35.46|139.62;æ¸‹è°·|5|35.65|139.70;" +
"æ± è¢‹|5|35.72|139.71;å“å·|5|35.62|139.74;ä¸Šé‡|4|35.71|139.77;ç«‹å·|4|35.69|139.41;" +
"å¤§å®®|4|35.90|139.62;æµ¦å’Œ|3|35.85|139.65;å·å´|4|35.53|139.69;æ­¦è”µå°æ‰|4|35.57|139.65;" +
"äºŒå­ç‰å·|3|35.61|139.62;ãŸã¾ãƒ—ãƒ©ãƒ¼ã‚¶|3|35.57|139.55;ã‚»ãƒ³ã‚¿ãƒ¼å—|3|35.54|139.57;" +
"ç”ºç”°|3|35.54|139.44;è—¤æ²¢|3|35.33|139.48;èˆ¹æ©‹|3|35.70|139.98;æŸ|3|35.86|139.97";

/* =========================================
   UTILITIES (Sanitizers & Formatters)
   ========================================= */
const Utils = {
    // å…¨è§’â†’åŠè§’, ä¸è¦æ–‡å­—å‰Šé™¤, æ•°å€¤åŒ–
    sanitizeNum: (val) => {
        if (!val) return 0;
        let s = val.toString().replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
        s = s.replace(/[^0-9.-]/g, '');
        return parseFloat(s) || 0;
    },
    // éƒµä¾¿ç•ªå·æ­£è¦åŒ– (123-4567 -> 1234567)
    sanitizeZip: (val) => {
        if (!val) return "";
        let s = val.toString().replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
        return s.replace(/[^0-9]/g, '').substring(0, 7);
    },
    formatCurrency: (num) => {
        return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(num);
    },
    // ç›´ç·šè·é›¢ (Haversine simplified)
    calcDist: (lat1, lon1, lat2, lon2) => {
        const R = 6371; // km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
};
    
/* =========================================
   CORE LOGIC: THE SONAR (API Connection)
   ========================================= */
class Sonar {
    constructor() {
        this.cache = {}; // Simple memory cache
    }

    // GSI Address Search (ä½æ‰€ -> ç·¯åº¦çµŒåº¦)
    async searchAddress(query) {
        if (!query) return null;
        const url = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(query)}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            if (data && data.length > 0) {
                const loc = data[0].geometry.coordinates; // [lon, lat]
                return { lat: loc[1], lon: loc[0], title: data[0].properties.title };
            }
        } catch (e) { console.error("Sonar GSI Error:", e); }
        return null;
    }

    // ZipCloud (éƒµä¾¿ç•ªå· -> ä½æ‰€)
    async searchZip(zip) {
        const z = Utils.sanitizeZip(zip);
        if (z.length !== 7) return null;
        const url = `https://zipcloud.ibsnet.co.jp/api/search?zipcode=${z}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            if (data && data.results) {
                const r = data.results[0];
                return `${r.address1}${r.address2}${r.address3}`;
            }
        } catch (e) { console.error("Sonar Zip Error:", e); }
        return null;
    }

    // Overpass API (å‘¨è¾ºæ–½è¨­æ¢ç´¢) - with Timeout Safety
    async scanArea(lat, lon) {
        // Find: Hospital, Supermarket within 1.5km
        const q = `
            [out:json][timeout:3];
            (
              node["amenity"="hospital"](around:1500,${lat},${lon});
              node["amenity"="clinic"](around:800,${lat},${lon});
              node["shop"="supermarket"](around:800,${lat},${lon});
              node["shop"="convenience"](around:500,${lat},${lon});
            );
            out body;
        `;
        const url = "https://overpass-api.de/api/interpreter";
        
        // Timeout Promise Wrapper
        const fetchWithTimeout = (ms, promise) => {
            return new Promise((resolve, reject) => {
                const timer = setTimeout(() => { resolve(null); }, ms); // Resolve null on timeout (don't break app)
                promise.then(value => { clearTimeout(timer); resolve(value); })
                       .catch(reason => { clearTimeout(timer); resolve(null); });
            });
        };

        try {
            const res = await fetchWithTimeout(3000, fetch(url, { method: 'POST', body: q })); // 3s Timeout
            if (!res) return { status: 'TIMEOUT' }; // Silent fail
            const data = await res.json();
            return this.analyzeNodes(data.elements, lat, lon);
        } catch (e) {
            return { status: 'ERROR' };
        }
    }

    analyzeNodes(nodes, centerLat, centerLon) {
        if (!nodes) return { status: 'NO_DATA' };
        let result = {
            hospital: { dist: 9999, name: '' },
            supermarket: { dist: 9999, name: '' },
            convenience: { dist: 9999, name: '' }
        };

        nodes.forEach(node => {
            const d = Utils.calcDist(centerLat, centerLon, node.lat, node.lon);
            const distM = Math.round(d * 1000);
            
            if (node.tags.amenity === 'hospital' || node.tags.amenity === 'clinic') {
                if (distM < result.hospital.dist) result.hospital = { dist: distM, name: node.tags.name };
            } else if (node.tags.shop === 'supermarket') {
                if (distM < result.supermarket.dist) result.supermarket = { dist: distM, name: node.tags.name };
            } else if (node.tags.shop === 'convenience') {
                if (distM < result.convenience.dist) result.convenience = { dist: distM, name: node.tags.name };
            }
        });
        return { status: 'OK', data: result };
    }
}

/* =========================================
   CORE LOGIC: ESTATE SIMULATOR (100-Year Engine)
   ========================================= */
class EstateEngine {
    constructor() {
        this.today = new Date();
    }

    // ãƒ¡ã‚¤ãƒ³è¨ˆç®—: å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å°†æ¥ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã‚’ç”Ÿæˆ
    simulate(inputs) {
        // Inputs: ageH, ageW, income, career, price, cost, eduType, etc.
        const startYear = this.today.getFullYear();
        const maxAge = 100;
        let timeline = [];
        let assets = 0; // Current savings assumed 0 for simplicity or add input
        let isBankrupt = false;
        let bankruptAge = null;

        // Loan Calc (Flat 35, 1.8% assumed)
        const loanAmount = inputs.price * 10000; // Man -> Yen
        const interestRate = 0.018;
        const loanTerm = 35;
        const monthlyRate = interestRate / 12;
        const monthlyPayment = (loanAmount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, - (loanTerm * 12)));
        let loanBalance = loanAmount;

        // Career Curve Setup
        const curve = CAREER_CURVES[inputs.career] || CAREER_CURVES.standard;
        const getSalaryMult = (age) => {
            // Simple Linear Interpolation
            for (let i = 0; i < curve.length - 1; i++) {
                if (age >= curve[i][0] && age <= curve[i+1][0]) {
                    const t = (age - curve[i][0]) / (curve[i+1][0] - curve[i][0]);
                    return curve[i][1] + t * (curve[i+1][1] - curve[i][1]);
                }
            }
            return age > 60 ? 50 : 100; // Fallback
        };

        // 100 Year Loop
        for (let i = 0; i <= (maxAge - inputs.ageH); i++) {
            const year = startYear + i;
            const currentAgeH = inputs.ageH + i;
            const currentAgeW = inputs.ageW + i;
            
            // 1. Income (Household)
            let baseIncome = inputs.income * 10000; // Yen
            let multiplier = getSalaryMult(currentAgeH) / 100; // Based on Husband mainly
            
            // Retirement Check
            let annualIncome = 0;
            if (currentAgeH < 60) {
                annualIncome = baseIncome * multiplier;
            } else if (currentAgeH < 65) {
                annualIncome = baseIncome * multiplier * 0.6; // Re-employment
            } else {
                annualIncome = 2500000; // Pension (Basic Pair)
            }

            // Tax & Social
            const taxRate = this.getTaxRate(annualIncome / 10000);
            const takeHome = annualIncome * (1 - taxRate);

            // 2. Expenses
            // Housing
            let annualHousing = (inputs.cost * 12);
            if (i < loanTerm) {
                annualHousing += (monthlyPayment * 12);
                loanBalance -= (monthlyPayment * 12) * 0.6; // Principal roughly
            }
            
            // Living (Basic) - 150k/m for couple + inflation 1%
            let livingCost = 150000 * 12 * Math.pow(1.01, i);
            
            // Education
            // Assuming child born at AgeH 35 (Model)
            const childAge = currentAgeH - 35; 
            if (childAge >= 0 && childAge <= 22) {
                const eduPlan = EDU_COSTS[inputs.eduType] || EDU_COSTS.public;
                let eduCost = 0;
                // Add event cost if matches age
                if (eduPlan[childAge]) eduCost = eduPlan[childAge] * 10000;
                // Basic child living cost
                livingCost += 600000; 
                annualHousing += eduCost;
            }

            // Total Balance
            const annualBalance = takeHome - annualHousing - livingCost;
            assets += annualBalance;

            if (assets < 0 && !isBankrupt) {
                isBankrupt = true;
                bankruptAge = currentAgeH;
            }

            timeline.push({ year, age: currentAgeH, assets, balance: annualBalance });
        }

        return { timeline, finalAssets: assets, bankruptAge, isBankrupt };
    }

    getTaxRate(incomeMan) {
        // Find bracket
        for (let b of TAX_MAP) {
            if (incomeMan <= b[0]) return (b[1] / 100) + 0.1; // IncomeTax + Resident(10%)
        }
        return 0.55; // Max
    }
}

/* =========================================
   CORE LOGIC: THE TRIAD SYSTEM (Magi)
   ========================================= */
class TriadMember {
    constructor(name, role) {
        this.name = name;
        this.role = role;
        this.vote = false; // Approval
        this.log = "";
    }
    decide(data) { return false; } // Override me
}

// 1. LOGOS (Financial)
class Logos extends TriadMember {
    decide(simResult, propertyData) {
        // Logic: 100æ­³ã§ãƒ—ãƒ©ã‚¹ã‹ï¼Ÿ ãƒªã‚»ãƒ¼ãƒ«ã¯ï¼Ÿ
        const finalAssets = simResult.finalAssets;
        const isBankrupt = simResult.isBankrupt;
        
        let score = 100;
        let msg = [];

        if (isBankrupt) {
            score -= 50;
            msg.push(`ç ´ç¶»è­¦å‘Š: ${simResult.bankruptAge}æ­³ã§è³‡é‡‘æ¯æ¸‡ã€‚`);
        } else {
            msg.push(`è³‡ç”£å¥å…¨: 100æ­³æ®‹é«˜ ${Utils.formatCurrency(finalAssets)}ã€‚`);
        }

        // Resale Value based on Station Rank
        if (propertyData.stationRank >= 5) {
            msg.push("è³‡ç”£æ€§: S (Coreé§…)ã€‚");
        } else if (propertyData.stationRank <= 2) {
            score -= 30;
            msg.push("è³‡ç”£æ€§: è„†å¼± (Localé§…)ã€‚");
        }

        this.vote = score >= 60;
        this.log = msg.join(" ");
        return this.vote;
    }
}

// 2. AEGIS (Safety)
class Aegis extends TriadMember {
    decide(sonarResult, userInputs) {
        // Logic: ç—…é™¢ã¯ã‚ã‚‹ã‹ï¼Ÿ ãƒã‚¶ãƒ¼ãƒ‰ã¯ï¼Ÿ
        let score = 100;
        let msg = [];

        // Sonar Data
        if (sonarResult.status === 'OK') {
            const hDist = sonarResult.data.hospital.dist;
            if (hDist > 1200) {
                score -= 40;
                msg.push(`åŒ»ç™‚éç–: æœ€å¯„ç—…é™¢ã¾ã§${hDist}mã€‚`);
            } else {
                msg.push(`åŒ»ç™‚ã‚¢ã‚¯ã‚»ã‚¹: è‰¯å¥½(${hDist}m)ã€‚`);
            }
        } else if (sonarResult.status === 'TIMEOUT') {
             msg.push("å‘¨è¾ºãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€‚ç¾åœ°ç¢ºèªæ¨å¥¨ã€‚");
             score -= 10;
        }

        // Manual Hazard Input
        // (Assuming we use the input fields for risk later, currently basic check)
        
        // Station Access (Safety for elderly)
        if (userInputs.stationRank < 2) {
            score -= 20;
            msg.push("å­¤ç«‹ãƒªã‚¹ã‚¯: è»Šå¿…é ˆã‚¨ãƒªã‚¢ã€‚");
        }

        this.vote = score >= 60;
        this.log = msg.join(" ");
        return this.vote;
    }
}

// 3. HEDON (Life Quality)
class Hedon extends TriadMember {
    decide(sonarResult, userInputs) {
        // Logic: ã‚³ãƒ³ãƒ“ãƒ‹ãƒ»ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ»é€šå‹¤
        let score = 100;
        let msg = [];

        // Sonar
        if (sonarResult.status === 'OK') {
            const sDist = sonarResult.data.supermarket.dist;
            const cDist = sonarResult.data.convenience.dist;
            if (sDist < 400) {
                msg.push(`è²·ç‰©è‡³ä¾¿: ã‚¹ãƒ¼ãƒ‘ãƒ¼${sDist}mã€‚`);
            } else if (sDist > 1000) {
                score -= 30;
                msg.push(`ç”Ÿæ´»ä¸ä¾¿: ã‚¹ãƒ¼ãƒ‘ãƒ¼é æ–¹(${sDist}m)ã€‚`);
            }
        }

        // Commute Stress
        if (userInputs.stress === 'hell') {
            score -= 50;
            msg.push("é€šå‹¤åœ°ç„: QOLå´©å£Šãƒªã‚¹ã‚¯ã€‚");
        } else if (userInputs.stress === 'high') {
            score -= 20;
            msg.push("é€šå‹¤è² è·: é«˜ã€‚");
        } else {
            msg.push("é€šå‹¤ç’°å¢ƒ: è¨±å®¹ç¯„å›²ã€‚");
        }
        
        // Station Power
        if (userInputs.stationRank >= 4) {
            score += 20;
            msg.push("éƒ½å¸‚åŠ›: é«˜ã€‚é€±æœ«ã‚‚å……å®Ÿã€‚");
        }

        this.vote = score >= 60;
        this.log = msg.join(" ");
        return this.vote;
    }
}

// THE TRIAD SYSTEM CONTROLLER
class TriadSystem {
    constructor() {
        this.logos = new Logos("LOGOS", "FINANCE");
        this.aegis = new Aegis("AEGIS", "SAFETY");
        this.hedon = new Hedon("HEDON", "LIFE");
    }

    execute(simResult, sonarResult, userInputs) {
        // Parallel Thinking
        const v1 = this.logos.decide(simResult, { stationRank: userInputs.stationRank });
        const v2 = this.aegis.decide(sonarResult, userInputs);
        const v3 = this.hedon.decide(sonarResult, userInputs);

        return this.synthesize(v1, v2, v3);
    }

    synthesize(v1, v2, v3) {
        // Aufheben Logic
        let rank = "C";
        let message = "";

        if (v1 && v2 && v3) {
            rank = "S";
            message = "å®Œå…¨èª¿å’Œ: è³‡ç”£ãƒ»å®‰å…¨ãƒ»å¿«é©æ€§ã®é»„é‡‘æ¯”ã€‚ç†æƒ³éƒ·ã§ã™ã€‚";
        } else if (v1 && v2 && !v3) {
            rank = "B";
            message = "ç¦æ¬²çš„é¸æŠ: è³‡ç”£ã¨å®‰å…¨ã¯ç›¤çŸ³ã€‚é€€å±ˆã•ã¯æˆ‘æ…¢ãŒå¿…è¦ã§ã™ã€‚";
        } else if (!v1 && v2 && v3) {
            rank = "C";
            message = "ç”˜ã„ç½ : ä½ã¿å¿ƒåœ°ã¯æœ€é«˜ã§ã™ãŒã€å°†æ¥ã®è²¡å‹™ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚";
        } else if (v1 && !v2 && v3) {
            rank = "D";
            message = "ç ‚ä¸Šã®æ¥¼é–£: è³‡ç”£ä¾¡å€¤ã¯é«˜ã„ã§ã™ãŒã€ç½å®³ãƒ»å®‰å…¨ãƒªã‚¹ã‚¯ãŒè‡´å‘½çš„ã§ã™ã€‚";
        } else if (!v1 && !v2 && !v3) {
            rank = "E";
            message = "è«–å¤–: æ¤œè¨ã«å€¤ã—ã¾ã›ã‚“ã€‚";
        } else {
            // Other mixes
            rank = "C";
            message = "è¦å¯©è­°: ãƒ¡ãƒªãƒƒãƒˆã¨ãƒªã‚¹ã‚¯ãŒæ‹®æŠ—ã—ã¦ã„ã¾ã™ã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        }

        return {
            rank: rank,
            msg: message,
            details: {
                logos: { vote: v1, log: this.logos.log },
                aegis: { vote: v2, log: this.aegis.log },
                hedon: { vote: v3, log: this.hedon.log }
            }
        };
    }
}

/* =========================================
   APP CONTROLLER: THE BRAIN
   ========================================= */
class App {
    constructor() {
        this.engine = new EstateEngine();
        this.sonar = new Sonar();
        this.triad = new TriadSystem();
        
        // State
        this.sonarData = { status: 'NO_DATA' }; // Cache
        this.debounceTimer = null;
        this.isProcessing = false;
    }

    init() {
        // Event Listeners for all inputs
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(el => {
            el.addEventListener('input', () => this.scheduleAnalysis());
            el.addEventListener('change', () => this.scheduleAnalysis());
        });

        // Initial Run (Empty)
        this.resetUI();
    }

    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç† (å…¥åŠ›ä¸­ã¯ã“ã®ç§’æ•°å¾…ã¤)
    scheduleAnalysis() {
        if (this.debounceTimer) clearTimeout(this.debounceTimer);
        // UIã‚’ã€Œæ€è€ƒä¸­ã€ãƒ¢ãƒ¼ãƒ‰ã¸
        document.getElementById('system_status').innerText = "CALCULATING...";
        document.getElementById('system_status').classList.add('blink');
        
        this.debounceTimer = setTimeout(() => {
            this.runAnalysis();
        }, 1000); // 1ç§’å¾…ã£ã¦å®Ÿè¡Œ
    }

    // â– â– â–  MAIN EXECUTION FLOW â– â– â– 
    async runAnalysis() {
        if (this.isProcessing) return;
        this.isProcessing = true;

        // 1. Gather Inputs (Sanitized)
        const inputs = {
            zip: document.getElementById('inp_zip').value,
            address: document.getElementById('inp_address').value,
            price: Utils.sanitizeNum(document.getElementById('inp_price').value),
            cost: Utils.sanitizeNum(document.getElementById('inp_cost').value),
            ageH: Utils.sanitizeNum(document.getElementById('inp_age_h').value) || 35,
            ageW: Utils.sanitizeNum(document.getElementById('inp_age_w').value) || 32,
            income: Utils.sanitizeNum(document.getElementById('inp_income').value),
            career: document.getElementById('inp_career').value,
            eduType: document.getElementById('inp_edu').value,
            stationRank: parseInt(document.getElementById('inp_station_rank').value),
            stress: document.getElementById('inp_commute_stress').value
        };

        // Validate essentials
        if (!inputs.income || !inputs.price) {
            this.isProcessing = false;
            document.getElementById('system_status').innerText = "STANDBY: INPUT REQUIRED";
            return;
        }

        // 2. Finance Simulation (Synchronous)
        const simResult = this.engine.simulate(inputs);

        // 3. Sonar Scan (Asynchronous / Cached)
        // Only run if address changed or no data
        // For this demo, we assume latitude lookup happened via fetchCoords
        // If we have lat/lon in hidden fields (or memory), use them.
        // *Here we rely on user clicking the Pin or entering Zip to set coords in memory*
        if (this.currentCoords && this.currentCoords.lat) {
            // If new coords, scan. If same, use cache.
            if (!this.sonarData.timestamp || this.sonarData.coords !== this.currentCoords) {
                this.sonarData = await this.sonar.scanArea(this.currentCoords.lat, this.currentCoords.lon);
                this.sonarData.coords = this.currentCoords;
                this.sonarData.timestamp = Date.now();
            }
        }

        // 4. TRIAD JUDGMENT
        const verdict = this.triad.execute(simResult, this.sonarData, inputs);

        // 5. UPDATE UI (The Reveal)
        this.renderVerdict(verdict);
        
        this.isProcessing = false;
    }

    // â– â– â–  UI RENDERING (MAGI STYLE) â– â– â– 
    renderVerdict(verdict) {
        // Reset Visuals
        const modules = ['logos', 'aegis', 'hedon'];
        modules.forEach(m => {
            const el = document.querySelector(`.status-${m}`);
            const stamp = document.getElementById(`stamp_${m}`);
            el.classList.remove('active');
            stamp.classList.remove('show');
            stamp.className = 'stamp'; // Reset colors
        });

        // Update Logs
        document.getElementById('log_logos').innerText = verdict.details.logos.log;
        document.getElementById('log_aegis').innerText = verdict.details.aegis.log;
        document.getElementById('log_hedon').innerText = verdict.details.hedon.log;

        // Animation Sequence
        setTimeout(() => {
            // 1. LOGOS Reveal
            this.updateModule('logos', verdict.details.logos.vote, 'text-blue');
        }, 100);

        setTimeout(() => {
            // 2. AEGIS Reveal
            this.updateModule('aegis', verdict.details.aegis.vote, 'text-yellow');
        }, 300);

        setTimeout(() => {
            // 3. HEDON Reveal
            this.updateModule('hedon', verdict.details.hedon.vote, 'text-red');
        }, 500);

        setTimeout(() => {
            // 4. Final Rank
            const rankEl = document.getElementById('final_rank');
            const statusEl = document.getElementById('system_status');
            
            rankEl.innerText = verdict.rank + " RANK";
            statusEl.innerText = verdict.msg;
            statusEl.classList.remove('blink');

            // Color coding rank
            rankEl.style.color = (verdict.rank === 'S' || verdict.rank === 'A') ? 'var(--accent-blue)' :
                                 (verdict.rank === 'B') ? 'var(--accent-main)' : 'var(--accent-red)';
        }, 700);
    }

    updateModule(id, isApproved, colorClass) {
        const mod = document.querySelector(`.status-${id}`);
        const stamp = document.getElementById(`stamp_${id}`);
        
        if (isApproved) {
            mod.classList.add('active');
            stamp.innerText = "æ‰¿èª";
            stamp.classList.add(colorClass); // Blue/Yellow/Red text
        } else {
            stamp.innerText = "å¦å®š";
            stamp.classList.add('text-red'); // Denied is always red border
            stamp.style.borderColor = 'red';
            stamp.style.color = 'red';
        }
        stamp.classList.add('show');
    }

    // â– â– â–  AUXILIARY ACTIONS â– â– â– 
    async fetchAddress() {
        const zip = document.getElementById('inp_zip').value;
        const addr = await this.sonar.searchZip(zip);
        if (addr) {
            document.getElementById('inp_address').value = addr;
            this.fetchCoords(); // Chain reaction
        }
    }

    async fetchCoords() {
        const addr = document.getElementById('inp_address').value;
        const res = await this.sonar.searchAddress(addr);
        if (res) {
            this.currentCoords = { lat: res.lat, lon: res.lon };
            // Auto-fill Lat/Lon visual feedback? For now, just trigger analysis
            document.getElementById('system_status').innerText = `LOCATED: ${res.title}`;
            this.scheduleAnalysis();
        } else {
            document.getElementById('system_status').innerText = "LOCATION ERROR";
        }
    }

    toggleDetail(id) {
        const el = document.getElementById(`detail_${id}`);
        el.classList.toggle('open');
    }
    
    resetUI() {
        document.getElementById('system_status').innerText = "SYSTEM READY";
    }
}

// BOOTSTRAP
const app = new App();
window.addEventListener('DOMContentLoaded', () => {
    app.init();
    
    // Auto-format on blur for sanitization visual
    document.querySelectorAll('.sanitizer').forEach(el => {
        el.addEventListener('blur', (e) => {
            const val = Utils.sanitizeNum(e.target.value);
            if(val > 0) e.target.value = val;
        });
    });
});

</script>
</body>
</html>
