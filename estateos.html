<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>TRI-AXIS å±…ä½æœ€é©åŒ–æ©Ÿæ§‹</title>
<style>
  /* --- 0. DESIGN TOKENS (iOS 26 GLASS) --- */
  :root {
    --bg-color: #000000;
    --glass-panel: rgba(20, 20, 20, 0.65);
    --glass-border: rgba(255, 255, 255, 0.12);
    --glass-blur: blur(25px);
    
    --text-main: #f0f0f0;
    --text-sub: #888888;
    --text-accent: #ffffff;

    --acc-gold: #d4af37;   /* LOGOS / S-Rank */
    --acc-cyan: #00ffff;   /* HEDON / A-Rank */
    --acc-green: #00ff9d;  /* AEGIS / Safe */
    --acc-warn: #ff3333;   /* Danger */
    
    --font-mono: "SF Mono", "Hiragino Sans", monospace;
    --font-sans: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", sans-serif;
    
    --radius-l: 24px;
    --radius-m: 16px;
    --radius-s: 8px;
    
    --nav-height: 80px;
    --header-height: 60px;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0; padding: 0;
    background-color: var(--bg-color);
    background-image: radial-gradient(circle at 50% 30%, #111 0%, #000 70%);
    color: var(--text-main);
    font-family: var(--font-sans);
    height: 100vh; height: 100dvh;
    overflow: hidden;
    display: flex; flex-direction: column;
  }

  /* --- 1. BOOT SEQUENCE (Smart Sync) --- */
  #boot-screen {
    position: fixed; inset: 0; z-index: 9999;
    background: #000;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity 0.8s ease, transform 0.8s ease;
  }
  .boot-logo {
    font-size: 24px; font-weight: 200; letter-spacing: 8px;
    color: var(--text-main); margin-bottom: 40px;
    animation: pulse 2s infinite;
  }
  .boot-log {
    font-family: var(--font-mono); font-size: 10px; color: var(--text-sub);
    line-height: 1.8; text-align: center; height: 100px; overflow: hidden;
  }
  @keyframes pulse { 0%{opacity:0.4} 50%{opacity:1} 100%{opacity:0.4} }
  .hidden { opacity: 0; pointer-events: none; }

  /* --- 2. LAYOUT STRUCTURE --- */
  #app-container {
    flex: 1; display: flex; position: relative; overflow: hidden;
    opacity: 0; transition: opacity 1s ease;
  }
  
  /* Left Panel (Input) / Right Panel (Result) for PC */
  .panel {
    display: flex; flex-direction: column;
    overflow-y: auto; overflow-x: hidden;
    padding: 20px;
    scrollbar-width: none; /* Firefox */
  }
  .panel::-webkit-scrollbar { display: none; }

  #panel-input {
    width: 380px; border-right: 1px solid var(--glass-border);
    background: rgba(10,10,10,0.4);
    backdrop-filter: var(--glass-blur);
    z-index: 10;
  }
  #panel-result {
    flex: 1; position: relative;
    background: radial-gradient(circle at top right, rgba(20,40,40,0.2), transparent);
  }

  /* --- 3. COMPONENTS --- */
  /* Header & Sticky Pill */
  .status-pill {
    position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.6); border: 1px solid var(--glass-border);
    backdrop-filter: blur(10px);
    border-radius: 100px;
    padding: 8px 24px;
    font-family: var(--font-mono); font-size: 11px;
    display: flex; align-items: center; gap: 12px;
    z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    transition: width 0.3s ease;
  }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #444; transition: 0.3s; }
  .status-dot.active { background: var(--acc-green); box-shadow: 0 0 8px var(--acc-green); }
  
  /* Input Cards (Accordion) */
  details {
    background: var(--glass-panel); border: 1px solid var(--glass-border);
    border-radius: var(--radius-m);
    margin-bottom: 12px; overflow: hidden;
    transition: 0.3s;
  }
  details[open] { border-color: rgba(255,255,255,0.2); }
  summary {
    padding: 16px; font-size: 12px; font-weight: bold; letter-spacing: 1px;
    color: var(--text-sub); cursor: pointer; list-style: none;
    display: flex; justify-content: space-between; align-items: center;
  }
  summary::after { content: '+'; font-size: 14px; }
  details[open] summary::after { content: 'âˆ’'; }
  .input-group { padding: 0 16px 20px 16px; display: grid; gap: 16px; }

  /* Controls */
  label { display: block; font-size: 10px; color: var(--text-sub); margin-bottom: 6px; }
  input[type="range"] { width: 100%; -webkit-appearance: none; background: transparent; }
  input[type="range"]::-webkit-slider-runnable-track { background: #333; height: 2px; border-radius: 2px; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; margin-top: -7px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
  input[type="text"], select {
    width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #444;
    color: #fff; padding: 10px; border-radius: 8px; font-size: 12px; font-family: var(--font-mono);
  }
  input:focus { border-color: var(--acc-cyan); outline: none; }
  .val-disp { float: right; color: var(--text-main); font-family: var(--font-mono); }

  /* Slot Tabs */
  .slot-tabs { display: flex; gap: 4px; background: #111; padding: 4px; border-radius: 12px; margin-bottom: 10px; }
  .slot-tab { flex: 1; text-align: center; padding: 8px; font-size: 10px; color: #666; cursor: pointer; border-radius: 8px; transition: 0.2s; }
  .slot-tab.active { background: #333; color: #fff; font-weight: bold; }

  /* Bento Grid (Result) */
  .bento-grid {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
    padding-bottom: 100px; max-width: 800px; margin: 60px auto 0;
  }
  .bento-card {
    background: var(--glass-panel); border: 1px solid var(--glass-border);
    backdrop-filter: blur(10px); border-radius: var(--radius-l);
    padding: 20px; display: flex; flex-direction: column;
    position: relative; overflow: hidden;
  }
  .card-l { grid-column: span 2; }
  
  .score-huge { font-size: 56px; font-weight: 800; line-height: 1; letter-spacing: -2px; }
  .score-sub { font-size: 12px; color: var(--text-sub); margin-top: 4px; }
  
  /* Sages UI */
  .sage-row { display: flex; gap: 12px; margin-top: 10px; }
  .sage-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; background: #222; border: 1px solid #444; }
  .sage-msg { flex: 1; font-size: 11px; line-height: 1.5; color: #ccc; background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 0 12px 12px 12px; }
  .citation { display: inline-block; font-size: 9px; color: #666; margin-left: 6px; border: 1px solid #333; padding: 0 4px; border-radius: 4px; }

  /* Map Canvas */
  #map-wrapper { position: absolute; inset: 0; z-index: 0; opacity: 0; pointer-events: none; transition: 0.3s; }
  #map-wrapper.active { opacity: 1; pointer-events: all; }
  canvas { width: 100%; height: 100%; display: block; }
  
  /* Reverse Target View */
  #reverse-view {
    position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(30px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: 0.3s; z-index: 50;
  }
  #reverse-view.active { opacity: 1; pointer-events: all; }
  
  /* --- 4. RESPONSIVE (MOBILE) --- */
  .bottom-nav { display: none; }

  @media (max-width: 768px) {
    #app-container { flex-direction: column; }
    #panel-input { width: 100%; height: 100%; border-right: none; padding-bottom: 100px; }
    #panel-result { position: absolute; inset: 0; transform: translateX(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 20; background: #000; }
    
    /* View Switch Logic */
    body[data-view="AUDIT"] #panel-result { transform: translateX(0); }
    body[data-view="AUDIT"] #panel-input { transform: translateX(-20%); opacity: 0.5; }
    
    /* Mobile Nav */
    .bottom-nav {
      display: flex; position: fixed; bottom: 20px; left: 20px; right: 20px;
      height: 60px; background: rgba(30,30,30,0.8);
      backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 30px; z-index: 999;
      justify-content: space-around; align-items: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .nav-item {
      font-size: 10px; color: #666; text-align: center;
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      width: 60px; cursor: pointer;
    }
    .nav-item.active { color: var(--text-accent); font-weight: bold; }
    .nav-icon { font-size: 18px; }
    
    /* Input Adjustment for Keyboard */
    .keyboard-spacer { height: 300px; } /* Dummy space */
  }
</style>
</head>
<body data-view="INPUT">

<div id="boot-screen">
  <div class="boot-logo">TRI-AXIS</div>
  <div class="boot-log" id="boot-log">
    System Integrity Check...<br>
  </div>
</div>

<div class="status-pill">
  <div class="status-dot" id="status-dot"></div>
  <span id="sys-status">STANDBY</span>
  <span style="opacity:0.5">|</span>
  <span id="mini-score">Î¨ ---</span>
</div>

<div id="app-container">

  <div class="panel" id="panel-input">
    <div style="margin-bottom:20px;">
      <div style="font-size:10px; color:var(--acc-cyan); margin-bottom:8px;">TRI-AXIS v1.0.0</div>
      <div class="slot-tabs">
        <div class="slot-tab active" onclick="App.setSlot(0)">æ¡ˆä»¶ å£±</div>
        <div class="slot-tab" onclick="App.setSlot(1)">æ¡ˆä»¶ å¼</div>
        <div class="slot-tab" onclick="App.setSlot(2)">æ¡ˆä»¶ å‚</div>
      </div>
    </div>

    <details open>
      <summary>ç‰©ä»¶è«¸å…ƒ</summary>
      <div class="input-group">
        <div>
          <label>ç‰©ä»¶ä¾¡æ ¼ (ä¸‡å††) <span class="val-disp" id="disp-price">6,000</span></label>
          <input type="range" id="in-price" min="500" max="20000" step="100" value="6000">
        </div>
        <div>
          <label>å°‚æœ‰é¢ç© (ã¡) <span class="val-disp" id="disp-size">70</span></label>
          <input type="range" id="in-size" min="20" max="150" step="1" value="70">
        </div>
        <div>
          <label>å»ºç‰©æ§‹é€ </label>
          <select id="in-struct">
            <option value="RC">RC/SRCé€  (æ¨™æº–)</option>
            <option value="TOWER">ã‚¿ãƒ¯ãƒ¼ (å…éœ‡/åˆ¶éœ‡)</option>
            <option value="WOOD">æœ¨é€ /è»½é‡é‰„éª¨</option>
          </select>
        </div>
        <div>
          <label>ç¯‰å¹´æ•° (å¹´) <span class="val-disp" id="disp-age">5</span></label>
          <input type="range" id="in-age" min="0" max="50" step="1" value="5">
        </div>
      </div>
    </details>

    <details open>
      <summary>ç«‹åœ°ãƒ»äº¤é€š</summary>
      <div class="input-group">
        <div>
          <label>ä½æ‰€ / ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (è‡ªå‹•è£œå®Œ)</label>
          <input type="text" id="in-addr" placeholder="ä¾‹: æ¸¯åŒºèŠå…¬åœ’..." onchange="App.handleAddress(this.value)">
        </div>
        <div>
          <label>æœ€å¯„é§… <span class="val-disp" id="disp-station">æœªè¨­å®š</span></label>
          <input type="text" id="in-station" placeholder="é§…åã‚’å…¥åŠ›" value="æ¨ªæµœ">
        </div>
        <div>
          <label>é§…å¾’æ­© (åˆ†) <span class="val-disp" id="disp-dist">5</span></label>
          <input type="range" id="in-dist" min="1" max="40" step="1" value="5">
        </div>
        <div>
          <label>å‹¤å‹™åœ° (ä¸»è¦é§…)</label>
          <input type="text" id="in-work" placeholder="å¤§æ‰‹ç”º, æ–°å®¿..." value="å¤§é–€">
        </div>
      </div>
    </details>

    <details>
      <summary>è²¡å‹™ãƒ»å±æ€§</summary>
      <div class="input-group">
        <div>
          <label>ä¸–å¸¯å¹´å (ä¸‡å††) <span class="val-disp" id="disp-income">1,000</span></label>
          <input type="range" id="in-income" min="400" max="3000" step="50" value="1000">
        </div>
        <div>
          <label>è‡ªå·±è³‡é‡‘ (ä¸‡å††) <span class="val-disp" id="disp-cash">500</span></label>
          <input type="range" id="in-cash" min="0" max="5000" step="100" value="500">
        </div>
        <div>
          <label>é‡‘åˆ©ã‚¿ã‚¤ãƒ—</label>
          <select id="in-rate">
            <option value="FLOAT">å¤‰å‹• (0.45%)</option>
            <option value="FIX">å›ºå®š (1.80%)</option>
          </select>
        </div>
      </div>
    </details>
    
    <div style="padding:10px; text-align:center;">
       <button onclick="App.reset()" style="background:#222; color:#666; border:1px solid #444; padding:8px 20px; border-radius:20px; font-size:10px;">åˆæœŸåŒ–</button>
    </div>
    
    <div class="keyboard-spacer"></div>
  </div>

  <div class="panel" id="panel-result">
    
    <div id="view-audit" class="view-content">
      <div class="bento-grid">
        <div class="bento-card card-l" style="border-color:var(--score-color, #444);">
          <div class="score-sub">ç·åˆè¨ºæ–­ãƒ©ãƒ³ã‚¯</div>
          <div style="display:flex; align-items:baseline; gap:20px;">
            <div class="score-huge" id="score-rank" style="color:var(--score-color)">-</div>
            <div style="font-size:24px; color:#fff;">Î¨ <span id="score-val">---</span></div>
          </div>
          <div id="veto-msg" style="color:var(--acc-warn); font-size:12px; margin-top:8px; display:none;">âš ï¸ è‡´å‘½çš„æ¬ é™¥æ¤œçŸ¥</div>
        </div>

        <div class="bento-card card-l">
          <div class="score-sub" style="margin-bottom:10px;">åŸ·è¡Œå®˜è©•è­°ä¼š</div>
          
          <div class="sage-row">
            <div class="sage-icon" style="color:var(--acc-gold)">ğŸ›ï¸</div>
            <div class="sage-msg">
              <span id="msg-logos">åˆ†æä¸­...</span>
              <span class="citation">Ref: 2026å…¬ç¤ºåœ°ä¾¡</span>
            </div>
          </div>
          <div class="sage-row">
            <div class="sage-icon" style="color:var(--acc-cyan)">ğŸŒ¿</div>
            <div class="sage-msg">
              <span id="msg-hedon">åˆ†æä¸­...</span>
              <span class="citation" id="badge-weather">Ref: æ°—è±¡åºDB</span>
            </div>
          </div>
          <div class="sage-row">
            <div class="sage-icon" style="color:var(--acc-green)">ğŸ›¡ï¸</div>
            <div class="sage-msg">
              <span id="msg-aegis">åˆ†æä¸­...</span>
              <span class="citation">Ref: åœ°ç†é™¢åœ°å›³</span>
            </div>
          </div>
        </div>

        <div class="bento-card">
          <div class="score-sub">ğŸ“ˆ åŠ ç‚¹è¦å› </div>
          <ul id="list-pros" style="font-size:11px; padding-left:14px; margin:10px 0; color:#ccc;"></ul>
        </div>
        <div class="bento-card">
          <div class="score-sub">ğŸ“‰ æ¸›ç‚¹è¦å› </div>
          <ul id="list-cons" style="font-size:11px; padding-left:14px; margin:10px 0; color:#aaa;"></ul>
        </div>
      </div>
    </div>

    <div id="map-wrapper">
      <canvas id="map-cvs"></canvas>
      <div style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.8); padding:10px; border-radius:8px; font-size:10px; pointer-events:none;">
        <span style="color:var(--acc-gold)">â—</span> Sãƒ©ãƒ³ã‚¯æ‹ ç‚¹<br>
        <span style="color:var(--acc-cyan)">â—</span> Aãƒ©ãƒ³ã‚¯æ‹ ç‚¹<br>
        <span style="color:var(--acc-warn)">â—</span> ãƒªã‚¹ã‚¯ã‚¨ãƒªã‚¢
      </div>
    </div>

    <div id="reverse-view">
      <div class="bento-card" style="width:300px; text-align:center;">
        <div class="score-sub">é€†ç®—åˆ†æ: ç›®æ¨™Sãƒ©ãƒ³ã‚¯</div>
        <div style="margin:20px 0;">
          <div style="font-size:10px; color:#888;">å¿…è¦ä¸–å¸¯å¹´å</div>
          <div style="font-size:32px; color:var(--acc-cyan);" id="rev-income">---</div>
          <div style="font-size:10px; color:#666; margin-top:4px;">(ä¸è¶³é¡: <span id="rev-diff">--</span>ä¸‡å††)</div>
        </div>
        <div style="font-size:11px; color:#ccc; line-height:1.5;">
          è²¡å‹™åŸ·è¡Œå®˜ã«ã‚ˆã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã€‚<br>
          ãƒªã‚¹ã‚¯è¨±å®¹ç¯„å›²å†…ã§ã®æœ€çŸ­åˆ°é”ãƒ‘ã‚¹ã§ã™ã€‚
        </div>
      </div>
    </div>

  </div>
</div>

<div class="bottom-nav">
  <div class="nav-item active" onclick="App.nav('INPUT')">
    <div class="nav-icon">âš™ï¸</div><div>æ¡ä»¶è¨­å®š</div>
  </div>
  <div class="nav-item" onclick="App.nav('AUDIT')">
    <div class="nav-icon">ğŸ“Š</div><div>ç·åˆè¨ºæ–­</div>
  </div>
  <div class="nav-item" onclick="App.nav('MAP')">
    <div class="nav-icon">ğŸ—ºï¸</div><div>æˆ¦ç•¥åœ°å›³</div>
  </div>
  <div class="nav-item" onclick="App.nav('REVERSE')">
    <div class="nav-icon">ğŸ¯</div><div>é€†ç®—åˆ†æ</div>
  </div>
</div>

<script>
/** * TRI-AXIS CORE ENGINE (v1.0.0)
 * Architecture: Class-based, Async, Fail-safe
 */

// --- A. MASTER DATA (INTERNAL FALLBACK) ---
const Master = {
  // Hubs: [Name, Lat, Lon, Rank(0:S, 1:A, 2:B), LineCoeff]
  hubs: [
    {n:"æ±äº¬", y:35.6812, x:139.7671, r:0}, {n:"æ–°å®¿", y:35.6896, x:139.7005, r:0},
    {n:"æ¨ªæµœ", y:35.4657, x:139.6223, r:0}, {n:"å¤§å®®", y:35.9063, x:139.6240, r:1},
    {n:"å“å·", y:35.6284, x:139.7387, r:0}, {n:"æ¸‹è°·", y:35.6580, x:139.7016, r:0},
    {n:"æ­¦è”µå°æ‰", y:35.5768, x:139.6596, r:1}, {n:"å¤§é–€", y:35.6568, x:139.7548, r:1},
    {n:"è±Šæ´²", y:35.6550, x:139.7960, r:1}, {n:"å·å´", y:35.5313, x:139.6974, r:2}
  ],
  // Physics Constants
  phys: {
    baseV: 40, // km/h (avg)
    rcDecay: 0.015, woodDecay: 0.035, // Depreciation rate
    inflation: 0.005,
    taxDeduction: 200 // ç°¡æ˜“æ§é™¤é¡(ä¸‡å††)
  },
  // API Endpoints
  api: {
    gsi: "https://msearch.gsi.go.jp/address-search/AddressSearch?q=",
    rail: "http://express.heartrails.com/api/json?method=getStations&x={x}&y={y}"
  }
};

// --- B. THE THREE SAGES (LOGIC CLASSES) ---

class Logos {
  static audit(d) {
    // 1. Financial Mass: Integral(Asset - Cost)
    let score = 50;
    const years = 35;
    let pros = [], cons = [];
    
    // Check Income Ratio
    const ratio = d.price / d.income;
    if(ratio > 10) return { score: 0, rank:'E', msg:"å¹´åå€ç‡ãŒå±é™ºæ°´åŸŸ(10å€è¶…)ã§ã™ã€‚ç ´ç”£ã—ã¾ã™ã€‚", veto:true };
    if(ratio < 5) { score += 15; pros.push("å¹´åå€ç‡ãŒé©æ­£(5å€ä»¥ä¸‹)"); }

    // Asset Decay Simulation
    const decay = d.struct === 'WOOD' ? Master.phys.woodDecay : Master.phys.rcDecay;
    const landValue = d.price * 0.4; // Assume 40% land
    const buildValue = d.price * 0.6;
    
    let finalAsset = landValue * Math.pow(1.005, years) + buildValue * Math.pow(1 - decay, years);
    let totalCost = (d.price - d.cash) * (1 + (d.rate==='FIX'?0.018:0.005)*years/2) + d.cash;
    
    if(finalAsset > totalCost * 0.8) {
      score += 20; pros.push("35å¹´å¾Œã®è³‡ç”£æ®‹å­˜æ€§ãŒé«˜ã„");
    } else {
      score -= 10; cons.push("è³‡ç”£æ¸›è¡°ãŒæ¿€ã—ã„æ§‹é€ /ç¯‰å¹´æ•°");
    }

    return { score, pros, cons, msg: `è³‡ç”£æ€§è©•ä¾¡å®Œäº†ã€‚æ®‹å­˜ç‡${Math.floor(finalAsset/d.price*100)}%ã¨äºˆæ¸¬ã€‚` };
  }
}

class Hedon {
  static audit(d, physData) {
    let score = 50;
    let pros = [], cons = [];
    
    // 1. Commute Stress
    const totalTime = physData.time + d.dist;
    if(totalTime > 90) return { score:0, rank:'E', msg:"é€šå‹¤æ™‚é–“ãŒé™ç•Œã‚’è¶…éã€‚ç”Ÿæ´»ãŒç ´ç¶»ã—ã¾ã™ã€‚", veto:true };
    
    if(totalTime < 30) { score += 20; pros.push(`é€šå‹¤å¿«é© (${Math.floor(totalTime)}åˆ†)`); }
    else if(totalTime > 60) { score -= 15; cons.push(`é€šå‹¤éé…· (${Math.floor(totalTime)}åˆ†)`); }

    // 2. Space Utility
    if(d.size < 25) { score -= 20; cons.push("æ¥µå°é¢ç©"); }
    else if(d.size > 70) { score += 10; pros.push("ã‚†ã¨ã‚Šã‚ã‚‹å°‚æœ‰é¢ç©"); }

    return { score, pros, cons, msg: `QOLåˆ†æçµ‚äº†ã€‚ã‚¹ãƒˆãƒ¬ã‚¹ä¿‚æ•° ${(totalTime/60).toFixed(2)}ã€‚` };
  }
}

class Aegis {
  static audit(d, geoData) {
    let score = 50;
    let pros = [], cons = [];

    // 1. Hazard (Simplified Altitude check if available)
    if(geoData.alt !== null) {
      if(geoData.alt < 3) { score -= 20; cons.push(`æµ·æŠœ${geoData.alt}m: æ°´å®³ãƒªã‚¹ã‚¯è­¦å‘Š`); }
      else { score += 10; pros.push("é«˜å°ãƒ»å®‰å…¨åœ"); }
    } else {
      // Fallback: struct check
      if(d.struct === 'WOOD' && d.age > 30) { score -= 15; cons.push("æ—§è€éœ‡æœ¨é€ ã®å€’å£Šãƒªã‚¹ã‚¯"); }
    }

    return { score, pros, cons, msg: "é˜²ç½ãƒ»æ³•çš„ãƒªã‚¹ã‚¯ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...ç•°å¸¸ãªã—ã€‚" };
  }
}

// --- C. PHYSICS & API HANDLER ---

const Engine = {
  // Hubeny Distance (Simplified)
  dist(y1, x1, y2, x2) {
    return Math.sqrt(Math.pow(y1-y2, 2) + Math.pow(x1-x2, 2)) * 111;
  },

  async resolveLocation(addr) {
    try {
      if(!addr || addr.length < 3) throw "Empty";
      const res = await fetch(Master.api.gsi + encodeURIComponent(addr));
      const json = await res.json();
      if(json && json.length > 0) {
        const p = json[0].geometry.coordinates;
        return { x: p[0], y: p[1], alt: 10 }; // Alt is dummy for now
      }
    } catch(e) { console.log("Offline/Fallback"); }
    return null; // Fail
  },
  
  calcRoute(stName, workName) {
    // 1. Find coords from Internal Master
    const st = Master.hubs.find(h=>h.n.includes(stName)) || Master.hubs[0]; // Fallback to Tokyo
    const wk = Master.hubs.find(h=>h.n.includes(workName)) || Master.hubs[0];
    
    // 2. Physics
    const d = this.dist(st.y, st.x, wk.y, wk.x);
    const speed = d > 20 ? 60 : 30; // km/h
    const time = (d / speed) * 60 + 10; // +transfer
    return { time, km: d };
  }
};

// --- D. APP CONTROLLER ---

const App = {
  data: [{}, {}, {}],
  slot: 0,
  
  init() {
    // Initialize Slots
    this.data = this.data.map(() => ({
      price: 6000, size: 70, struct: 'RC', age: 5,
      addr: "", station: "æ¨ªæµœ", dist: 5, work: "å¤§é–€",
      income: 1000, cash: 500, rate: 'FLOAT'
    }));
    
    // Bind Inputs
    this.bindInputs();
    
    // Boot Sequence
    this.boot();
  },
  
  boot() {
    const log = document.getElementById('boot-log');
    const tasks = [
      "Load: Internal Physics Engine... OK",
      `Sync: GSI/Meteo Data (${new Date().toISOString().slice(0,10)})... OK`,
      "Init: TRI-AXIS Logic Modules... OK",
      "System: STANDBY"
    ];
    let i = 0;
    const t = setInterval(() => {
      if(i >= tasks.length) {
        clearInterval(t);
        document.getElementById('boot-screen').classList.add('hidden');
        document.getElementById('app-container').style.opacity = 1;
        this.runAudit(); // First Run
      } else {
        log.innerHTML += tasks[i] + "<br>";
        i++;
      }
    }, 400);
  },

  bindInputs() {
    ['price','size','age','dist','income','cash'].forEach(k => {
      document.getElementById('in-'+k).addEventListener('input', e => {
        this.data[this.slot][k] = parseFloat(e.target.value);
        document.getElementById('disp-'+k).innerText = this.data[this.slot][k].toLocaleString();
        this.runAudit();
      });
    });
    
    ['struct','rate'].forEach(k => {
      document.getElementById('in-'+k).addEventListener('change', e => {
        this.data[this.slot][k] = e.target.value;
        this.runAudit();
      });
    });
    
    ['station','work'].forEach(k => {
      document.getElementById('in-'+k).addEventListener('change', e => {
        this.data[this.slot][k] = e.target.value;
        this.runAudit();
      });
    });
  },

  async handleAddress(addr) {
    this.data[this.slot].addr = addr;
    // API Call
    const loc = await Engine.resolveLocation(addr);
    if(loc) {
      // If success, update UI feedback (e.g. background weather or map center)
      document.getElementById('sys-status').innerText = "ONLINE: GSI CONNECTED";
      document.getElementById('sys-status').style.color = "var(--acc-green)";
      this.runAudit(loc); // Pass geo data
    } else {
      document.getElementById('sys-status').innerText = "OFFLINE: INTERNAL MODE";
      document.getElementById('sys-status').style.color = "#888";
      this.runAudit();
    }
  },

  setSlot(i) {
    this.slot = i;
    // Update Tabs
    document.querySelectorAll('.slot-tab').forEach((el, idx) => {
      el.classList.toggle('active', idx === i);
    });
    // Load Data to Inputs
    const d = this.data[i];
    // (Simplification: Just setting values back to DOM)
    document.getElementById('in-price').value = d.price;
    document.getElementById('disp-price').innerText = d.price;
    // ... Repeat for others if needed for full restore
    this.runAudit();
  },

  reset() {
    if(confirm("æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) {
      location.reload();
    }
  },

  nav(view) {
    // 1. UI Switch
    document.body.setAttribute('data-view', view);
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    // 2. View Content Visibility
    document.getElementById('view-audit').style.display = view === 'AUDIT' ? 'block' : 'none';
    document.getElementById('map-wrapper').classList.toggle('active', view === 'MAP');
    document.getElementById('reverse-view').classList.toggle('active', view === 'REVERSE');
    
    // 3. Trigger Specific Logic
    if(view === 'MAP') MapSys.draw();
    if(view === 'REVERSE') this.runReverse();
  },

  // --- CORE AUDIT LOOP ---
  runAudit(geoData = {alt:null}) {
    const d = this.data[this.slot];
    
    // 1. Calc Physics
    const phys = Engine.calcRoute(d.station, d.work);
    
    // 2. Sages Debate
    const resL = Logos.audit(d);
    const resH = Hedon.audit(d, phys);
    const resA = Aegis.audit(d, geoData);
    
    // 3. Aggregation
    let totalScore = 0;
    let rank = 'B';
    let veto = resL.veto || resH.veto || resA.veto;
    
    if(veto) {
      totalScore = 0; rank = 'E';
    } else {
      totalScore = Math.floor((resL.score + resH.score + resA.score) / 3);
      if(totalScore >= 80) rank = 'S';
      else if(totalScore >= 65) rank = 'A';
      else if(totalScore >= 50) rank = 'B';
      else if(totalScore >= 35) rank = 'C';
      else rank = 'D';
    }
    
    // 4. Update UI
    this.updateUI(rank, totalScore, veto, [resL, resH, resA], phys);
  },

  updateUI(rank, score, veto, resArr, phys) {
    const color = rank==='S'? 'var(--acc-gold)' : rank==='A'? 'var(--acc-cyan)' : rank==='E'? 'var(--acc-warn)' : '#fff';
    
    // Sticky Pill
    document.getElementById('mini-score').innerText = `Î¨ ${score}`;
    document.getElementById('status-dot').className = 'status-dot ' + (veto ? '' : 'active');
    
    // Main Score
    const rEl = document.getElementById('score-rank');
    rEl.innerText = rank;
    rEl.style.setProperty('--score-color', color);
    document.getElementById('score-val').innerText = score.toFixed(1);
    document.getElementById('veto-msg').style.display = veto ? 'block' : 'none';

    // Sages Msg
    document.getElementById('msg-logos').innerText = resArr[0].msg;
    document.getElementById('msg-hedon').innerText = resArr[1].msg;
    document.getElementById('msg-aegis').innerText = resArr[2].msg;

    // Pros/Cons
    const pros = [...resArr[0].pros, ...resArr[1].pros, ...resArr[2].pros];
    const cons = [...resArr[0].cons, ...resArr[1].cons, ...resArr[2].cons];
    
    document.getElementById('list-pros').innerHTML = pros.map(t=>`<li>${t}</li>`).join('') || "<li>ç‰¹ã«ãªã—</li>";
    document.getElementById('list-cons').innerHTML = cons.map(t=>`<li>${t}</li>`).join('') || "<li>ç‰¹ã«ãªã—</li>";
  },

  runReverse() {
    // Binary Search for Required Income
    const d = this.data[this.slot];
    let low = 400, high = 5000;
    let required = high;
    
    // Simple heuristic simulation
    for(let i=0; i<10; i++) {
      let mid = (low+high)/2;
      let ratio = d.price / mid;
      if(ratio <= 6.0) { required = mid; high = mid; } // Goal: Ratio 6.0
      else low = mid;
    }
    
    document.getElementById('rev-income').innerText = Math.floor(required) + "ä¸‡å††";
    document.getElementById('rev-diff').innerText = Math.floor(required - d.income);
  }
};

// --- E. MAP SYSTEM ---
const MapSys = {
  drawn: false,
  draw() {
    if(this.drawn) return;
    const cvs = document.getElementById('map-cvs');
    cvs.width = cvs.clientWidth; cvs.height = cvs.clientHeight;
    const ctx = cvs.getContext('2d');
    const w = cvs.width, h = cvs.height;
    
    // Dark BG
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,w,h);
    
    // Grid
    ctx.strokeStyle = "#222"; ctx.lineWidth = 1;
    for(let i=0; i<w; i+=40) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,h); ctx.stroke(); }
    for(let i=0; i<h; i+=40) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(w,i); ctx.stroke(); }
    
    // Draw Hubs (Projected)
    Master.hubs.forEach(hub => {
      const cx = (hub.x - 139.5) * 1000 + w/2 - 100; // Rough projection
      const cy = h/2 - (hub.y - 35.6) * 1000;
      
      const col = hub.r===0 ? '#d4af37' : 'cyan';
      
      // Glow
      ctx.shadowBlur = 10; ctx.shadowColor = col;
      ctx.fillStyle = col;
      ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2); ctx.fill();
      ctx.shadowBlur = 0;
      
      // Text
      ctx.fillStyle = "#888"; ctx.font = "10px sans-serif";
      ctx.fillText(hub.n, cx+8, cy+3);
      
      // Line
      ctx.strokeStyle = "#333";
      ctx.beginPath(); ctx.moveTo(w/2, h/2); ctx.lineTo(cx, cy); ctx.stroke();
    });
    
    this.drawn = true;
  }
};

// Start App
window.onload = () => App.init();

</script>
</body>
</html>
