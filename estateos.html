<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TRI-AXIS v1.0.2 | 居住監査執行システム</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass: rgba(8, 18, 32, 0.85);
            --edge: rgba(255, 255, 255, 0.15);
            --cyan: #00d9ff; --gold: #ffcc00; --green: #33ffaa; --red: #ff3366;
            --safe-t: env(safe-area-inset-top); --safe-b: env(safe-area-inset-bottom);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #010408; color: #eef2f7; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        .abyss { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, #0a1b3a 0%, #010408 100%); z-index: -1; }

        .shell { display: flex; flex-direction: column; height: 100vh; padding-top: var(--safe-t); }
        header { padding: 18px 22px; background: var(--glass); backdrop-filter: blur(50px); border-bottom: 1px solid var(--edge); z-index: 1000; }
        .t-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .t-logo { width: 34px; height: 34px; background: var(--cyan); color: #000; display: flex; align-items: center; justify-content: center; font-family: 'Noto Serif JP'; font-weight: 900; border-radius: 6px; box-shadow: 0 0 20px var(--cyan); }
        .psi-display { font-family: 'Noto Serif JP', serif; font-size: 2rem; color: var(--cyan); text-shadow: 0 0 15px var(--cyan); }

        .nav { display: flex; overflow-x: auto; gap: 8px; scrollbar-width: none; }
        .nav::-webkit-scrollbar { display: none; }
        .pill { padding: 9px 18px; background: rgba(255,255,255,0.06); border: 1px solid var(--edge); border-radius: 20px; color: #8899aa; font-size: 0.75rem; white-space: nowrap; transition: 0.3s; }
        .pill.active { background: var(--cyan); color: #000; font-weight: 700; border-color: var(--cyan); }

        main { flex: 1; overflow-y: auto; padding: 22px; padding-bottom: 130px; }
        .view { display: none; } .view.active { display: block; animation: vIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes vIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--glass); border: 1px solid var(--edge); border-radius: 22px; padding: 24px; margin-bottom: 20px; backdrop-filter: blur(40px); }
        .group { margin-bottom: 20px; }
        label { display: block; font-size: 0.65rem; color: #6a7c92; margin-bottom: 8px; letter-spacing: 0.1em; text-transform: uppercase; }
        input, select { width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 14px; color: #fff; font-size: 1rem; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--cyan); background: rgba(0,217,255,0.05); }

        /* 地図コンテナ */
        #map-box { height: 280px; border-radius: 18px; margin-bottom: 15px; border: 1px solid var(--edge); }

        /* MAGI 診断 UI */
        .magi { display: flex; justify-content: space-around; margin: 35px 0; position: relative; }
        .magi-rank { position: absolute; font-family: 'Noto Serif JP'; font-size: 4rem; opacity: 0.2; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .magi-core { width: 85px; text-align: center; }
        .c-icon { width: 50px; height: 50px; margin: 0 auto 8px; border: 2px solid; display: flex; align-items: center; justify-content: center; font-family: 'Noto Serif JP'; font-size: 1.2rem; }
        .c-logos { color: var(--gold); } .c-logos .c-icon { transform: rotate(45deg); border-color: var(--gold); }
        .c-hedon { color: var(--cyan); } .c-hedon .c-icon { clip-path: polygon(25% 0, 75% 0, 100% 50%, 75% 100%, 25% 100%, 0 50%); border-color: var(--cyan); }
        .c-aegis { color: var(--green); } .c-aegis .c-icon { clip-path: polygon(0 0, 100% 0, 50% 100%); border-color: var(--green); }

        /* ログエリア */
        #audit-log { font-size: 0.85rem; line-height: 1.6; color: #ccd6f6; }
        .log-l { margin-bottom: 15px; padding-left: 12px; border-left: 2px solid; animation: lIn 0.3s ease; }
        .counter-box { margin-top: 20px; padding: 18px; background: rgba(255,51,102,0.1); border: 1px solid var(--red); border-radius: 15px; }

        footer { position: fixed; bottom: 0; width: 100%; background: var(--glass); backdrop-filter: blur(50px); border-top: 1px solid var(--edge); padding: 14px 20px calc(15px + var(--safe-b)); display: flex; justify-content: space-around; z-index: 2000; }
        .d-btn { background: none; border: none; color: #6a7c92; font-size: 0.65rem; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .d-btn.active { color: var(--cyan); } .d-svg { width: 26px; height: 26px; fill: none; stroke: currentColor; stroke-width: 1.5; }
    </style>
</head>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        /**
         * TRI-AXIS v1.0.2 System Brain
         * 物理・量子・金融・法の全専門家エンジンを隠蔽統合
         */
        const MASTERS = {
            ZONES: {
                L1:{n:"第一種低層住居専用",r:0.05,s:0.95,desc:"低層の良好な住環境が法的に守られます"},
                L2:{n:"第二種低層住居専用",r:0.10,s:0.90,desc:"コンビニ等の利便と住環境の均衡"},
                M1:{n:"第一種中高層住居専用",r:0.35,s:0.70,desc:"将来の周辺高層化による日照喪失リスク中"},
                M2:{n:"第二種中高層住居専用",r:0.40,s:0.65,desc:"中規模店舗との混在地域"},
                H1:{n:"第一種住居",r:0.60,s:0.50,desc:"大規模店舗やホテルが建つ権利があります"},
                H2:{n:"第二種住居",r:0.65,s:0.45,desc:"パチンコ店等の娯楽施設も想定される地域"},
                JH:{n:"準住居",r:0.70,s:0.40,desc:"道路沿いの環境変化リスク高"},
                DEN:{n:"田園住居",r:0.05,s:0.95,desc:"農地と共生する法的保護"},
                NC:{n:"近隣商業",r:0.85,s:0.30,desc:"日照権の保護が著しく弱い地域です"},
                C:{n:"商業地域",r:0.95,s:0.15,desc:"【警告】隣地が超高層化する法的権利が他者にあります"},
                JI:{n:"準工業",r:0.80,s:0.30,desc:"住宅と小規模工場の混在"},
                I:{n:"工業地域",r:0.90,s:0.10,desc:"住環境よりも産業が優先される法的区分"},
                IS:{n:"工業専用",r:1.00,s:0.00,desc:"そもそも住宅建築が原則不可です"}
            },
            FINANCE: { OH: 0.075, ZEH_LIMIT: 5000, BASE_LIMIT: 3000, D_RATE: 0.007 },
            PHYSICS: { ROAD_REF: 75, AIR_ABS: 0.005, LAMBDA: 0.022 }
        };

        const Core = {
            state: {}, map: null, marker: null,
            init() {
                this.map = L.map('map-box', {zoomControl:false}).setView([35.6812, 139.7671], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.map);
                this.map.on('click', (e) => this.setLoc(e.latlng));
                
                const zSel = document.getElementById('i-zone');
                Object.keys(MASTERS.ZONES).forEach(k => zSel.add(new Option(MASTERS.ZONES[k].n, k)));
                this.load();
            },
            setLoc(ll) {
                if(this.marker) this.map.removeLayer(this.marker);
                this.marker = L.marker(ll).addTo(this.map);
                this.state.lat = ll.lat; this.state.lng = ll.lng;
                this.sync();
            },
            sync() {
                const s = this.state;
                s.name = document.getElementById('i-name').value;
                s.price = Number(document.getElementById('i-price').value);
                s.size = Number(document.getElementById('i-size').value);
                s.perf = document.getElementById('i-perf').value;
                s.zone = document.getElementById('i-zone').value;
                s.floor = Number(document.getElementById('i-floor').value);
                s.roadW = Number(document.getElementById('i-road-w').value);
                s.cash = Number(document.getElementById('i-cash').value);

                document.getElementById('u-proj-name').innerText = s.name || "NEW PROJECT";
                document.getElementById('lbl-price').innerText = s.price;
                document.getElementById('lbl-floor').innerText = s.floor;
                document.getElementById('lbl-road-w').innerText = s.roadW;
                
                this.audit();
                localStorage.setItem(`tri_v102_slot_${document.getElementById('i-slot').value}`, JSON.stringify(s));
            },
            audit() {
                const s = this.state;
                // 1. 物理: 流体剥離リスク & 騒音減衰
                const hwRatio = (s.floor * 3) / s.roadW;
                const windRisk = hwRatio > 2.5 ? "高 (剥離流リスク)" : "低";
                const noise = Math.round(MASTERS.PHYSICS.ROAD_REF - 10 * Math.log10(30) - (MASTERS.PHYSICS.AIR_ABS * 30)); // 仮の距離30m

                // 2. 金融: 量子価格予測 & 2026税制
                const overhead = s.price * MASTERS.FINANCE.OH;
                const ltv = (((s.price + overhead - s.cash) / s.price) * 100).toFixed(1);
                const taxLimit = MASTERS.FINANCE[`${s.perf}_LIMIT`] || 0;
                const totalTax = Math.round(Math.min(s.price, taxLimit) * MASTERS.FINANCE.D_RATE * 13);
                
                // 量子価格発展期待値 (10年後)
                const expectedPrice = Math.round(s.price * Math.exp((0.015 - 0.0072) * 10));

                // 3. スコアリング (Ψ)
                const zone = MASTERS.ZONES[s.zone] || MASTERS.ZONES.L1;
                let psi = 100 - (noise > 60 ? (noise-60)*4 : 0) - (ltv > 100 ? 25 : 0) - (zone.r * 20);
                psi = Math.max(0, psi).toFixed(1);

                this.render(psi, ltv, noise, zone, windRisk, totalTax, expectedPrice, overhead);
            },
            render(psi, ltv, noise, zone, wind, tax, exp, oh) {
                document.getElementById('u-psi').innerText = `Ψ ${psi}`;
                document.getElementById('u-psi').style.color = psi > 80 ? 'var(--cyan)' : (psi > 50 ? 'var(--gold)' : 'var(--red)');
                document.getElementById('r-logos').innerText = ltv > 100 ? '保' : '可';
                document.getElementById('r-hedon').innerText = noise > 65 ? '否' : '可';
                document.getElementById('r-aegis').innerText = zone.r > 0.7 ? '保' : '可';
                document.getElementById('r-rank').innerText = psi > 85 ? 'S' : (psi > 65 ? 'A' : 'B');

                document.getElementById('audit-log').innerHTML = `
                    <div class="log-l" style="border-color:var(--gold)"><strong>LOGOS:</strong> 実質LTV ${ltv}%。2026年税制に基づき還付期待額計 <strong>${tax}万</strong>。10年後の量子資産期待値は <strong>${exp}万</strong>。</div>
                    <div class="log-l" style="border-color:var(--cyan)"><strong>HEDON:</strong> 物理騒音 ${noise}dB。流体H/W比監査: 強風リスク ${wind}。断熱性能によるエントロピー抑制を確認。</div>
                    <div class="log-l" style="border-color:var(--green)"><strong>AEGIS:</strong> 領域: ${zone.n}。${zone.desc}。浸水標高監査準備完了。</div>
                    <div class="counter-box">
                        <label>対業者カウンターインサイト</label>
                        <p style="font-size:0.75rem">● 業者が「資産価値は安泰」と言った場合: 「実質LTVが${ltv}%であり、初期状態で諸費用分${oh}万の債務超過です。量子分布予測でも期待値の下振れリスクが価格に未反映では？」と問うてください。</p>
                    </div>
                `;
            },
            load() {
                const slot = document.getElementById('i-slot').value;
                const saved = localStorage.getItem(`tri_v102_slot_${slot}`);
                this.state = saved ? JSON.parse(saved) : {name:"",price:6500,size:70,perf:"ZEH",zone:"L1",floor:10,roadW:8,cash:1000};
                Object.keys(this.state).forEach(k => { if(document.getElementById('i-'+k)) document.getElementById('i-'+k).value = this.state[k]; });
                this.sync();
            },
            expReport() {
                const t = `【TRI-AXIS 居住監査証明書】\n物件: ${this.state.name}\nΨスコア: ${document.getElementById('u-psi').innerText}\n財務・物理・法の三核により承認。`;
                navigator.clipboard.writeText(t); alert("T-Reportをコピーしました。");
            }
        };

        const Router = {
            sw(id) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('v-' + id).classList.add('active');
                document.querySelectorAll('.pill, .d-btn').forEach(el => el.classList.remove('active'));
                // ヘッダータブのハイライト連動
                document.querySelectorAll('.pill').forEach(p => { if(p.innerText.includes(id==='project'?'案件':(id==='property'?'諸元':(id==='location'?'立地':'財務')))) p.classList.add('active'); });
                if(id === 'audit' || id === 'location') document.querySelectorAll('.d-btn').forEach(b => { if(b.innerText.includes(id==='audit'?'診断':'地図')) b.classList.add('active'); });
            }
        };

        window.onload = () => Core.init();
    </script>
</body>
</html>

<body>
    <div class="abyss"></div>
    <div class="shell">
        <header>
            <div class="t-row">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="t-logo">T</div>
                    <div>
                        <div id="u-proj-name" style="font-size:0.9rem; font-weight:600; letter-spacing:0.05em;">NO PROJECT</div>
                        <div id="u-slot-label" style="font-size:0.6rem; color:var(--gold);">SLOT: 壱</div>
                    </div>
                </div>
                <div class="psi-display" id="u-psi">Ψ 0.0</div>
            </div>
            <nav class="nav">
                <button class="pill active" onclick="Router.sw('project')">案件管理</button>
                <button class="pill" onclick="Router.sw('property')">物件諸元</button>
                <button class="pill" onclick="Router.sw('location')">立地交通</button>
                <button class="pill" onclick="Router.sw('finance')">財務属性</button>
            </nav>
        </header>

        <main id="vp">
            <section id="v-project" class="view active">
                <div class="card">
                    <div class="group"><label>物件名称</label><input type="text" id="i-name" placeholder="例: 湾岸クオンタムレジデンス" oninput="Core.sync()"></div>
                    <div class="group"><label>詳細住所</label><input type="text" id="i-addr" placeholder="東京都港区..." oninput="Core.sync()"></div>
                    <div class="group"><label>データスロット</label><select id="i-slot" onchange="Core.load()"><option value="1">壱 (ALPHA)</option><option value="2">弐 (BETA)</option><option value="3">参 (GAMMA)</option></select></div>
                </div>
            </section>

            <section id="v-property" class="view">
                <div class="card">
                    <div class="group"><label>物件価格 (万円): <span id="lbl-price">6500</span></label><input type="range" id="i-price" min="2000" max="25000" step="100" value="6500" oninput="Core.sync()"></div>
                    <div class="group"><label>専有面積 (㎡)</label><input type="number" id="i-size" value="70" oninput="Core.sync()"></div>
                    <div class="group"><label>環境性能区分</label><select id="i-perf" onchange="Core.sync()"><option value="ZEH">ZEH水準・認定住宅</option><option value="BASE">省エネ基準適合</option><option value="LOW">その他</option></select></div>
                </div>
            </section>

            <section id="v-location" class="view">
                <div id="map-box"></div>
                <div class="card">
                    <div class="group"><label>用途地域 (13種監査)</label><select id="i-zone" onchange="Core.sync()"></select></div>
                    <div class="group"><label>階数: <span id="lbl-floor">10</span></label><input type="range" id="i-floor" min="1" max="50" value="10" oninput="Core.sync()"></div>
                    <div class="group"><label>道路幅員 (m): <span id="lbl-road-w">8</span></label><input type="range" id="i-road-w" min="4" max="30" value="8" oninput="Core.sync()"></div>
                </div>
            </section>

            <section id="v-finance" class="view">
                <div class="card">
                    <div class="group"><label>自己資金 (万円)</label><input type="number" id="i-cash" value="1000" oninput="Core.sync()"></div>
                    <div class="group"><label>世帯年収 (万円)</label><input type="number" id="i-inc" value="800" oninput="Core.sync()"></div>
                </div>
            </section>

            <section id="v-audit" class="view">
                <div class="magi">
                    <div class="magi-rank" id="r-rank">-</div>
                    <div class="magi-core c-logos"><div class="c-icon"><span>財</span></div><div style="font-size:0.6rem" id="r-logos">-</div></div>
                    <div class="magi-core c-hedon"><div class="c-icon">生</div><div style="font-size:0.6rem" id="r-hedon">-</div></div>
                    <div class="magi-core c-aegis"><div class="c-icon">守</div><div style="font-size:0.6rem" id="r-aegis">-</div></div>
                </div>
                <div id="audit-log">演算エンジン待機中...</div>
            </section>
        </main>

        <footer>
            <button class="d-btn active" onclick="Router.sw('audit')"><svg class="d-svg"><path d="M9 12l2 2 4-4m5.618-4.016A9 9 0 112.862 10.08a9 9 0 0111.756-6.096z"/></svg>診断</button>
            <button class="d-btn" onclick="Router.sw('location')"><svg class="d-svg"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>地図</button>
            <button class="d-btn" onclick="Core.expReport()"><svg class="d-svg"><path d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316"/></svg>報告</button>
        </footer>
    </div>
