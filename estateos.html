<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ESTATE OS</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogIzBmMTcyYTsiPjxkZWZzPjxsaW5lYXJHcmFkaWVudCBpZD0iZ29sZCIgeDE9IjAlIiB5MT0iMTAwJSIgeDI9IjEwMCUiIHkyPSIwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2IzODcyZTtzdG9wLW9wYWNpdHk6MSIgLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmQ3MDA7c3RvcC1vcGFjaXR5OjEiIC8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiMwZjE3MmEiLz48cGF0aCBkPSJNMjU2IDQwIEwxNjAgNDcyIEwzNTIgNDcyIFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0idXJsKCNnb2xkKSIgc3Ryb2tlLXdpZHRoPSIxMCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgb3BhY2l0eT0iMC41Ii8+PHBhdGggZD0iTTI1NiA4MCBMMjU2IDQ3MiNNMjA2IDQ3MiBMMjA2IDIwMCBMMzE2IDIwMCBMMzE2IDQ3MiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ1cmwoI2dvbGQpIiBzdHJva2Utd2lkdGg9IjgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjgwIiByPSIxMiIgZmlsbD0idXJsKCNnb2xkKSIvPjxjaXJjbGUgY3g9IjIwNiIgY3k9IjIwMCIgcj0iOCIgZmlsbD0idXJsKCNnb2xkKSIvPjxjaXJjbGUgY3g9IjMxNiIgY3k9IjIwMCIgcj0iOCIgZmlsbD0idXJsKCNnb2xkKSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjMyMCIgcj0iOCIgZmlsbD0idXJsKCNnb2xkKSIvPjwvc3ZnPg==">

    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --accent-gold: #fbbf24;
            --accent-cyan: #06b6d4;
            --accent-red: #f43f5e;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --font-stack: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Sans", sans-serif;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-stack);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .glass { background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 30px rgba(0,0,0,0.3); }
        .text-gold { color: var(--accent-gold); }
        .text-cyan { color: var(--accent-cyan); }
        .text-red { color: var(--accent-red); }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 0.5rem; }
        .p-2 { padding: 0.5rem; }
        .p-4 { padding: 1rem; }
        .rounded { border-radius: 12px; }
        .btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-main);
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .btn:active { transform: scale(0.98); background: rgba(255,255,255,0.2); }
        .btn-primary { background: var(--accent-cyan); color: #000; border: none; }
        .btn-gold { background: var(--accent-gold); color: #000; border: none; }
        
        /* Inputs & Sliders */
        input[type="text"], input[type="number"], select {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #334155;
            color: #fff; padding: 10px; border-radius: 6px; font-size: 16px; margin-bottom: 8px;
        }
        input[type="range"] {
            width: 100%; height: 4px; background: #334155; border-radius: 2px; outline: none; appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none; width: 20px; height: 20px; background: var(--accent-cyan); border-radius: 50%;
        }

        /* --- Lock Screen --- */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; background: var(--bg-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .lock-msg { margin-bottom: 20px; font-size: 14px; color: var(--text-sub); letter-spacing: 2px; }
        #pattern-canvas { touch-action: none; }

        /* --- App Layout --- */
        header {
            padding: calc(var(--safe-top) + 10px) 16px 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            background: rgba(15, 23, 42, 0.9);
        }
        .app-title { font-size: 18px; font-weight: 800; letter-spacing: 1px; }
        .app-icon-mini { width: 24px; height: 24px; margin-right: 8px; vertical-align: middle; }

        main { flex: 1; overflow-y: auto; padding-bottom: 80px; scroll-behavior: smooth; }
        .tab-content { display: none; padding: 16px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        .radar-container { width: 100%; max-width: 300px; margin: 0 auto; position: relative; }
        .gauge-bar { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .gauge-fill { height: 100%; width: 0%; transition: width 0.5s ease; }
        .compare-row { display: flex; justify-content: space-between; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 4px 0; }
        
        .station-suggest-list {
            position: absolute; background: #1e293b; border: 1px solid #334155;
            width: 100%; max-height: 150px; overflow-y: auto; z-index: 100;
            border-radius: 0 0 8px 8px;
        }
        .suggest-item { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }

        /* --- Tab Bar --- */
        nav.tab-bar {
            position: fixed; bottom: 0; width: 100%; height: calc(60px + var(--safe-bottom));
            background: rgba(15, 23, 42, 0.95); border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; padding-top: 10px; padding-bottom: var(--safe-bottom);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .tab-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            color: var(--text-sub); font-size: 10px; background: none; border: none; cursor: pointer;
        }
        .tab-btn.active { color: var(--accent-cyan); }
        .tab-icon { font-size: 20px; margin-bottom: 4px; }

        /* --- Footer --- */
        .copyright { text-align: center; color: #475569; font-size: 10px; margin-top: 40px; padding-bottom: 20px; }

    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="app-title text-gold" style="margin-bottom:10px; font-size:24px;">ESTATE OS</div>
        <div id="lock-msg" class="lock-msg">CONNECT CIRCUIT TO BOOT</div>
        <canvas id="pattern-canvas" width="300" height="300"></canvas>
    </div>

    <div id="app-container" class="hidden">
        
        <header>
            <div class="btn" style="padding:4px 8px; font-size:16px;" onclick="resetToHome()">ğŸ </div>
            <div class="app-title">ESTATE <span class="text-cyan">OS</span></div>
            <div class="btn text-gold" style="padding:4px 8px; font-size:12px;" onclick="toggleLock()">ğŸ”’</div>
        </header>

        <main>
            <div id="tab-home" class="tab-content active">
                <div class="glass rounded p-4 mb-4">
                    <h2 class="text-cyan" style="margin:0 0 10px 0;">STATUS</h2>
                    <div class="flex" style="justify-content:space-between; margin-bottom:10px;">
                        <span>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ (2027/08) ã¾ã§</span>
                        <span class="text-gold" style="font-weight:bold;"><span id="days-left">0</span> Days</span>
                    </div>
                    <div style="font-size:12px; color:var(--text-sub);">ç¾åœ¨ã‚¹ã‚³ã‚¢ (Latest)</div>
                    <div style="font-size:48px; font-weight:800; line-height:1;" id="dash-score">--</div>
                    <div id="dash-rank" style="font-size:18px; color:#fbbf24; margin-bottom:10px;">--</div>
                    <div class="gauge-bar"><div id="dash-gauge" class="gauge-fill" style="background:var(--accent-red);"></div></div>
                    <div style="font-size:10px; text-align:right; margin-top:4px;">äºˆç®—æ¶ˆåŒ–ç‡</div>
                </div>

                <div class="glass rounded p-4">
                    <h3>History</h3>
                    <div id="history-list" style="font-size:12px;">
                        <div style="padding:10px; text-align:center; color:gray;">No Data</div>
                    </div>
                </div>
            </div>

            <div id="tab-input" class="tab-content">
                <div class="glass rounded p-4 mb-4">
                    <h3 class="text-cyan">PROPERTY SPEC</h3>
                    <input type="text" id="prop-name" placeholder="ç‰©ä»¶å (ä¾‹: ã‚»ãƒ³ã‚¿ãƒ¼å—ã‚¿ãƒ¯ãƒ¼)">
                    
                    <div class="mt-2">ä¾¡æ ¼: <span id="disp-price" class="text-gold">4500</span> ä¸‡å††</div>
                    <input type="range" id="in-price" min="2000" max="8000" step="50" value="4500" oninput="updateDisp('price')">
                    
                    <div class="flex mt-2" style="gap:10px;">
                        <div class="w-full">
                            <label>ç®¡ç†è²»ç­‰(å††)</label>
                            <input type="number" id="in-fee" value="25000">
                        </div>
                        <div class="w-full">
                            <label>å°‚æœ‰é¢ç©(ã¡)</label>
                            <input type="number" id="in-area" value="60">
                        </div>
                    </div>
                    <div class="flex" style="gap:10px;">
                        <div class="w-full">
                            <label>ç¯‰å¹´(è¥¿æš¦)</label>
                            <input type="number" id="in-year" value="2005">
                        </div>
                        <div class="w-full">
                            <label>é§…å¾’æ­©(åˆ†)</label>
                            <input type="number" id="in-walk" value="5">
                        </div>
                    </div>
                </div>

                <div class="glass rounded p-4 mb-4">
                    <h3 class="text-cyan">LOCATION & MARKET</h3>
                    <div style="position:relative;">
                        <label>æœ€å¯„é§… (æ±äº¬ãƒ»ç¥å¥ˆå·)</label>
                        <input type="text" id="in-station" placeholder="é§…åã‚’å…¥åŠ›..." oninput="suggestStation(this.value)">
                        <div id="station-suggest" class="station-suggest-list hidden"></div>
                    </div>
                    
                    <div class="mt-2 text-gold" style="font-size:12px;" id="station-info"></div>

                    <div class="mt-2">
                        <label>ç›¸å ´ä¹–é›¢ãƒã‚§ãƒƒã‚¯</label>
                        <button class="btn w-full" style="font-size:12px; margin-bottom:5px;" onclick="openMarketSearch()">ğŸ“Š ç›¸å ´ãƒ»åœ°ä¾¡ã‚’æ¤œç´¢ (Web)</button>
                        <input type="number" id="in-market-price" placeholder="èª¿æŸ»ã—ãŸã‚¨ãƒªã‚¢åªå˜ä¾¡ (ä¸‡å††)">
                    </div>

                    <div class="mt-2">
                        <label>å‘¨è¾ºæ–½è¨­ (åˆ†)</label>
                        <div class="flex" style="gap:5px;">
                            <input type="number" id="in-conbini" placeholder="ã‚³ãƒ³ãƒ“ãƒ‹">
                            <input type="number" id="in-super" placeholder="ã‚¹ãƒ¼ãƒ‘ãƒ¼">
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-access" class="tab-content">
                <div class="glass rounded p-4 mb-4" style="height:320px; position:relative;">
                    <h3 class="text-cyan" style="position:absolute; top:10px; left:16px;">ACCESS MAP</h3>
                    <canvas id="access-canvas" width="300" height="250" style="width:100%; height:100%; object-fit:contain;"></canvas>
                </div>

                <div class="glass rounded p-4">
                    <h3>Commute Data (Min)</h3>
                    <div class="flex" style="gap:10px; align-items:flex-end;">
                        <div class="w-full">
                            <label>å¤« (To <span id="lbl-work-h">Work</span>)</label>
                            <input type="number" id="commute-h">
                        </div>
                        <button class="btn" onclick="searchRoute('husband')">ğŸ”</button>
                    </div>
                    <div class="flex mt-2" style="gap:10px; align-items:flex-end;">
                        <div class="w-full">
                            <label>å¦» (To <span id="lbl-work-w">Work</span>)</label>
                            <input type="number" id="commute-w">
                        </div>
                        <button class="btn" onclick="searchRoute('wife')">ğŸ”</button>
                    </div>
                    <div class="mt-2 text-sub" style="font-size:12px;">
                        â€»ç¾½ç”°ç©ºæ¸¯ã‚¿ã‚¯ã‚·ãƒ¼: <span id="taxi-haneda">--</span>å††<br>
                        â€»æ–°å¹¹ç·šã‚¢ã‚¯ã‚»ã‚¹: <span id="shinkansen-acc">--</span>
                    </div>
                </div>
            </div>

            <div id="tab-config" class="tab-content">
                
                <div class="glass rounded p-4 mb-4" style="border: 1px solid var(--accent-gold);">
                    <h2 class="text-gold" style="text-align:center;">JUDGMENT</h2>
                    <div class="radar-container">
                        <canvas id="radar-chart"></canvas>
                    </div>
                    <div id="judge-comment" style="font-size:13px; margin-top:10px; line-height:1.4;"></div>
                    
                    <div id="finance-alert" class="hidden" style="background:rgba(244,63,94,0.2); color:#f43f5e; padding:10px; border-radius:8px; margin-top:10px; font-size:12px;">
                        âš ï¸ è³‡é‡‘ä¸è¶³è­¦å‘Š: <span id="shortage-amt">0</span>ä¸‡å††ä¸è¶³
                    </div>

                    <div class="flex mt-2" style="gap:10px;">
                        <button class="btn w-full btn-gold" onclick="saveHistory()">ğŸ’¾ è¨˜éŒ²</button>
                        <button class="btn w-full" onclick="generatePrompt()">ğŸ¤– AIç›¸è«‡</button>
                    </div>
                    <button class="btn w-full mt-2" style="background:linear-gradient(90deg, #0f172a, #1e293b);" onclick="generateShareImage()">ğŸ“¸ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å…±æœ‰ç”»åƒä½œæˆ</button>
                </div>

                <div class="glass rounded p-4">
                    <h3 class="text-cyan" onclick="toggleSettings()">âš™ï¸ SYSTEM CONFIG (Tap to Open)</h3>
                    <div id="settings-area" class="hidden">
                        <label>æˆ¦ç•¥ãƒ¢ãƒ¼ãƒ‰</label>
                        <select id="conf-mode" onchange="calc()">
                            <option value="dinks">ğŸ¦ Power DINKs (è³‡ç”£ãƒ»é€šå‹¤)</option>
                            <option value="family">ğŸ¥ Family (åºƒã•ãƒ»ç’°å¢ƒ)</option>
                            <option value="senior">ğŸ¢ Senior (ç—…é™¢ãƒ»ãƒ•ãƒ©ãƒƒãƒˆ)</option>
                        </select>

                        <label class="mt-2">å¤«: æœˆå/è³ä¸(ä¸‡)</label>
                        <div class="flex" style="gap:5px;">
                            <input type="number" id="conf-sal-h-m" value="30">
                            <input type="number" id="conf-sal-h-b" value="100">
                        </div>
                        <label>å¦»: å¹´å(ä¸‡)</label>
                        <input type="number" id="conf-sal-w" value="400">
                        
                        <label>é ­é‡‘(ä¸‡)</label>
                        <input type="number" id="conf-downpay" value="400">

                        <label>è·å ´æœ€å¯„é§…</label>
                        <div class="flex" style="gap:5px;">
                            <input type="text" id="conf-st-h" placeholder="å¤«è·å ´">
                            <input type="text" id="conf-st-w" placeholder="å¦»è·å ´">
                        </div>

                        <hr style="border-color:rgba(255,255,255,0.1); margin:15px 0;">
                        
                        <div class="flex" style="gap:10px;">
                            <button class="btn w-full" onclick="exportData()">ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                            <button class="btn w-full" onclick="importData()">ğŸ“¥ å¾©å…ƒ</button>
                        </div>
                    </div>
                </div>

                <div class="copyright">
                    Mansion Scorer 2027 (Infinity Model)<br>
                    Ver 4.0.0<br>
                    Created by Y.T<br>
                    Â© 2025-2027 Y.T All Rights Reserved.
                </div>
            </div>
        </main>

        <nav class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('home')">
                <span class="tab-icon">ğŸ </span>STATUS
            </button>
            <button class="tab-btn" onclick="switchTab('input')">
                <span class="tab-icon">ğŸ“</span>INPUT
            </button>
            <button class="tab-btn" onclick="switchTab('access')">
                <span class="tab-icon">ğŸ§­</span>ACCESS
            </button>
            <button class="tab-btn" onclick="switchTab('config')">
                <span class="tab-icon">ğŸ“Š</span>JUDGE
            </button>
        </nav>
    </div>

    <canvas id="share-canvas" width="600" height="800" style="display:none;"></canvas>

    <script>
        // --- 1. Global State & Config ---
        const APP_KEY = 'estate_os_v4_data';
        const LOCK_KEY = 'estate_os_lock';
        
        let state = {
            profile: {
                salary_h_m: 30, salary_h_b: 100, salary_w_y: 400,
                down_payment: 400,
                station_h: 'æ±äº¬', station_w: 'äºŒå­ç‰å·',
                mode: 'dinks'
            },
            property: {
                name: '', price: 4500, fee: 25000, area: 60, year: 2005, walk: 5,
                station: 'ã‚»ãƒ³ã‚¿ãƒ¼å—', market_price: 0,
                commute_h: 50, commute_w: 40,
                conbini: 3, super: 5
            },
            history: []
        };

        // Station DB (Compression: Name: [LineType, Express, Rank, Lat, Lon, Bus, Note])
        // LineType: 0=Other, 1=Blue/Green, 2=DenEn, 3=JR
        // Rank: 3=S, 2=A, 1=B, 0=C
        const stationDB = {
            "ã‚»ãƒ³ã‚¿ãƒ¼å—": [1, 1, 3, 35.54, 139.57, 1, "æœ¬å‘½ãƒ»æ¸‡æœ›ã‚¨ãƒªã‚¢"],
            "ã‚»ãƒ³ã‚¿ãƒ¼åŒ—": [1, 1, 3, 35.55, 139.57, 1, "æœ¬å‘½ãƒ»å¯¾æŠ—ã‚¨ãƒªã‚¢"],
            "é•·æ´¥ç”°": [2, 1, 2, 35.53, 139.49, 0, "å§‹ç™ºãƒ»åˆ©ä¾¿æ€§é«˜"],
            "ã‚ã–ã¿é‡": [1, 1, 2, 35.56, 139.55, 1, "ãƒ–ãƒ«ãƒ¼ãƒ©ã‚¤ãƒ³æ¥ç¶š"],
            "äºŒå­ç‰å·": [2, 1, 3, 35.61, 139.62, 1, "å¦»è·å ´ãƒ»é«˜ç›¸å ´"],
            "æ–°æ¨ªæµœ": [1, 1, 3, 35.50, 139.61, 1, "æ–°å¹¹ç·šãƒ»ç›¸é‰„ç›´é€š"],
            "æ¨ªæµœ": [3, 1, 3, 35.46, 139.62, 1, "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«"],
            "ç”ºç”°": [3, 1, 2, 35.54, 139.44, 1, "å•†æ¥­å……å®Ÿ"]
        };
        const HANEDA_COORDS = [35.54, 139.77];
        
        // --- 2. Lock Screen Logic (Pattern) ---
        let pattern = [];
        let isSetup = false;
        const lockCanvas = document.getElementById('pattern-canvas');
        const ctx = lockCanvas.getContext('2d');
        let isDrawing = false;
        const dots = [];

        function initLock() {
            // Calc dot positions
            const step = 300 / 4;
            for(let i=0; i<3; i++){
                for(let j=0; j<3; j++){
                    dots.push({x: step*(j+1), y: step*(i+1), id: i*3+j});
                }
            }
            
            // Check stored pattern
            const saved = localStorage.getItem(LOCK_KEY);
            if(!saved) {
                isSetup = true;
                document.getElementById('lock-msg').innerText = "NEW SYSTEM: DRAW PATTERN TO SET";
            } else {
                isSetup = false;
            }

            // Events
            lockCanvas.addEventListener('touchstart', startDraw, {passive:false});
            lockCanvas.addEventListener('touchmove', moveDraw, {passive:false});
            lockCanvas.addEventListener('touchend', endDraw);
            lockCanvas.addEventListener('mousedown', startDraw);
            lockCanvas.addEventListener('mousemove', moveDraw);
            lockCanvas.addEventListener('mouseup', endDraw);
            
            renderLock();
        }

        function getPos(e) {
            const rect = lockCanvas.getBoundingClientRect();
            let cx, cy;
            if(e.touches) { cx=e.touches[0].clientX; cy=e.touches[0].clientY; }
            else { cx=e.clientX; cy=e.clientY; }
            return {x: cx - rect.left, y: cy - rect.top};
        }

        function startDraw(e) { e.preventDefault(); isDrawing = true; pattern = []; renderLock(); checkDot(getPos(e)); }
        function moveDraw(e) { if(!isDrawing) return; e.preventDefault(); renderLock(getPos(e)); checkDot(getPos(e)); }
        function endDraw() {
            isDrawing = false; renderLock();
            verifyPattern();
        }

        function checkDot(pos) {
            dots.forEach(d => {
                const dist = Math.sqrt((d.x-pos.x)**2 + (d.y-pos.y)**2);
                if(dist < 30 && !pattern.includes(d.id)) {
                    pattern.push(d.id);
                    // Haptic feedback if supported
                    if(navigator.vibrate) navigator.vibrate(10);
                }
            });
        }

        function renderLock(currPos = null) {
            ctx.clearRect(0,0,300,300);
            
            // Lines
            if(pattern.length > 0) {
                ctx.beginPath();
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#fbbf24';
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                const first = dots[pattern[0]];
                ctx.moveTo(first.x, first.y);
                for(let i=1; i<pattern.length; i++) {
                    const d = dots[pattern[i]];
                    ctx.lineTo(d.x, d.y);
                }
                if(currPos) ctx.lineTo(currPos.x, currPos.y);
                ctx.stroke();
            }

            // Dots
            dots.forEach(d => {
                ctx.beginPath();
                ctx.arc(d.x, d.y, 6, 0, Math.PI*2);
                ctx.fillStyle = pattern.includes(d.id) ? '#fbbf24' : '#334155';
                ctx.fill();
                // Glow
                if(pattern.includes(d.id)){
                    ctx.shadowBlur = 10; ctx.shadowColor = '#fbbf24';
                    ctx.stroke(); ctx.shadowBlur=0;
                }
            });
        }

        function verifyPattern() {
            if(pattern.length < 3) {
                resetLock("TOO SHORT"); return;
            }
            const patStr = JSON.stringify(pattern);
            
            if(isSetup) {
                localStorage.setItem(LOCK_KEY, patStr);
                unlockApp();
            } else {
                const saved = localStorage.getItem(LOCK_KEY);
                if(saved === patStr) {
                    unlockApp();
                } else {
                    resetLock("ACCESS DENIED");
                    // Flash red
                    document.getElementById('lock-msg').style.color = 'red';
                }
            }
        }

        function resetLock(msg) {
            document.getElementById('lock-msg').innerText = msg;
            pattern = []; renderLock();
        }

        function unlockApp() {
            document.getElementById('lock-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            initApp();
        }
        
        function toggleLock() {
            location.reload(); // Simple re-lock
        }

        // --- 3. App Logic ---
        
        function initApp() {
            loadData();
            // Populate Inputs
            document.getElementById('in-price').value = state.property.price;
            document.getElementById('in-fee').value = state.property.fee;
            document.getElementById('in-area').value = state.property.area;
            document.getElementById('in-year').value = state.property.year;
            document.getElementById('in-station').value = state.property.station;
            document.getElementById('in-walk').value = state.property.walk;
            document.getElementById('prop-name').value = state.property.name;
            
            document.getElementById('conf-sal-h-m').value = state.profile.salary_h_m;
            document.getElementById('conf-sal-h-b').value = state.profile.salary_h_b;
            document.getElementById('conf-sal-w').value = state.profile.salary_w_y;
            document.getElementById('conf-downpay').value = state.profile.down_payment;
            document.getElementById('conf-st-h').value = state.profile.station_h;
            document.getElementById('conf-st-w').value = state.profile.station_w;
            document.getElementById('conf-mode').value = state.profile.mode;

            document.getElementById('commute-h').value = state.property.commute_h;
            document.getElementById('commute-w').value = state.property.commute_w;
            
            // Calc Target Days
            const target = new Date('2027-08-31');
            const now = new Date();
            const diff = Math.ceil((target - now)/(1000*60*60*24));
            document.getElementById('days-left').innerText = diff;
            
            // Labels
            document.getElementById('lbl-work-h').innerText = state.profile.station_h || "Work";
            document.getElementById('lbl-work-w').innerText = state.profile.station_w || "Work";

            calc();
        }

        function loadData() {
            const saved = localStorage.getItem(APP_KEY);
            if(saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed }; // Merge
            }
        }

        function saveData() {
            // Update state from inputs
            state.profile.salary_h_m = parseInt(document.getElementById('conf-sal-h-m').value) || 0;
            state.profile.salary_h_b = parseInt(document.getElementById('conf-sal-h-b').value) || 0;
            state.profile.salary_w_y = parseInt(document.getElementById('conf-sal-w').value) || 0;
            state.profile.down_payment = parseInt(document.getElementById('conf-downpay').value) || 0;
            state.profile.station_h = document.getElementById('conf-st-h').value;
            state.profile.station_w = document.getElementById('conf-st-w').value;
            state.profile.mode = document.getElementById('conf-mode').value;
            
            state.property.name = document.getElementById('prop-name').value;
            state.property.price = parseInt(document.getElementById('in-price').value);
            state.property.fee = parseInt(document.getElementById('in-fee').value);
            state.property.area = parseInt(document.getElementById('in-area').value);
            state.property.year = parseInt(document.getElementById('in-year').value);
            state.property.walk = parseInt(document.getElementById('in-walk').value);
            state.property.station = document.getElementById('in-station').value;
            state.property.commute_h = parseInt(document.getElementById('commute-h').value) || 0;
            state.property.commute_w = parseInt(document.getElementById('commute-w').value) || 0;
            state.property.market_price = parseInt(document.getElementById('in-market-price').value) || 0;
            state.property.conbini = parseInt(document.getElementById('in-conbini').value) || 5;
            state.property.super = parseInt(document.getElementById('in-super').value) || 10;

            localStorage.setItem(APP_KEY, JSON.stringify(state));
        }

        function updateDisp(id) {
            const val = document.getElementById('in-'+id).value;
            document.getElementById('disp-'+id).innerText = val;
            calc();
        }

        function suggestStation(val) {
            const list = document.getElementById('station-suggest');
            list.innerHTML = '';
            if(val.length < 1) { list.classList.add('hidden'); return; }
            
            Object.keys(stationDB).forEach(key => {
                if(key.includes(val)) {
                    const div = document.createElement('div');
                    div.className = 'suggest-item';
                    div.innerText = key;
                    div.onclick = () => {
                        document.getElementById('in-station').value = key;
                        list.classList.add('hidden');
                        calc();
                    };
                    list.appendChild(div);
                }
            });
            list.classList.remove('hidden');
        }

        // --- 4. The CORE Logic ---
        function calc() {
            saveData();
            let points = 0;
            const p = state.property;
            const u = state.profile;
            const mode = u.mode;

            // 1. Finance (Max 30)
            const h_annual = (u.salary_h_m * 12) + u.salary_h_b;
            const total_inc = h_annual + u.salary_w_y;
            const net_monthly = (total_inc * 0.8) / 12; // æ‰‹å–ã‚Šæ¦‚ç®—
            
            // Loan Calc (0.5% 35y)
            const loan_amt = Math.max(0, p.price - u.down_payment);
            const r = 0.005 / 12;
            const n = 35 * 12;
            const monthly_repay = Math.floor(loan_amt * 10000 * r * Math.pow(1+r, n) / (Math.pow(1+r, n)-1));
            const total_monthly_cost = monthly_repay + p.fee;
            
            const ratio = (total_monthly_cost / (net_monthly*10000)) * 100;
            
            // Score
            if(ratio <= 20) points += 30;
            else if(ratio <= 25) points += 20;
            else if(ratio <= 30) points += 10;
            else points -= 10;
            
            // å€Ÿå…¥é™åº¦ãƒã‚§ãƒƒã‚¯ (DINKsæˆ¦ç•¥: å¤«å˜ç‹¬8å€å®‰å…¨åœ or ä¸–å¸¯7å€)
            const safe_loan = h_annual * 8; 
            const shortage = Math.max(0, loan_amt - safe_loan);
            
            if(shortage > 0) {
                document.getElementById('finance-alert').classList.remove('hidden');
                document.getElementById('shortage-amt').innerText = shortage;
                points -= 10;
            } else {
                document.getElementById('finance-alert').classList.add('hidden');
            }

            // 2. Location (Max 30)
            const stData = stationDB[p.station];
            if(stData) {
                if(p.station.includes('ã‚»ãƒ³ã‚¿ãƒ¼å—')) points += 20; // æ¸‡æœ›
                else if(p.station.includes('ã‚»ãƒ³ã‚¿ãƒ¼åŒ—')) points += 15;
                else if(stData[2] >= 3) points += 10; // S Rank
                
                document.getElementById('station-info').innerText = stData[6] + (stData[5] ? " [ğŸšŒç©ºæ¸¯ãƒã‚¹æœ‰]" : "");
                
                // Haneda Taxi Calc (Approx distance from LatLon)
                const lat1 = stData[3], lon1 = stData[4];
                const lat2 = HANEDA_COORDS[0], lon2 = HANEDA_COORDS[1];
                const dist = Math.sqrt(Math.pow(lat1-lat2, 2) + Math.pow(lon1-lon2, 2)) * 111; // km
                const taxi_price = Math.floor(dist * 1.2 * 350 + 1000); // æ¦‚ç®—
                document.getElementById('taxi-haneda').innerText = taxi_price.toLocaleString();
                document.getElementById('shinkansen-acc').innerText = p.station.includes('æ–°æ¨ªæµœ') || [1,3].includes(stData[0]) ? "â—ç›´é€š" : "â—‹ä¹—æ›";

            } else {
                document.getElementById('station-info').innerText = "ãƒ‡ãƒ¼ã‚¿ãªã—";
                document.getElementById('taxi-haneda').innerText = "--";
            }

            if(p.walk <= 5) points += 10;
            else if(p.walk > 10) points -= 5;

            // 3. Spec (Max 20)
            if(p.area >= 60) points += 10;
            else if(p.area >= 50) points += 5;
            else points -= 10;
            
            if(p.year >= 2000) points += 5;

            // 4. Commute (Max 20)
            // å¤«:50åˆ† å¦»:40åˆ†ä»¥å†…ãŒç†æƒ³
            if(p.commute_h <= 50) points += 5;
            if(p.commute_w <= 40) points += 15; // å¦»å„ªå…ˆ
            else if(p.commute_w > 60) points -= 20; // å¦»NG

            // 5. Market (Bonus)
            if(p.market_price > 0) {
                const unit_price = p.price / (p.area * 0.3025);
                const diff = (unit_price / p.market_price) - 1;
                if(diff < -0.05) points += 5; // Bargain
                else if(diff > 0.1) points -= 10; // Overpriced
            }

            // Mode Adjustment
            if(mode === 'family') {
                // åºƒã•é‡è¦–
                if(p.area < 65) points -= 10;
            }

            // Render Score
            document.getElementById('dash-score').innerText = points;
            let rank = 'C';
            if(points >= 85) rank = 'S (THE AXIS)';
            else if(points >= 75) rank = 'A (Excellent)';
            else if(points >= 65) rank = 'B (Standard)';
            
            const rEl = document.getElementById('dash-rank');
            rEl.innerText = rank;
            rEl.style.color = points >= 75 ? '#fbbf24' : '#94a3b8';

            // Gauge
            const bud_pct = Math.min(100, (p.price / safe_loan) * 100);
            document.getElementById('dash-gauge').style.width = bud_pct + '%';
            document.getElementById('dash-gauge').style.background = bud_pct > 110 ? '#f43f5e' : '#06b6d4';

            // Draw Charts
            drawRadar([
                Math.min(5, (p.station.includes('ã‚»ãƒ³ã‚¿ãƒ¼') ? 5 : 3)), 
                Math.min(5, p.area/15),
                Math.min(5, (100-ratio)/15),
                Math.min(5, (60-p.commute_h)/10),
                Math.min(5, (60-p.commute_w)/10)
            ]);
            drawAccessMap();
            
            // History check
            renderHistory();
        }

        function drawRadar(data) {
            const cvs = document.getElementById('radar-chart');
            const c = cvs.getContext('2d');
            cvs.width = 300; cvs.height = 300;
            const cx=150, cy=150, r=100;
            
            c.clearRect(0,0,300,300);
            
            // Grid
            c.strokeStyle = '#334155';
            c.lineWidth = 1;
            for(let i=1; i<=5; i++){
                c.beginPath();
                for(let j=0; j<5; j++){
                    const ang = (Math.PI*2/5)*j - Math.PI/2;
                    const rad = (r/5)*i;
                    c.lineTo(cx + Math.cos(ang)*rad, cy + Math.sin(ang)*rad);
                }
                c.closePath(); c.stroke();
            }

            // Data
            c.beginPath();
            c.strokeStyle = '#06b6d4';
            c.fillStyle = 'rgba(6,182,212,0.3)';
            c.lineWidth = 2;
            for(let j=0; j<5; j++){
                const ang = (Math.PI*2/5)*j - Math.PI/2;
                const val = Math.max(0, data[j]);
                const rad = (r/5)*val;
                const x = cx + Math.cos(ang)*rad;
                const y = cy + Math.sin(ang)*rad;
                if(j==0) c.moveTo(x,y); else c.lineTo(x,y);
            }
            c.closePath(); c.fill(); c.stroke();
            
            // Labels
            c.fillStyle = '#fff'; c.font='10px Arial'; c.textAlign='center';
            const labs = ['Location','Spec','Fund','Acc(H)','Acc(W)'];
            for(let j=0; j<5; j++){
                const ang = (Math.PI*2/5)*j - Math.PI/2;
                c.fillText(labs[j], cx + Math.cos(ang)*(r+20), cy + Math.sin(ang)*(r+20));
            }
        }

        function drawAccessMap() {
            const cvs = document.getElementById('access-canvas');
            const c = cvs.getContext('2d');
            // Simple visualizer
            c.clearRect(0,0,300,250);
            const cx=150, cy=125;
            
            // Home Node
            c.fillStyle = '#fbbf24'; c.beginPath(); c.arc(cx, cy, 8, 0, Math.PI*2); c.fill();
            
            // Targets
            const targets = [
                {l:'å¤«Work', t:state.property.commute_h, a:-Math.PI/2},
                {l:'å¦»Work', t:state.property.commute_w, a:Math.PI/6},
                {l:'å®Ÿå®¶', t:120, a:Math.PI*5/6}, // Dummy fixed
                {l:'ç¾½ç”°', t:60, a:Math.PI}
            ];
            
            targets.forEach(t => {
                const len = Math.min(100, t.t * 1.5);
                const ex = cx + Math.cos(t.a)*len;
                const ey = cy + Math.sin(t.a)*len;
                
                c.beginPath();
                c.strokeStyle = t.t > 60 ? '#f43f5e' : '#06b6d4';
                c.lineWidth = 2;
                c.moveTo(cx, cy); c.lineTo(ex, ey); c.stroke();
                
                c.fillStyle = '#fff'; c.font='10px Arial';
                c.fillText(t.l, ex-10, ey-10);
                c.fillText(t.t+'min', ex-10, ey+5);
            });
        }

        // --- 5. Interactions & Output ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            window.scrollTo(0,0);
        }

        function resetToHome() {
            switchTab('home');
        }

        function toggleSettings() {
            const el = document.getElementById('settings-area');
            el.classList.toggle('hidden');
        }

        function openMarketSearch() {
            const st = document.getElementById('in-station').value;
            if(!st) return alert("é§…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            window.open(`https://www.google.com/search?q=${st}+ãƒãƒ³ã‚·ãƒ§ãƒ³ç›¸å ´+åªå˜ä¾¡`);
        }

        function searchRoute(who) {
            const from = document.getElementById('in-station').value;
            const to = who==='husband' ? state.profile.station_h : state.profile.station_w;
            if(!from || !to) return alert("é§…åã‚’è¨­å®šã—ã¦ãã ã•ã„");
            window.open(`https://transit.yahoo.co.jp/search/result?from=${from}&to=${to}`);
        }

        function generatePrompt() {
            const text = `ESTATE OS Analysis Request:
Please evaluate this property based on my 2027 strategy.

â–  Property
Name: ${state.property.name}
Price: ${state.property.price}ä¸‡ / ${state.property.area}ã¡
Station: ${state.property.station} (${state.property.walk}min)

â–  My Status (2027)
Score: ${document.getElementById('dash-score').innerText} points
Shortage: ${document.getElementById('shortage-amt').innerText}ä¸‡å††
Commute: H(${state.property.commute_h}min) / W(${state.property.commute_w}min)

â–  Ask
1. Is this realistic for a Power DINKs couple?
2. Asset value risk?
3. Compare with Center Minami specs.`;
            
            navigator.clipboard.writeText(text).then(()=>alert("AIä¾é ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
        }

        function saveHistory() {
            const rec = {
                name: state.property.name || 'No Name',
                score: document.getElementById('dash-score').innerText,
                date: new Date().toLocaleDateString()
            };
            state.history.unshift(rec);
            saveData();
            renderHistory();
            alert("å±¥æ­´ã«ä¿å­˜ã—ã¾ã—ãŸ");
        }

        function renderHistory() {
            const div = document.getElementById('history-list');
            div.innerHTML = '';
            state.history.forEach(h => {
                const r = document.createElement('div');
                r.className = 'compare-row';
                r.innerHTML = `<span>${h.name}</span> <span class="text-gold">${h.score}pt</span>`;
                div.appendChild(r);
            });
        }

        function exportData() {
            const str = "MS27_" + btoa(JSON.stringify(state));
            navigator.clipboard.writeText(str).then(()=>alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚\nãƒ¡ãƒ¢å¸³ãªã©ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"));
        }

        function importData() {
            const str = prompt("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰(MS27_...)ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„");
            if(str && str.startsWith("MS27_")) {
                try {
                    const json = atob(str.replace("MS27_", ""));
                    state = JSON.parse(json);
                    saveData();
                    location.reload();
                } catch(e) { alert("ãƒ‡ãƒ¼ã‚¿ç ´æ"); }
            }
        }
        
        function generateShareImage() {
            const cvs = document.getElementById('share-canvas');
            const c = cvs.getContext('2d');
            
            // BG
            const grad = c.createLinearGradient(0,0,0,800);
            grad.addColorStop(0, '#0f172a'); grad.addColorStop(1, '#1e293b');
            c.fillStyle = grad; c.fillRect(0,0,600,800);
            
            // Title
            c.fillStyle = '#06b6d4'; c.font = 'bold 40px sans-serif';
            c.fillText("ESTATE OS REPORT", 50, 80);
            
            // Prop Name
            c.fillStyle = '#fff'; c.font = 'bold 36px sans-serif';
            c.fillText(state.property.name || "Target Property", 50, 150);
            
            // Score
            c.fillStyle = '#fbbf24'; c.font = 'bold 100px sans-serif';
            c.fillText(document.getElementById('dash-score').innerText, 50, 280);
            c.font = '30px sans-serif'; c.fillText("POINTS", 200, 280);
            
            // Details
            c.fillStyle = '#94a3b8'; c.font = '24px sans-serif';
            c.fillText(`Price: ${state.property.price}ä¸‡å††`, 50, 360);
            c.fillText(`Commute: å¤«${state.property.commute_h}åˆ† / å¦»${state.property.commute_w}åˆ†`, 50, 400);
            c.fillText(`Area: ${state.property.area}ã¡ (${state.property.walk}min walk)`, 50, 440);
            
            // Footer
            c.fillStyle = '#334155'; c.fillRect(50, 700, 500, 2);
            c.fillStyle = '#64748b'; c.font = '20px sans-serif';
            c.fillText("Created by Y.T", 50, 740);

            // Download
            const link = document.createElement('a');
            link.download = 'estate_os_report.png';
            link.href = cvs.toDataURL();
            link.click();
        }

        // Init
        window.onload = initLock;

    </script>
</body>
</html>
