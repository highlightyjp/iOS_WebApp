<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<meta name="format-detection" content="telephone=no">
<title>SUI SYSTEM</title>

<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">

<style>
    /* --- 0. ZERO GRAVITY RESET --- */
    :root {
        --bg-deep: #000000;
        --bg-navy: #001228;
        --glass-bg: rgba(20, 30, 50, 0.45);
        --glass-border: rgba(100, 200, 255, 0.12);
        --glass-blur: blur(20px);
        --primary: #C5A059;
        --secondary: #E5C585;
        --accent: #D4AF37;
        --text: #e0faff;
        --text-dim: #5c6a79;
        --danger: #FF453A;
        --success: #32D74B;
        --nixie-on: #ff5a00;
        --nixie-off: #2a1100;
        --dock-h: 90px;
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
    }

    * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation; /* Eliminate 300ms delay */
        user-select: none; /* No text selection */
        outline: none;
    }

    html, body {
        margin: 0; padding: 0;
        width: 100vw; height: 100dvh; /* Dynamic Viewport Height */
        background-color: #000000; /* Absolute Black Base */
        color: var(--text);
        font-family: "Noto Sans JP", sans-serif;
        overflow: hidden; /* SCROLL BAN */
        position: fixed; inset: 0;
    }

    /* --- 1. BACKGROUND LAYER (FIXED) --- */
    #bg-layer {
        position: fixed; inset: 0; z-index: -1;
        background: radial-gradient(circle at center top, #001E43 0%, #000000 120%);
        pointer-events: none;
    }
    .sui-watermark {
        position: absolute; right: -40px; bottom: 140px;
        font-family: 'Orbitron'; font-weight: 900; font-size: 22vw;
        color: rgba(255, 255, 255, 0.02);
        transform: rotate(-15deg);
    }

    /* --- 2. LAYOUT CONTAINERS --- */
    .page {
        display: none; position: absolute; inset: 0;
        padding: 20px;
        padding-top: max(20px, var(--safe-top));
        padding-bottom: calc(var(--dock-h) + var(--safe-bottom));
        flex-direction: column; gap: 15px;
        z-index: 10;
        height: 100dvh; /* Ensure full height */
    }
    .page.active { display: flex; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from{opacity:0; transform:scale(0.99);} to{opacity:1; transform:scale(1);} }

    /* Scrollable zone for lists only */
    .scroll-zone {
        flex: 1; overflow-y: auto; 
        padding-bottom: 20px;
        /* Hide Scrollbar but keep functionality */
        scrollbar-width: none; -ms-overflow-style: none;
    }
    .scroll-zone::-webkit-scrollbar { display: none; }

    /* --- 3. GLASS UI COMPONENTS --- */
    .card {
        background: var(--glass-bg); border: 1px solid var(--glass-border);
        border-radius: 12px; padding: 16px; position: relative;
        backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        flex-shrink: 0;
    }
    /* Auto-fit card (expands to fill space) */
    .card.fit { flex: 1; min-height: 0; display: flex; flex-direction: column; }

    .label {
        font-size: 10px; color: var(--text-dim); letter-spacing: 1px; 
        text-transform: uppercase; margin-bottom: 4px; display: flex; justify-content: space-between;
    }
    .val-lg {
        font-size: 28px; font-family: 'Orbitron'; font-weight: 700; 
        letter-spacing: 1px; color: #fff;
        text-shadow: 0 0 15px rgba(197, 160, 89, 0.4);
    }

    /* Inputs (Dark Mode Force) */
    input, select, textarea {
        background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); 
        color: #fff; padding: 12px; width: 100%; border-radius: 6px; 
        font-family: var(--font-code); font-size: 16px; margin-bottom: 8px;
        color-scheme: dark; /* Prevents white background on input */
        user-select: text; /* Allow selection inside inputs */
    }

    /* Buttons (Fast Response) */
    .btn {
        width: 100%; padding: 14px; border: none; font-weight: bold; cursor: pointer;
        background: linear-gradient(135deg, var(--primary), var(--secondary)); 
        color: #001228; font-family: var(--font-code); border-radius: 6px; 
        letter-spacing: 2px;
        box-shadow: 0 4px 15px rgba(197, 160, 89, 0.2);
        transition: transform 0.1s, opacity 0.1s;
    }
    .btn:active { transform: scale(0.97); opacity: 0.9; }

    /* --- 4. DIVERGENCE METER NIXIE TUBES --- */
    .nixie-rack {
        display: flex; justify-content: center; align-items: flex-end; gap: 4px;
        margin: 0 auto; padding: 5px; pointer-events: none;
    }
    .nixie-tube {
        width: 26px; height: 48px; position: relative;
        background: rgba(20, 10, 5, 0.6); /* Amber tint glass */
        border: 1px solid rgba(255,255,255,0.15); border-radius: 6px;
        box-shadow: inset 0 0 15px #000, 0 0 5px rgba(0,0,0,0.5);
        overflow: hidden; flex-shrink: 0;
    }
    /* Mesh Grid */
    .nixie-tube::after {
        content: ''; position: absolute; inset: 0; opacity: 0.25;
        background-image: linear-gradient(#000 1px, transparent 1px), linear-gradient(90deg, #000 1px, transparent 1px);
        background-size: 3px 3px; z-index: 1; pointer-events: none;
    }
    /* Glass Reflection */
    .nixie-tube::before {
        content: ''; position: absolute; inset: 0; z-index: 10;
        background: linear-gradient(120deg, rgba(255,255,255,0.15) 0%, transparent 40%, rgba(255,255,255,0.05) 100%);
        pointer-events: none;
    }
    /* Lit Digit */
    .nixie-digit {
        position: absolute; inset: 0; display: flex; justify-content: center; align-items: center;
        font-family: 'Share Tech Mono', monospace; font-size: 38px; line-height: 1;
        color: var(--nixie-on); z-index: 5;
        text-shadow: 0 0 5px var(--nixie-on), 0 0 10px #ff0000, 0 0 20px #ff0000;
        filter: blur(0.4px);
    }
    /* Ghost Digit (Off) */
    .nixie-ghost {
        position: absolute; inset: 0; display: flex; justify-content: center; align-items: center;
        font-family: 'Share Tech Mono', monospace; font-size: 38px;
        color: var(--nixie-off); z-index: 0; opacity: 0.15;
    }
    /* Separator dots */
    .nixie-sep { 
        width: 10px; display: flex; align-items: flex-end; justify-content: center; 
        padding-bottom: 10px; color: var(--nixie-on); font-family: 'Share Tech Mono'; 
        text-shadow: 0 0 5px var(--nixie-on); animation: blink 1s infinite;
    }
    @keyframes blink { 50% { opacity: 0.3; } }

    /* --- 5. CALCULATOR (FULL SCREEN / FIXED LOGIC) --- */
    #calc-screen {
        position: fixed; inset: 0; z-index: 9000; background: #050505;
        display: none; flex-direction: column;
        padding-top: max(20px, var(--safe-top));
        padding-bottom: var(--safe-bottom); /* Fix bottom bar issue */
    }
    #calc-header {
        position: absolute; top: max(20px, var(--safe-top)); left: 20px; z-index: 9100;
    }
    .calc-close-btn {
        width: 44px; height: 44px; border-radius: 50%; background: #333;
        color: #fff; border: none; font-size: 24px; display: flex; justify-content: center; align-items: center;
    }
    #calc-display-area {
        flex: 0 0 25%; background: #000;
        display: flex; flex-direction: column; justify-content: flex-end;
        padding: 20px; text-align: right;
    }
    #calc-val {
        font-family: 'Orbitron'; font-size: 16vw; color: #fff; line-height: 1;
        word-break: break-all;
    }
    .calc-grid {
        flex: 1; display: grid; grid-template-columns: repeat(4, 1fr);
        background: #111; gap: 1px; border-top: 1px solid #333;
    }
    .calc-btn {
        width: 100%; height: 100%; border: none; border-radius: 0;
        background: #1c1c1e; color: #fff; font-size: 32px; font-family: 'Share Tech Mono';
        display: flex; justify-content: center; align-items: center;
    }
    .calc-btn:active { background: #444; }
    .calc-btn.op { background: #333; color: var(--primary); }
    .calc-btn.eq { background: var(--primary); color: #000; }

    /* --- 6. GLASS DOCK --- */
    #glass-dock {
        position: fixed; bottom: calc(20px + var(--safe-bottom)); 
        left: 20px; right: 20px; height: 70px;
        background: rgba(10, 20, 30, 0.65); border: 1px solid rgba(255,255,255,0.1);
        backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
        border-radius: 35px; display: flex; justify-content: space-around; align-items: center;
        z-index: 5000; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    }
    .dock-item {
        color: var(--text-dim); font-size: 28px; width: 60px; height: 60px;
        display: flex; justify-content: center; align-items: center; border-radius: 50%;
        transition: 0.2s;
    }
    .dock-item.active {
        color: var(--primary); background: rgba(255,255,255,0.08);
        box-shadow: 0 0 20px rgba(197, 160, 89, 0.1); transform: translateY(-4px);
    }

    /* --- 7. LAUNCHER GRID (Evenly Spaced) --- */
    #launcher-grid {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
        padding: 10px; align-content: center; flex: 1;
    }
    .app-icon {
        background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
        aspect-ratio: 1; border-radius: 18px; display: flex; flex-direction: column;
        justify-content: center; align-items: center; color: var(--text);
        backdrop-filter: blur(10px); transition: 0.1s;
    }
    .app-icon:active { background: rgba(255,255,255,0.1); transform: scale(0.96); }
    .app-icon i { font-size: 32px; margin-bottom: 8px; color: var(--primary); }
    .icon-lbl { font-size: 11px; font-weight: bold; letter-spacing: 1px; }

    /* --- 8. CHART CONTAINERS --- */
    .radar-container { flex: 1; width: 100%; position: relative; min-height: 0; }
    .spark-container { width: 100%; height: 40px; margin-top: 5px; opacity: 0.8; }

    /* --- 9. BOOT & AUTH --- */
    #boot-screen, #auth-screen { 
        position: fixed; inset: 0; background: #000; z-index: 10000; 
        display: flex; flex-direction: column; justify-content: center; align-items: center; 
    }
    .pin-input {
        background: transparent; border: 1px solid var(--primary); color: var(--primary);
        font-family: 'Orbitron'; font-size: 36px; width: 220px; text-align: center;
        padding: 10px; margin-bottom: 25px; letter-spacing: 8px; border-radius: 6px;
    }
</style>
</head>
<body>

<div id="bg-layer"><div class="sui-watermark">SUI</div></div>

<div id="boot-screen" onclick="skipBoot()">
    <div style="font-family:'Orbitron'; font-size:42px; color:var(--primary); letter-spacing:8px; margin-bottom:20px; text-shadow:0 0 20px var(--primary);">SUI</div>
    <div id="boot-log" style="font-family:var(--font-code); font-size:12px; color:var(--text-dim);">INITIALIZING KERNEL...</div>
</div>

<div id="auth-screen" style="display:none;">
    <div style="font-family:'Orbitron'; font-size:24px; color:var(--primary); margin-bottom:40px;">SECURITY CHECK</div>
    <div id="auth-msg" style="font-size:12px; color:var(--text-dim); margin-bottom:10px;">ENTER PASSCODE</div>
    <input type="password" id="auth-input" class="pin-input" pattern="[0-9]*" inputmode="numeric" placeholder="****">
    <button class="btn" style="width:200px" onclick="handleAuth()">UNLOCK</button>
</div>

<div id="p-cockpit" class="page">
    <div style="flex:0 0 auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <div class="label" style="border:1px solid var(--text-dim); padding:2px 6px;">UNIT: Y.T-001</div>
            <div style="font-family:'Orbitron'; font-size:12px; color:var(--primary);">SUI SYSTEM</div>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px; align-items:center;">
            <div class="nixie-rack" id="nixie-date"></div>
            <div class="nixie-rack" id="nixie-time"></div>
        </div>
        <div style="text-align:center; font-family:'Noto Sans JP'; font-weight:bold; color:var(--primary); letter-spacing:2px; margin-top:8px; text-shadow:0 0 10px rgba(197,160,89,0.6);" id="rank-display">---</div>
    </div>

    <div style="display:flex; gap:12px; flex:0 0 auto;">
        <div class="card" style="flex:1;">
            <div class="label">純資産総額</div>
            <div class="val-lg" id="cp-net" style="font-size:24px;">¥0</div>
            <div class="spark-container"><canvas id="sparkCanvas"></canvas></div>
        </div>
        <div class="card" style="flex:1;">
            <div class="label">月次収支 / FIRE</div>
            <div class="val-lg" id="cp-pl" style="font-size:20px; color:var(--text);">¥0</div>
            <div style="text-align:right; font-family:'Orbitron'; font-size:14px; color:var(--secondary); margin-top:8px;">
                <span id="fire-pct">0</span>%
            </div>
        </div>
    </div>

    <div class="card fit">
        <div class="label">ポートフォリオ戦略 (STRATEGY)</div>
        <div class="radar-container"><canvas id="radarChart"></canvas></div>
    </div>
</div>

<div id="p-assets" class="page">
    <div class="card">
        <div class="label">為替レート (USD/JPY)</div>
        <div style="display:flex; gap:10px;">
            <input type="number" id="rate-usd" value="145" style="font-size:20px; font-weight:bold; text-align:center;">
            <button class="btn" style="width:80px;" onclick="fetchRate()">更新</button>
        </div>
    </div>
    <div class="scroll-zone" id="asset-list"></div>
    <button class="btn" onclick="addAsset()">＋ 資産追加</button>
</div>

<div id="p-flows" class="page">
    <div class="card">
        <div class="label">年間特別費予算</div>
        <input type="number" id="special-exp" onchange="saveData()" placeholder="0">
    </div>
    <div class="scroll-zone" id="flow-list"></div>
    <button class="btn" onclick="addFlow()">＋ 収支追加</button>
</div>

<div id="p-menu" class="page">
    <div class="card" style="text-align:center;">
        <div class="label">SYSTEM STATUS</div>
        <div style="font-family:'Orbitron'; color:var(--success); letter-spacing:2px; font-size:18px;">ALL SYSTEMS OPERATIONAL</div>
    </div>
    <div id="launcher-grid">
        <div class="app-icon" onclick="openCalc()">
            <i class="ri-calculator-fill"></i><span class="icon-lbl">電卓</span>
        </div>
        <div class="app-icon" onclick="openApp('bs')">
            <i class="ri-scales-3-fill"></i><span class="icon-lbl">B/S</span>
        </div>
        <div class="app-icon" onclick="openApp('pl')">
            <i class="ri-funds-fill"></i><span class="icon-lbl">P/L</span>
        </div>
        <div class="app-icon" onclick="openApp('config')">
            <i class="ri-settings-4-fill"></i><span class="icon-lbl">設定</span>
        </div>
        <div class="app-icon" onclick="togglePrivacy()">
            <i class="ri-eye-off-fill"></i><span class="icon-lbl">隠蔽</span>
        </div>
        <div class="app-icon" onclick="forceReset()">
            <i class="ri-alert-fill" style="color:var(--danger)"></i><span class="icon-lbl">初期化</span>
        </div>
    </div>
</div>

<div id="p-config" class="page">
    <h2>システム設定</h2>
    <div class="card">
        <div class="label">理想ポートフォリオ比率 (%)</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><span class="label">現金</span><input type="number" id="tgt-cash" onchange="saveData()"></div>
            <div><span class="label">国内株</span><input type="number" id="tgt-jp" onchange="saveData()"></div>
            <div><span class="label">米国株</span><input type="number" id="tgt-us" onchange="saveData()"></div>
            <div><span class="label">暗号資産</span><input type="number" id="tgt-cryp" onchange="saveData()"></div>
        </div>
    </div>
    <div class="card">
        <div class="label">デッドマンスイッチ (遺言)</div>
        <textarea id="inherit-txt" rows="4" onchange="saveData()"></textarea>
    </div>
    <div style="height:50px;"></div>
</div>

<div id="p-bs" class="page"><h2>貸借対照表 (B/S)</h2><div class="scroll-zone" id="bs-view"></div></div>
<div id="p-pl" class="page"><h2>損益計算書 (P/L)</h2><div class="scroll-zone" id="pl-view"></div></div>

<div id="glass-dock">
    <div class="dock-item" onclick="openApp('cockpit')" id="nav-cockpit"><i class="ri-dashboard-line"></i></div>
    <div class="dock-item" onclick="openApp('assets')" id="nav-assets"><i class="ri-safe-2-line"></i></div>
    <div class="dock-item" onclick="openApp('flows')" id="nav-flows"><i class="ri-exchange-dollar-line"></i></div>
    <div class="dock-item" onclick="openApp('menu')" id="nav-menu"><i class="ri-menu-5-line"></i></div>
</div>

<div id="calc-screen">
    <div id="calc-header">
        <button class="calc-close-btn" onclick="closeCalc()"><i class="ri-close-line"></i></button>
    </div>
    <div id="calc-display-area">
        <div id="calc-val">0</div>
    </div>
    <div class="calc-grid">
        <button class="calc-btn op" onclick="calc('C')">C</button>
        <button class="calc-btn op" onclick="calc('/')">÷</button>
        <button class="calc-btn op" onclick="calc('*')">×</button>
        <button class="calc-btn op" onclick="calc('-')">-</button>
        <button class="calc-btn" onclick="calc(7)">7</button>
        <button class="calc-btn" onclick="calc(8)">8</button>
        <button class="calc-btn" onclick="calc(9)">9</button>
        <button class="calc-btn eq" onclick="calc('+')">+</button>
        <button class="calc-btn" onclick="calc(4)">4</button>
        <button class="calc-btn" onclick="calc(5)">5</button>
        <button class="calc-btn" onclick="calc(6)">6</button>
        <button class="calc-btn eq" onclick="calc('=')" style="grid-row: span 3;">=</button>
        <button class="calc-btn" onclick="calc(1)">1</button>
        <button class="calc-btn" onclick="calc(2)">2</button>
        <button class="calc-btn" onclick="calc(3)">3</button>
        <button class="calc-btn" onclick="calc(0)" style="grid-column: span 2">0</button>
        <button class="calc-btn" onclick="calc('.')">.</button>
    </div>
</div>

<script>
    /* --- SUI CORE LOGIC --- */
    const DATA_KEY = 'sui_ult_data';
    const PASS_KEY = 'sui_ult_pass';
    let data = {};
    let radarInstance = null;
    let isPrivacy = false;

    // Default State (Auto Healing)
    const DEF = {
        assets: [{name:'メイン口座', val:0, type:'asset', cat:'cash', curr:'JPY'}],
        flows: [], history: [],
        settings: { usd_rate:145, tgt_cash:30, tgt_jp:30, tgt_us:30, tgt_cryp:10, inherit:"" }
    };

    window.onload = function() {
        // Recover Data
        try {
            let s = localStorage.getItem(DATA_KEY);
            data = s ? {...DEF, ...JSON.parse(s)} : JSON.parse(JSON.stringify(DEF));
            if(!data.settings) data.settings = DEF.settings;
        } catch(e) { data = JSON.parse(JSON.stringify(DEF)); }

        // Start Systems
        setInterval(updateClock, 1000);
        updateClock();
        
        // Boot Animation Simulation
        setTimeout(() => {
            document.getElementById('boot-screen').style.display='none';
            checkAuth();
        }, 1200);
    };

    function skipBoot() { document.getElementById('boot-screen').style.display='none'; checkAuth(); }

    /* --- AUTH --- */
    function checkAuth() {
        if(!localStorage.getItem(PASS_KEY)) {
            document.getElementById('auth-screen').style.display='flex';
            document.getElementById('auth-msg').innerText = "NEW PILOT: SET PASSCODE";
        } else {
            document.getElementById('auth-screen').style.display='flex';
        }
    }
    function handleAuth() {
        let val = document.getElementById('auth-input').value;
        let stored = localStorage.getItem(PASS_KEY);
        if(val === '9999') { if(confirm("完全初期化しますか？")){ localStorage.clear(); location.reload(); } return; }
        if(val === '0000') { data = JSON.parse(JSON.stringify(DEF)); unlock(); return; } // Decoy

        if(!stored) {
            if(val) { localStorage.setItem(PASS_KEY, val); unlock(); }
        } else {
            if(val === stored) unlock();
            else { alert("INVALID PASSCODE"); document.getElementById('auth-input').value = ""; }
        }
    }
    function unlock() {
        document.getElementById('auth-screen').style.display='none';
        logHistory();
        openApp('cockpit');
    }

    /* --- NAVIGATION --- */
    function openApp(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
        
        let target = id;
        if(['config','bs','pl'].includes(id)) target = id;
        else if(id==='menu') target = 'menu';
        
        // Activate Page
        let pageId = 'p-' + target;
        let pEl = document.getElementById(pageId);
        if(pEl) pEl.classList.add('active');
        else document.getElementById('p-menu').classList.add('active');

        // Highlight Dock
        if(id==='cockpit') document.getElementById('nav-cockpit').classList.add('active');
        else if(id==='assets') document.getElementById('nav-assets').classList.add('active');
        else if(id==='flows') document.getElementById('nav-flows').classList.add('active');
        else document.getElementById('nav-menu').classList.add('active');

        // Render Page Data
        if(id==='cockpit') renderCockpit();
        if(id==='assets') renderAssets();
        if(id==='flows') renderFlows();
        if(id==='bs') renderBS();
        if(id==='pl') renderPL();
        if(id==='config') renderConfig();
    }

    /* --- NIXIE TUBE ENGINE --- */
    function updateClock() {
        let now = new Date();
        // DATE: 2026.01.10 [SAT]
        let y = now.getFullYear().toString().split('');
        let m = String(now.getMonth()+1).padStart(2,'0').split('');
        let d = String(now.getDate()).padStart(2,'0').split('');
        let w = ['SUN','MON','TUE','WED','THU','FRI','SAT'][now.getDay()];
        
        // Assemble Date HTML
        let dHTML = "";
        y.forEach(c => dHTML += makeTube(c));
        dHTML += makeSep('.');
        m.forEach(c => dHTML += makeTube(c));
        dHTML += makeSep('.');
        d.forEach(c => dHTML += makeTube(c));
        dHTML += makeSep('['); // Space
        for(let c of w) dHTML += makeTube(c);
        dHTML += makeSep(']'); // Space
        document.getElementById('nixie-date').innerHTML = dHTML;

        // TIME: 14:20:30
        let tHTML = "";
        let hh = String(now.getHours()).padStart(2,'0').split('');
        let mm = String(now.getMinutes()).padStart(2,'0').split('');
        let ss = String(now.getSeconds()).padStart(2,'0').split('');
        
        hh.forEach(c => tHTML += makeTube(c));
        tHTML += makeSep(':');
        mm.forEach(c => tHTML += makeTube(c));
        tHTML += makeSep(':');
        ss.forEach(c => tHTML += makeTube(c));
        document.getElementById('nixie-time').innerHTML = tHTML;
    }

    function makeTube(char) {
        return `<div class="nixie-tube"><div class="nixie-ghost">8</div><div class="nixie-digit">${char}</div></div>`;
    }
    function makeSep(char) {
        if(char===':' || char==='.') return `<div class="nixie-sep">${char}</div>`;
        return `<div class="nixie-sep" style="width:5px"></div>`; // Spacer for []
    }

    /* --- CALCULATOR LOGIC --- */
    let cVal = "";
    function openCalc() { document.getElementById('calc-screen').style.display='flex'; cVal=""; updateCalc(); }
    function closeCalc() { document.getElementById('calc-screen').style.display='none'; }
    function updateCalc() { document.getElementById('calc-val').innerText = cVal || "0"; }
    function calc(v) {
        if(v==='C') cVal="";
        else if(v==='=') {
            if(cVal==='8888') { alert("SECRET STASH UNLOCKED"); cVal=""; }
            else { try { cVal = String(eval(cVal)); } catch { cVal="ERR"; } }
        } else {
            // Prevent double decimals or operators
            let last = cVal.slice(-1);
            if(['.','/','*','-','+'].includes(v) && ['.','/','*','-','+'].includes(last)) return;
            if(cVal==='0' && v!=='0' && v!=='.') cVal=v; // Replace leading zero
            else cVal += v;
        }
        updateCalc();
    }

    /* --- DATA RENDERERS --- */
    function getNet() {
        let a=0, d=0;
        (data.assets||[]).forEach(x => {
            let v = parseInt(x.val) * (x.curr==='USD'?data.settings.usd_rate:1);
            x.type==='asset' ? a+=v : d+=v;
        });
        return a - d;
    }

    function renderCockpit() {
        let net = getNet();
        document.getElementById('cp-net').innerText = isPrivacy ? '***' : '¥'+net.toLocaleString();
        
        let inc=0, exp=0;
        (data.flows||[]).forEach(f => f.type==='inc'?inc+=parseInt(f.val):exp+=parseInt(f.val));
        document.getElementById('cp-pl').innerText = isPrivacy ? '***' : '¥'+(inc-exp).toLocaleString();
        
        let goal = exp * 12 * 25;
        let pct = goal>0 ? Math.round((net/goal)*100) : 0;
        document.getElementById('fire-pct').innerText = pct;

        // Rank
        let r="訓練兵"; let m=net/10000;
        if(m>100) r="一等水兵"; if(m>500) r="兵曹長"; if(m>1000) r="少尉";
        if(m>5000) r="大尉"; if(m>10000) r="中佐"; if(m>50000) r="元帥";
        document.getElementById('rank-display').innerText = r;

        renderRadar();
        renderSpark();
    }

    function renderRadar() {
        let ctx = document.getElementById('radarChart');
        if(!ctx) return;
        if(radarInstance) radarInstance.destroy();

        // Calculate Ratios
        let c={cash:0, stock_jp:0, stock_us:0, crypto:0, other:0};
        let tot=0;
        (data.assets||[]).forEach(x=>{
            if(x.type==='asset'){
                let v = parseInt(x.val)*(x.curr==='USD'?data.settings.usd_rate:1);
                if(c[x.cat]!==undefined) c[x.cat]+=v; else c.other+=v;
                tot+=v;
            }
        });
        
        let cur = [
            tot?Math.round(c.cash/tot*100):0,
            tot?Math.round(c.stock_jp/tot*100):0,
            tot?Math.round(c.stock_us/tot*100):0,
            tot?Math.round(c.crypto/tot*100):0,
            tot?Math.round(c.other/tot*100):0
        ];
        let tgt = [
            parseInt(data.settings.tgt_cash), parseInt(data.settings.tgt_jp),
            parseInt(data.settings.tgt_us), parseInt(data.settings.tgt_cryp), 0
        ];
        tgt[4] = Math.max(0, 100 - (tgt[0]+tgt[1]+tgt[2]+tgt[3]));

        radarInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['現金','国内株','米国株','暗号','その他'],
                datasets: [
                    { label:'現在', data:cur, borderColor:'#C5A059', backgroundColor:'rgba(197,160,89,0.4)', borderWidth:2 },
                    { label:'理想', data:tgt, borderColor:'rgba(255,255,255,0.3)', borderDash:[3,3], borderWidth:1, fill:false }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { r: { angleLines:{color:'rgba(255,255,255,0.1)'}, grid:{color:'rgba(255,255,255,0.1)'}, ticks:{display:false}, pointLabels:{color:'#8FA0B5', font:{size:10}} } },
                plugins: { legend: { display:false } }
            }
        });
    }

    function renderSpark() {
        let cvs = document.getElementById('sparkCanvas');
        let ctx = cvs.getContext('2d');
        let w = cvs.width = cvs.clientWidth; let h = cvs.height = cvs.clientHeight;
        ctx.clearRect(0,0,w,h);
        
        let hist = data.history;
        if(hist.length<2) return;
        
        let min = Math.min(...hist.map(x=>x.v));
        let max = Math.max(...hist.map(x=>x.v));
        let range = max-min || 1;
        
        ctx.beginPath();
        ctx.strokeStyle = '#32D74B'; ctx.lineWidth = 2;
        hist.forEach((p,i)=>{
            let x = (i/(hist.length-1))*w;
            let y = h - ((p.v-min)/range)*h;
            i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
        });
        ctx.stroke();
    }

    function renderAssets() {
        let el = document.getElementById('asset-list'); el.innerHTML='';
        data.assets.forEach((a,i) => {
            el.innerHTML += `<div class="card"><div style="display:flex;gap:8px;margin-bottom:8px;"><input value="${a.name}" onchange="upd('assets',${i},'name',this.value)" style="font-weight:bold"><select onchange="upd('assets',${i},'cat',this.value)"><option value="cash" ${a.cat=='cash'?'selected':''}>現金</option><option value="stock_jp" ${a.cat=='stock_jp'?'selected':''}>国内株</option><option value="stock_us" ${a.cat=='stock_us'?'selected':''}>米国株</option><option value="crypto" ${a.cat=='crypto'?'selected':''}>暗号</option><option value="real_estate" ${a.cat=='real_estate'?'selected':''}>不動産</option></select></div><div style="display:flex;gap:8px;"><select style="width:70px" onchange="upd('assets',${i},'curr',this.value)"><option value="JPY" ${a.curr=='JPY'?'selected':''}>¥</option><option value="USD" ${a.curr=='USD'?'selected':''}>$</option></select><input type="number" value="${a.val}" onchange="upd('assets',${i},'val',this.value)"><button class="btn" style="width:50px; background:var(--danger)" onclick="del('assets',${i})">×</button></div></div>`;
        });
    }
    
    function renderFlows() {
        let el = document.getElementById('flow-list'); el.innerHTML='';
        data.flows.forEach((f,i) => {
            el.innerHTML += `<div class="card"><div style="display:flex;gap:8px;"><input value="${f.title}" onchange="upd('flows',${i},'title',this.value)"><select style="width:90px" onchange="upd('flows',${i},'type',this.value)"><option value="inc" ${f.type=='inc'?'selected':''}>収入</option><option value="exp" ${f.type=='exp'?'selected':''}>支出</option></select></div><div style="display:flex;gap:8px;margin-top:8px;"><input type="number" value="${f.val}" onchange="upd('flows',${i},'val',this.value)"><button class="btn" style="width:50px; background:var(--danger)" onclick="del('flows',${i})">×</button></div></div>`;
        });
    }

    function renderBS() {
        let a=0,d=0,h='';
        data.assets.forEach(x=>{
            let v = parseInt(x.val)*(x.curr==='USD'?data.settings.usd_rate:1);
            x.type==='asset'?a+=v:d+=v;
            h+=`<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1)"><span>${x.name}</span><span>¥${v.toLocaleString()}</span></div>`;
        });
        document.getElementById('bs-view').innerHTML = `<div class="card">${h}<div style="text-align:right;margin-top:10px;font-weight:bold;color:var(--primary)">純資産: ¥${(a-d).toLocaleString()}</div></div>`;
    }
    function renderPL() {
        let i=0,e=0,h='';
        data.flows.forEach(x=>{
            let v = parseInt(x.val); x.type==='inc'?i+=v:e+=v;
            h+=`<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1)"><span>${x.title}</span><span style="color:${x.type==='inc'?'var(--success)':'var(--danger)'}">¥${v.toLocaleString()}</span></div>`;
        });
        document.getElementById('pl-view').innerHTML = `<div class="card">${h}<div style="text-align:right;margin-top:10px;font-weight:bold">収支: ¥${(i-e).toLocaleString()}</div></div>`;
    }
    function renderConfig() {
        document.getElementById('tgt-cash').value = data.settings.tgt_cash;
        document.getElementById('tgt-jp').value = data.settings.tgt_jp;
        document.getElementById('tgt-us').value = data.settings.tgt_us;
        document.getElementById('tgt-cryp').value = data.settings.tgt_cryp;
        document.getElementById('inherit-txt').value = data.settings.inherit || "";
    }

    /* --- HELPERS --- */
    function upd(k,i,f,v) { data[k][i][f]=v; saveData(); }
    function del(k,i) { if(confirm("削除しますか？")) { data[k].splice(i,1); saveData(); k=='assets'?renderAssets():renderFlows(); } }
    function addAsset() { data.assets.push({name:'新規',val:0,type:'asset',cat:'cash',curr:'JPY'}); saveData(); renderAssets(); }
    function addFlow() { data.flows.push({title:'新規',type:'exp',val:0}); saveData(); renderFlows(); }
    function saveData() { localStorage.setItem(DATA_KEY, JSON.stringify(data)); }
    function togglePrivacy() { isPrivacy=!isPrivacy; openApp('cockpit'); }
    function forceReset() { if(confirm("全データを削除しますか？")) { localStorage.clear(); location.reload(); } }
    async function fetchRate() {
        try { let r = await fetch('https://api.exchangerate-api.com/v4/latest/USD').then(x=>x.json()); data.settings.usd_rate=r.rates.JPY; document.getElementById('rate-usd').value=r.rates.JPY; saveData(); alert("レート更新完了"); } catch{alert("オフラインです");}
    }
    function logHistory() {
        let t = new Date().toISOString().split('T')[0];
        let h = data.history;
        if(h.length===0 || h[h.length-1].d !== t) { h.push({d:t, v:getNet()}); if(h.length>30)h.shift(); saveData(); }
    }
</script>
</body>
</html>
